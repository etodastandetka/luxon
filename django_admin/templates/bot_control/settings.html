{% extends 'base.html' %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ - –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å{% endblock %}

{% block header_icon %}cog{% endblock %}
{% block header_title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞{% endblock %}
{% block header_subtitle %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏{% endblock %}

{% block content %}
 

<style>
/* –ö–∞—Ä—Ç–æ—á–∫–∏ */
.card {
    background: #121212;
    border: 1px solid #2a2a2a;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.25);
}
.card h3 {
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* –ö–Ω–æ–ø–∫–∏ */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid transparent;
    background: linear-gradient(180deg, #1f1f1f, #171717);
    color: #e5e7eb;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all .2s ease;
}
.btn:hover { transform: translateY(-1px); border-color: #2f2f2f; }
.btn:active { transform: translateY(0); opacity: .9; }

.btn-success { background: linear-gradient(180deg, #10b981, #059669); color: #fff; }
.btn-success:hover { filter: brightness(1.05); }

.btn-warning { background: linear-gradient(180deg, #f59e0b, #d97706); color: #111; }
.btn-warning:hover { filter: brightness(1.05); }

.btn-danger { background: linear-gradient(180deg, #ef4444, #dc2626); color: #fff; }
.btn-danger:hover { filter: brightness(1.05); }

.btn-secondary { background: linear-gradient(180deg, #374151, #1f2937); color: #fff; }

.btn-row { display: flex; flex-wrap: wrap; gap: 10px; }

/* –°—Ç–∞—Ç—É—Å–Ω–æ–µ –ø–æ–ª–µ */
#bot-status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 10px;
    color: #d1d5db;
}

.form-group label { color: #9ca3af; font-size: 13px; }
.form-control { width: 100%; background: #0a0a0a; border: 1px solid #2a2a2a; color: #e5e7eb; border-radius: 10px; padding: 10px 12px; }
</style>
<div class="card">
    <h3><i class="fas fa-power-off"></i> –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞</h3>
    
    <div class="form-group">
        <label>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</label>
        <div id="bot-status" style="padding: 15px; background: #333; border-radius: 8px; margin-top: 10px;">
            <span id="status-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>
    
    <div class="form-group btn-row">
        <button class="btn btn-success" onclick="setBotStatus(true)"><i class="fas fa-play"></i> –í–∫–ª—é—á–∏—Ç—å</button>
        <button class="btn btn-warning" onclick="setBotStatus(false)"><i class="fas fa-pause"></i> –ü–∞—É–∑–∞</button>
        <button class="btn btn-danger" onclick="restartBot()"><i class="fas fa-sync"></i> –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
</div>

<div class="card">
    <h3><i class="fas fa-tools"></i> –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–∞—Ö</h3>
    
    <div class="form-group">
        <label for="maintenance-message">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
        <textarea id="maintenance-message" class="form-control">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã&#10;–ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</textarea>
    </div>
    
    <button class="btn btn-secondary" onclick="saveMaintenanceMessage()"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadBotStatus() {
    try {
        const response = await fetch('{% url "bot_control:api_bot_status" %}');
        const data = await response.json();
        updateStatusDisplay(data.is_active);
        document.getElementById('maintenance-message').value = data.maintenance_message || '';
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞:', error);
    }
}

function updateStatusDisplay(isActive) {
    const statusText = document.getElementById('status-text');
    if (isActive) {
        statusText.innerHTML = '<i class="fas fa-check-circle" style="color: #00ff88;"></i> –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç';
    } else {
        statusText.innerHTML = '<i class="fas fa-pause-circle" style="color: #ffaa00;"></i> –ë–æ—Ç –Ω–∞ –ø–∞—É–∑–µ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã)';
    }
}

async function setBotStatus(isActive) {
    try {
        const maintenanceMessage = document.getElementById('maintenance-message').value;
        const response = await fetch('{% url "bot_control:api_set_bot_status" %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                is_active: isActive,
                maintenance_message: maintenanceMessage
            })
        });
        
        const data = await response.json();
        if (data.success) {
            updateStatusDisplay(isActive);
            alert(isActive ? '–ë–æ—Ç –≤–∫–ª—é—á–µ–Ω!' : '–ë–æ—Ç –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ –ø–∞—É–∑—É!');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞:', error);
    }
}

async function saveMaintenanceMessage() {
    try {
        const maintenanceMessage = document.getElementById('maintenance-message').value;
        if (!maintenanceMessage.trim()) {
            alert('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            return;
        }
        
        const response = await fetch('{% url "bot_control:api_set_bot_status" %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                is_active: true,
                maintenance_message: maintenanceMessage
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    }
}

async function restartBot() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞? –≠—Ç–æ –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å –µ–≥–æ —Ä–∞–±–æ—Ç—É.')) {
        return;
    }
    
    try {
        const response = await fetch('{% url "bot_control:api_restart_bot" %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.success) {
            alert('–ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ —Ä–∞–±–æ—Ç—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(loadBotStatus, 3000);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞');
    }
}

document.addEventListener('DOMContentLoaded', loadBotStatus);
</script>
{% endblock %}
