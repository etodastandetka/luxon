{% extends 'base.html' %}
{% load static %}

{% block title %}–ó–∞—è–≤–∫–∞ #{{ deposit.id }}{% endblock %}

{% block content %}
<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="card" style="position: relative; overflow: hidden;">
    <!-- –¶–≤–µ—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∞ —Å–ª–µ–≤–∞ -->
    <div style="
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 6px;
        background: {% if deposit.request_type == 'deposit' %}linear-gradient(180deg, #00ff88 0%, #00cc6a 100%){% else %}linear-gradient(180deg, #ff4757 0%, #ff3742 100%){% endif %};
        border-radius: 0 3px 3px 0;
    "></div>
    
    <div class="card-header" style="margin-left: 16px;">
        <div class="card-icon">
            <i class="fas fa-{% if deposit.request_type == 'deposit' %}credit-card{% else %}money-bill-wave{% endif %}" style="color: {% if deposit.request_type == 'deposit' %}#00ff88{% else %}#ff4757{% endif %};"></i>
        </div>
        <div>
            <div class="card-title">–ó–∞—è–≤–∫–∞ #{{ deposit.id }}</div>
            <div class="card-subtitle" style="color: {% if deposit.request_type == 'deposit' %}#00ff88{% else %}#ff4757{% endif %}; font-weight: 600;">
                {% if deposit.request_type == 'deposit' %}üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ{% else %}üí∞ –í—ã–≤–æ–¥{% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ -->
<div class="card">
    <div class="card-body">
        <div class="list-item">
            <div class="list-icon">
                <i class="fas fa-user"></i>
            </div>
            <div class="list-content">
                <div class="list-title">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {{ deposit.user_id }}</div>
                {% if deposit.username %}
                <div class="list-subtitle">@{{ deposit.username }}</div>
                {% else %}
                <div class="list-subtitle">–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ</div>
                {% endif %}
            </div>
        </div>

        <div class="list-item">
            <div class="list-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="list-content">
                <div class="list-title">–ë—É–∫–º–µ–∫–µ—Ä</div>
                <div class="list-subtitle">
                    {% if deposit.bookmaker %}{{ deposit.bookmaker|upper }}{% else %}–ù–µ —É–∫–∞–∑–∞–Ω{% endif %}
                </div>
            </div>
        </div>

        <div class="list-item">
            <div class="list-icon">
                <i class="fas fa-money-bill"></i>
            </div>
            <div class="list-content">
                <div class="list-title">–°—É–º–º–∞</div>
                <div class="list-subtitle">{{ deposit.amount }} KGS</div>
            </div>
            <div class="list-amount" style="
                font-weight: 700;
                font-size: 18px;
                color: {% if deposit.request_type == 'deposit' %}#00ff88{% else %}#ff4757{% endif %};
            ">
                {% if deposit.request_type == 'withdraw' %}-{% endif %}{{ deposit.amount }} KGS
            </div>
        </div>

        <div class="list-item">
            <div class="list-icon">
                <i class="fas fa-{% if deposit.status == 'pending' %}clock{% elif deposit.status == 'completed' %}check{% elif deposit.status == 'auto_completed' %}robot{% elif deposit.status == 'rejected' %}times{% else %}question{% endif %}"></i>
            </div>
            <div class="list-content">
                <div class="list-title">–°—Ç–∞—Ç—É—Å</div>
                <div class="list-subtitle">
                    {% if deposit.status == 'pending' %}–û–∂–∏–¥–∞–µ—Ç{% elif deposit.status == 'completed' %}–ó–∞–≤–µ—Ä—à–µ–Ω–∞{% elif deposit.status == 'auto_completed' %}–ê–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∞{% elif deposit.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–∞{% else %}{{ deposit.status }}{% endif %}
                </div>
            </div>
        </div>

        <div class="list-item">
            <div class="list-icon">
                <i class="fas fa-university"></i>
            </div>
            <div class="list-content">
                <div class="list-title">–ë–∞–Ω–∫</div>
                <div class="list-subtitle">
                    {% if deposit.bank_name %}{{ deposit.bank_name }}{% else %}–ù–µ —É–∫–∞–∑–∞–Ω{% endif %}
                </div>
            </div>
        </div>

        <div class="list-item">
            <div class="list-icon">
                <i class="fas fa-calendar"></i>
            </div>
            <div class="list-content">
                <div class="list-title">–°–æ–∑–¥–∞–Ω–∞</div>
                <div class="list-subtitle">{{ deposit.created_at|date:"d.m.Y H:i" }}</div>
            </div>
        </div>

        {% if deposit.transaction_id %}
        <div class="list-item">
            <div class="list-icon">
                <i class="fas fa-hashtag"></i>
            </div>
            <div class="list-content">
                <div class="list-title">ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
                <div class="list-subtitle">{{ deposit.transaction_id }}</div>
            </div>
        </div>
        {% endif %}

        {% if deposit.admin_comment %}
        <div class="list-item">
            <div class="list-icon">
                <i class="fas fa-comment"></i>
            </div>
            <div class="list-content">
                <div class="list-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
                <div class="list-subtitle">{{ deposit.admin_comment }}</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- –§–æ—Ç–æ —á–µ–∫–∞ -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-qrcode"></i>
        </div>
        <div>
            <div class="card-title">–§–æ—Ç–æ —á–µ–∫–∞</div>
            <div class="card-subtitle">–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
        </div>
    </div>
    <div class="card-body text-center">
        {% if deposit.photo_url %}
            <img src="{{ deposit.photo_url }}" class="img-fluid" alt="–§–æ—Ç–æ —á–µ–∫–∞" style="max-width: 100%; border-radius: 10px; border: 2px solid #333;">
        {% else %}
            <div class="text-muted">
                <i class="fas fa-image fa-3x mb-3"></i><br>
                <strong>–§–æ—Ç–æ —á–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</strong><br>
                <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–∏–ª —Ñ–æ—Ç–æ</small>
            </div>
        {% endif %}
    </div>
</div>

<!-- –î–µ–π—Å—Ç–≤–∏—è -->
{% if deposit.status == 'pending' %}
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-cogs"></i>
        </div>
        <div>
            <div class="card-title">–î–µ–π—Å—Ç–≤–∏—è</div>
            <div class="card-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–æ–π</div>
        </div>
    </div>
    <div class="card-body">
        <button class="btn btn-primary" onclick="updateStatus('completed')" style="width: 100%; margin-bottom: 10px;">
            <i class="fas fa-check"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞—è–≤–∫—É
        </button>
        <button class="btn btn-danger" onclick="updateStatus('rejected')" style="width: 100%; margin-bottom: 10px;">
            <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É
        </button>
        <button class="btn btn-secondary" onclick="addComment()" style="width: 100%;">
            <i class="fas fa-comment"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        </button>
    </div>
</div>
{% endif %}

<!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
<div class="card">
    <div class="card-body">
        <a href="{% url 'dashboard:dashboard' %}" class="btn btn-primary" style="width: 100%;">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∑–∞—è–≤–æ–∫
        </a>
    </div>
</div>

<script>
function updateStatus(newStatus) {
    const statusText = newStatus === 'completed' ? '–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å' : '–æ—Ç–∫–ª–æ–Ω–∏—Ç—å';
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${statusText} –∑–∞—è–≤–∫—É #{{ deposit.id }}?`)) {
        fetch(`/bot/api/deposit-status/{{ deposit.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                status: newStatus,
                comment: '–ò–∑–º–µ–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞: ' + error);
        });
    }
}

function addComment() {
    const comment = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:');
    if (comment) {
        fetch(`/bot/api/deposit-status/{{ deposit.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                status: '{{ deposit.status }}',
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞: ' + error);
        });
    }
}
</script>
{% endblock %}
