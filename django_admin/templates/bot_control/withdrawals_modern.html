{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Выводы{% endblock %}

{% block header_icon %}{% endblock %}
{% block header_title %}{% endblock %}

{% block extra_css %}
<style>
:root {
    /* Lux minimal palette */
    --primary: #22c55e;            /* emerald */
    --primary-light: #d1fae5;      /* emerald light */
    --success: #22c55e;
    --success-light: #d1fae5;
    --warning: #f59e0b;
    --warning-light: #fef3c7;
    --danger: #ef4444;
    --danger-light: #fee2e2;
    --dark: #0b1220;               /* deep navy */
    --light: #0f172a;              /* slate */
    --gray: #94a3b8;
    --gray-light: #1f2937;
    --border: #203047;
    --card-bg: #0f172a;
    --card-hover: #111c2f;
}

/* Base styles */
body { background-color: var(--dark); color: #e5e7eb; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

.lux-container { max-width: 980px; margin: 0 auto; }

.withdrawal-list {
    padding: 0 12px;
}

.withdrawal-card {
    background: transparent;
    color: #FFFFFF;
    padding: 10px 8px;
    border-bottom: 1px solid #3A3A3A;
}
.withdrawal-card:hover { background: rgba(255,255,255,0.03); }

.withdrawal-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.withdrawal-amount {
    font-weight: 600;
    font-size: 1.1rem;
    color: #FFFFFF;
}

.withdrawal-id {
    color: #94a3b8;
    font-size: 0.85rem;
}

.withdrawal-status {
    font-weight: 500;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
}

/* Status colors */
.status-pending {
    border-left-color: #FFC107; /* yellow */
}

.status-pending .withdrawal-status {
    color: #FFC107;
    background: rgba(255, 193, 7, 0.1);
}

.status-completed {
    border-left-color: #4CAF50; /* green */
}

.status-completed .withdrawal-status {
    color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}

.status-rejected {
    border-left-color: #F44336; /* red */
}

.status-rejected .withdrawal-status {
    color: #F44336;
    background: rgba(244, 67, 54, 0.1);
}

/* Action buttons */
.withdrawal-actions {
    display: flex;
    gap: 6px;
    margin-left: 12px;
}

.withdrawal-actions .btn-icon {
    background: transparent;
    border: none;
    color: #94a3b8;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s ease;
    opacity: 0.8;
}

.withdrawal-actions .btn-icon:hover {
    background: rgba(255, 255, 255, 0.1);
    opacity: 1;
}

.withdrawal-actions .btn-icon i {
    font-size: 0.9rem;
}

/* Empty state */
.w-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.w-left {
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 0;
}

.w-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #2c2c2c;
    color: #b3b3b3;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.85rem;
}

.w-meta {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
}

.w-title {
    color: #ffffff;
    font-weight: 600;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.w-sub {
    color: #9aa5b1;
    font-size: 0.78rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.w-date {
    color: #8b97a3;
    font-size: 0.72rem;
}

.w-right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: nowrap;
}

.w-amount {
    font-weight: 600;
    color: #F44336; /* red like screenshot */
    white-space: nowrap;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.status-dot.status-completed { background: #10b981; }
.status-dot.status-pending { background: #f59e0b; }
.status-dot.status-rejected { background: #ef4444; }

.hint-block {
    background: #1f1f1f;
    border: 1px solid #2a2a2a;
    color: #b3b3b3;
    padding: 10px 12px;
    border-radius: 12px;
    margin: 8px 12px 0 12px;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Flat list container (no cards) */
.withdrawals-list { background: transparent; border-radius: 12px; padding: 0; border: 1px solid var(--border); }
.withdrawals-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 0.9rem; background: rgba(15,23,42,0.65);
}
.withdrawals-row:last-child { border-bottom: 0; }
.withdrawals-row:hover { background: rgba(17,28,47,0.9); }
.withdrawals-left { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
.withdrawals-left .w-top { color: #fff; font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.withdrawals-left .w-date { color: #8b97a3; font-size: 0.72rem; }
.withdrawals-right { display: flex; align-items: center; gap: 10px; white-space: nowrap; }
.withdrawals-right .amount { color: #e2e8f0; font-weight: 600; }
.status-pill { background: transparent; color: var(--primary); border-radius: 999px; padding: 4px 10px; font-size: 0.78rem; border: 1px solid rgba(34,197,94,0.35); }
.status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
.status-dot.status-completed { background: #4CAF50; }
.status-dot.status-rejected { background: #F44336; }
.status-dot.status-pending { background: #FFC107; }

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #94a3b8;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h5 {
    color: #e2e8f0;
    margin-bottom: 0.5rem;
}

.empty-state p {
    margin: 0;
    font-size: 0.95rem;
}

/* Card styles */
.card {
    background: var(--card-bg);
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease-in-out;
    margin-bottom: 1rem;
    color: #FFFFFF;
}

.card:hover {
    background: var(--card-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
}

.card-header {
    background-color: var(--card-hover);
    border-bottom: 1px solid #333;
    padding: 1rem 1.25rem;
    border-radius: 0.5rem 0.5rem 0 0 !important;
}

/* Transaction card styles */
.transaction-card {
    background: var(--card-bg);
    color: #FFFFFF;
    padding: 12px 16px;
    margin-bottom: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
    cursor: pointer;
    border-left: 4px solid transparent;
}

.transaction-card:hover {
    background: var(--card-hover);
    transform: translateY(-1px);
}

.transaction-id {
    font-weight: 500;
    color: #94a3b8;
    font-size: 0.875rem;
}

.transaction-amount {
    font-weight: 600;
    font-size: 1rem;
}

.transaction-status {
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-pending {
    border-left-color: var(--warning);
}

.status-pending .transaction-status {
    color: var(--warning);
}

.status-completed {
    border-left-color: var(--success);
}

.status-completed .transaction-status {
    color: var(--success);
}

.status-rejected {
    border-left-color: var(--danger);
}

.status-rejected .transaction-status {
    color: var(--danger);
}

.card-body {
    padding: 1.5rem;
}

/* Status badges */
.badge {
    font-weight: 500;
    padding: 0.35em 0.65em;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    text-transform: capitalize;
}

.badge-pending {
    background-color: var(--warning-light);
    color: var(--warning);
}

.badge-completed {
    background-color: var(--success-light);
    color: var(--success);
}

.badge-rejected {
    background-color: var(--danger-light);
    color: var(--danger);
}

/* Buttons */
.btn {
    border-radius: 0.5rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    transition: all 0.2s ease-in-out;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn-icon {
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}
/* Table styles */
.table {
    margin-bottom: 0;
    color: #374151;
    font-size: 0.9rem;
}

.table thead th {
    background-color: #f8f9fa;
    color: #4b5563;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    border-bottom: 1px solid #e5e7eb;
    padding: 0.8rem 1rem;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 10;
}

.table td {
    padding: 0.9rem 1rem;
    vertical-align: middle;
    border-color: #f1f5f9;
    white-space: nowrap;
}

.table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.2s ease;
}

.table td:last-child {
    padding-right: 1rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(59, 130, 246, 0.04);
}

/* Status badges */
.badge {
    font-weight: 500;
    padding: 0.4em 0.75em;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    text-transform: capitalize;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

/* Action buttons */
.btn-icon {
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    border-radius: 0.375rem;
    transition: all 0.2s;
}

.btn-icon:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* User avatar */
.avatar-sm {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-weight: 600;
    font-size: 0.875rem;
}

/* Stats cards */
.stats-card {
    border-left: 4px solid;
    transition: all 0.3s ease;
    padding: 1rem;
}

.stats-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.stats-card .card-body {
    padding: 1.25rem;
}

.stats-card .icon {
    width: 48px;
    height: 48px;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .table-responsive {
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .table thead {
        display: none;
    }
    
    .table, .table tbody, .table tr, .table td {
        display: block;
        width: 100%;
    }
    
    .table tr {
        margin-bottom: 1rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .table td {
        text-align: right;
        padding-left: 50%;
        position: relative;
        border-bottom: 1px solid var(--border);
    }
    
    .table td::before {
        content: attr(data-label);
        position: absolute;
        left: 1rem;
        width: 45%;
        padding-right: 1rem;
        text-align: left;
        font-weight: 600;
        color: #6b7280;
    }
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.3s ease-out forwards;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 lux-container">
    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stats-card h-100" style="border-left-color: #3b82f6;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-muted mb-2 small">Всего заявок</h6>
                            <h3 class="mb-0">{{ stats.total|intcomma }}</h3>
                        </div>
                        <div class="icon" style="background-color: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-list"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stats-card h-100" style="border-left-color: #f59e0b;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-muted mb-2 small">Ожидают</h6>
                            <h3 class="mb-0">{{ stats.pending|intcomma }}</h3>
                        </div>
                        <div class="icon" style="background-color: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stats-card h-100" style="border-left-color: #10b981;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-muted mb-2 small">Завершено</h6>
                            <h3 class="mb-0">{{ stats.completed|intcomma }}</h3>
                        </div>
                        <div class="icon" style="background-color: rgba(16, 185, 129, 0.1); color: #10b981;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stats-card h-100" style="border-left-color: #ef4444;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-muted mb-2 small">Отклонено</h6>
                            <h3 class="mb-0">{{ stats.rejected|intcomma }}</h3>
                        </div>
                        <div class="icon" style="background-color: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-times-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Actions -->
    <div class="card mb-4">
        <div class="card-body p-3">
            <form method="get" class="row g-3 align-items-center">
                <div class="col-12 col-md-4">
                    <label for="status" class="form-label small text-muted mb-1">Статус</label>
                    <select name="status" id="status" class="form-select form-select-sm">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Все статусы</option>
                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Ожидает</option>
                        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Завершено</option>
                        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Отклонено</option>
                    </select>
                </div>
                <div class="col-12 col-md-6">
                    <label for="search" class="form-label small text-muted mb-1">Поиск</label>
                    <div class="input-group input-group-sm">
                        <input type="text" 
                               class="form-control" 
                               id="search" 
                               name="search" 
                               placeholder="ID пользователя, сумма или реквизиты" 
                               value="{{ search_query|default:'' }}">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-12 col-md-2 d-flex align-items-end">
                    <div class="d-flex gap-2 w-100">
                        <button type="submit" class="btn btn-primary btn-sm flex-grow-1">Применить</button>
                        <a href="{% url 'bot_control:withdrawals_list' %}" class="btn btn-outline-secondary btn-sm" title="Сбросить фильтры">
                            <i class="fas fa-sync-alt"></i>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Withdrawals (flat list) -->
    <div class="d-flex justify-content-between align-items-center px-1 pt-2">
        <h5 class="mb-0" style="font-weight:600;">Список заявок</h5>
        <button class="btn btn-sm btn-outline-light" id="exportBtn"><i class="fas fa-download me-1"></i> Экспорт</button>
    </div>
    <div class="hint-block" style="background:#0f172a;border-color:var(--border);">Заявки на вывод • Нажмите на строку, чтобы открыть детали</div>
    <div class="withdrawals-list mt-1">
        {% for req in withdrawals %}
        <div class="withdrawals-row" data-id="{{ req.id }}">
            <div class="withdrawals-left">
                <div class="w-top" style="display:flex; align-items:center; gap:8px;">
                  {% with wd=req.wallet_details|default:''|lower %}
                    {% if 'mbank' in wd %}
                      <img src="{% static 'images/mbank.png' %}" alt="mbank" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                    {% elif 'optima' in wd %}
                      <img src="{% static 'images/optima.jpg' %}" alt="optima" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                    {% elif 'omoney' in wd %}
                      <img src="{% static 'images/omoney.jpg' %}" alt="omoney" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                    {% elif 'demir' in wd %}
                      <img src="{% static 'images/demirbank.jpg' %}" alt="demirbank" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                    {% elif 'megapay' in wd %}
                      <img src="{% static 'images/megapay.jpg' %}" alt="megapay" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                    {% endif %}
                  {% endwith %}
                  <span>Пользователь ID {{ req.user_id }}</span>
                </div>
                <div class="w-date">{% if req.created_at %}{{ req.created_at|date:'d.m.Y • H:i' }}{% endif %}</div>
            </div>
            <div class="withdrawals-right">
                <div class="amount">-{{ req.amount|floatformat:0|intcomma }} KGS</div>
                {% if req.status == 'pending' %}
                    <button class="status-pill" data-bs-toggle="modal" data-bs-target="#approveModal" data-id="{{ req.id }}">Подтвердить</button>
                {% else %}
                    <span class="status-dot status-{{ req.status }}" title="{{ req.status }}"></span>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h5>Заявок не найдено</h5>
            <p>Попробуйте изменить параметры поиска</p>
        </div>
        {% endfor %}
    </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="d-flex justify-content-between align-items-center px-3 py-2">
            <div class="text-muted small">
                Показано с {{ page_obj.start_index }} по {{ page_obj.end_index }} из {{ page_obj.paginator.count }} записей
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Previous">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                                    {{ num }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Next">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Подтвердить вывод
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="approveForm" method="post" action="">
                <div class="modal-body">
                    <p>Вы уверены, что хотите подтвердить вывод средств?</p>
                    <div class="mb-3">
                        <label for="txHash" class="form-label small text-muted">Хеш транзакции (необязательно)</label>
                        <input type="text" class="form-control form-control-sm" id="txHash" name="tx_hash" 
                            placeholder="Введите хеш транзакции">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="fas fa-check me-1"></i> Подтвердить
                    </button>
                </div>
                {% csrf_token %}
            </form>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle text-danger me-2"></i>
                    Отклонить заявку
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="rejectForm" method="post" action="">
                <div class="modal-body">
                    <p>Укажите причину отклонения заявки:</p>
                    <div class="mb-3">
                        <textarea class="form-control" id="rejectReason" name="reason" 
                                rows="3" placeholder="Причина отклонения" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="fas fa-times me-1"></i> Отклонить
                    </button>
                </div>
                {% csrf_token %}
            </form>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    Детали заявки
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="requestDetails">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка данных...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Current request ID
    let currentRequestId = null;

    // Show alert message
    function showAlert(type, message, duration = 5000) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        const alertContainer = document.createElement('div');
        alertContainer.innerHTML = alertHtml;
        document.querySelector('.container-fluid').prepend(alertContainer.firstElementChild);
        
        setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(alertContainer.firstElementChild);
            alert.close();
        }, duration);
    }

    // Handle approve modal show
    const approveModal = document.getElementById('approveModal');
    if (approveModal) {
        approveModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            currentRequestId = button.getAttribute('data-id');
            const form = document.getElementById('approveForm');
            form.reset();
        });
    }

    // Handle reject modal show
    const rejectModal = document.getElementById('rejectModal');
    if (rejectModal) {
        rejectModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            currentRequestId = button.getAttribute('data-id');
            const form = document.getElementById('rejectForm');
            form.reset();
        });
    }

    // Handle details modal show
    const detailsModal = document.getElementById('detailsModal');
    if (detailsModal) {
        detailsModal.addEventListener('show.bs.modal', async function (event) {
            const button = event.relatedTarget;
            currentRequestId = button.getAttribute('data-id');
            const modal = this;
            const detailsDiv = modal.querySelector('#requestDetails');
            
            // Show loading state
            detailsDiv.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка данных...</p>
                </div>
            `;
            
            try {
                // Simulate API call to get request details
                // Replace with actual API call
                const response = await fetch(`/api/withdrawals/${currentRequestId}/`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка загрузки данных');
                }
                
                // Format date
                const formatDate = (dateString) => {
                    const options = { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    };
                    return new Date(dateString).toLocaleDateString('ru-RU', options);
                };
                
                // Render details
                detailsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-uppercase text-muted mb-3">Информация о пользователе</h6>
                            <div class="d-flex align-items-center mb-4">
                                <div class="avatar-lg bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center rounded-circle me-3" style="width: 60px; height: 60px;">
                                    ${data.user_id ? data.user_id.toString().charAt(0).toUpperCase() : 'U'}
                                </div>
                                <div>
                                    <h5 class="mb-0">ID ${data.user_id}</h5>
                                    <div class="text-muted small">Пользователь</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between py-2 border-bottom">
                                    <span class="text-muted">Дата регистрации:</span>
                                    <span>${formatDate(data.user_created_at || data.created_at)}</span>
                                </div>
                                <div class="d-flex justify-content-between py-2 border-bottom">
                                    <span class="text-muted">Телефон:</span>
                                    <span>${data.phone_number || 'Не указан'}</span>
                                </div>
                                <div class="d-flex justify-content-between py-2 border-bottom">
                                    <span class="text-muted">Email:</span>
                                    <span>${data.email || 'Не указан'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-uppercase text-muted mb-3">Детали заявки</h6>
                            <div class="card bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted">ID заявки:</span>
                                        <span class="fw-medium">#${data.id}</span>
                                    </div>
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted">Сумма:</span>
                                        <span class="fw-bold">${parseFloat(data.amount).toFixed(2)} ₽</span>
                                    </div>
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted">Статус:</span>
                                        <span class="badge ${data.status === 'pending' ? 'badge-pending' : data.status === 'completed' ? 'badge-completed' : 'badge-rejected'}">
                                            ${data.status === 'pending' ? 'Ожидает' : data.status === 'completed' ? 'Завершено' : 'Отклонено'}
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted">Создано:</span>
                                        <span>${formatDate(data.created_at)}</span>
                                    </div>
                                    ${data.processed_at ? `
                                        <div class="d-flex justify-content-between py-2 border-bottom">
                                            <span class="text-muted">Обработано:</span>
                                            <span>${formatDate(data.processed_at)}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="text-uppercase text-muted mb-3">Реквизиты для вывода</h6>
                            <div class="card bg-light">
                                <div class="card-body p-3">
                                    <pre class="mb-0">${data.wallet_details || 'Нет данных'}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${data.admin_comment ? `
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6 class="text-uppercase text-muted mb-3">Комментарий администратора</h6>
                                <div class="card bg-light">
                                    <div class="card-body p-3">
                                        <p class="mb-0">${data.admin_comment}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${data.tx_hash ? `
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-uppercase text-muted mb-0">Хеш транзакции</h6>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="navigator.clipboard.writeText('${data.tx_hash}'); showAlert('success', 'Хеш скопирован')">
                                        <i class="far fa-copy me-1"></i> Копировать
                                    </button>
                                </div>
                                <div class="card bg-light">
                                    <div class="card-body p-3">
                                        <code class="text-break">${data.tx_hash}</code>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Error loading request details:', error);
                detailsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Ошибка при загрузке данных: ${error.message || 'Неизвестная ошибка'}
                    </div>
                `;
            }
        });
    }

    // Handle approve form submission
    const approveForm = document.getElementById('approveForm');
    if (approveForm) {
        approveForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Обработка...
            `;
            
            try {
                const formData = new FormData(form);
                const response = await fetch(`/api/withdrawals/${currentRequestId}/approve/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка сервера');
                }
                
                showAlert('success', 'Заявка успешно подтверждена');
                
                // Close modal and reload page after a short delay
                const modal = bootstrap.Modal.getInstance(approveModal);
                modal.hide();
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                console.error('Error approving request:', error);
                showAlert('danger', error.message || 'Произошла ошибка при подтверждении заявки');
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });
    }

    // Handle reject form submission
    const rejectForm = document.getElementById('rejectForm');
    if (rejectForm) {
        rejectForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            const reason = form.querySelector('textarea').value.trim();
            
            if (!reason) {
                showAlert('warning', 'Пожалуйста, укажите причину отклонения');
                return;
            }
            
            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Обработка...
            `;
            
            try {
                const formData = new FormData(form);
                const response = await fetch(`/api/withdrawals/${currentRequestId}/reject/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(formData).toString()
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка сервера');
                }
                
                showAlert('success', 'Заявка отклонена');
                
                // Close modal and reload page after a short delay
                const modal = bootstrap.Modal.getInstance(rejectModal);
                modal.hide();
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                console.error('Error rejecting request:', error);
                showAlert('danger', error.message || 'Произошла ошибка при отклонении заявки');
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });
    }

    // Handle export button click
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = `
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Экспорт...
            `;
            
            try {
                // Get current filters
                const status = new URLSearchParams(window.location.search).get('status') || 'all';
                const search = new URLSearchParams(window.location.search).get('search') || '';
                
                // Create export URL
                const exportUrl = `/api/withdrawals/export/?status=${status}&search=${encodeURIComponent(search)}`;
                
                // Trigger download
                window.location.href = exportUrl;
                
                // Show success message
                showAlert('success', 'Экспорт начат. Файл будет загружен автоматически.');
                
            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('danger', 'Произошла ошибка при экспорте данных');
            } finally {
                // Reset button state
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });
    }

    // Handle status filter change
    const statusFilter = document.getElementById('status');
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            this.form.submit();
        });
    }
});
</script>
{% endblock %}
