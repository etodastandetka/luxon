{% extends 'dashboard/base_mobile.html' %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-white mb-2">ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</h1>
        <p class="text-white/70">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ IMAP</p>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="card text-center">
            <div class="text-2xl font-bold text-green-400" id="processed-24h">0</div>
            <div class="text-sm text-white/70">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ 24—á</div>
        </div>
        <div class="card text-center">
            <div class="text-2xl font-bold text-blue-400" id="total-processed">0</div>
            <div class="text-sm text-white/70">–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        </div>
        <div class="card text-center">
            <div class="text-2xl font-bold text-yellow-400" id="pending-requests">0</div>
            <div class="text-sm text-white/70">–û–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
        </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="card space-y-6">
        <h2 class="text-lg font-semibold text-white">–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        
        <form id="autodeposit-form" class="space-y-4">
            <!-- –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
            <div class="flex items-center justify-between">
                <label class="text-white font-medium">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="autodeposit_enabled" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                </label>
            </div>

            <!-- IMAP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-white font-medium mb-2">IMAP —Å–µ—Ä–≤–µ—Ä</label>
                    <input type="text" id="autodeposit_imap" class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none" placeholder="imap.timeweb.ru">
                </div>
                <div>
                    <label class="block text-white font-medium mb-2">–ü–∞–ø–∫–∞</label>
                    <input type="text" id="autodeposit_folder" class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none" placeholder="INBOX">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-white font-medium mb-2">Email</label>
                    <input type="email" id="autodeposit_email" class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none" placeholder="bank@example.com">
                </div>
                <div>
                    <label class="block text-white font-medium mb-2">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="autodeposit_password" class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
            </div>

            <!-- –ë–∞–Ω–∫ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-white font-medium mb-2">–ë–∞–Ω–∫</label>
                    <select id="autodeposit_bank" class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
                        <option value="DEMIRBANK">DemirBank</option>
                        <option value="OPTIMA">Optima Bank</option>
                        <option value="MBANK">MBank</option>
                        <option value="MEGAPAY">MegaPay</option>
                        <option value="BAKAI">Bakai</option>
                    </select>
                </div>
                <div>
                    <label class="block text-white font-medium mb-2">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ–∫)</label>
                    <input type="number" id="autodeposit_interval_sec" class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none" placeholder="60" min="10" max="3600">
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex gap-3">
                <button type="submit" class="flex-1 bg-blue-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <button type="button" id="test-btn" class="flex-1 bg-green-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </form>
    </div>

    <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞ -->
    <div class="card space-y-4" id="test-section" style="display: none;">
        <h2 class="text-lg font-semibold text-white">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞</h2>
        
        <div>
            <label class="block text-white font-medium mb-2">–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞</label>
            <textarea id="test-text" rows="6" class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none resize-none" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞ –æ—Ç –±–∞–Ω–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."></textarea>
        </div>
        
        <div class="flex gap-3">
            <button id="parse-test-btn" class="flex-1 bg-green-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                –ü–∞—Ä—Å–∏—Ç—å —Ç–µ–∫—Å—Ç
            </button>
            <button id="close-test-btn" class="flex-1 bg-gray-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
        
        <div id="test-result" class="hidden">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
    </div>

    <!-- –õ–æ–≥–∏ –∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
    <div class="card space-y-4">
        <h2 class="text-lg font-semibold text-white">–õ–æ–≥–∏ –∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
        <div id="autodeposit-logs" class="space-y-2">
            <!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    loadLogs();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('autodeposit-form').addEventListener('submit', saveSettings);
    document.getElementById('test-btn').addEventListener('click', showTestSection);
    document.getElementById('parse-test-btn').addEventListener('click', testParser);
    document.getElementById('close-test-btn').addEventListener('click', hideTestSection);
});

async function loadSettings() {
    try {
        const response = await fetch('/bot/autodeposit/api/');
        const data = await response.json();
        
        if (data.success) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            Object.keys(data.settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = data.settings[key] === '1';
                    } else {
                        element.value = data.settings[key];
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('processed-24h').textContent = data.stats.processed_24h;
            document.getElementById('total-processed').textContent = data.stats.total_processed;
            document.getElementById('pending-requests').textContent = data.stats.pending_requests;
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

async function saveSettings(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const settings = {};
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
    for (let [key, value] of formData.entries()) {
        settings[key] = value;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º checkbox
    settings.autodeposit_enabled = document.getElementById('autodeposit_enabled').checked ? '1' : '0';
    
    try {
        const response = await fetch('/bot/autodeposit/api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            loadSettings(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        console.error('Error saving settings:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
    }
}

function showTestSection() {
    document.getElementById('test-section').style.display = 'block';
}

function hideTestSection() {
    document.getElementById('test-section').style.display = 'none';
}

async function testParser() {
    const testText = document.getElementById('test-text').value;
    const bank = document.getElementById('autodeposit_bank').value;
    
    if (!testText.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç');
        return;
    }
    
    try {
        const response = await fetch('/bot/autodeposit/api/test/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                test_text: testText,
                bank: bank
            })
        });
        
        const data = await response.json();
        const resultDiv = document.getElementById('test-result');
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="bg-green-800 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-200 mb-2">‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω</h3>
                    <p class="text-green-100">–°—É–º–º–∞: ${data.parsed.amount} —Å–æ–º</p>
                    <p class="text-green-100">–î–∞—Ç–∞: ${data.parsed.datetime || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}</p>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="bg-red-800 p-4 rounded-lg">
                    <h3 class="font-semibold text-red-200 mb-2">‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞</h3>
                    <p class="text-red-100">${data.error}</p>
                </div>
            `;
        }
        
        resultDiv.classList.remove('hidden');
    } catch (error) {
        console.error('Error testing parser:', error);
        alert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
    }
}

async function loadLogs() {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –ª–æ–≥–æ–≤ –∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º
}
</script>
{% endblock %}

