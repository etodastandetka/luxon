{% extends 'base.html' %}

{% block title %}Статистика - Админ Панель{% endblock %}

{% block header_icon %}chart-bar{% endblock %}
{% block header_title %}Статистика{% endblock %}
{% block header_subtitle %}Аналитика по букмекерам{% endblock %}

{% block content %}
<style>
/* Специальные стили для полей ввода в статистике */
.form-control {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%) !important;
    color: #ffffff !important;
    border: 2px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 12px !important;
    backdrop-filter: blur(10px) !important;
    transition: all 0.3s ease !important;
}

.form-control::placeholder {
    color: #cccccc !important;
    opacity: 1 !important;
}

.form-control:focus {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.7) 100%) !important;
    color: #ffffff !important;
    border-color: #22c55e !important;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2) !important;
}

/* Стили для select - принудительные */
select.form-control {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%) !important;
    color: #ffffff !important;
    border-radius: 12px !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 15px center !important;
    background-size: 16px !important;
    padding-right: 45px !important;
}

/* Принудительные стили для опций */
select.form-control option {
    background: #1a1a1a !important;
    color: #ffffff !important;
    padding: 12px 15px !important;
    border-radius: 8px !important;
    margin: 2px 0 !important;
    transition: all 0.3s ease !important;
    border: none !important;
    outline: none !important;
}

select.form-control option:hover {
    background: #22c55e !important;
    color: #ffffff !important;
    transform: translateX(5px) !important;
}

select.form-control option:checked {
    background: #22c55e !important;
    color: #ffffff !important;
    font-weight: 600 !important;
}

select.form-control option:focus {
    background: #22c55e !important;
    color: #ffffff !important;
}

/* Дополнительные принудительные стили */
select.form-control:focus option {
    background: #1a1a1a !important;
    color: #ffffff !important;
}

select.form-control option:selected {
    background: #22c55e !important;
    color: #ffffff !important;
}

/* Стили для выпадающего списка */
select.form-control:focus {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.7) 100%) !important;
    color: #ffffff !important;
    border-color: #22c55e !important;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2) !important;
}

/* Стили для input[type="date"] */
input[type="date"].form-control {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%) !important;
    color: #ffffff !important;
    border-radius: 12px !important;
    position: relative !important;
}

input[type="date"].form-control::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
    background: transparent !important;
    border-radius: 4px !important;
    padding: 4px !important;
    transition: all 0.3s ease !important;
}

input[type="date"].form-control::-webkit-calendar-picker-indicator:hover {
    background: rgba(34, 197, 94, 0.2) !important;
    transform: scale(1.1) !important;
}

/* Убираем белый фон у выпадающих списков */
select.form-control:focus {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.7) 100%) !important;
}
</style>

<!-- Фильтры -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-filter"></i>
        </div>
        <div>
            <div class="card-title">Фильтры</div>
            <div class="card-subtitle">Настройте параметры отображения</div>
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label">Период</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="date" id="date-from" class="form-control" placeholder="От">
            <input type="date" id="date-to" class="form-control" placeholder="До">
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label">Букмекер</label>
        <select id="bookmaker-filter" class="form-control">
            <option value="">Все букмекеры</option>
            <option value="1xbet">1XBET</option>
            <option value="1win">1WIN</option>
            <option value="melbet">MELBET</option>
            <option value="mostbet">MOSTBET</option>
        </select>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button id="apply-filters" class="btn btn-primary">
            <i class="fas fa-search"></i> Применить
        </button>
        <button id="export-data" class="btn btn-secondary">
            <i class="fas fa-download"></i> Экспорт
        </button>
    </div>
</div>

<!-- Общая статистика -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div>
            <div class="card-title">Общая статистика</div>
            <div class="card-subtitle">Основные показатели</div>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-users">0</div>
            <div class="stat-label">Пользователей</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-deposits">0</div>
            <div class="stat-label">Пополнений</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-withdrawals">0</div>
            <div class="stat-label">Выводов</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-amount">0 KGS</div>
            <div class="stat-label">Общая сумма</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avg-deposit">0 KGS</div>
            <div class="stat-label">Средний депозит</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avg-withdrawal">0 KGS</div>
            <div class="stat-label">Средний вывод</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="conversion-rate">0%</div>
            <div class="stat-label">Конверсия</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="active-users">0</div>
            <div class="stat-label">Активных</div>
        </div>
    </div>
</div>

<!-- Статистика по букмекерам -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <div>
            <div class="card-title">По букмекерам</div>
            <div class="card-subtitle">Детальная статистика</div>
        </div>
    </div>
    
    <div id="bookmaker-stats">
        <div style="text-align: center; color: #ccc; padding: 20px;">Загрузка данных...</div>
    </div>
</div>

<!-- Графики -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-chart-area"></i>
        </div>
        <div>
            <div class="card-title">Графики</div>
            <div class="card-subtitle">Динамика операций</div>
        </div>
    </div>
    
    <div style="margin-bottom: 20px;">
        <canvas id="deposits-chart" width="400" height="200"></canvas>
    </div>
    <div>
        <canvas id="withdrawals-chart" width="400" height="200"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let depositsChart, withdrawalsChart;

// Загружаем данные при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    initializeCharts();
    
    // Обработчики событий
    document.getElementById('apply-filters').addEventListener('click', loadStatistics);
    document.getElementById('export-data').addEventListener('click', exportData);
    
    // Принудительное применение стилей к select
    const selectElement = document.getElementById('bookmaker-filter');
    if (selectElement) {
        // Применяем стили принудительно
        selectElement.style.setProperty('background', 'linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%)', 'important');
        selectElement.style.setProperty('color', '#ffffff', 'important');
        selectElement.style.setProperty('border-radius', '12px', 'important');
        
        // Обработчик изменения для принудительного применения стилей
        selectElement.addEventListener('change', function() {
            this.style.setProperty('background', 'linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%)', 'important');
            this.style.setProperty('color', '#ffffff', 'important');
        });
        
        // Обработчик фокуса
        selectElement.addEventListener('focus', function() {
            this.style.setProperty('background', 'linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.7) 100%)', 'important');
            this.style.setProperty('color', '#ffffff', 'important');
        });
    }
});

async function loadStatistics() {
    try {
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        const bookmaker = document.getElementById('bookmaker-filter').value;
        
        const params = new URLSearchParams();
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (bookmaker) params.append('bookmaker', bookmaker);
        
        const response = await fetch(`{% url "bot_control:api_statistics" %}?${params}`);
        const data = await response.json();
        
        if (data.success) {
            updateGeneralStats(data.general);
            updateBookmakerStats(data.bookmakers);
            updateCharts(data.charts);
        }
    } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
    }
}

function updateGeneralStats(stats) {
    document.getElementById('total-users').textContent = stats.total_users || 0;
    document.getElementById('total-deposits').textContent = stats.total_deposits || 0;
    document.getElementById('total-withdrawals').textContent = stats.total_withdrawals || 0;
    document.getElementById('total-amount').textContent = `${formatAmount(stats.total_amount || 0)} KGS`;
    document.getElementById('avg-deposit').textContent = `${formatAmount(stats.avg_deposit || 0)} KGS`;
    document.getElementById('avg-withdrawal').textContent = `${formatAmount(stats.avg_withdrawal || 0)} KGS`;
    document.getElementById('conversion-rate').textContent = `${stats.conversion_rate || 0}%`;
    document.getElementById('active-users').textContent = stats.active_users || 0;
}

function updateBookmakerStats(bookmakers) {
    const container = document.getElementById('bookmaker-stats');
    
    if (bookmakers && bookmakers.length > 0) {
        container.innerHTML = '';
        
        bookmakers.forEach(bookmaker => {
            const bookmakerCard = document.createElement('div');
            bookmakerCard.className = 'stat-card';
            bookmakerCard.style.marginBottom = '10px';
            
            bookmakerCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: bold; color: #00ff88;">${bookmaker.name}</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                    <div>
                        <div style="color: #00ff88;">${bookmaker.deposits_count}</div>
                        <div style="color: #ccc;">Пополнений</div>
                    </div>
                    <div>
                        <div style="color: #00ff88;">${formatAmount(bookmaker.deposits_amount || 0)} KGS</div>
                        <div style="color: #ccc;">Сумма депозитов</div>
                    </div>
                    <div>
                        <div style="color: #ffaa00;">${bookmaker.withdrawals_count}</div>
                        <div style="color: #ccc;">Выводов</div>
                    </div>
                    <div>
                        <div style="color: #ffaa00;">${formatAmount(bookmaker.withdrawals_amount || 0)} KGS</div>
                        <div style="color: #ccc;">Сумма выводов</div>
                    </div>
                </div>
            `;
            
            container.appendChild(bookmakerCard);
        });
    } else {
        container.innerHTML = '<div style="text-align: center; color: #ccc; padding: 20px;">Нет данных</div>';
    }
}

function initializeCharts() {
    const depositsCtx = document.getElementById('deposits-chart').getContext('2d');
    const withdrawalsCtx = document.getElementById('withdrawals-chart').getContext('2d');
    
    depositsChart = new Chart(depositsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Пополнения',
                data: [],
                borderColor: '#00ff88',
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#cccccc'
                    },
                    grid: {
                        color: '#333333'
                    }
                },
                y: {
                    ticks: {
                        color: '#cccccc'
                    },
                    grid: {
                        color: '#333333'
                    }
                }
            }
        }
    });
    
    withdrawalsChart = new Chart(withdrawalsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Выводы',
                data: [],
                borderColor: '#ffaa00',
                backgroundColor: 'rgba(255, 170, 0, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#cccccc'
                    },
                    grid: {
                        color: '#333333'
                    }
                },
                y: {
                    ticks: {
                        color: '#cccccc'
                    },
                    grid: {
                        color: '#333333'
                    }
                }
            }
        }
    });
}

function updateCharts(charts) {
    if (depositsChart && charts.deposits) {
        depositsChart.data.labels = charts.deposits.labels;
        depositsChart.data.datasets[0].data = charts.deposits.data;
        depositsChart.update();
    }
    
    if (withdrawalsChart && charts.withdrawals) {
        withdrawalsChart.data.labels = charts.withdrawals.labels;
        withdrawalsChart.data.datasets[0].data = charts.withdrawals.data;
        withdrawalsChart.update();
    }
}

function formatAmount(amount) {
    // Округляем до целых, но сохраняем копейки в данных
    return Math.round(amount).toLocaleString('ru-RU');
}

function exportData() {
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    const bookmaker = document.getElementById('bookmaker-filter').value;
    
    const params = new URLSearchParams();
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    if (bookmaker) params.append('bookmaker', bookmaker);
    
    window.open(`{% url "bot_control:api_export_statistics" %}?${params}`, '_blank');
}
</script>
{% endblock %}

