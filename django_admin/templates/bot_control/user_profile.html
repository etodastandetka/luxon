{% extends 'base.html' %}
{% load static %}

{% block title %}Профиль {{ user.username|default:user.user_id }}{% endblock %}

{% block content %}
<style>
  .card { border-radius: 14px !important; border: 1px solid #242424 !important; background: #111 !important; }
  .kpi { display:grid; grid-template-columns: repeat(2,1fr); gap:10px; }
  .kpi .item { background:#0f0f0f; border:1px solid #222; border-radius:10px; padding:12px; }
  .kpi .label { color:#9aa4b2; font-size:12px; }
  .kpi .value { color:#e8f0ff; font-size:18px; font-weight:700; }
  .req-row { display:flex; align-items:center; justify-content:space-between; padding:10px 2px; border-bottom:1px solid #1a1a1a; color:#cdd6f4; text-decoration:none; }
  .req-row:hover { background:#0f0f0f; }
</style>

<div class="page-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
  <div style="display:flex; align-items:center; gap:12px;">
    {% if avatar_url %}
      <img src="{{ avatar_url }}" alt="avatar" style="width:42px; height:42px; border-radius:50%; object-fit:cover; border:1px solid #2a2a2a;" />
    {% else %}
      <div class="header-avatar"><i class="fas fa-user"></i></div>
    {% endif %}
    <div class="header-content">
      <div style="color:#9aa4b2; font-size:12px; letter-spacing:.2px; text-transform:uppercase;">Профиль</div>
      <div style="color:#fff; font-size:20px; font-weight:600; line-height:1.2;">{{ user.username|default:user.user_id }}</div>
      <div style="color:#8b8b8b; font-size:12px;">ID: {{ user.user_id }}</div>
    </div>
  </div>
  <a class="action-btn action-btn--neutral" style="padding:8px 12px; display:inline-flex; align-items:center; gap:8px;" href="#chat">
    <i class="fas fa-comments"></i><span>Открыть чат</span>
  </a>
</div>

<div class="card" style="padding:16px;">
  <div class="kpi">
    <div class="item"><div class="label">Всего пополнено</div><div class="value">{{ stats.total_deposits|floatformat:2 }} сом</div></div>
    <div class="item"><div class="label">Всего выведено</div><div class="value">{{ stats.total_withdrawals|floatformat:2 }} сом</div></div>
    <div class="item"><div class="label">Кол-во пополнений</div><div class="value">{{ stats.deposit_count }}</div></div>
    <div class="item"><div class="label">Кол-во выводов</div><div class="value">{{ stats.withdraw_count }}</div></div>
    <div class="item" style="grid-column:1 / -1;"><div class="label">Чистый итог</div><div class="value" style="color:{% if stats.net >= 0 %}#21f39c{% else %}#ff6b6b{% endif %};">{{ stats.net|floatformat:2 }} сом</div></div>
  </div>
</div>

{% if requests %}
<div class="card" style="padding:12px; margin-top:12px;">
  <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
    <i class="fas fa-list"></i>
    <div style="font-weight:600;">Все заявки</div>
  </div>
  <div style="border-top:1px solid #222"></div>
  {% for r in requests %}
    <a href="{% url 'bot_control:transaction_detail' r.id %}" class="req-row">
      <div style="display:flex; align-items:center; gap:10px; min-width:0;">
        <div style="color:#8b8b8b; font-size:12px;">#{{ r.id }}</div>
        <div style="color:#9aa4b2; font-size:11px; white-space:nowrap;">{{ r.created_at|slice:":16" }}</div>
        <div style="font-size:12px; color:#7a869a;">{{ r.bookmaker|upper }}</div>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="font-weight:600; font-size:13px; {% if r.type == 'deposit' %}color:#21f39c;{% else %}color:#ff6b6b;{% endif %}">{{ r.amount|floatformat:2 }} сом</div>
        <div style="font-size:11px; padding:2px 6px; border-radius:6px; border:1px solid #2a2a2a; color:#aab1c2; background:#151515;">
          {% if r.status == 'pending' %}Ожидает{% elif r.status == 'processing' %}В обработке{% elif r.status == 'completed' %}Завершена{% elif r.status == 'rejected' %}Отклонена{% elif r.status == 'awaiting_manual' %}Оставленные{% else %}{{ r.status }}{% endif %}
        </div>
        <i class="fas fa-chevron-right" style="color:#555;"></i>
      </div>
    </a>
  {% endfor %}
</div>
{% endif %}

<!-- Chat widget -->
<div id="chat" class="card" style="padding:12px; margin-top:12px;">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
    <div style="display:flex; align-items:center; gap:8px;">
      <i class="fas fa-comments"></i>
      <div style="font-weight:600;">Чат с пользователем</div>
    </div>
    <div style="color:#8b8b8b; font-size:12px;">ID: {{ user.user_id }}</div>
  </div>
  <div id="chat-history" style="height:260px; overflow:auto; border:1px solid #222; border-radius:10px; padding:10px; background:#0f0f0f;">
    <div id="chat-empty" style="color:#7a869a; font-size:12px;">Здесь будет история сообщений…</div>
  </div>
  <div style="display:flex; gap:8px; margin-top:10px;">
    <input id="chat-input" type="text" placeholder="Написать сообщение" style="flex:1; background:#0f0f0f; border:1px solid #2a2a2a; color:#e8f0ff; border-radius:8px; padding:10px; outline:none;">
    <button id="chat-send" class="action-btn action-btn--neutral" style="padding:10px 14px;">Отправить</button>
  </div>
</div>

{% block extra_js %}
<script>
const CHAT_HISTORY_URL = '{% url "bot_control:chat_history" user.user_id %}';
const CHAT_SEND_URL = '{% url "bot_control:chat_send_from_admin" %}';
function getCookie(name) { const v = `; ${document.cookie}`; const p = v.split(`; ${name}=`); if (p.length === 2) return p.pop().split(';').shift(); }

function appendMsg(item){
  const box = document.getElementById('chat-history');
  const empty = document.getElementById('chat-empty');
  if (empty) empty.style.display = 'none';
  const wrap = document.createElement('div');
  wrap.style.display = 'flex';
  wrap.style.justifyContent = item.direction === 'out' ? 'flex-end' : 'flex-start';
  wrap.style.margin = '6px 0';
  const bubble = document.createElement('div');
  bubble.textContent = item.message;
  bubble.style.maxWidth = '80%';
  bubble.style.padding = '8px 10px';
  bubble.style.borderRadius = '10px';
  bubble.style.fontSize = '13px';
  bubble.style.lineHeight = '1.35';
  if (item.direction === 'out') { bubble.style.background = '#0e2f24'; bubble.style.color = '#c6ffe7'; bubble.style.border = '1px solid #1bd58a'; }
  else { bubble.style.background = '#191919'; bubble.style.color = '#e8e8e8'; bubble.style.border = '1px solid #2a2a2a'; }
  wrap.appendChild(bubble);
  box.appendChild(wrap);
  box.scrollTop = box.scrollHeight;
}

async function loadHistory(){
  try{
    const res = await fetch(CHAT_HISTORY_URL, {credentials:'same-origin'});
    if(!res.ok) return; const data = await res.json(); if(!data.success) return;
    const box = document.getElementById('chat-history'); box.innerHTML='';
    if(!data.items || !data.items.length){ document.getElementById('chat-empty').style.display='block'; return; }
    data.items.forEach(appendMsg);
  }catch(e){ /* silent */ }
}

async function sendMessage(){
  const input = document.getElementById('chat-input');
  const text = (input.value||'').trim(); if(!text) return;
  input.value='';
  appendMsg({direction:'out', message:text});
  try{
    await fetch(CHAT_SEND_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken')||''},
      body: JSON.stringify({user_id: {{ user.user_id }}, message: text})
    });
  }catch(e){ /* silent */ }
}

document.addEventListener('DOMContentLoaded', () => {
  loadHistory();
  document.getElementById('chat-send').addEventListener('click', sendMessage);
  document.getElementById('chat-input').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });
  setInterval(loadHistory, 5000);
});
</script>
{% endblock %}

{% endblock %}
