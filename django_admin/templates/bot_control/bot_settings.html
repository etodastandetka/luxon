{% extends 'base.html' %}

{% block title %}‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ - Luxon{% endblock %}
{% block header_icon %}cog{% endblock %}
{% block header_title %}‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}
{% block header_subtitle %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π{% endblock %}

{% block content %}
    <div class="content">
        <div id="save-status" style="display:none;position:fixed;top:12px;right:12px;background:#2b2b2b;color:#fff;padding:10px 14px;border-radius:8px;z-index:1000;border:1px solid #444;font-size:13px;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶</div>
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">‚è∏Ô∏è</div>
                <div>
                    <div class="card-title">–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <div class="card-subtitle"></div>
                </div>
            </div>
            <div class="card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-label">–ü–∞—É–∑–∞</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pause-bot" name="pause-bot">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–æ–≤ -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üåê</div>
                <div>
                    <div class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–æ–≤</div>
                    <div class="card-subtitle"></div>
                </div>
            </div>
            <div class="card-body">
                <div class="checkbox-grid" id="sites-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" data-site="melbet" name="site-melbet" id="site-melbet" checked>
                        <span class="checkmark"></span>
                        Melbet
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-site="1xbet" name="site-1xbet" id="site-1xbet" checked>
                        <span class="checkmark"></span>
                        1xbet
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-site="1win" name="site-1win" id="site-1win" checked>
                        <span class="checkmark"></span>
                        1win
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-site="mostbet" name="site-mostbet" id="site-mostbet" checked>
                        <span class="checkmark"></span>
                        mostbet
                    </label>
                </div>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üí∞</div>
                <div>
                    <div class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π</div>
                    <div class="card-subtitle"></div>
                </div>
            </div>
            <div class="card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-label">–í–∫–ª—é—á–∏—Ç—å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="deposits-enabled" name="deposits-enabled" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="deposit-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="mbank" name="deposit-mbank" id="deposit-mbank" checked>
                        <span class="checkmark"></span>
                        mbank
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="bakai" name="deposit-bakai" id="deposit-bakai" checked>
                        <span class="checkmark"></span>
                        bakai
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="balance" name="deposit-balance" id="deposit-balance" checked>
                        <span class="checkmark"></span>
                        balance
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="demir" name="deposit-demir" id="deposit-demir" checked>
                        <span class="checkmark"></span>
                        demir
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="omoney" name="deposit-omoney" id="deposit-omoney" checked>
                        <span class="checkmark"></span>
                        omoney
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="elcart" name="deposit-elcart" id="deposit-elcart" checked>
                        <span class="checkmark"></span>
                        elcart
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="megapay" name="deposit-megapay" id="deposit-megapay" checked>
                        <span class="checkmark"></span>
                        megapay
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="qr" name="deposit-qr" id="deposit-qr">
                        <span class="checkmark"></span>
                        qr
                    </label>
                </div>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–≤–æ–¥–æ–≤ -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">‚è∞</div>
                <div>
                    <div class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–≤–æ–¥–æ–≤</div>
                    <div class="card-subtitle"></div>
                </div>
            </div>
            <div class="card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-label">–í–∫–ª—é—á–∏—Ç—å –≤—ã–≤–æ–¥—ã</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="withdrawals-enabled" name="withdrawals-enabled" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="withdrawal-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="kompanion" name="withdrawal-kompanion" id="withdrawal-kompanion" checked>
                        <span class="checkmark"></span>
                        kompanion
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="odengi" name="withdrawal-odengi" id="withdrawal-odengi" checked>
                        <span class="checkmark"></span>
                        odengi
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="bakai" name="withdrawal-bakai" id="withdrawal-bakai" checked>
                        <span class="checkmark"></span>
                        bakai
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="balance" name="withdrawal-balance" id="withdrawal-balance" checked>
                        <span class="checkmark"></span>
                        balance
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="megapay" name="withdrawal-megapay" id="withdrawal-megapay" checked>
                        <span class="checkmark"></span>
                        megapay
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" data-bank="mbank" name="withdrawal-mbank" id="withdrawal-mbank" checked>
                        <span class="checkmark"></span>
                        mbank
                    </label>
                </div>
            </div>
        </div>

        <!-- –ö–æ—à–µ–ª—å–∫–∏/—Ä–µ–∫–≤–∏–∑–∏—Ç—ã -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üëõ</div>
                <div>
                    <div class="card-title">–ö–æ—à–µ–ª—å–∫–∏/—Ä–µ–∫–≤–∏–∑–∏—Ç—ã</div>
                    <div class="card-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</div>
                </div>
            </div>
            <div class="card-body" id="wallets-section">
                <div class="setting-item" style="margin-bottom: 12px;">
                    <div class="setting-info">
                        <span class="setting-label">–¢–µ–∫—É—â–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ—à–µ–ª–µ–∫</span>
                    </div>
                    <div>
                        <span id="current-main-wallet" style="color:#fff">‚Äî</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="wallet-select">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫</label>
                    <select id="wallet-select" name="wallet-select" class="form-input" style="appearance: none;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç‚Ä¶</option>
                    </select>
                    <div id="wallets-count" style="margin-top:6px;color:#888;font-size:12px;">‚Äî</div>
                </div>

                <div style="display:flex; gap:8px;">
                    <button class="save-btn" style="width:auto" onclick="setMainWalletSelected()">–°–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º</button>
                </div>

                <div class="form-group" style="margin-top: 14px;">
                    <small style="color:#888">–ê–∫—Ç–∏–≤–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–æ—Ç–æ–º –ø—Ä–∏ –≤—ã–¥–∞—á–µ QR/—Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤.</small>
                </div>
            </div>
        </div>

        <!-- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üì¢</div>
                <div>
                    <div class="card-title">–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</div>
                    <div class="card-subtitle"></div>
                </div>
            </div>
            <div class="card-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-label">–í–∫–ª—é—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="channel-subscription">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="channel-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</label>
                    <input type="text" id="channel-name" name="channel-name" class="form-input" placeholder="@bingokg_news" value="@bingokg_news">
                </div>
                <div class="form-group">
                    <label class="form-label" for="channel-id">ID –∫–∞–Ω–∞–ª–∞ (chat_id)</label>
                    <input type="text" id="channel-id" name="channel-id" class="form-input" placeholder="-1001234567890" value="">
                    <small style="color:#888">–ü—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø–æ @handle, –Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–¥—ë–∂–Ω–µ–µ chat_id –≤–∏–¥–∞ -100‚Ä¶</small>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
        <button class="save-btn" onclick="saveSettings()">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </div>

<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ, –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–ª–∞–≥–∏
let __saveTimer = null;
let __loadingSettings = false;
let __saving = false;
async function autoSave(evt) {
    if (__loadingSettings) return; // –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ UI
    const target = evt && evt.target ? evt.target : null;
    const prevState = target ? {
        type: target.type,
        checked: target.type === 'checkbox' ? (target.dataset.prevChecked === '1') : undefined,
        value: target.type === 'text' ? (target.dataset.prevValue || target.value) : undefined,
    } : null;

    // debounce 600ms
    if (__saveTimer) clearTimeout(__saveTimer);
    __saveTimer = setTimeout(async () => {
        const settings = collectSettings();
        const ok = await saveToDatabase(settings);
        if (!ok && target) {
            try {
                if (target.type === 'checkbox' && typeof prevState.checked !== 'undefined') {
                    target.checked = !!prevState.checked;
                } else if (target.type === 'text' && typeof prevState.value !== 'undefined') {
                    target.value = prevState.value;
                } else if (ok) {
            try { await loadSettings(); } catch (e) {}
        }
            } catch (e) { console.warn('revert failed', e); }
        }
        // cleanup stored prev
        if (target) { delete target.dataset.prevChecked; delete target.dataset.prevValue; }
    }, 300);
}

// –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: –±–µ–∑ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    // –¢–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadSettings();
    loadMainWallet();
    loadWallets();
});

function collectSettings() {
    return {
        pause: document.getElementById('pause-bot').checked,
        sites: getSelectedSites(),
        deposits: {
            enabled: document.getElementById('deposits-enabled').checked,
            banks: getSelectedBanks('deposit')
        },
        withdrawals: {
            enabled: document.getElementById('withdrawals-enabled').checked,
            banks: getSelectedBanks('withdrawal')
        },
        channel: {
            enabled: document.getElementById('channel-subscription').checked,
            name: document.getElementById('channel-name').value,
            id: document.getElementById('channel-id').value
        }
    };
}

function getSelectedSites() {
    const sites = [];
    document.querySelectorAll('#sites-grid .checkbox-item input:checked').forEach(checkbox => {
        const key = checkbox.dataset.site || checkbox.parentElement.textContent.trim();
        sites.push(key);
    });
    return sites;
}

function getSelectedBanks(type) {
    const banks = [];
    const selector = type === 'deposit' ? '.deposit-grid' : '.withdrawal-grid';
    document.querySelectorAll(`${selector} .checkbox-item input:checked`).forEach(checkbox => {
        banks.push(checkbox.getAttribute('data-bank'));
    });
    return banks;
}

function setSaveBanner(text, ok=true) {
    const el = document.getElementById('save-status');
    if (!el) return;
    el.textContent = text;
    el.style.background = ok ? '#204f2a' : '#5a2020';
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, ok ? 1200 : 2000);
}

function setSaveButtonBusy(busy) {
    const btn = document.querySelector('button.save-btn');
    if (!btn) return;
    if (busy) {
        btn.dataset.prevText = btn.textContent;
        btn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';
        btn.disabled = true;
    } else {
        btn.textContent = btn.dataset.prevText || 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
        btn.disabled = false;
    }
}

function applySettingsFromPayload(payload) {
    try {
        if (!payload) return;
        // pause
        if (payload.pause !== undefined) {
            document.getElementById('pause-bot').checked = !!payload.pause;
        }
        // sites
        if (payload.sites) {
            const enabledSites = new Set((payload.sites || []).map(s => String(s).toLowerCase()));
            document.querySelectorAll('#sites-grid input[type="checkbox"]').forEach(cb => {
                const key = (cb.dataset.site || '').toLowerCase();
                cb.checked = enabledSites.has(key);
            });
        }
        // deposits
        if (payload.deposits) {
            document.getElementById('deposits-enabled').checked = !!payload.deposits.enabled;
            document.querySelectorAll('.deposit-grid [data-bank]').forEach(cb => cb.checked = false);
            (payload.deposits.banks || []).forEach(b => {
                const k = String(b).toLowerCase();
                const el = document.querySelector(`.deposit-grid [data-bank="${k}"]`);
                if (el) el.checked = true;
            });
        }
        // withdrawals
        if (payload.withdrawals) {
            document.getElementById('withdrawals-enabled').checked = !!payload.withdrawals.enabled;
            document.querySelectorAll('.withdrawal-grid [data-bank]').forEach(cb => cb.checked = false);
            (payload.withdrawals.banks || []).forEach(b => {
                const k = String(b).toLowerCase();
                const el = document.querySelector(`.withdrawal-grid [data-bank="${k}"]`);
                if (el) el.checked = true;
            });
        }
        // channel
        if (payload.channel) {
            document.getElementById('channel-subscription').checked = !!payload.channel.enabled;
            document.getElementById('channel-name').value = payload.channel.name || '';
            document.getElementById('channel-id').value = payload.channel.id || '';
        }
    } catch (e) { console.warn('applySettingsFromPayload failed', e); }
}

async function saveToDatabase(settings) {
    try {
        __saving = true;
        setSaveButtonBusy(true);
        const response = await fetch('{% url "bot_control:api_save_bot_settings" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(settings)
        });

        if (response.ok) {
            let data = null;
            try { data = await response.json(); } catch (e) {}
            if (data && data.settings) {
                applySettingsFromPayload(data.settings);
            }
            setSaveBanner('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', true);
            return true;
        } else {
            const msg = await response.text().catch(() => '');
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', msg);
            setSaveBanner('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', false);
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        setSaveBanner('‚ùå –°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', false);
        return false;
    } finally { __saving = false; setSaveButtonBusy(false); }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
async function loadSettings() {
    try {
        __loadingSettings = true;
        const response = await fetch('{% url "bot_control:api_get_bot_settings" %}');
        const settings = await response.json();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        if (settings.pause !== undefined) {
            document.getElementById('pause-bot').checked = settings.pause;
        }
        // –°–∞–π—Ç—ã: —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ, –∑–∞—Ç–µ–º –æ—Ç–º–µ—Ç–∏—Ç—å –∏–∑ settings.sites
        try {
            const enabledSites = new Set((settings.sites || []).map(s => String(s).toLowerCase()));
            document.querySelectorAll('#sites-grid input[type="checkbox"]').forEach(cb => {
                const key = (cb.dataset.site || '').toLowerCase();
                cb.checked = enabledSites.size ? enabledSites.has(key) : cb.checked;
            });
        } catch (e) { console.warn('Sites apply failed', e); }
        
        if (settings.deposits) {
            document.getElementById('deposits-enabled').checked = settings.deposits.enabled;
            // –°–±—Ä–æ—Å–∏–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –∏ –ø—Ä–æ—Å—Ç–∞–≤–∏–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.querySelectorAll('.deposit-grid [data-bank]').forEach(cb => cb.checked = false);
            (settings.deposits.banks || []).forEach(bank => {
                const key = String(bank).toLowerCase();
                const checkbox = document.querySelector(`[data-bank="${key}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        if (settings.withdrawals) {
            document.getElementById('withdrawals-enabled').checked = settings.withdrawals.enabled;
            // –°–±—Ä–æ—Å–∏–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –∏ –ø—Ä–æ—Å—Ç–∞–≤–∏–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.querySelectorAll('.withdrawal-grid [data-bank]').forEach(cb => cb.checked = false);
            (settings.withdrawals.banks || []).forEach(bank => {
                const key = String(bank).toLowerCase();
                const checkbox = document.querySelector(`[data-bank="${key}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        if (settings.channel) {
            document.getElementById('channel-subscription').checked = settings.channel.enabled;
            document.getElementById('channel-name').value = settings.channel.name || '@bingokg_news';
            document.getElementById('channel-id').value = settings.channel.id || '';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
    } finally { __loadingSettings = false; }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞/—Ä–µ–∫–≤–∏–∑–∏—Ç–∞ –∏–∑ QRHash –∏ BankWallets
async function loadMainWallet() {
    try {
        const [qrResp, bwResp] = await Promise.all([
            fetch('{% url "bot_control:api_list_qr_hashes" %}'),
            fetch('{% url "dashboard:api_bank_wallets" %}')
        ]);
        let qr = { wallets: [] }, bw = { items: [] };
        try { qr = await qrResp.json(); } catch(e) {}
        try { bw = await bwResp.json(); } catch(e) {}
        const qrMain = (qr.wallets || []).find(w => w.is_main);
        const bwMain = (bw.items || []).find(w => w.is_main);
        const label = qrMain
            ? (qrMain.account_name || '(Demirbank)')
            : (bwMain ? `${(bwMain.bank_code || '').toUpperCase()} ‚Ä¢ ${bwMain.account_name || 'Wallet'}` : '‚Äî');
        document.getElementById('current-main-wallet').textContent = label || '‚Äî';
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞:', e);
        document.getElementById('current-main-wallet').textContent = '‚Äî';
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å QRHash (Demirbank) –∏ BankWallets, —Å–æ–±—Ä–∞—Ç—å –µ–¥–∏–Ω—ã–π —Å–µ–ª–µ–∫—Ç
async function loadWallets() {
    try {
        const [qrResp, bwResp] = await Promise.all([
            fetch('{% url "bot_control:api_list_qr_hashes" %}'),
            fetch('{% url "dashboard:api_bank_wallets" %}')
        ]);
        const select = document.getElementById('wallet-select');
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç‚Ä¶</option>';

        const makeOpt = (val, text) => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = text;
            return opt;
        };

        // –ì—Ä—É–ø–ø–∞ Demirbank (QR)
        let qrCount = 0;
        try {
            const qr = await qrResp.json();
            const qrItems = Array.isArray(qr.wallets) ? qr.wallets : [];
            console.log('QR items:', qrItems.length);
            if (qrItems.length) {
                const grp = document.createElement('optgroup');
                grp.label = 'Demirbank (QR)';
                qrItems.forEach(q => {
                    const opt = makeOpt(`qr:${q.id}`, `${q.account_name || ('QR '+q.id)}`.trim());
                    if (q.is_main) opt.selected = true;
                    grp.appendChild(opt);
                });
                select.appendChild(grp);
                qrCount = qrItems.length;
            }
        } catch(e) { console.warn('QR list parse failed', e); }

        // –ì—Ä—É–ø–ø–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–æ—à–µ–ª—å–∫–æ–≤
        let bwCount = 0;
        try {
            const bw = await bwResp.json();
            const items = Array.isArray(bw.items) ? bw.items : [];
            console.log('BankWallet items:', items.length);
            if (items.length) {
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ bank_code, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏
                items.sort((a,b)=>String(a.bank_code).localeCompare(String(b.bank_code)) || String(a.account_name).localeCompare(String(b.account_name)));
                const grp = document.createElement('optgroup');
                grp.label = '–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–æ—à–µ–ª—å–∫–∏';
                items.forEach(w => {
                    const label = `${(w.bank_code || '').toUpperCase()} ‚Ä¢ ${w.account_name}`.trim();
                    const opt = makeOpt(`bw:${w.id}`, label);
                    if (w.is_main) opt.selected = true;
                    grp.appendChild(opt);
                });
                select.appendChild(grp);
                bwCount = items.length;
            }
        } catch(e) { console.warn('BW list parse failed', e); }

        const info = document.getElementById('wallets-count');
        if (info) info.textContent = `–ù–∞–π–¥–µ–Ω–æ: QR ${qrCount}, –∫–æ—à–µ–ª—å–∫–æ–≤ ${bwCount}`;

    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤:', e);
    }
}

// –°–¥–µ–ª–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω—ã–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º
async function setMainWalletSelected() {
    const select = document.getElementById('wallet-select');
    const raw = (select.value || '').trim();
    if (!raw) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç'); return; }
    const [type, idStr] = raw.split(':');
    const id = parseInt(idStr || '0', 10);
    if (!id || (type !== 'qr' && type !== 'bw')) { alert('–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä'); return; }
    try {
        if (type === 'qr') {
            // 1) –°–¥–µ–ª–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π QR –æ—Å–Ω–æ–≤–Ω—ã–º
            const setMainUrl = '{% url "bot_control:api_set_main_qr_hash" 0 %}'.replace('/0/', `/${id}/`);
            await fetch(setMainUrl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
            // 2) –í—ã–∫–ª—é—á–∏—Ç—å –≤—Å–µ –ø—Ä–æ—á–∏–µ QR –∏ –≤–∫–ª—é—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π
            const qrListResp = await fetch('{% url "bot_control:api_list_qr_hashes" %}');
            const qrList = await qrListResp.json();
            for (const q of (qrList.wallets || [])) {
                if (q.id === id) {
                    if (!q.is_active) {
                        const tgl = '{% url "bot_control:api_toggle_qr_hash" 0 %}'.replace('/0/', `/${q.id}/`);
                        await fetch(tgl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                    }
                } else if (q.is_active) {
                    const tgl = '{% url "bot_control:api_toggle_qr_hash" 0 %}'.replace('/0/', `/${q.id}/`);
                    await fetch(tgl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                }
            }
            // 3) –û—Ç–∫–ª—é—á–∏—Ç—å –í–°–ï –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–æ—à–µ–ª—å–∫–∏ (—ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ—Å—Ç—å –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏)
            try {
                const bwResp = await fetch('{% url "dashboard:api_bank_wallets" %}');
                const bw = await bwResp.json();
                for (const w of (bw.items || [])) {
                    if (w.is_active) {
                        const tgl = '{% url "dashboard:api_bank_wallets_toggle" 0 %}'.replace('/0/', `/${w.id}/`);
                        await fetch(tgl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                    }
                }
            } catch(e) { console.warn('BW deactivate on QR select failed', e); }
        } else if (type === 'bw') {
            // 1) –°–¥–µ–ª–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –∫–æ—à–µ–ª—ë–∫ –æ—Å–Ω–æ–≤–Ω—ã–º
            const setMainUrl = '{% url "dashboard:api_bank_wallets_set_main" 0 %}'.replace('/0/', `/${id}/`);
            await fetch(setMainUrl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
            // 2) –ü—Ä–æ–π—Ç–∏—Å—å –ø–æ –≤—Å–µ–º –±–∞–Ω–∫–æ–≤—Å–∫–∏–º –∫–æ—à–µ–ª—å–∫–∞–º: –∞–∫—Ç–∏–≤–µ–Ω —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π
            try {
                const bwResp = await fetch('{% url "dashboard:api_bank_wallets" %}');
                const bw = await bwResp.json();
                for (const w of (bw.items || [])) {
                    if (w.id === id) {
                        if (!w.is_active) {
                            const tgl = '{% url "dashboard:api_bank_wallets_toggle" 0 %}'.replace('/0/', `/${w.id}/`);
                            await fetch(tgl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                        }
                    } else if (w.is_active) {
                        const tgl = '{% url "dashboard:api_bank_wallets_toggle" 0 %}'.replace('/0/', `/${w.id}/`);
                        await fetch(tgl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                    }
                }
            } catch(e) { console.warn('BW toggle normalize failed', e); }
            // 3) –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ QR hash (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø —Ä–µ–∫–≤–∏–∑–∏—Ç–∞)
            const qrListResp = await fetch('{% url "bot_control:api_list_qr_hashes" %}');
            const qrList = await qrListResp.json();
            for (const q of (qrList.wallets || [])) {
                if (q.is_active) {
                    const tgl = '{% url "bot_control:api_toggle_qr_hash" 0 %}'.replace('/0/', `/${q.id}/`);
                    await fetch(tgl, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                }
            }
        }
        await loadMainWallet();
        await loadWallets();
    } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
    }
}

// –†—É—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
async function saveSettings() {
    const ok = await saveToDatabase(collectSettings());
    if (ok) {
        // –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è: –ø–æ–¥—Ç—è–Ω–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        try { await loadSettings(); } catch (e) {}
    }
}

// (–¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –≤–µ—Ä—Å–∏—è saveSettings —É–¥–∞–ª–µ–Ω–∞)
</script>

<style>
/* –î–æ–ø. —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ */

.setting-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.setting-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.setting-label {
    color: #ffffff;
    font-size: 14px;
    font-weight: 500;
}

/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #555555;
    transition: .4s;
    border-radius: 28px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #2196f3;
}

input:checked + .slider:before {
    transform: translateX(22px);
}

/* Checkbox Grid */
.checkbox-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.deposit-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 16px;
}

.withdrawal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 16px;
}

/* Form Elements */
.form-group {
    margin-top: 16px;
}

.form-label {
    display: block;
    color: #ffffff;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
}

.form-input {
    width: 100%;
    padding: 12px;
    background: #3a3a3a;
    border: 1px solid #555555;
    border-radius: 8px;
    color: #ffffff;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.form-input:focus {
    outline: none;
    border-color: #2196f3;
}

.form-input::placeholder {
    color: #888888;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: background-color 0.2s ease;
}

.checkbox-item:hover {
    background: #3a3a3a;
}

.checkbox-item input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 18px;
    height: 18px;
    border: 2px solid #555555;
    border-radius: 4px;
    position: relative;
    transition: all 0.2s ease;
}

.checkbox-item input[type="checkbox"]:checked + .checkmark {
    background: #2196f3;
    border-color: #2196f3;
}

.checkbox-item input[type="checkbox"]:checked + .checkmark:after {
    content: "‚úì";
    position: absolute;
    top: -2px;
    left: 2px;
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.checkbox-item span:not(.checkmark) {
    color: #ffffff;
    font-size: 13px;
    font-weight: 500;
}

/* Save Button */
.save-btn {
    width: 100%;
    background: #2196f3;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease;
    margin-top: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.save-btn:hover {
    background: #1976d2;
}

.save-btn:active {
    transform: scale(0.98);
}


/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .checkbox-grid,
    .withdrawal-grid {
        grid-template-columns: 1fr;
    }
    
    .card-body {
        padding: 16px;
    }
}
</style>
{% endblock %}
