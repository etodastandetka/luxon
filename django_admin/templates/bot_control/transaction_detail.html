{% extends 'base.html' %}
{% load static %}

{% block title %}Заявка #{{ transaction.id }}{% endblock %}
{% block header_icon %}{% endblock %}
{% block header_title %}{% endblock %}

{% block content %}
<style>
  /* Красивые универсальные кнопки под тёмную тему */
  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #2a2a2a;
    background: linear-gradient(180deg, #1b1b1b 0%, #141414 100%);
    color: #eaeaea;
    text-decoration: none;
    cursor: pointer;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    box-shadow: 0 6px 16px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    user-select: none;
  }
  .action-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05); }
  .action-btn:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(0,0,0,.35) inset; }

  .action-btn--approve {
    border-color: rgba(16,185,129,.35);
    background: linear-gradient(180deg, rgba(16,185,129,.25) 0%, rgba(6,95,70,.2) 100%);
    color: #a7ffdf;
  }
  .action-btn--approve:hover { border-color: rgba(16,185,129,.55); }

  .action-btn--reject {
    border-color: rgba(239,68,68,.35);
    background: linear-gradient(180deg, rgba(239,68,68,.22) 0%, rgba(127,29,29,.2) 100%);
    color: #ffc9c9;
  }
  .action-btn--reject:hover { border-color: rgba(239,68,68,.55); }

  .action-btn--neutral {
    border-color: rgba(107,114,128,.35);
    background: linear-gradient(180deg, rgba(75,85,99,.25) 0%, rgba(31,41,55,.25) 100%);
    color: #e5e7eb;
  }
  .action-btn--neutral:hover { border-color: rgba(107,114,128,.55); }

  /* Кнопка под фото */
  .photo-link-btn {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid rgba(99,102,241,.35);
    background: linear-gradient(180deg, rgba(79,70,229,.22) 0%, rgba(30,27,75,.25) 100%);
    color: #c7d2fe;
    text-decoration: none;
    font-weight: 600;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    box-shadow: 0 6px 16px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .photo-link-btn:hover { transform: translateY(-1px); border-color: rgba(99,102,241,.6); }
  .photo-link-btn:active { transform: translateY(0); }

  /* Блоки карточек и отступы */
  .card { border-radius: 14px !important; border: 1px solid #242424 !important; background: #111 !important; }
  .btns-row { margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; }
  .muted-note { color:#8b8b8b; font-size:12px; text-align:center; margin-top:8px; }
</style>
<div class="page-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div class="header-content">
        <h1 style="margin:0; line-height:1.1; font-size:18px; font-weight:800;">Заявка #{{ transaction.id }}</h1>
        <div style="margin-top:6px; color:#9aa7bd; font-size:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
            {# Убрали маленькую иконку под заголовком #}
        </div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div style="margin-right:8px; text-align:right;">
        {% if transaction.first_name or transaction.last_name %}
          <div style="color:#e5e7eb; font-size:14px; font-weight:600;">
            {% if transaction.first_name and transaction.last_name %}
              {{ transaction.first_name }} {{ transaction.last_name }}
            {% elif transaction.first_name %}
              {{ transaction.first_name }}
            {% elif transaction.last_name %}
              {{ transaction.last_name }}
            {% endif %}
          </div>
        {% elif transaction.username %}
          <div style="color:#e5e7eb; font-size:14px; font-weight:600;">@{{ transaction.username }}</div>
        {% endif %}
        <div style="color:#9aa4b2; font-size:12px;">ID: {{ transaction.user_id }}</div>
      </div>
      <a class="action-btn action-btn--neutral" href="{% url 'bot_control:user_profile' transaction.user_id %}">
        <i class="fas fa-user"></i>
        <span>Профиль</span>
      </a>
      <a class="action-btn action-btn--approve" href="{% url 'bot_control:user_chat' transaction.user_id %}">
        <i class="fas fa-comments"></i>
        <span>Чат</span>
      </a>
    </div>
</div>

{% with rt=transaction.request_type|default:'deposit' %}
<!-- Верхний блок: краткая сводка заявки (без фото) -->
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:14px; margin-top:14px; box-shadow:0 6px 16px rgba(0,0,0,.35);">
  <!-- Шапка карточки (иконка банка/ELQR, ID, дата; справа статус и сумма) -->
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
    <div style="display:flex; align-items:center; gap:10px;">
      {% if rt == 'deposit' %}
        <img src="{% static 'images/elqr.svg' %}?v=20251002" alt="ELQR" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;background:#0f0f0f;object-fit:contain;">
      {% else %}
        {% with b=transaction.bank|default:'' %}
          {% if b|lower == 'mbank' %}
            <img src="{% static 'images/mbank.png' %}" alt="mbank" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% elif b|lower == 'optima' %}
            <img src="{% static 'images/optima.jpg' %}" alt="optima" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% elif b|lower == 'omoney' %}
            <img src="{% static 'images/omoney.jpg' %}" alt="omoney" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% elif b|lower == 'demirbank' or b|lower == 'demir' %}
            <img src="{% static 'images/demirbank.jpg' %}" alt="demirbank" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% elif b|lower == 'megapay' %}
            <img src="{% static 'images/megapay.jpg' %}" alt="megapay" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% endif %}
        {% endwith %}
      {% endif %}
      <div>
        {% comment %} Показываем имя пользователя вместо ID {% endcomment %}
        {% if transaction.first_name or transaction.last_name %}
          <div style="font-weight:700; color:#e5e7eb; padding:4px 8px; border-radius:8px; border:1px solid #2a2a2a; background:#151515;">
            {% if transaction.first_name and transaction.last_name %}
              {{ transaction.first_name }} {{ transaction.last_name }}
            {% elif transaction.first_name %}
              {{ transaction.first_name }}
            {% elif transaction.last_name %}
              {{ transaction.last_name }}
            {% endif %}
          </div>
        {% elif transaction.username %}
          <div style="font-weight:700; color:#e5e7eb; padding:4px 8px; border-radius:8px; border:1px solid #2a2a2a; background:#151515;">
            @{{ transaction.username }}
          </div>
        {% else %}
          <div style="font-weight:700; color:#e5e7eb; padding:4px 8px; border-radius:8px; border:1px solid #2a2a2a; background:#151515;">
            Пользователь #{{ transaction.user_id }}
          </div>
        {% endif %}
        <div style="color:#9aa4b2; font-size:12px; margin-top:4px;">{{ transaction.created_at|date:'d.m.Y • H:i' }}</div>
      </div>
    </div>
    <div style="display:flex; align-items:flex-end; gap:10px; flex-direction:column;">
      {% if transaction.status != 'awaiting_manual' %}
        <div style="display:flex; align-items:center; gap:6px;">
          <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:{% if transaction.status == 'completed' or transaction.status == 'auto_completed' %}#22c55e{% elif transaction.status == 'pending' or transaction.status == 'processing' %}#f59e0b{% else %}#6b7280{% endif %};"></span>
          <span style="font-size:12px; color:#aab1c2;">{% if transaction.status == 'completed' %}Успешно{% elif transaction.status == 'auto_completed' %}Автопополнена{% elif transaction.status == 'pending' %}Ожидает{% elif transaction.status == 'processing' %}В обработке{% elif transaction.status == 'rejected' %}Отклонена{% else %}{{ transaction.status }}{% endif %}</span>
        </div>
      {% endif %}
      <div style="font-weight:800; font-size:18px; {% if rt == 'deposit' %}color:#21f39c;{% else %}color:#ff6b6b;{% endif %}">{% if rt == 'deposit' %}+{% else %}-{% endif %}{{ transaction.amount|floatformat:2 }} сом</div>
    </div>
  </div>

</div>

{% endwith %}

<!-- QR / Фото чека: отдельная карточка (ниже сводки) -->
{% if photo_url %}
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:14px; margin-top:12px; box-shadow:0 6px 16px rgba(0,0,0,.35);">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
    <div style="font-weight:700; color:#e5e7eb;">QR / Чек</div>
    <div style="color:#9aa4b2; font-size:12px;">Источник: Telegram</div>
  </div>
  <div style="text-align:center;">
    <img src="{{ photo_url }}" alt="Чек" style="max-width:100%; height:auto; border-radius:10px; border:1px solid #2d2d2d;" />
  </div>
</div>
{% endif %}

{# Карточка кода активации (для выводов только при наличии кода) #}
{% firstof transaction.withdraw_code transaction.code '' as vcode %}
{% if transaction.request_type == 'withdraw' and vcode %}
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:16px; margin-top:12px; box-shadow:0 6px 16px rgba(0,0,0,.35);">
  <div style="color:#9aa4b2; font-size:12px;">Код активации</div>
  <div style="margin-top:6px; font-weight:800; font-size:18px; letter-spacing:1px;">{{ vcode }}</div>
</div>
{% endif %}

<!-- Детали -->
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:18px; margin-top:12px;">
  <div style="display:grid; grid-template-columns: 1fr; gap:16px;">
    <div>
      <div style="color:#9aa4b2; font-size:12px;">Сайт</div>
      <div style="color:#e5e7eb; font-size:14px; font-weight:700;">{{ transaction.bookmaker|upper }}</div>
    </div>
    <div>
      <div style="color:#9aa4b2; font-size:12px; margin-bottom:6px;">ID Telegram</div>
      <button type="button" onclick="copyText('{{ transaction.user_id }}')" title="Скопировать Telegram ID" style="padding:6px 10px; border-radius:8px; border:1px solid #2a2a2a; background:#151515; color:#e5e7eb; cursor:pointer; font-size:14px; font-weight:700; transition:all .2s;">
        {{ transaction.user_id }}
      </button>
    </div>
    {% if transaction.account_id %}
    <div>
      <div style="color:#9aa4b2; font-size:12px; margin-bottom:6px;">ID Casino</div>
      <button type="button" onclick="copyText('{{ transaction.account_id }}')" title="Скопировать Casino ID" style="padding:6px 10px; border-radius:8px; border:1px solid #2a2a2a; background:#151515; color:#e5e7eb; cursor:pointer; font-size:14px; font-weight:700; transition:all .2s;">
        {{ transaction.account_id }}
      </button>
    </div>
    {% endif %}
    {% firstof transaction.withdraw_code transaction.code '' as vcode %}
    {% if transaction.request_type == 'withdraw' and vcode %}
      <div>
        <div style="color:#9aa4b2; font-size:12px;">Код</div>
        <div style="color:#e5e7eb; font-size:14px; font-weight:700;">{{ vcode }}</div>
      </div>
    {% endif %}
    <div>
      <div style="color:#9aa4b2; font-size:12px;">Дата создания заявки</div>
      <div style="color:#e5e7eb; font-size:14px; font-weight:700;">{% if transaction.created_at %}{{ transaction.created_at|date:'d.m.Y • H:i' }}{% else %}—{% endif %}</div>
    </div>
    <div>
      <div style="color:#9aa4b2; font-size:12px;">Дата закрытия заявки</div>
      <div style="color:#e5e7eb; font-size:14px; font-weight:700;">{% if transaction.processed_at %}{{ transaction.processed_at|date:'d.m.Y • H:i' }}{% else %}—{% endif %}</div>
    </div>
  </div>
  
</div>

<!-- Все заявки пользователя (последние 100) -->
{% if user_requests %}
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:14px; margin-top:12px;">
  <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
      <div style="font-weight:600;">Все заявки пользователя</div>
  </div>
  <div style="margin-top:8px;">
    <div style="border-top:1px solid #222"></div>
    {% for r in user_requests %}
      <a href="/bot/transactions/{{ r.id }}/" style="display:flex; align-items:center; gap:16px; justify-content:space-between; padding:16px 14px; color:#cdd6f4; text-decoration:none; background:#141414; border:1px solid #222; border-radius:12px; margin:12px 0;">
        <div style="display:flex; align-items:center; gap:14px; min-width:0;">
          {# Иконка для каждой заявки в списке #}
          {% if r.type == 'deposit' %}
            <img src="{% static 'images/elqr.svg' %}?v=20251002" alt="ELQR" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;object-fit:contain;background:#0f0f0f;">
          {% else %}
            {% with wd=r.wallet_details|default:''|lower %}
              {% if 'mbank' in wd %}
                <img src="{% static 'images/mbank.png' %}" alt="mbank" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% elif 'optima' in wd %}
                <img src="{% static 'images/optima.jpg' %}" alt="optima" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% elif 'omoney' in wd %}
                <img src="{% static 'images/omoney.jpg' %}" alt="omoney" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% elif 'demir' in wd %}
                <img src="{% static 'images/demirbank.jpg' %}" alt="demirbank" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% elif 'megapay' in wd %}
                <img src="{% static 'images/megapay.jpg' %}" alt="megapay" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% endif %}
            {% endwith %}
          {% endif %}
          <div style="display:flex; flex-direction:column; gap:8px; min-width:0;">
            <div style="display:flex; align-items:center; gap:10px; min-width:0;">
              {% firstof r.full_name r.name r.username transaction.username 'N B' as rname %}
              <div style="font-weight:700; color:#e5e7eb; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px;">{{ rname }}</div>
              <div style="color:#8b8b8b; font-size:12px;">#{{ r.id }}</div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
              {% firstof r.account_id r.user_id r.telegram_id transaction.user_id '-' as rid %}
              <div style="color:#9aa4b2; font-size:12px;">ID: {{ rid }}</div>
              <div style="font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2a2a2a; color:#9ec5fe; background:#0f172a;">{% if r.type == 'deposit' %}{% if r.status == 'auto_completed' %}Авто пополнение{% else %}Пополнение{% endif %}{% else %}Вывод{% endif %}</div>
            </div>
          </div>
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px; flex-direction:column; min-width:140px;">
          <div style="color:#9aa4b2; font-size:12px; white-space:nowrap;">{{ r.created_at|date:'d.m.Y • H:i' }}</div>
          <div style="font-weight:800; font-size:16px; {% if r.type == 'deposit' %}color:#21f39c;{% else %}color:#ff6b6b;{% endif %}">{% if r.type == 'deposit' %}+{% else %}-{% endif %}{{ r.amount|floatformat:2 }} сом</div>
          {% if r.status != 'awaiting_manual' %}
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:{% if r.status == 'completed' or r.status == 'auto_completed' %}#22c55e{% elif r.status == 'pending' or r.status == 'processing' %}#f59e0b{% else %}#6b7280{% endif %};"></span>
              <span style="font-size:12px; color:#aab1c2;">{% if r.status == 'auto_completed' %}Авто пополнение{% elif r.status == 'completed' %}Успешно{% elif r.status == 'pending' %}Ожидает{% elif r.status == 'processing' %}В работе{% elif r.status == 'rejected' %}Отклонена{% else %}{{ r.status }}{% endif %}</span>
            </div>
          {% endif %}
        </div>
      </a>
    {% endfor %}
  </div>
</div>
{% endif %}


{% endblock %}

{% block extra_js %}
<script>
let currentStatus = '{{ transaction.status }}';
function ruStatus(code) {
  switch (code) {
    case 'pending': return 'Ожидает';
    case 'processing': return 'В обработке';
    case 'completed': return 'Завершена';
    case 'auto_completed': return 'Автопополнена';
    case 'rejected': return 'Отклонена';
    default: return code || '';
  }
}
async function handleAction(action) {
  try {
    // Готовим корректный payload под API: /bot/api/requests/{id}/status/
    const status = action === 'approve' ? 'completed' : 'rejected';
    const payload = { 
      status: status
    };

    console.log('🔄 Отправляем запрос на обновление статуса:', payload);

    const res = await fetch('/bot/api/requests/{{ transaction.id }}/status/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    console.log('📥 Ответ от сервера:', { status: res.status, data });
    
    if (res.ok && data.success) {
      const el = document.getElementById('status-text');
      if (el) el.textContent = ruStatus(status);
      const chip = document.getElementById('status-chip');
      if (chip) chip.textContent = ruStatus(status);
      // Блокируем/скрываем кнопки действий после финального статуса
      try {
        const bar = document.getElementById('sticky-actions');
        if (bar) bar.style.display = 'none';
      } catch (e) { /* no-op */ }
      alert(data.message || 'Готово');
    } else {
      console.error('❌ Ошибка обновления статуса:', data);
      alert((data && data.error) || 'Ошибка обновления статуса');
    }
  } catch (e) {
    console.error(e);
    alert('Ошибка запроса');
  }
}


document.addEventListener('DOMContentLoaded', function() {
  try { startStatusPolling(); } catch(e) {}
});

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

function disableActionsUI() {
  try {
    const row = document.getElementById('actions-row');
    if (row) {
      const btns = row.querySelectorAll('button');
      btns.forEach(b => { if (b){ b.disabled = true; b.style.opacity = .5; b.style.pointerEvents = 'none'; }});
    }
  } catch (e) {}
}

function startStatusPolling(){
  const id = Number('{{ transaction.id }}');
  const url = '/bot/api/requests/' + id + '/status/';
  setInterval(async ()=>{
    try{
      const res = await fetch(url, {credentials:'same-origin'});
      if(!res.ok) return;
      const data = await res.json();
      if(!data || !data.success) return;
      const st = data.status || '';
      if (st && st !== currentStatus){
        currentStatus = st;
        const el = document.getElementById('status-text');
        if (el) el.textContent = ruStatus(st);
        const chip = document.getElementById('status-chip');
        if (chip) chip.textContent = ruStatus(st);
        if (st === 'completed' || st === 'rejected' || st === 'auto_completed') {
          const bar = document.getElementById('sticky-actions');
          if (bar) bar.style.display = 'none';
        }
      }
    }catch(e){ /* silent */ }
  }, 7000);
}

// Копирование текста в буфер обмена (для ID)
function copyText(t) {
  try {
    const s = String(t || '').trim();
    if (!s) return;
    navigator.clipboard.writeText(s).then(() => {
      alert('Скопировано: ' + s);
    }).catch(() => {
      // Фолбэк через скрытый input
      const i = document.createElement('input');
      i.value = s;
      document.body.appendChild(i);
      i.select();
      document.execCommand('copy');
      document.body.removeChild(i);
      alert('Скопировано: ' + s);
    });
  } catch (e) { alert('Ошибка копирования'); }
}
</script>
{% endblock %}

{% block extra_body %}
<!-- Отладка: статус заявки = {{ transaction.status }} -->
{% if transaction.status == 'pending' or transaction.status == 'processing' or transaction.status == 'awaiting_manual' %}
<div id="sticky-actions" style="position:fixed; bottom:80px; left:10px; right:10px; background:rgba(10,10,10,.96); border:1px solid #333; border-radius:12px; padding:12px; display:flex; gap:8px; z-index:20; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
  <button class="action-btn action-btn--approve" style="flex:1; padding:8px 12px; font-size:14px; border-radius:8px;" onclick="handleAction('approve')">Принять</button>
  <button class="action-btn action-btn--reject" style="flex:1; padding:8px 12px; font-size:14px; border-radius:8px;" onclick="handleAction('reject')">Отказать</button>
  <a class="action-btn action-btn--neutral" style="flex:0 0 auto; padding:8px 12px; font-size:14px; border-radius:8px;" href="{% url 'dashboard:deposits_list' %}">Назад</a>
</div>
{% else %}
<!-- Кнопки не показываются, статус: {{ transaction.status }} -->
<div style="position:fixed; bottom:80px; left:10px; right:10px; background:rgba(255,0,0,.1); border:1px solid #ff0000; border-radius:8px; padding:8px; color:#ff0000; text-align:center; font-size:12px;">
  ОТЛАДКА: Статус заявки = "{{ transaction.status }}" - кнопки скрыты
</div>
{% endif %}
{% endblock %}
