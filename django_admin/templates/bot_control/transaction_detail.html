{% extends 'base.html' %}
{% load static %}

{% block title %}–ó–∞—è–≤–∫–∞ #{{ transaction.id }}{% endblock %}

{% block content %}
<style>
  /* –ö—Ä–∞—Å–∏–≤—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —Ç—ë–º–Ω—É—é —Ç–µ–º—É */
  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #2a2a2a;
    background: linear-gradient(180deg, #1b1b1b 0%, #141414 100%);
    color: #eaeaea;
    text-decoration: none;
    cursor: pointer;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    box-shadow: 0 6px 16px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    user-select: none;
  }
  .action-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05); }
  .action-btn:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(0,0,0,.35) inset; }

  .action-btn--approve {
    border-color: rgba(16,185,129,.35);
    background: linear-gradient(180deg, rgba(16,185,129,.25) 0%, rgba(6,95,70,.2) 100%);
    color: #a7ffdf;
  }
  .action-btn--approve:hover { border-color: rgba(16,185,129,.55); }

  .action-btn--reject {
    border-color: rgba(239,68,68,.35);
    background: linear-gradient(180deg, rgba(239,68,68,.22) 0%, rgba(127,29,29,.2) 100%);
    color: #ffc9c9;
  }
  .action-btn--reject:hover { border-color: rgba(239,68,68,.55); }

  .action-btn--neutral {
    border-color: rgba(107,114,128,.35);
    background: linear-gradient(180deg, rgba(75,85,99,.25) 0%, rgba(31,41,55,.25) 100%);
    color: #e5e7eb;
  }
  .action-btn--neutral:hover { border-color: rgba(107,114,128,.55); }

  /* –ö–Ω–æ–ø–∫–∞ –ø–æ–¥ —Ñ–æ—Ç–æ */
  .photo-link-btn {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid rgba(99,102,241,.35);
    background: linear-gradient(180deg, rgba(79,70,229,.22) 0%, rgba(30,27,75,.25) 100%);
    color: #c7d2fe;
    text-decoration: none;
    font-weight: 600;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    box-shadow: 0 6px 16px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .photo-link-btn:hover { transform: translateY(-1px); border-color: rgba(99,102,241,.6); }
  .photo-link-btn:active { transform: translateY(0); }

  /* –ë–ª–æ–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –æ—Ç—Å—Ç—É–ø—ã */
  .card { border-radius: 14px !important; border: 1px solid #242424 !important; background: #111 !important; }
  .btns-row { margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; }
  .muted-note { color:#8b8b8b; font-size:12px; text-align:center; margin-top:8px; }
</style>
<div class="page-header">
    <div class="header-avatar">
        <i class="fas fa-receipt"></i>
    </div>
    <div class="header-content">
        <h1>–ó–∞—è–≤–∫–∞ #{{ transaction.id }}</h1>
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–æ–π –∏–∑ –±–∞–∑—ã –±–æ—Ç–∞</p>
    </div>
</div>

{% with rt=transaction.request_type|default:'deposit' %}
<div class="card" style="background: #111; border: 1px solid #333; border-radius: 12px; padding: 16px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
            <div style="color:#999; font-size:12px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            <div style="color:#fff; font-size:14px; font-weight:600;">{{ transaction.username }}</div>
            <div style="color:#666; font-size:11px;">ID: {{ transaction.user_id }}</div>
        </div>
        <div>
            <div style="color:#999; font-size:12px;">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
            <div style="color:#fff; font-size:14px; font-weight:600;">{% if rt == 'deposit' %}–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ{% else %}–í—ã–≤–æ–¥{% endif %}</div>
        </div>
        <div>
            <div style="color:#999; font-size:12px;">–ë—É–∫–º–µ–∫–µ—Ä</div>
            <div style="color:#fff; font-size:14px; font-weight:600;">{{ transaction.bookmaker|upper }}</div>
        </div>
        <div>
            <div style="color:#999; font-size:12px;">–°—É–º–º–∞</div>
            <div style="color:#fff; font-size:18px; font-weight:700;">{{ transaction.amount }} —Å–æ–º</div>
        </div>
        <div>
            <div style="color:#999; font-size:12px;">–°—Ç–∞—Ç—É—Å</div>
            <div id="status-text" style="color:#fff; font-size:14px; font-weight:600;">
                {% if transaction.status == 'pending' %}–û–∂–∏–¥–∞–µ—Ç
                {% elif transaction.status == 'processing' %}–í –æ–±—Ä–∞–±–æ—Ç–∫–µ
                {% elif transaction.status == 'completed' %}–ó–∞–≤–µ—Ä—à–µ–Ω–∞
                {% elif transaction.status == 'auto_completed' %}–ê–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∞
                {% elif transaction.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–∞
                {% else %}{{ transaction.status }}{% endif %}
            </div>
        </div>
        <div>
            <div style="color:#999; font-size:12px;">–°–æ–∑–¥–∞–Ω–æ</div>
            <div style="color:#fff; font-size:14px; font-weight:600;">{{ transaction.created_at }}</div>
        </div>
    </div>

    {% if transaction.status != 'completed' and transaction.status != 'rejected' %}
    <div class="btns-row" id="actions-row">
        <button class="action-btn" id="btn-api">üîó –û–±—Ä–∞–±–æ—Ç–∞—Ç—å API</button>
        <button class="action-btn action-btn--approve" id="btn-approve" onclick="handleAction('approve')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="action-btn action-btn--reject" id="btn-reject" onclick="handleAction('reject')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        <a class="action-btn action-btn--neutral" href="{% url 'dashboard:deposits_list' %}">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º</a>
    </div>
    {% else %}
    <div class="btns-row">
        <a class="action-btn action-btn--neutral" href="{% url 'dashboard:deposits_list' %}">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º</a>
    </div>
    {% endif %}
</div>

<!-- –§–æ—Ç–æ —á–µ–∫–∞ -->
{% if photo_url %}
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:16px; margin-top:12px;">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <i class="fas fa-qrcode"></i>
        <div style="font-weight:600;">–§–æ—Ç–æ —á–µ–∫–∞</div>
    </div>
    <div style="text-align:center;">
        <img src="{{ photo_url }}" alt="–ß–µ–∫" style="max-width:100%; height:auto; border-radius:8px; border:1px solid #2d2d2d;" />
    </div>
    <div style="text-align:center; margin-top:10px;">
        <a class="photo-link-btn" href="{{ photo_url }}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</a>
    </div>
    <div class="muted-note">–ò—Å—Ç–æ—á–Ω–∏–∫: Telegram File API</div>
 </div>
 {% endif %}
 {% endwith %}

<!-- –í—Å–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100) -->
{% if user_requests %}
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:16px; margin-top:12px;">
  <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <i class="fas fa-list"></i>
      <div style="font-weight:600;">–í—Å–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
  </div>
  <div>
    {% for r in user_requests %}
      <div style="display:flex; justify-content:space-between; padding:8px 0; border-top:1px solid #222;">
        <div style="color:#9aa4b2;">#{{ r.id }} ¬∑ {{ r.created_at }}</div>
        <div style="color:#e8f0ff; font-weight:600;">
          {% if r.type == 'deposit' %}<span style="background:#0e2f24;color:#21f39c;border:1px solid #1bd58a;padding:2px 6px;border-radius:6px;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</span>{% else %}<span style="background:#2f0e0e;color:#ff6b6b;border:1px solid #ea5455;padding:2px 6px;border-radius:6px;">–í—ã–≤–æ–¥</span>{% endif %}
          &nbsp; {{ r.amount|floatformat:2 }} —Å–æ–º ¬∑ {{ r.status|title }}
          &nbsp; <a href="/bot/transactions/{{ r.id }}/" style="color:#0fa;">–û—Ç–∫—Ä—ã—Ç—å</a>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
let currentStatus = '{{ transaction.status }}';
function ruStatus(code) {
  switch (code) {
    case 'pending': return '–û–∂–∏–¥–∞–µ—Ç';
    case 'processing': return '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
    case 'completed': return '–ó–∞–≤–µ—Ä—à–µ–Ω–∞';
    case 'auto_completed': return '–ê–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∞';
    case 'rejected': return '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞';
    default: return code || '';
  }
}
async function handleAction(action) {
  try {
    // –ì–æ—Ç–æ–≤–∏–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π payload –ø–æ–¥ API: /api/bot/update-status/
    const status = action === 'approve' ? 'completed' : 'rejected';
    const requestId = Number('{{ transaction.id }}');
    const requestType = ('{{ rt }}' === 'withdraw') ? 'withdraw' : 'deposit';
    const source = '';
    const payload = { 
      request_type: requestType, 
      request_id: requestId, 
      status, 
      source,
      user_id: Number('{{ transaction.user_id }}'),
      amount: Number('{{ transaction.amount }}')
    };

    const res = await fetch('{% url "bot_control:update_request_status" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.ok && data.success) {
      const el = document.getElementById('status-text');
      if (el) el.textContent = ruStatus(status);
      // –ë–ª–æ–∫–∏—Ä—É–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
      try {
        const row = document.getElementById('actions-row');
        if (row) {
          const btnA = document.getElementById('btn-approve');
          const btnR = document.getElementById('btn-reject');
          [btnA, btnR].forEach(b => { if (b) { b.disabled = true; b.style.opacity = .5; b.style.pointerEvents = 'none'; }});
        }
      } catch (e) { /* no-op */ }
      alert(data.message || '–ì–æ—Ç–æ–≤–æ');
    } else {
      alert((data && data.error) || '–û—à–∏–±–∫–∞');
    }
  } catch (e) {
    console.error(e);
    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
  }
}

async function handleApiProcess() {
  try {
    const bookmaker = '{{ transaction.bookmaker }}'.toLowerCase();
    const accountId = String('{{ transaction.account_id }}');
    const amount = parseFloat(String('{{ transaction.amount }}').replace(',', '.'));
    // –î–ª—è API –±—É–∫–º–µ–∫–µ—Ä–∞ –Ω—É–∂–µ–Ω –ò–ú–ï–ù–ù–û ID –∞–∫–∫–∞—É–Ω—Ç–∞ —É –±—É–∫–º–µ–∫–µ—Ä–∞, –∞ –Ω–µ Telegram user_id
    const userId = String('{{ transaction.account_id }}');
    const rt = '{{ transaction.request_type|default:"deposit" }}'.toLowerCase();
    if (rt === 'withdraw') {
      alert('API –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π');
      return;
    }
    let endpoint = '';
    if (bookmaker.includes('1xbet') || bookmaker.includes('xbet')) endpoint = '{% url "bot_control:api_1xbet_deposit" %}';
    else if (bookmaker.includes('1win')) endpoint = '{% url "bot_control:api_1win_deposit" %}';
    else if (bookmaker.includes('melbet')) endpoint = '{% url "bot_control:api_melbet_deposit" %}';
    else if (bookmaker.includes('mostbet')) endpoint = '{% url "bot_control:api_mostbet_deposit" %}';
    if (!endpoint) {
      alert('–î–ª—è —ç—Ç–æ–≥–æ –±—É–∫–º–µ–∫–µ—Ä–∞ API-–∫–Ω–æ–ø–∫–∞ –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞');
      return;
    }
    const payload = {
      bookmaker: bookmaker,
      account_id: accountId,
      amount: amount,
      currency: 'KGS',
      user_id: userId,
    };
    const headers = { 
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken') || ''
    };
    const apiToken = '{{ api_token|default:"" }}';
    if (apiToken) headers['Authorization'] = `Token ${apiToken}`;
    const res = await fetch(endpoint, { 
      method: 'POST', 
      credentials: 'same-origin',
      headers,
      body: JSON.stringify(payload) 
    });
    const data = await res.json().catch(()=>({ raw: 'non-json response' }));
    if (!res.ok) {
      const msg = (data && (data.error || data.message)) || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API –±—É–∫–º–µ–∫–µ—Ä–∞';
      alert(`API error (${res.status}): ${msg}\n\nDetails: ${JSON.stringify(data)}`);
      return;
    }
    // –ü–æ—Å–ª–µ —É–¥–∞—á–Ω–æ–≥–æ API-–¥–µ–ø–æ–∑–∏—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ -> completed
    await handleAction('approve');
  } catch (e) {
    console.error(e);
    alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ API');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  try {
    const apiBtn = document.getElementById('btn-api');
    if (apiBtn) apiBtn.addEventListener('click', handleApiProcess);
  } catch (e) { /* noop */ }
  try { startStatusPolling(); } catch(e) {}
});

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

function disableActionsUI() {
  try {
    const row = document.getElementById('actions-row');
    if (row) {
      const btns = row.querySelectorAll('button');
      btns.forEach(b => { if (b){ b.disabled = true; b.style.opacity = .5; b.style.pointerEvents = 'none'; }});
    }
  } catch (e) {}
}

function startStatusPolling(){
  const id = Number('{{ transaction.id }}');
  const url = '{% url "bot_control:api_request_status" 0 %}'.replace('/0/', `/${id}/`);
  setInterval(async ()=>{
    try{
      const res = await fetch(url, {credentials:'same-origin'});
      if(!res.ok) return;
      const data = await res.json();
      if(!data || !data.success) return;
      const st = data.status || '';
      if (st && st !== currentStatus){
        currentStatus = st;
        const el = document.getElementById('status-text');
        if (el) el.textContent = ruStatus(st);
        if (st === 'completed' || st === 'rejected' || st === 'auto_completed') {
          disableActionsUI();
        }
      }
    }catch(e){ /* silent */ }
  }, 7000);
}
</script>
{% endblock %}
