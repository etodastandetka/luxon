{% extends 'base.html' %}
{% load static %}

{% block title %}Заявка #{{ transaction.id }}{% endblock %}
{% block header_icon %}{% endblock %}
{% block header_title %}{% endblock %}

{% block content %}
<style>
  /* Красивые универсальные кнопки под тёмную тему */
  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #2a2a2a;
    background: linear-gradient(180deg, #1b1b1b 0%, #141414 100%);
    color: #eaeaea;
    text-decoration: none;
    cursor: pointer;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    box-shadow: 0 6px 16px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    user-select: none;
  }
  .action-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05); }
  .action-btn:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(0,0,0,.35) inset; }

  .action-btn--approve {
    border-color: rgba(16,185,129,.35);
    background: linear-gradient(180deg, rgba(16,185,129,.25) 0%, rgba(6,95,70,.2) 100%);
    color: #a7ffdf;
  }
  .action-btn--approve:hover { border-color: rgba(16,185,129,.55); }

  .action-btn--reject {
    border-color: rgba(239,68,68,.35);
    background: linear-gradient(180deg, rgba(239,68,68,.22) 0%, rgba(127,29,29,.2) 100%);
    color: #ffc9c9;
  }
  .action-btn--reject:hover { border-color: rgba(239,68,68,.55); }

  .action-btn--neutral {
    border-color: rgba(107,114,128,.35);
    background: linear-gradient(180deg, rgba(75,85,99,.25) 0%, rgba(31,41,55,.25) 100%);
    color: #e5e7eb;
  }
  .action-btn--neutral:hover { border-color: rgba(107,114,128,.55); }

  /* Кнопка под фото */
  .photo-link-btn {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid rgba(99,102,241,.35);
    background: linear-gradient(180deg, rgba(79,70,229,.22) 0%, rgba(30,27,75,.25) 100%);
    color: #c7d2fe;
    text-decoration: none;
    font-weight: 600;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    box-shadow: 0 6px 16px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .photo-link-btn:hover { transform: translateY(-1px); border-color: rgba(99,102,241,.6); }
  .photo-link-btn:active { transform: translateY(0); }

  /* Блоки карточек и отступы */
  .card { border-radius: 14px !important; border: 1px solid #242424 !important; background: #111 !important; }
  .btns-row { margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; }
  .muted-note { color:#8b8b8b; font-size:12px; text-align:center; margin-top:8px; }
</style>
<div class="page-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div class="header-content">
        <h1 style="margin:0; line-height:1.2;">Заявка #{{ transaction.id }}</h1>
        <div style="margin-top:6px; color:#9aa7bd; font-size:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
            {# Иконка операции: ELQR для пополнений, банк для выводов #}
            {% with rt=transaction.request_type|default:'deposit' %}
              {% if rt == 'deposit' %}
                <img src="{% static 'elqr.svg' %}?v=20251002" alt="ELQR" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;object-fit:contain;padding:1px;background:#0f0f0f;">
              {% else %}
                {% with b=transaction.bank|default:'' %}
                  {% if b|lower == 'mbank' %}
                    <img src="{% static 'images/mbank.png' %}" alt="mbank" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                  {% elif b|lower == 'optima' %}
                    <img src="{% static 'images/optima.jpg' %}" alt="optima" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                  {% elif b|lower == 'omoney' %}
                    <img src="{% static 'images/omoney.jpg' %}" alt="omoney" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                  {% elif b|lower == 'demirbank' or b|lower == 'demir' %}
                    <img src="{% static 'images/demirbank.jpg' %}" alt="demirbank" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                  {% elif b|lower == 'megapay' %}
                    <img src="{% static 'images/megapay.jpg' %}" alt="megapay" style="width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a;">
                  {% endif %}
                {% endwith %}
              {% endif %}
            {% endwith %}
            {# Перенесено в карточку Детали ниже #}
            {# Убрали статус-чип в хедере, статус показывается в основной карточке #}
        </div>
    </div>
    <div style="display:flex; gap:8px;">
      <a class="action-btn action-btn--neutral" href="{% url 'bot_control:user_profile' transaction.user_id %}">
        <i class="fas fa-user"></i>
        <span>Профиль</span>
      </a>
      <a class="action-btn action-btn--approve" href="{% url 'bot_control:user_chat' transaction.user_id %}">
        <i class="fas fa-comments"></i>
        <span>Чат</span>
      </a>
    </div>
    
</div>

{% with rt=transaction.request_type|default:'deposit' %}
<!-- Верхний блок: информация и фото в одной карточке -->
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:12px; margin-top:0;">
  <!-- Шапка карточки (иконка банка/ELQR, ID, дата; справа статус и сумма) -->
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
    <div style="display:flex; align-items:center; gap:10px;">
      {% if rt == 'deposit' %}
        <img src="{% static 'elqr.svg' %}?v=20251002" alt="ELQR" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;background:#0f0f0f;object-fit:contain;">
      {% else %}
        {% with b=transaction.bank|default:'' %}
          {% if b|lower == 'mbank' %}
            <img src="{% static 'images/mbank.png' %}" alt="mbank" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% elif b|lower == 'optima' %}
            <img src="{% static 'images/optima.jpg' %}" alt="optima" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% elif b|lower == 'omoney' %}
            <img src="{% static 'images/omoney.jpg' %}" alt="omoney" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% elif b|lower == 'demirbank' or b|lower == 'demir' %}
            <img src="{% static 'images/demirbank.jpg' %}" alt="demirbank" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% elif b|lower == 'megapay' %}
            <img src="{% static 'images/megapay.jpg' %}" alt="megapay" style="width:28px;height:28px;border-radius:6px;border:1px solid #2a2a2a;">
          {% endif %}
        {% endwith %}
      {% endif %}
      <div>
        <div style="font-weight:700; color:#e5e7eb;">{% firstof transaction.account_id transaction.user_id transaction.telegram_id '-' %}</div>
        <div style="color:#9aa4b2; font-size:12px;">{{ transaction.created_at|date:'d.m.Y • H:i' }}</div>
      </div>
    </div>
    <div style="display:flex; align-items:flex-end; gap:10px; flex-direction:column;">
      {% if transaction.status != 'awaiting_manual' %}
        <div style="display:flex; align-items:center; gap:6px;">
          <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:{% if transaction.status == 'completed' or transaction.status == 'auto_completed' %}#22c55e{% elif transaction.status == 'pending' or transaction.status == 'processing' %}#f59e0b{% else %}#6b7280{% endif %};"></span>
          <span style="font-size:12px; color:#aab1c2;">{% if transaction.status == 'completed' %}Успешно{% elif transaction.status == 'auto_completed' %}Автопополнена{% elif transaction.status == 'pending' %}Ожидает{% elif transaction.status == 'processing' %}В обработке{% elif transaction.status == 'rejected' %}Отклонена{% else %}{{ transaction.status }}{% endif %}</span>
        </div>
      {% endif %}
      <div style="font-weight:800; font-size:18px; {% if rt == 'deposit' %}color:#21f39c;{% else %}color:#ff6b6b;{% endif %}">{% if rt == 'deposit' %}+{% else %}-{% endif %}{{ transaction.amount|floatformat:2 }} сом</div>
    </div>
  </div>

  {% if photo_url %}
    <div style="text-align:center;">
        <img src="{{ photo_url }}" alt="Чек" style="max-width:100%; height:auto; border-radius:10px; border:1px solid #2d2d2d;" />
    </div>
    <div style="text-align:center; margin-top:10px;">
        <a class="photo-link-btn" href="{{ photo_url }}" target="_blank">Загрузить чек</a>
    </div>
    <div class="muted-note" style="margin-top:6px;">Источник: Telegram</div>
  {% endif %}
</div>

{% endwith %}

<!-- Детали -->
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:16px; margin-top:12px;">
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
    <div>
      <div style="color:#9aa4b2; font-size:12px;">Сайт</div>
      <div style="color:#e5e7eb; font-size:14px; font-weight:700;">{{ transaction.bookmaker|upper }}</div>
    </div>
    <div>
      <div style="color:#9aa4b2; font-size:12px;">ID</div>
      {% firstof transaction.account_id transaction.user_id transaction.telegram_id '-' as did %}
      <div style="color:#e5e7eb; font-size:14px; font-weight:700;">{{ did }}</div>
    </div>
    <div>
      <div style="color:#9aa4b2; font-size:12px;">Код</div>
      {% firstof transaction.withdraw_code transaction.code '-' as vcode %}
      <div style="color:#e5e7eb; font-size:14px; font-weight:700;">{{ vcode }}</div>
    </div>
    <div>
      <div style="color:#9aa4b2; font-size:12px;">Дата создания</div>
      <div style="color:#e5e7eb; font-size:14px; font-weight:700;">{{ transaction.created_at|date:'d.m.Y • H:i' }}</div>
    </div>
  </div>
</div>

<!-- Все заявки пользователя (последние 100) -->
{% if user_requests %}
<div class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:12px; margin-top:12px;">
  <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
      <div style="font-weight:600;">Все заявки пользователя</div>
  </div>
  <div style="margin-top:8px;">
    <div style="border-top:1px solid #222"></div>
    {% for r in user_requests %}
      <a href="/bot/transactions/{{ r.id }}/" style="display:flex; align-items:center; gap:14px; justify-content:space-between; padding:14px 12px; color:#cdd6f4; text-decoration:none; background:#141414; border:1px solid #222; border-radius:12px; margin:10px 0;">
        <div style="display:flex; align-items:center; gap:12px; min-width:0;">
          {# Иконка для каждой заявки в списке #}
          {% if r.type == 'deposit' %}
            <img src="{% static 'elqr.svg' %}?v=20251002" alt="ELQR" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;object-fit:contain;background:#0f0f0f;">
          {% else %}
            {% with wd=r.wallet_details|default:''|lower %}
              {% if 'mbank' in wd %}
                <img src="{% static 'images/mbank.png' %}" alt="mbank" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% elif 'optima' in wd %}
                <img src="{% static 'images/optima.jpg' %}" alt="optima" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% elif 'omoney' in wd %}
                <img src="{% static 'images/omoney.jpg' %}" alt="omoney" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% elif 'demir' in wd %}
                <img src="{% static 'images/demirbank.jpg' %}" alt="demirbank" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% elif 'megapay' in wd %}
                <img src="{% static 'images/megapay.jpg' %}" alt="megapay" style="width:32px;height:32px;border-radius:8px;border:1px solid #2a2a2a;">
              {% endif %}
            {% endwith %}
          {% endif %}
          <div style="display:flex; flex-direction:column; gap:4px; min-width:0;">
            <div style="display:flex; align-items:center; gap:8px; min-width:0;">
              <div style="font-weight:700; color:#e5e7eb; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px;">{{ r.username|default:'N B' }}</div>
              <div style="color:#8b8b8b; font-size:12px;">#{{ r.id }}</div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              {% firstof r.account_id r.user_id r.telegram_id '-' as rid %}
              <div style="color:#9aa4b2; font-size:12px;">ID: {{ rid }}</div>
              <div style="font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2a2a2a; color:#9ec5fe; background:#0f172a;">{% if r.type == 'deposit' %}{% if r.status == 'auto_completed' %}Авто пополнение{% else %}Пополнение{% endif %}{% else %}Вывод{% endif %}</div>
            </div>
          </div>
        </div>
        <div style="display:flex; align-items:flex-end; gap:12px; flex-direction:column; min-width:140px;">
          <div style="color:#9aa4b2; font-size:12px; white-space:nowrap;">{{ r.created_at|date:'d.m.Y • H:i' }}</div>
          <div style="font-weight:800; font-size:16px; {% if r.type == 'deposit' %}color:#21f39c;{% else %}color:#ff6b6b;{% endif %}">{% if r.type == 'deposit' %}+{% else %}-{% endif %}{{ r.amount|floatformat:2 }} сом</div>
          {% if r.status != 'awaiting_manual' %}
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:{% if r.status == 'completed' or r.status == 'auto_completed' %}#22c55e{% elif r.status == 'pending' or r.status == 'processing' %}#f59e0b{% else %}#6b7280{% endif %};"></span>
              <span style="font-size:12px; color:#aab1c2;">{% if r.status == 'auto_completed' %}Авто пополнение{% elif r.status == 'completed' %}Успешно{% elif r.status == 'pending' %}Ожидает{% elif r.status == 'processing' %}В работе{% elif r.status == 'rejected' %}Отклонена{% else %}{{ r.status }}{% endif %}</span>
            </div>
          {% endif %}
        </div>
      </a>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Debug photo info (only rendered when no photo and debug available) -->
{% if not photo_url and photo_debug %}
<details class="card" style="background:#111; border:1px solid #333; border-radius:12px; padding:16px; margin-top:12px;">
  <summary style="cursor:pointer; color:#aaa;">Отладка фото (почему не отображается)</summary>
  <div style="margin-top:10px; font-family:monospace; font-size:12px; color:#bbb;">
    <div>photo_file_url: {{ photo_debug.photo_file_url|default:"" }}</div>
    <div>receipt_photo_url: {{ photo_debug.receipt_photo_url|default:"" }}</div>
    <div>qr_photo_url: {{ photo_debug.qr_photo_url|default:"" }}</div>
    <div>photo_url_field: {{ photo_debug.photo_url_field|default:"" }}</div>
    <div>screenshot_url: {{ photo_debug.screenshot_url|default:"" }}</div>
    <div>photo_file_id: {{ photo_debug.photo_file_id|default:"" }}</div>
    <div>BOT_TOKEN задан: {{ photo_debug.bot_token_present }}</div>
    <div>resolved_via: {{ photo_debug.resolved_via|default:"" }}</div>
    <div>resolved_photo_url: {{ photo_debug.resolved_photo_url|default:"" }}</div>
  </div>
</details>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
let currentStatus = '{{ transaction.status }}';
function ruStatus(code) {
  switch (code) {
    case 'pending': return 'Ожидает';
    case 'processing': return 'В обработке';
    case 'completed': return 'Завершена';
    case 'auto_completed': return 'Автопополнена';
    case 'rejected': return 'Отклонена';
    default: return code || '';
  }
}
async function handleAction(action) {
  try {
    // Готовим корректный payload под API: /api/bot/update-status/
    const status = action === 'approve' ? 'completed' : 'rejected';
    const requestId = Number('{{ transaction.id }}');
    const requestType = ('{{ rt }}' === 'withdraw') ? 'withdraw' : 'deposit';
    const source = '';
    const payload = { 
      request_type: requestType, 
      request_id: requestId, 
      status, 
      source,
      user_id: Number('{{ transaction.user_id }}'),
      amount: Number('{{ transaction.amount }}')
    };

    const res = await fetch('{% url "bot_control:update_request_status" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.ok && data.success) {
      const el = document.getElementById('status-text');
      if (el) el.textContent = ruStatus(status);
      const chip = document.getElementById('status-chip');
      if (chip) chip.textContent = ruStatus(status);
      // Блокируем/скрываем кнопки действий после финального статуса
      try {
        const bar = document.getElementById('sticky-actions');
        if (bar) bar.style.display = 'none';
      } catch (e) { /* no-op */ }
      alert(data.message || 'Готово');
    } else {
      alert((data && data.error) || 'Ошибка');
    }
  } catch (e) {
    console.error(e);
    alert('Ошибка запроса');
  }
}


document.addEventListener('DOMContentLoaded', function() {
  try { startStatusPolling(); } catch(e) {}
});

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

function disableActionsUI() {
  try {
    const row = document.getElementById('actions-row');
    if (row) {
      const btns = row.querySelectorAll('button');
      btns.forEach(b => { if (b){ b.disabled = true; b.style.opacity = .5; b.style.pointerEvents = 'none'; }});
    }
  } catch (e) {}
}

function startStatusPolling(){
  const id = Number('{{ transaction.id }}');
  const url = '{% url "bot_control:api_request_status" 0 %}'.replace('/0/', `/${id}/`);
  setInterval(async ()=>{
    try{
      const res = await fetch(url, {credentials:'same-origin'});
      if(!res.ok) return;
      const data = await res.json();
      if(!data || !data.success) return;
      const st = data.status || '';
      if (st && st !== currentStatus){
        currentStatus = st;
        const el = document.getElementById('status-text');
        if (el) el.textContent = ruStatus(st);
        const chip = document.getElementById('status-chip');
        if (chip) chip.textContent = ruStatus(st);
        if (st === 'completed' || st === 'rejected' || st === 'auto_completed') {
          const bar = document.getElementById('sticky-actions');
          if (bar) bar.style.display = 'none';
        }
      }
    }catch(e){ /* silent */ }
  }, 7000);
}
</script>
{% endblock %}

{% block extra_body %}
{% if transaction.status != 'completed' and transaction.status != 'rejected' %}
<div id="sticky-actions" style="position:sticky; bottom:0; left:0; right:0; background:rgba(10,10,10,.96); border-top:1px solid #222; padding:10px; display:flex; gap:10px; z-index:20;">
  <button class="action-btn action-btn--approve" style="flex:1 1 50%; justify-content:center;" onclick="handleAction('approve')">Принять</button>
  <button class="action-btn action-btn--reject" style="flex:1 1 50%; justify-content:center;" onclick="handleAction('reject')">Отказать</button>
  <a class="action-btn action-btn--neutral" style="flex:0 0 auto;" href="{% url 'dashboard:deposits_list' %}">Назад</a>
  
</div>
{% endif %}
{% endblock %}
