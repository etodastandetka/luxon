{% extends 'base.html' %}
{% load static %}

{% block title %}–ó–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ{% endblock %}

{% block header_icon %}list{% endblock %}
{% block header_title %}–ó–∞—è–≤–∫–∏{% endblock %}
{% block header_subtitle %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏{% endblock %}

{% block content %}
{% csrf_token %}

<!-- –í—Å–µ –∑–∞—è–≤–∫–∏ -->
{% for request in page_obj %}
{% firstof request.request_type request.type 'deposit' as rt %}
<div class="list-item" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 4px 16px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; padding: 16px; margin-bottom: 12px; border-radius: 12px; backdrop-filter: blur(10px);" onmouseover="this.style.transform='translateY(-2px) scale(1.01)'; this.style.boxShadow='0 16px 50px rgba(0, 0, 0, 0.6), 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 15px rgba(34, 197, 94, 0.2)'; this.style.borderColor='rgba(34, 197, 94, 0.4)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 12px 40px rgba(0, 0, 0, 0.5), 0 4px 16px rgba(0, 0, 0, 0.3)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'">
    <div class="list-icon" style="margin-right: 16px;">
        <div style="width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px solid rgba(34, 197, 94, 0.3); background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%); overflow:hidden; font-size:20px; backdrop-filter: blur(10px);">
            {% if rt == 'deposit' %}üí≥{% else %}üí∏{% endif %}
        </div>
    </div>
    <div class="list-content">
        <div class="list-title">
            {% if request.username %}{{ request.username }}{% else %}user_{{ request.user_id }}{% endif %}
        </div>
        <div class="list-subtitle">
            {{ request.bookmaker|upper }}{% if request.account_id %} ‚Ä¢ ID: {{ request.account_id }}{% endif %}
        </div>
        <div class="list-date" style="font-size: 11px; color: #999; margin-top: 4px;">
            {{ request.created_at|date:"d.m.Y ‚Ä¢ H:i" }}
        </div>
    </div>
    <div class="list-right" style="text-align: right;">
        <div class="list-amount" style="color: {% if rt == 'deposit' %}#00ff88{% else %}#ff4444{% endif %}; font-weight: bold; font-size: 16px; margin-bottom: 4px;">
            {% if rt == 'deposit' %}+{% else %}-{% endif %}{{ request.amount }} —Å–æ–º
        </div>
        <div class="list-status" style="display: flex; align-items: center; justify-content: flex-end; font-size: 11px; color: #999; gap:6px;">
            <div class="status-dot" style="
                width: 6px;
                height: 6px;
                border-radius: 50%;
                margin-right: 6px;
                background: {% if request.status == 'pending' %}#ffa500{% elif request.status == 'completed' %}#16a34a{% elif request.status == 'auto_completed' %}#22c55e{% elif request.status == 'rejected' %}#ff4444{% else %}#ffa500{% endif %};
            "></div>
            <span>
                {% if request.status == 'pending' %}–û–∂–∏–¥–∞–µ—Ç{% elif request.status == 'completed' %}–£—Å–ø–µ—à–Ω–æ{% elif request.status == 'auto_completed' %}–ê–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–æ{% elif request.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–æ{% else %}{{ request.status }}{% endif %}
            </span>
        </div>
        {% if request.status == 'auto_completed' %}
        <div style="margin-top:4px; font-size:10px; color:#9aa7bd;">–∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–æ</div>
        {% endif %}
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    {% if request.status == 'pending' %}
    <div class="list-actions" style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn btn-success btn-sm" onclick="quickApprove({{ request.id }})" style="padding: 6px 12px; font-size: 12px;">
            <i class="fas fa-check"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
        </button>
        <button class="btn btn-danger btn-sm" onclick="quickReject({{ request.id }})" style="padding: 6px 12px; font-size: 12px;">
            <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
        </button>
        <button class="btn btn-info btn-sm" onclick="openTransaction({{ request.id }})" style="padding: 6px 12px; font-size: 12px;">
            <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
        </button>
    </div>
    {% else %}
    <div class="list-actions" style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn btn-info btn-sm" onclick="openTransaction({{ request.id }})" style="padding: 6px 12px; font-size: 12px;">
            <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
        </button>
    </div>
    {% endif %}
    </div>
</div>
{% empty %}
<div class="card" style="background: transparent; border: none; box-shadow: none;">
    <div class="card-body text-center" style="background: transparent;">
        <i class="fas fa-inbox fa-3x mb-3" style="color: #22c55e; opacity: 0.5;"></i>
        <h5 style="color: #cccccc;">–ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
        <p style="color: #999999;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
    </div>
</div>
{% endfor %}

<script>
function openTransaction(transId) {
    window.location.href = `/bot_control/transactions/${transId}/`;
}

async function quickApprove(requestId) {
    if (confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) {
        try {
            const response = await fetch(`/bot/api/requests/${requestId}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    status: 'completed',
                    source: 'admin_panel'
                })
            });
            
            if (response.ok) {
                alert('–ó–∞—è–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!');
                location.reload();
            } else {
                const error = await response.json();
                alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }
}

async function quickReject(requestId) {
    if (confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) {
        try {
            const response = await fetch(`/bot/api/requests/${requestId}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    status: 'rejected',
                    source: 'admin_panel'
                })
            });
            
            if (response.ok) {
                alert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞!');
                location.reload();
            } else {
                const error = await response.json();
                alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}