{% extends 'base.html' %}

{% block title %}Рассылка сообщений - Luxon{% endblock %}

{% block header_icon %}bullhorn{% endblock %}
{% block header_title %}Рассылка сообщений{% endblock %}
{% block header_subtitle %}Отправка сообщений всем пользователям{% endblock %}

{% block content %}
<!-- Создание рассылки -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-edit"></i>
        </div>
        <div>
            <div class="card-title">Создать рассылку</div>
            <div class="card-subtitle">Отправка сообщения всем пользователям</div>
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label">Текст сообщения:</label>
        <textarea id="broadcast-message" class="form-control" placeholder="Введите текст сообщения для рассылки..." rows="6"></textarea>
        <small style="color: #888; margin-top: 5px; display: block;">
            Поддерживается HTML разметка: &lt;b&gt;жирный&lt;/b&gt;, &lt;i&gt;курсив&lt;/i&gt;, &lt;code&gt;код&lt;/code&gt;
        </small>
    </div>
    
    <button class="btn btn-primary" onclick="sendBroadcast()">
        <i class="fas fa-paper-plane"></i> Отправить рассылку
    </button>
</div>


<!-- История рассылок -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-history"></i>
        </div>
        <div>
            <div class="card-title">История рассылок</div>
            <div class="card-subtitle">Последние отправленные сообщения</div>
        </div>
    </div>
    
    <div id="broadcast-list">
        <div style="text-align: center; color: #ccc; padding: 20px;">
            <i class="fas fa-spinner fa-spin"></i> Загрузка истории...
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Загружаем данные при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadBroadcastHistory();
});

async function sendBroadcast() {
    const message = document.getElementById('broadcast-message').value.trim();
    
    if (!message) {
        alert('Введите текст сообщения');
        return;
    }
    
    if (!confirm('Вы уверены, что хотите отправить это сообщение ВСЕМ пользователям бота?')) {
        return;
    }
    
    try {
        const response = await fetch('{% url "bot_control:api_send_broadcast" %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message: message
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            // Очищаем поле
            document.getElementById('broadcast-message').value = '';
            // Обновляем историю
            loadBroadcastHistory();
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
        
    } catch (error) {
        console.error('Ошибка отправки рассылки:', error);
        alert('Ошибка отправки рассылки');
    }
}

async function loadBroadcastHistory() {
    try {
        const response = await fetch('{% url "bot_control:api_broadcast_history" %}');
        const data = await response.json();
        
        if (data.success) {
            updateBroadcastList(data.broadcasts);
        } else {
            showError('Ошибка загрузки истории: ' + data.error);
        }
    } catch (error) {
        console.error('Ошибка загрузки истории рассылок:', error);
        showError('Ошибка соединения с сервером');
    }
}

function updateBroadcastList(broadcasts) {
    const container = document.getElementById('broadcast-list');
    
    if (broadcasts && broadcasts.length > 0) {
        container.innerHTML = '';
        
        broadcasts.forEach(broadcast => {
            const broadcastItem = document.createElement('div');
            broadcastItem.className = 'list-item';
            
            broadcastItem.innerHTML = `
                <div class="list-icon">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div class="list-content">
                    <div class="list-title">${formatDate(broadcast.created_at)}</div>
                    <div class="list-subtitle">${broadcast.message}</div>
                </div>
            `;
            
            container.appendChild(broadcastItem);
        });
    } else {
        container.innerHTML = `
            <div style="text-align: center; color: #ccc; padding: 20px;">
                <i class="fas fa-inbox"></i><br>
                История рассылок пуста
            </div>
        `;
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('ru-RU', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showError(message) {
    const container = document.getElementById('broadcast-list');
    container.innerHTML = `
        <div style="text-align: center; color: #ff4444; padding: 20px;">
            <i class="fas fa-exclamation-triangle"></i><br>
            ${message}
        </div>
    `;
}
</script>
{% endblock %}


