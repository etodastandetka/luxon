{% extends 'base.html' %}

{% block title %}Wallets Management - Luxon{% endblock %}
{% block header_icon %}money bill alternate outline{% endblock %}
{% block header_title %}–ö–æ—à–µ–ª—å–∫–∏ / –†–µ–∫–≤–∏–∑–∏—Ç—ã{% endblock %}
{% block header_subtitle %}Demirbank (QR) ‚Ä¢ MBank ‚Ä¢ Bakai ‚Ä¢ Optima{% endblock %}

{% block content %}
<div class="content-container">
  <div class="card">
    <div class="card-header">
      <h3>üíº –ö–æ—à–µ–ª—å–∫–∏ / –†–µ–∫–≤–∏–∑–∏—Ç—ã</h3>
      {% if message %}<div class="alert alert-success" style="margin-top:8px;">{{ message }}</div>{% endif %}
      {% if error %}<div class="alert alert-danger" style="margin-top:8px;">{{ error }}</div>{% endif %}
      <div class="text-muted" style="font-size:13px; margin-top:6px;">
        –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∏ –æ—Å–Ω–æ–≤–Ω—ã–º –∫–æ—à–µ–ª—å–∫–æ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–Ω–∫–∞. –ê–∫—Ç–∏–≤–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–æ—Ç–æ–º –ø—Ä–∏ –≤—ã–¥–∞—á–µ QR/—Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤.
      </div>

      <!-- –†–µ–∫–≤–∏–∑–∏—Ç—ã Demirbank: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤–Ω–∏–∑—É -->
      <div class="card" style="margin-top:16px; border-color:#ffe9e9;">
        <div class="card-header" style="background:#ffe9e9;"><strong>–†–µ–∫–≤–∏–∑–∏—Ç—ã ({{ qrhash|length }})</strong></div>
        <div class="card-body">
          {% if qrhash and qrhash|length %}
            <div>
              {% for q in qrhash %}
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed #333;">
                  <div style="max-width:70%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="{{ q.hash_value }}">
                    {{ q.hash_value }}
                    {% if q.is_active %}<span class="badge bg-success" style="margin-left:8px;">–ê–ö–¢–ò–í–ù–´–ô</span>{% else %}<span class="badge bg-secondary" style="margin-left:8px;">–Ω–µ –∞–∫—Ç–∏–≤–µ–Ω</span>{% endif %}
                    {% if q.is_main %}<span class="badge bg-warning text-dark" style="margin-left:6px;">–æ—Å–Ω–æ–≤–Ω–æ–π</span>{% endif %}
                  </div>
                  <div style="color:#9ca3af; font-size:12px;">{{ q.created_at|date:'Y-m-d H:i:s' }}</div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">–ù–µ—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ Demirbank</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- –¢–µ–∫—É—â–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ—à–µ–ª—ë–∫ -->
      <div class="mb-3" style="padding:12px; border:1px dashed #ccc; border-radius:8px;">
        <div style="font-weight:600;">–¢–µ–∫—É—â–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ—à–µ–ª—ë–∫</div>
        {% with main_qr=qrhash|dictsortreversed:"is_main" %}{% endwith %}
        {% with main_db=None %}
        {% endwith %}
        {% comment %}
          –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–≤–µ—Å—Ç–∏ –æ–¥–∏–Ω –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ Demirbank (QRHash), –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏–∑ bank wallets.
        {% endcomment %}
        {% if qrhash and qrhash|length %}
          {% with has_qr_main=False %}
            {% for q in qrhash %}
              {% if q.is_main %}
                <div class="mt-1">Demirbank ‚Ä¢ {{ q.account_name }}{% if q.hash_value %} <span class="text-muted" style="font-size:12px;">({{ q.hash_value }})</span>{% endif %}</div>
                {% with has_qr_main=True %}{% endwith %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endwith %}
        {% endif %}
        {% if not qrhash or not qrhash|dictsortreversed:"is_main" %}{% endif %}
        {% if groups %}
          {% for code in 'mbank,bakai,optima'|split:',' %}
            {% for w in groups[code] %}
              {% if w.is_main %}
                <div class="mt-1">{{ code|upper }} ‚Ä¢ {{ w.account_name }}</div>
              {% endif %}
            {% endfor %}
          {% endfor %}
        {% endif %}
      </div>

      
      <div class="row" style="display:flex; gap:16px; flex-wrap:wrap;">
        <div class="col" style="flex:1; min-width:320px;">
          <div class="card" style="border-color:#e3f2fd;">
            <div class="card-header" style="background:#e3f2fd;"><strong>MBank</strong></div>
            <div class="card-body">
              {% if groups.mbank and groups.mbank|length %}
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                      <th>–°–æ–∑–¥–∞–Ω</th>
                      <th>–°—Ç–∞—Ç—É—Å—ã</th>
                      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for w in groups.mbank %}
                    <tr>
                      <td>{{ w.account_name }}</td>
                      <td>{{ w.created_at|date:'Y-m-d H:i:s' }}</td>
                      <td>
                        {% if w.is_main %}<span title="–û—Å–Ω–æ–≤–Ω–æ–π">‚≠ê</span>{% endif %}
                        {% if w.is_active %}<span title="–ê–∫—Ç–∏–≤–µ–Ω">‚úÖ</span>{% else %}<span title="–ù–µ–∞–∫—Ç–∏–≤–µ–Ω">‚≠ï</span>{% endif %}
                      </td>
                      <td>
                        <form method="post" action="/bot_control/wallets/" style="display:inline-block;">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="toggle_active" />
                          <input type="hidden" name="id" value="{{ w.id }}" />
                          <button class="btn btn-sm btn-outline-primary" type="submit">{% if w.is_active %}–í—ã–∫–ª—é—á–∏—Ç—å{% else %}–í–∫–ª—é—á–∏—Ç—å{% endif %}</button>
                        </form>
                        {% if not w.is_main %}
                        <form method="post" action="/bot_control/wallets/" style="display:inline-block; margin-left:6px;">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="set_main" />
                          <input type="hidden" name="id" value="{{ w.id }}" />
                          <button class="btn btn-sm btn-outline-warning" type="submit">–°–¥–µ–ª–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–º</button>
                        </form>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
                <div class="text-muted">–ù–µ—Ç –∫–æ—à–µ–ª—å–∫–æ–≤ MBank</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col" style="flex:1; min-width:320px;">
          <div class="card" style="border-color:#f3e8ff;">
            <div class="card-header" style="background:#f3e8ff;"><strong>Bakai</strong></div>
            <div class="card-body">
              {% if groups.bakai and groups.bakai|length %}
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                      <th>–†–µ–∫–≤–∏–∑–∏—Ç</th>
                      <th>–°–æ–∑–¥–∞–Ω</th>
                      <th>–°—Ç–∞—Ç—É—Å—ã</th>
                      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for w in groups.bakai %}
                    <tr>
                      <td>{{ w.account_name }}</td>
                      <td style="max-width:320px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="{{ w.hash_value }}">{{ w.hash_value }}</td>
                      <td>{{ w.created_at|date:'Y-m-d H:i:s' }}</td>
                      <td>
                        {% if w.is_main %}<span class="badge bg-warning text-dark">–û—Å–Ω–æ–≤–Ω–æ–π</span>{% endif %}
                        {% if w.is_active %}<span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>{% else %}<span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>{% endif %}
                      </td>
                      <td>
                        <form method="post" action="/bot_control/wallets/" style="display:inline-block;">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="toggle_active" />
                          <input type="hidden" name="id" value="{{ w.id }}" />
                          <button class="btn btn-sm btn-outline-primary" type="submit">{% if w.is_active %}–í—ã–∫–ª—é—á–∏—Ç—å{% else %}–í–∫–ª—é—á–∏—Ç—å{% endif %}</button>
                        </form>
                        {% if not w.is_main %}
                        <form method="post" action="/bot_control/wallets/" style="display:inline-block; margin-left:6px;">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="set_main" />
                          <input type="hidden" name="id" value="{{ w.id }}" />
                          <button class="btn btn-sm btn-outline-warning" type="submit">–°–¥–µ–ª–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–º</button>
                        </form>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
                <div class="text-muted">–ù–µ—Ç –∫–æ—à–µ–ª—å–∫–æ–≤ Bakai</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col" style="flex:1; min-width:320px;">
          <div class="card" style="border-color:#e8f5e9;">
            <div class="card-header" style="background:#e8f5e9;"><strong>Optima</strong></div>
            <div class="card-body">
              {% if groups.optima and groups.optima|length %}
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                      <th>–†–µ–∫–≤–∏–∑–∏—Ç</th>
                      <th>–°–æ–∑–¥–∞–Ω</th>
                      <th>–°—Ç–∞—Ç—É—Å—ã</th>
                      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for w in groups.optima %}
                    <tr>
                      <td>{{ w.account_name }}</td>
                      <td style="max-width:320px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="{{ w.hash_value }}">{{ w.hash_value }}</td>
                      <td>{{ w.created_at|date:'Y-m-d H:i:s' }}</td>
                      <td>
                        {% if w.is_main %}<span class="badge bg-warning text-dark">–û—Å–Ω–æ–≤–Ω–æ–π</span>{% endif %}
                        {% if w.is_active %}<span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>{% else %}<span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>{% endif %}
                      </td>
                      <td>
                        <form method="post" action="/bot_control/wallets/" style="display:inline-block;">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="toggle_active" />
                          <input type="hidden" name="id" value="{{ w.id }}" />
                          <button class="btn btn-sm btn-outline-primary" type="submit">{% if w.is_active %}–í—ã–∫–ª—é—á–∏—Ç—å{% else %}–í–∫–ª—é—á–∏—Ç—å{% endif %}</button>
                        </form>
                        {% if not w.is_main %}
                        <form method="post" action="/bot_control/wallets/" style="display:inline-block; margin-left:6px;">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="set_main" />
                          <input type="hidden" name="id" value="{{ w.id }}" />
                          <button class="btn btn-sm btn-outline-warning" type="submit">–°–¥–µ–ª–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–º</button>
                        </form>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
                <div class="text-muted">–ù–µ—Ç –∫–æ—à–µ–ª—å–∫–æ–≤ Optima</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
{% endblock %}
