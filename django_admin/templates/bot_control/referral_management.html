{% extends 'dashboard/base_mobile.html' %}

{% block title %}–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-white mb-2">ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h1>
        <p class="text-white/70">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π</p>
    </div>

    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="card text-center">
            <div class="text-2xl font-bold text-blue-400" id="active-referrers">0</div>
            <div class="text-sm text-white/70">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤</div>
        </div>
        <div class="card text-center">
            <div class="text-2xl font-bold text-green-400" id="total-referrals">0</div>
            <div class="text-sm text-white/70">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
        </div>
        <div class="card text-center">
            <div class="text-2xl font-bold text-yellow-400" id="total-paid">0</div>
            <div class="text-sm text-white/70">–í—ã–ø–ª–∞—á–µ–Ω–æ</div>
        </div>
        <div class="card text-center">
            <div class="text-2xl font-bold text-green-400" id="pending-payments">0</div>
            <div class="text-sm text-white/70">–û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—ã</div>
        </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã -->
    <div class="card space-y-4 mb-6">
        <h2 class="text-lg font-semibold text-white">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-white font-medium mb-2">–í–∫–ª—é—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É</label>
                <select id="referral-enabled" class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
                    <option value="1">–í–∫–ª—é—á–µ–Ω–∞</option>
                    <option value="0">–û—Ç–∫–ª—é—á–µ–Ω–∞</option>
                </select>
            </div>
            
            <div>
                <label class="block text-white font-medium mb-2">–ü—Ä–æ—Ü–µ–Ω—Ç 1-–π —É—Ä–æ–≤–µ–Ω—å (%)</label>
                <input type="number" id="referral-percentage-level1" step="0.1" min="0" max="100" 
                       class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
            </div>
            
            <div>
                <label class="block text-white font-medium mb-2">–ü—Ä–æ—Ü–µ–Ω—Ç 2-–π —É—Ä–æ–≤–µ–Ω—å (%)</label>
                <input type="number" id="referral-percentage-level2" step="0.1" min="0" max="100" 
                       class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
            </div>
            
            <div>
                <label class="block text-white font-medium mb-2">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <input type="number" id="referral-min-deposit" step="1" min="0" 
                       class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
            </div>
            
            <div>
                <label class="block text-white font-medium mb-2">–ú–∞–∫—Å–∏–º—É–º —É—Ä–æ–≤–Ω–µ–π</label>
                <input type="number" id="referral-max-levels" step="1" min="1" max="5" 
                       class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
            </div>
            
            <div>
                <label class="block text-white font-medium mb-2">–î–µ–Ω—å –≤—ã–ø–ª–∞—Ç (—á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞)</label>
                <input type="number" id="referral-payout-day" step="1" min="1" max="31" 
                       class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
            </div>
        </div>
        
        <div class="flex gap-3">
            <button id="save-settings" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            <button id="process-payouts" class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                üí∞ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–ø–ª–∞—Ç—ã
            </button>
        </div>
    </div>

    <!-- –¢–æ–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤ -->
    <div class="card mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-white">üèÜ –¢–æ–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤</h2>
            <button id="refresh-stats" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
        
        <div id="top-referrers" class="space-y-3">
            <!-- –¢–æ–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
        </div>
    </div>

    <!-- –í—ã–ø–ª–∞—Ç—ã —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-white">üí∞ –í—ã–ø–ª–∞—Ç—ã —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</h2>
            <div class="flex gap-2">
                <select id="payment-status-filter" class="bg-gray-800 text-white p-2 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none">
                    <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending">–û–∂–∏–¥–∞—é—Ç</option>
                    <option value="paid">–í—ã–ø–ª–∞—á–µ–Ω—ã</option>
                </select>
                <button id="refresh-payments" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>
        
        <div id="payments-list" class="space-y-3">
            <!-- –í—ã–ø–ª–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
        </div>
        
        <div id="loading-payments" class="text-center py-8 hidden">
            <div class="text-white/70">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—ã–ø–ª–∞—Ç...</div>
        </div>
        
        <div id="no-payments" class="text-center py-8 hidden">
            <div class="text-white/70">–í—ã–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadReferralStats();
    loadTopReferrers();
    loadPayments();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('save-settings').addEventListener('click', saveSettings);
    document.getElementById('process-payouts').addEventListener('click', processPayouts);
    document.getElementById('refresh-stats').addEventListener('click', loadReferralStats);
    document.getElementById('refresh-payments').addEventListener('click', loadPayments);
    document.getElementById('payment-status-filter').addEventListener('change', loadPayments);
});

async function loadReferralStats() {
    try {
        const response = await fetch('/bot/referral/api/stats/');
        const data = await response.json();
        
        if (data.success) {
            updateGeneralStats(data.general_stats);
            updateSettings(data.settings);
        } else {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading referral stats:', error);
        showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    }
}

function updateGeneralStats(stats) {
    document.getElementById('active-referrers').textContent = stats.active_referrers;
    document.getElementById('total-referrals').textContent = stats.total_referrals;
    document.getElementById('total-paid').textContent = stats.total_paid.toFixed(2);
    document.getElementById('pending-payments').textContent = stats.pending_payments.toFixed(2);
}

function updateSettings(settings) {
    document.getElementById('referral-enabled').value = settings.referral_enabled || '1';
    document.getElementById('referral-percentage-level1').value = settings.referral_percentage_level1 || '5.0';
    document.getElementById('referral-percentage-level2').value = settings.referral_percentage_level2 || '2.0';
    document.getElementById('referral-min-deposit').value = settings.referral_min_deposit || '500';
    document.getElementById('referral-max-levels').value = settings.referral_max_levels || '2';
    document.getElementById('referral-payout-day').value = settings.referral_payout_day || '1';
}

async function saveSettings() {
    const settings = {
        referral_enabled: document.getElementById('referral-enabled').value,
        referral_percentage_level1: document.getElementById('referral-percentage-level1').value,
        referral_percentage_level2: document.getElementById('referral-percentage-level2').value,
        referral_min_deposit: document.getElementById('referral-min-deposit').value,
        referral_max_levels: document.getElementById('referral-max-levels').value,
        referral_payout_day: document.getElementById('referral-payout-day').value
    };
    
    try {
        const response = await fetch('/bot/referral/api/settings/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
        } else {
            showError('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        console.error('Error saving settings:', error);
        showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
    }
}

async function processPayouts() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –º–µ—Å—è—á–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã?')) {
        return;
    }
    
    try {
        const response = await fetch('/bot/referral/api/process-payouts/', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—ã–ø–ª–∞—Ç: ${data.payouts_count}`);
            loadReferralStats();
            loadPayments();
        } else {
            showError('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        console.error('Error processing payouts:', error);
        showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–ø–ª–∞—Ç');
    }
}

async function loadTopReferrers() {
    try {
        const response = await fetch('/bot/referral/api/stats/');
        const data = await response.json();
        
        if (data.success) {
            displayTopReferrers(data.top_referrers);
        }
    } catch (error) {
        console.error('Error loading top referrers:', error);
    }
}

function displayTopReferrers(referrers) {
    const container = document.getElementById('top-referrers');
    
    if (referrers.length === 0) {
        container.innerHTML = '<div class="text-white/70 text-center py-4">–¢–æ–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤ –ø—É—Å—Ç</div>';
        return;
    }
    
    container.innerHTML = referrers.map((user, index) => {
        const name = user.first_name || user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
        
        return `
            <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
                <div class="flex items-center gap-3">
                    <span class="text-lg">${medal}</span>
                    <div>
                        <div class="text-white font-semibold">${name}</div>
                        <div class="text-white/70 text-sm">@${user.username || 'N/A'}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-white font-semibold">${user.referrals_count} —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
                    <div class="text-white/70 text-sm">${user.total_earnings.toFixed(2)} —Å–æ–º</div>
                </div>
            </div>
        `;
    }).join('');
}

async function loadPayments() {
    const status = document.getElementById('payment-status-filter').value;
    
    showLoadingPayments();
    
    try {
        const response = await fetch(`/bot/referral/api/payments/?status=${status}`);
        const data = await response.json();
        
        if (data.success) {
            displayPayments(data.payments);
        } else {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–ø–ª–∞—Ç: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading payments:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–ø–ª–∞—Ç');
    }
}

function displayPayments(payments) {
    const container = document.getElementById('payments-list');
    const loading = document.getElementById('loading-payments');
    const noPayments = document.getElementById('no-payments');
    
    loading.classList.add('hidden');
    
    if (payments.length === 0) {
        noPayments.classList.remove('hidden');
        container.innerHTML = '';
        return;
    }
    
    noPayments.classList.add('hidden');
    
    container.innerHTML = payments.map(payment => {
        const statusColors = {
            'pending': 'text-yellow-400',
            'paid': 'text-green-400'
        };
        
        const statusText = {
            'pending': '–û–∂–∏–¥–∞–µ—Ç',
            'paid': '–í—ã–ø–ª–∞—á–µ–Ω–æ'
        };
        
        const referrerName = payment.referrer_first_name || payment.referrer_username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        const referredName = payment.referred_first_name || payment.referred_username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        
        return `
            <div class="border border-gray-700 rounded-lg p-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-sm ${statusColors[payment.status]}">${statusText[payment.status]}</span>
                            <span class="text-sm text-white/70">–£—Ä–æ–≤–µ–Ω—å ${payment.level}</span>
                        </div>
                        <div class="text-sm text-white/70 space-y-1">
                            <div>–†–µ—Ñ–µ—Ä–µ—Ä: ${referrerName}</div>
                            <div>–†–µ—Ñ–µ—Ä–∞–ª: ${referredName}</div>
                            <div>–°—É–º–º–∞: ${payment.amount} —Å–æ–º (${payment.percentage}%)</div>
                            <div>–°–æ–∑–¥–∞–Ω–∞: ${new Date(payment.created_at).toLocaleString()}</div>
                            ${payment.paid_at ? `<div>–í—ã–ø–ª–∞—á–µ–Ω–∞: ${new Date(payment.paid_at).toLocaleString()}</div>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-white">${payment.amount} —Å–æ–º</div>
                        <div class="text-sm text-white/70">${payment.percentage}%</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function showLoadingPayments() {
    document.getElementById('loading-payments').classList.remove('hidden');
    document.getElementById('no-payments').classList.add('hidden');
}

function showError(message) {
    alert('–û—à–∏–±–∫–∞: ' + message);
}

function showSuccess(message) {
    alert('–£—Å–ø–µ—Ö: ' + message);
}
</script>
{% endblock %}

