{% extends 'base.html' %}
{% load static %}

{% block title %}Лимиты и балансы{% endblock %}
{% block header_icon %}wallet{% endblock %}
{% block header_title %}Лимиты{% endblock %}
{% block header_subtitle %}Лимиты и балансы платформ{% endblock %}

{% block content %}
<style>
  .card { border-radius: 14px !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%) !important; backdrop-filter: blur(10px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 4px 16px rgba(0, 0, 0, 0.3); }
  .section-title { font-weight: 700; font-size: 18px; margin: 8px 0 12px; }
  .muted { color: #9aa7bd; font-size: 12px; }
  .block { background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%); border:1px solid rgba(255, 255, 255, 0.2); border-radius:12px; padding:14px; margin-bottom:12px; backdrop-filter: blur(10px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
  .row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:6px 0; }
  .name { color:#ffffff; }
  .value { color:#22c55e; font-weight:700; }
  .pill { display:inline-block; padding:6px 10px; background:#151515; border:1px solid #2a2a2a; border-radius:10px; color:#c9c9c9; font-size:12px; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .stat-label { color:#9aa7bd; font-size:12px; margin-bottom: 4px; }
  .stat-value { color:#22c55e; font-weight:700; font-size:20px; margin-bottom: 4px; }
  .stat-small { font-size:11px; color:#9aa7bd; margin-top: 4px; }
  .small { font-size:11px; color:#9aa7bd; }
  .stat-card-item { background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%); border:1px solid rgba(255, 255, 255, 0.2); border-radius:12px; padding:16px; backdrop-filter: blur(10px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
  .income-card { background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.1) 100%); border:1px solid rgba(34, 197, 94, 0.3); }
  .actions { display:flex; gap:8px; }
  input[type=date] { background:#0f0f0f; color:#e5e7eb; border:1px solid #2a2a2a; border-radius:8px; padding:8px 10px; }
  button.apply { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color:#ffffff; border:1px solid rgba(34, 197, 94, 0.6); border-radius:8px; padding:8px 12px; cursor:pointer; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
  button.apply:hover { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4); }
</style>


<div class="block">
  <div class="section-title">Период (от — до)</div>
  <form id="period-form" class="actions" method="get">
    <input type="hidden" name="start" id="start-hidden" value="{{ start }}" />
    <input type="hidden" name="end" id="end-hidden" value="{{ end }}" />
    <input
      type="text"
      id="date-range"
      placeholder="ГГГГ-ММ-ДД — ГГГГ-ММ-ДД"
      style="flex:1; background:#0f0f0f; color:#e5e7eb; border:1px solid #2a2a2a; border-radius:8px; padding:8px 10px;"
    />
    <button class="apply" type="submit">Применить</button>
  </form>
  <div class="small" style="margin-top:6px;">Оставьте пустым, чтобы показать все время</div>
</div>

<div class="block">
  <div class="section-title">Лимиты платформ</div>
  {% for p in platform_limits %}
  <div class="row">
    <div class="name">{{ p.name }}</div>
    <div class="value">{{ p.limit|floatformat:2 }} с</div>
  </div>
  {% empty %}
  <div class="muted" style="background: transparent; color: #cccccc;">Нет данных по лимитам</div>
  {% endfor %}
</div>

<!-- Статистика -->
<div class="block">
  <div class="section-title">Общая статистика</div>
  <div class="grid-2" style="margin-top: 12px;">
    <!-- Всего пополнений -->
    <div class="stat-card-item">
      <div class="stat-label">Всего пополнений</div>
      <div class="stat-value">{{ total_deposits_sum|floatformat:2 }} с</div>
      <div class="stat-small">{{ total_deposits_count }} операций</div>
    </div>
    <!-- Всего выводов -->
    <div class="stat-card-item">
      <div class="stat-label">Всего выводов</div>
      <div class="stat-value">{{ total_withdrawals_sum|floatformat:2 }} с</div>
      <div class="stat-small">{{ total_withdrawals_count }} операций</div>
    </div>
    <!-- Сумма пополнений -->
    <div class="stat-card-item">
      <div class="stat-label">Сумма пополнений</div>
      <div class="stat-value">{{ total_deposits_sum|floatformat:2 }} с</div>
    </div>
    <!-- Сумма выводов -->
    <div class="stat-card-item">
      <div class="stat-label">Сумма выводов</div>
      <div class="stat-value">{{ total_withdrawals_sum|floatformat:2 }} с</div>
    </div>
  </div>
</div>

<!-- Приблизительный доход -->
<div class="block income-card">
  <div class="section-title">Приблизительный доход</div>
  <div class="stat-value" style="margin-top: 8px;">{{ approximate_income|floatformat:2 }} с</div>
  <div class="stat-small" style="margin-top: 4px;">8% от пополнений + 2% от выводов</div>
</div>

<!-- График -->
<div class="block">
  <div class="section-title">График операций</div>
  <div style="margin-top: 16px;">
    <canvas id="operations-chart" width="400" height="200"></canvas>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let operationsChart;

(function() {
  const form = document.getElementById('period-form');
  const rangeInput = document.getElementById('date-range');
  const startH = document.getElementById('start-hidden');
  const endH = document.getElementById('end-hidden');

  // Инициализация из контекста
  const s = (startH && startH.value) ? startH.value : '';
  const e = (endH && endH.value) ? endH.value : '';
  if (rangeInput) {
    rangeInput.value = (s || e) ? `${s || ''} — ${e || ''}` : '';
  }

  function parseRange(val) {
    // Допускаем разделители: "—", "-", "to", "до"
    if (!val) return {start:'', end:''};
    const parts = String(val).split(/\s*[—\-–toдо]+\s*/i).filter(Boolean);
    const start = (parts[0] || '').trim();
    const end = (parts[1] || '').trim();
    return { start, end };
  }

  if (form) {
    form.addEventListener('submit', function() {
      const { start, end } = parseRange(rangeInput.value);
      if (startH) startH.value = start;
      if (endH) endH.value = end;
    });
  }

  // ===== Подключаем Flatpickr (календарь диапазона) через CDN и инициализируем =====
  function loadCSS(href) {
    return new Promise((resolve) => {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = href;
      link.onload = resolve;
      document.head.appendChild(link);
    });
  }
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      document.body.appendChild(s);
    });
  }

  const startVal = s || '';
  const endVal = e || '';

  loadCSS('https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css')
    .then(() => loadScript('https://cdn.jsdelivr.net/npm/flatpickr'))
    .then(() => loadScript('https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js'))
    .then(() => {
      if (!window.flatpickr || !rangeInput) return;
      const opts = {
        mode: 'range',
        dateFormat: 'Y-m-d',
        altInput: true,
        altFormat: 'd.m.Y',
        locale: (window.flatpickr && window.flatpickr.l10ns && window.flatpickr.l10ns.ru) ? window.flatpickr.l10ns.ru : 'ru',
        defaultDate: (startVal || endVal) ? [startVal || null, endVal || null] : undefined,
        onChange: function(selectedDates, dateStr) {
          // dateStr в формате 'YYYY-MM-DD to YYYY-MM-DD'
          const parts = String(dateStr).split(/\s*to\s*/i).filter(Boolean);
          const a = parts[0] || '';
          const b = parts[1] || '';
          if (startH) startH.value = a;
          if (endH) endH.value = b;
        },
        onClose: function(selectedDates, dateStr) {
          const parts = String(dateStr).split(/\s*to\s*/i).filter(Boolean);
          const a = parts[0] || '';
          const b = parts[1] || '';
          if (startH) startH.value = a;
          if (endH) endH.value = b;
        }
      };
      window.flatpickr(rangeInput, opts);
    })
    .catch(() => {/* проглатываем, останется текстовый ввод */});

  // Инициализация графика
  const ctx = document.getElementById('operations-chart');
  if (ctx) {
    const labels = JSON.parse('{{ chart_labels_json|escapejs }}');
    const depositsData = JSON.parse('{{ chart_deposits_json|escapejs }}');
    const withdrawalsData = JSON.parse('{{ chart_withdrawals_json|escapejs }}');
    
    operationsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Пополнения',
          data: depositsData,
          borderColor: '#00ff88',
          backgroundColor: 'rgba(0, 255, 136, 0.1)',
          tension: 0.4,
          fill: true
        }, {
          label: 'Выводы',
          data: withdrawalsData,
          borderColor: '#ffaa00',
          backgroundColor: 'rgba(255, 170, 0, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#ffffff'
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#cccccc'
            },
            grid: {
              color: '#333333'
            }
          },
          y: {
            ticks: {
              color: '#cccccc'
            },
            grid: {
              color: '#333333'
            }
          }
        }
      }
    });
    
    // Устанавливаем высоту canvas
    ctx.parentElement.style.height = '250px';
  }
})();
</script>
{% endblock %}
