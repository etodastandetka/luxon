{% extends 'base.html' %}
{% load static %}

{% block title %}Чат{% endblock %}
{% block header_icon %}comments{% endblock %}
{% block header_title %}Чат{% endblock %}
{% block header_subtitle %}{% endblock %}

{% block content %}
<style>
  .chat-wrap { display:flex; flex-direction:column; height:calc(100vh - 110px); gap:10px; padding: 0 10px 8px; background: transparent; }
  .chat-head { display:flex; align-items:center; justify-content:space-between; padding:6px 2px; }
  .chat-board { flex:1; overflow:auto; border:none; border-radius:0; padding:14px; background:#0a0a0a; box-shadow:none; margin:0; }
  /* Scrollbar (Firefox) */
  .chat-board { scrollbar-width: thin; scrollbar-color: #22c55e #0a0a0a; }
  /* Scrollbar (WebKit) */
  .chat-board::-webkit-scrollbar { width: 10px; }
  .chat-board::-webkit-scrollbar-track { background:#0a0a0a; border-radius:8px; border:1px solid #1f1f1f; }
  .chat-board::-webkit-scrollbar-thumb { background:linear-gradient(180deg,#22c55e,#16a34a); border-radius:8px; border:2px solid #0a0a0a; }
  .chat-board:hover::-webkit-scrollbar-thumb { background:linear-gradient(180deg,#2dd286,#18b06f); }
  .chat-row { display:flex; margin:10px 0; }
  .chat-msg { max-width:78%; padding:12px 14px; border-radius:18px; font-size:14px; line-height:1.5; box-shadow: 0 2px 8px rgba(0,0,0,.35); word-wrap:break-word; }
  .chat-msg--in { background:#171a1f; color:#e6e8ee; border:1px solid #242932; border-top-left-radius:6px; }
  .chat-msg--out { background:linear-gradient(135deg,#0fa36b,#0b7f55); color:#eafff6; border:1px solid #14cf86; border-top-right-radius:6px; margin-left:auto; }
  .chat-input { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #1f1f1f; border-radius:14px; background:#0e0f10; position:sticky; bottom:0; z-index:2; box-shadow: 0 -2px 14px rgba(0,0,0,.35); }
  .chat-input input[type="text"] { flex:1; background:#0a0b0c; border:1px solid #23262d; color:#e8f0ff; border-radius:12px; padding:12px 14px; outline:none; box-shadow: inset 0 1px 0 rgba(255,255,255,.03); }
  .chat-input input[type="text"]::placeholder { color:#77809a; }
  .attach-btn { display:inline-flex; align-items:center; justify-content:center; width:42px; height:42px; border:1px dashed #2a2f3a; border-radius:12px; background:#0f1114; color:#91b9ff; transition:.2s; }
  .attach-btn:hover { border-color:#3a4252; color:#b6d0ff; transform:translateY(-1px); }
  .send-btn { width:42px; height:42px; padding:0; border:none; border-radius:12px; background:linear-gradient(135deg,#2dd286,#18b06f); color:#04160d; font-weight:700; letter-spacing:.2px; cursor:pointer; box-shadow: 0 6px 18px rgba(24,176,111,.25), inset 0 1px 0 rgba(255,255,255,.12); transition:.15s; display:inline-flex; align-items:center; justify-content:center; }
  .send-btn:hover { filter:brightness(1.05); transform: translateY(-1px); }
  .send-btn i { color:#042015; }
  .thumb { max-width:66%; border-radius:12px; border:1px solid #2a2a2a; }
  .typing { color:#9aa4b2; font-size:12px; padding:0 6px; }
</style>

<div class="chat-wrap">
  <div id="board" class="chat-board">
    <div id="empty" style="color:#7a869a; font-size:12px;">История пуста…</div>
  </div>
  <div id="typing" class="typing" style="display:none">Печатает…</div>
  <div class="chat-input">
    <button id="attach" class="attach-btn" title="Прикрепить"><i class="fas fa-paperclip"></i></button>
    <input id="text" placeholder="Написать сообщение" type="text">
    <button id="send" class="send-btn" title="Отправить"><i class="fas fa-paper-plane"></i></button>
  </div>
  <input id="file" type="file" accept="image/*,video/*" style="display:none" />
</div>

{% block extra_js %}
<script>
(function(){
  const HISTORY_URL = '{% url "bot_control:chat_history" user.user_id %}';
  const SEND_URL = '{% url "bot_control:chat_send_from_admin" %}';
  const TYPING_URL = '{% url "bot_control:chat_typing_from_admin" %}';
  function getCookie(name){ const v = `; ${document.cookie}`; const p = v.split(`; ${name}=`); if(p.length===2) return p.pop().split(';').shift(); }
  function setTypingVisible(show){ const el=document.getElementById('typing'); if(!el) return; el.style.display = show ? 'block' : 'none'; }
  let lastTypingSent = 0; let typingHideTimer = null;
  function pingTyping(action='typing'){
    const now = Date.now();
    if(now - lastTypingSent < 1500) return;
    lastTypingSent = now;
    setTypingVisible(true);
    try{ fetch(TYPING_URL,{method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')||''}, body: JSON.stringify({'user_id': {{ user.user_id }}, 'action': action})}); }catch(e){}
    if(typingHideTimer) clearTimeout(typingHideTimer);
    typingHideTimer = setTimeout(()=> setTypingVisible(false), 3000);
  }
  function add(msg){
    const b = document.getElementById('board');
    const e = document.getElementById('empty'); if(e) e.style.display='none';
    const row = document.createElement('div'); row.className='chat-row';
    const div = document.createElement('div');
    const sideClass = (msg.direction==='out' ? 'chat-msg--out':'chat-msg--in');
    div.className = 'chat-msg ' + sideClass;
    const kind = msg.kind || 'text';
    if(kind === 'photo' && msg.media_url){
      const img = document.createElement('img');
      img.src = msg.media_url; img.alt = msg.message||''; img.className='thumb';
      div.innerHTML = '';
      div.appendChild(img);
      if(msg.message){ const cap=document.createElement('div'); cap.style.marginTop='6px'; cap.textContent=msg.message; div.appendChild(cap); }
    } else if(kind === 'video' && msg.media_url){
      const vid = document.createElement('video'); vid.src = msg.media_url; vid.controls = true; vid.className='thumb';
      div.innerHTML = '';
      div.appendChild(vid);
      if(msg.message){ const cap=document.createElement('div'); cap.style.marginTop='6px'; cap.textContent=msg.message; div.appendChild(cap); }
    } else {
      div.textContent = msg.message;
    }
    row.appendChild(div); b.appendChild(row); b.scrollTop = b.scrollHeight;
  }

  async function sendMedia(file){
    if(!file) return;
    const t=document.getElementById('text');
    const caption=(t.value||'').trim();
    const isPhoto = file.type && file.type.startsWith('image/');
    const isVideo = file.type && file.type.startsWith('video/');
    if(!isPhoto && !isVideo){ alert('Поддерживаются только фото и видео'); return; }
    // optimistic preview
    add({direction:'out', message: caption, kind: isPhoto ? 'photo' : 'video', media_url: URL.createObjectURL(file)});
    const form = new FormData();
    form.append('user_id', String({{ user.user_id }}));
    form.append('media_type', isPhoto ? 'photo' : 'video');
    form.append('caption', caption);
    form.append('file', file, file.name || (isPhoto ? 'photo.jpg' : 'video.mp4'));
    try{
      const r = await fetch('{% url "bot_control:chat_send_media_from_admin" %}', { method:'POST', body: form, credentials:'same-origin' });
      const d = await r.json().catch(()=>({success:false,error:'bad response'}));
      if(!r.ok || !d.success){ alert((d && d.error) || 'Ошибка отправки медиа'); }
    }catch(e){
      alert('Ошибка сети при отправке медиа');
    } finally {
      scrollToBottom();
      load();
    }
  }
  function scrollToBottom(){
    try{
      const b=document.getElementById('board'); if(b){ b.scrollTop = b.scrollHeight; }
      window.requestAnimationFrame(()=>{ window.scrollTo({ top: document.body.scrollHeight, behavior: 'auto' }); });
    }catch(e){}
  }
  async function load(){
    try{
      const r=await fetch(HISTORY_URL,{credentials:'same-origin'});
      if(!r.ok) return; const d=await r.json(); if(!d.success) return;
      const b=document.getElementById('board'); b.innerHTML='';
      if(!d.items||!d.items.length){ document.getElementById('empty').style.display='block'; scrollToBottom(); return; }
      d.items.forEach(add);
      scrollToBottom();
    }catch(e){}
  }
  async function send(){
    const t=document.getElementById('text');
    const v=(t.value||'').trim(); if(!v) return;
    t.value='';
    add({direction:'out', message:v});
    try{
      const r = await fetch(SEND_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')||''},
        body:JSON.stringify({'user_id': {{ user.user_id }}, 'message': v})
      });
      const d = await r.json().catch(()=>({success:false,error:'bad response'}));
      if(!r.ok || !d.success){
        alert((d && (d.error||d.message)) || 'Ошибка отправки');
      }
    }catch(e){
      alert('Ошибка сети при отправке');
    } finally {
      // Обновим историю, чтобы зафиксировать итоговое состояние
      load();
      setTypingVisible(false);
    }
  }

  document.addEventListener('DOMContentLoaded',()=>{
    load();
    document.getElementById('send').addEventListener('click', send);
    const inputEl = document.getElementById('text');
    try{ inputEl.focus(); }catch(e){}
    inputEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter') send(); else pingTyping('typing'); });
    inputEl.addEventListener('input',()=>{ if(inputEl.value.trim()) pingTyping('typing'); });
    document.getElementById('attach').addEventListener('click', ()=> document.getElementById('file').click());
    document.getElementById('file').addEventListener('change', (e)=>{ const f=e.target.files && e.target.files[0]; if(f){ const kind = f.type && f.type.startsWith('video/') ? 'upload_video' : 'upload_photo'; pingTyping(kind); } sendMedia(f); e.target.value=''; });
    setInterval(load, 4000);
    // Дополнительно прокрутим страницу к низу, чтобы панель ввода была видна сразу
    scrollToBottom();
  });
})();
</script>
{% endblock %}

{% endblock %}
