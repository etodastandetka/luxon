{% extends 'base.html' %}

{% block title %}Заявки на вывод{% endblock %}

{% block header_icon %}money-bill-wave{% endblock %}
{% block header_title %}Заявки на вывод{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <!-- Фильтры -->
            <div class="card border-0 mb-3">
                <div class="card-body p-3">
                    <form method="get" class="row g-2">
                        <div class="col-md-3">
                            <select name="status" id="status" class="form-select form-select-sm">
                                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Все статусы</option>
                                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Ожидает</option>
                                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Завершено</option>
                                <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Отклонено</option>
                            </select>
                        </div>
                        <div class="col-md-7">
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="search" name="search" 
                                       placeholder="Поиск по ID или сумме" value="{{ search_query|default:'' }}">
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <a href="{% url 'dashboard:withdrawals_list' %}" class="btn btn-outline-secondary btn-sm w-100">
                                <i class="fas fa-sync-alt"></i>
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Статистика -->
            <div class="d-flex gap-2 mb-3">
                <span class="badge bg-light text-dark">Всего: {{ stats.total }}</span>
                <span class="badge bg-warning text-dark">Ожидают: {{ stats.pending }}</span>
                <span class="badge bg-success text-white">Завершено: {{ stats.completed }}</span>
                <span class="badge bg-danger text-white">Отклонено: {{ stats.rejected }}</span>
            </div>

            <!-- Таблица заявок -->
            <div class="card border-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th class="ps-3" style="width: 80px;">ID</th>
                                <th>Пользователь</th>
                                <th class="text-end" style="width: 120px;">Сумма</th>
                                <th class="text-center" style="width: 100px;">Дата</th>
                                <th class="text-center" style="width: 120px;">Статус</th>
                                <th class="text-end pe-3" style="width: 80px;"></th>
                            </tr>
                        </thead>
                            <tbody>
                                {% for req in page_obj %}
                                <tr class="request-row" data-id="{{ req.id }}" data-status="{{ req.status }}">
                                    <td class="ps-3">
                                        <div class="text-muted small">#{{ req.id }}</div>
                                        <div class="text-muted small">{{ req.user_id }}</div>
                                    </td>
                                    <td>
                                        <div class="fw-medium">ID {{ req.user_id }}</div>
                                        <div class="text-muted small">{{ req.created_at|date:"d.m.Y H:i" }}</div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-medium">{{ req.amount|floatformat:2 }} ₽</div>
                                    </td>
                                    <td class="text-center">
                                        <div class="small">{{ req.created_at|date:"d.m.Y" }}</div>
                                        <div class="text-muted small">{{ req.created_at|date:"H:i" }}</div>
                                    </td>
                                    <td class="text-center">
                                        {% if req.status == 'pending' %}
                                            <span class="badge bg-warning text-dark">Ожидает</span>
                                        {% elif req.status == 'completed' %}
                                            <span class="badge bg-success">Завершено</span>
                                        {% elif req.status == 'rejected' %}
                                            <span class="badge bg-danger">Отклонено</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ req.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end pe-3">
                                        {% if req.status == 'pending' %}
                                            <button class="btn btn-sm btn-outline-success me-1" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#approveModal"
                                                    data-id="{{ req.id }}"
                                                    title="Подтвердить">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#rejectModal"
                                                    data-id="{{ req.id }}"
                                                    title="Отклонить">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-secondary" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#detailsModal"
                                                    data-id="{{ req.id }}"
                                                    title="Просмотр">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="py-2">
                                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                            <p class="mb-2">Заявки не найдены</p>
                                            <a href="{% url 'dashboard:withdrawals_list' %}" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-sync-alt"></i> Сбросить
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Пагинация -->
                {% if page_obj.has_other_pages %}
                <div class="card-footer">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                                            {{ num }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения вывода -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтвердить заявку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="approveForm" method="post" action="">
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" id="txHash" name="tx_hash" 
                           placeholder="Хеш транзакции (необязательно)">
                </div>
                <div class="modal-footer p-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-sm btn-success">Подтвердить</button>
                </div>
                {% csrf_token %}
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно отклонения заявки -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Отклонить заявку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="rejectForm" method="post" action="">
                <div class="modal-body">
                    <textarea class="form-control" id="rejectReason" name="reason" 
                             rows="2" placeholder="Причина отклонения" required></textarea>
                </div>
                <div class="modal-footer p-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-sm btn-danger">Отклонить</button>
                </div>
                {% csrf_token %}
            </form>
        </div>
    </div>
</div>
{% block extra_js %}
<script>
$(document).ready(function() {
    
    // Обработка отправки форм
    $('#approveForm, #rejectForm').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var action = form.attr('action');
        var data = form.serialize();
        var method = form.attr('method');
        var modal = form.closest('.modal');
        
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                modal.modal('hide');
                location.reload();
            },
            error: function(xhr) {
                alert('Произошла ошибка. Пожалуйста, попробуйте снова.');
            }
        });
    });
                            <h6>Информация о пользователе</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>ID:</th>
                                    <td>${response.user_id}</td>
                                </tr>
                                <tr>
                                    <th>Имя:</th>
                                    <td>${response.first_name || 'Не указано'}</td>
                                </tr>
                                <tr>
                                    <th>Username:</th>
                                    <td>${response.username ? '@' + response.username : 'Не указан'}</td>
                                </tr>
                                <tr>
                                    <th>Телефон:</th>
                                    <td>${response.phone_number || 'Не указан'}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Детали заявки</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Сумма:</th>
                                    <td>${response.amount} ${response.currency || 'RUB'}</td>
                                </tr>
                                <tr>
                                    <th>Способ вывода:</th>
                                    <td>${response.payment_method || 'Не указан'}</td>
                                </tr>
                                <tr>
                                    <th>Статус:</th>
                                    <td>${getStatusBadge(response.status)}</td>
                                </tr>
                                <tr>
                                    <th>Создано:</th>
                                    <td>${new Date(response.created_at).toLocaleString()}</td>
                                </tr>
                                ${response.processed_at ? `
                                    <tr>
                                        <th>Обработано:</th>
                                        <td>${new Date(response.processed_at).toLocaleString()}</td>
                                    </tr>
                                ` : ''}
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Реквизиты для вывода</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <pre class="mb-0">${response.wallet_details}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${response.admin_comment ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Комментарий администратора</h6>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <p class="mb-0">${response.admin_comment}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    ${response.tx_hash ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Хеш транзакции</h6>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <code>${response.tx_hash}</code>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                detailsDiv.html(html);
            },
            error: function(xhr, status, error) {
                detailsDiv.html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Ошибка при загрузке данных: ${xhr.responseJSON?.error || error}
                    </div>
                `);
            }
        });
    });
    
    // Обработка подтверждения вывода
    $('#approveModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var requestId = button.data('id');
        var form = $('#approveForm');
        form.attr('action', `/api/withdrawal-requests/${requestId}/approve/`);
    });
    
    $('#approveForm').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var submitBtn = form.find('button[type="submit"]');
        var originalText = submitBtn.html();
        
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Обработка...');
        
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    showAlert('success', 'Заявка успешно подтверждена');
                    $('#approveModal').modal('hide');
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert('danger', response.error || 'Произошла ошибка');
                    submitBtn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr) {
                var error = xhr.responseJSON?.error || 'Ошибка сервера';
                showAlert('danger', error);
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });
    
    // Обработка отклонения заявки
    $('#rejectModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var requestId = button.data('id');
        var form = $('#rejectForm');
        form.attr('action', `/api/withdrawal-requests/${requestId}/reject/`);
        form[0].reset();
    });
    
    $('#rejectForm').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var submitBtn = form.find('button[type="submit"]');
        var originalText = submitBtn.html();
        
        if (!form[0].checkValidity()) {
            form[0].reportValidity();
            return;
        }
        
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Обработка...');
        
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    showAlert('success', 'Заявка отклонена');
                    $('#rejectModal').modal('hide');
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert('danger', response.error || 'Произошла ошибка');
                    submitBtn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr) {
                var error = xhr.responseJSON?.error || 'Ошибка сервера';
                showAlert('danger', error);
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });
    
    // Вспомогательные функции
    function getStatusBadge(status) {
        const statusMap = {
            'pending': { class: 'warning', text: 'Ожидает' },
            'completed': { class: 'success', text: 'Завершено' },
            'rejected': { class: 'danger', text: 'Отклонено' },
            'processing': { class: 'info', text: 'В обработке' }
        };
        
        const statusInfo = statusMap[status] || { class: 'secondary', text: status };
        return `<span class="badge bg-${statusInfo.class}">${statusInfo.text}</span>`;
    }
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // Удаляем существующие алерты
        $('.alert-dismissible').alert('close');
        
        // Добавляем новый алерт
        $('.container-fluid').prepend(alertHtml);
        
        // Автоматически скрываем через 5 секунд
        setTimeout(() => {
            $('.alert-dismissible').alert('close');
        }, 5000);
    }
});
</script>
{% endblock %}
