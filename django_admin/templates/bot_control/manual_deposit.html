{% extends 'base.html' %}

{% block title %}Ручной депозит - Админ Панель{% endblock %}

{% block content %}
<!-- Статус подключения -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-plug"></i>
        </div>
        <div>
            <div class="card-title">Статус подключения</div>
            <div class="card-subtitle">Проверка API соединения</div>
        </div>
    </div>
    
    <div class="status-grid">
        <div class="status-item">
            <div class="status-icon success">
                <i class="fas fa-check"></i>
            </div>
            <div class="status-text">
                <div class="status-label">API подключен</div>
                <div class="status-value">1XBET MobCash</div>
            </div>
        </div>
        <div class="status-item">
            <div class="status-icon success">
                <i class="fas fa-check"></i>
            </div>
            <div class="status-text">
                <div class="status-label">Аутентификация</div>
                <div class="status-value">Активна</div>
            </div>
        </div>
    </div>
</div>

<!-- Поиск игрока -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-search"></i>
        </div>
        <div>
            <div class="card-title">Поиск игрока</div>
            <div class="card-subtitle">Найти игрока по ID</div>
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label">ID игрока:</label>
        <input type="text" id="player-id" class="form-control" placeholder="Введите ID игрока">
    </div>
    
    <button id="search-player" class="btn btn-primary">
        <i class="fas fa-search"></i> Найти игрока
    </button>
    
    <div id="player-info" class="player-info" style="display: none;">
        <div class="player-detail">
            <div class="player-detail-icon">
                <i class="fas fa-user"></i>
            </div>
            <div class="player-detail-content">
                <div class="player-detail-label">ID игрока</div>
                <div class="player-detail-value" id="player-id-value"></div>
            </div>
        </div>
        <div class="player-detail">
            <div class="player-detail-icon">
                <i class="fas fa-id-card"></i>
            </div>
            <div class="player-detail-content">
                <div class="player-detail-label">Имя</div>
                <div class="player-detail-value" id="player-name-value"></div>
            </div>
        </div>
        <div class="player-detail">
            <div class="player-detail-icon">
                <i class="fas fa-coins"></i>
            </div>
            <div class="player-detail-content">
                <div class="player-detail-label">Валюта</div>
                <div class="player-detail-value" id="player-currency-value"></div>
            </div>
        </div>
    </div>
</div>

<!-- Пополнение счета -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-plus-circle"></i>
        </div>
        <div>
            <div class="card-title">Пополнение счета</div>
            <div class="card-subtitle">Зачислить средства на счет игрока</div>
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label">ID игрока:</label>
        <input type="text" id="deposit-player-id" class="form-control" placeholder="Введите ID игрока">
    </div>
    
    <div class="form-group">
        <label class="form-label">Сумма пополнения:</label>
        <input type="number" id="deposit-amount" class="form-control" placeholder="Введите сумму" step="0.01">
    </div>
    
    <button id="process-deposit" class="btn btn-secondary">
        <i class="fas fa-plus-circle"></i> Пополнить счет
    </button>
    
    <div id="deposit-result"></div>
</div>

<!-- Проверка баланса кассы -->
<div class="card">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-wallet"></i>
        </div>
        <div>
            <div class="card-title">Баланс кассы</div>
            <div class="card-subtitle">Текущий баланс и лимиты</div>
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label">Номер кассы:</label>
        <input type="text" id="cashdesk-id" class="form-control" placeholder="Введите номер кассы" value="5288">
    </div>
    
    <button id="check-balance" class="btn btn-primary">
        <i class="fas fa-wallet"></i> Проверить баланс
    </button>
    
    <div id="balance-result"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Поиск игрока
    document.getElementById('search-player').addEventListener('click', searchPlayer);
    
    // Пополнение счета
    document.getElementById('process-deposit').addEventListener('click', processDeposit);
    
    // Проверка баланса
    document.getElementById('check-balance').addEventListener('click', checkBalance);
});

async function searchPlayer() {
    const playerId = document.getElementById('player-id').value;
    const resultDiv = document.getElementById('player-info');
    
    if (!playerId) {
        alert('Введите ID игрока');
        return;
    }
    
    try {
        const response = await fetch('/bot/api/1xbet/search-player/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                player_id: playerId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('player-id-value').textContent = data.userId;
            document.getElementById('player-name-value').textContent = data.name;
            document.getElementById('player-currency-value').textContent = data.currencyId;
            resultDiv.style.display = 'block';
        } else {
            alert('Игрок не найден: ' + (data.message || 'Неизвестная ошибка'));
        }
    } catch (error) {
        alert('Ошибка соединения с сервером');
    }
}

async function processDeposit() {
    const playerId = document.getElementById('deposit-player-id').value;
    const amount = document.getElementById('deposit-amount').value;
    const resultDiv = document.getElementById('deposit-result');
    
    if (!playerId || !amount) {
        alert('Заполните все поля');
        return;
    }
    
    resultDiv.innerHTML = '<div class="loading">⏳ Обработка...</div>';
    
    try {
        const response = await fetch('/bot/api/1xbet/deposit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                player_id: playerId,
                amount: parseFloat(amount)
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="result-container result-success">
                    <div class="result-title">Пополнение успешно</div>
                    <div class="result-content">
                        Сумма: ${data.summa} KGS<br>
                        Статус: Успешно
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="result-container result-error">
                    <div class="result-title">Ошибка пополнения</div>
                    <div class="result-content">${data.message || 'Неизвестная ошибка'}</div>
                </div>
            `;
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="result-container result-error">
                <div class="result-title">Ошибка соединения</div>
                <div class="result-content">Не удалось подключиться к серверу</div>
            </div>
        `;
    }
}

async function checkBalance() {
    const cashdeskId = document.getElementById('cashdesk-id').value;
    const resultDiv = document.getElementById('balance-result');
    
    if (!cashdeskId) {
        alert('Введите номер кассы');
        return;
    }
    
    resultDiv.innerHTML = '<div class="loading">⏳ Проверка...</div>';
    
    try {
        const response = await fetch('/bot/api/1xbet/balance/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                cashdesk_id: cashdeskId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="result-container result-success">
                    <div class="result-title">Баланс получен</div>
                    <div class="result-content">
                        Баланс: ${data.balance} KGS<br>
                        Лимит: ${data.limit} KGS
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="result-container result-error">
                    <div class="result-title">Ошибка получения баланса</div>
                    <div class="result-content">${data.message || 'Неизвестная ошибка'}</div>
                </div>
            `;
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="result-container result-error">
                <div class="result-title">Ошибка соединения</div>
                <div class="result-content">Не удалось подключиться к серверу</div>
            </div>
        `;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}




























