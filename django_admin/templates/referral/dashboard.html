{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h1 class="mb-3">Реферальная программа</h1>

  {% if success_message %}
  <div class="alert alert-success">{{ success_message }}</div>
  {% endif %}
  {% if error_message %}
  <div class="alert alert-danger">{{ error_message }}</div>
  {% endif %}

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Профиль</h5>
          <p><b>Telegram:</b> @{{ user.username }} {{ user.first_name }}</p>
          <p><b>ID:</b> {{ user.user_id }}</p>
          <p><b>Доступно к выводу:</b> {{ stats.available_balance }} KGS</p>
          <p class="text-muted">В ожидании вывода: {{ stats.pending_withdrawals }} KGS</p>
          <p class="text-muted">Начислено всего: {{ stats.balance }} KGS</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Реферальная ссылка</h5>
          <div class="input-group">
            <input type="text" class="form-control" value="{{ referral_link }}" readonly>
            <a class="btn btn-outline-primary" href="{{ referral_link }}" target="_blank">Открыть</a>
          </div>
          <small class="text-muted">Поделитесь ссылкой. Реферал считается активным после первого пополнения.</small>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Статистика</h5>
          <p><b>Активных рефералов:</b> {{ stats.active_referrals }}</p>
          <p><b>Сумма пополнений рефералов:</b> {{ stats.total_deposits }} KGS</p>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Вывести средства</h5>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="withdraw" />
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">Букмекер</label>
                <select name="bookmaker" class="form-select" required>
                  <option value="1xbet">1XBET</option>
                  <option value="1win">1WIN</option>
                  <option value="melbet">MELBET</option>
                  <option value="mostbet">MOSTBET</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">ID аккаунта в БК</label>
                <input type="text" name="account_id" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Сумма (KGS)</label>
                <input id="ref-amount" type="number" step="0.01" min="0" name="amount" class="form-control" required />
                <small class="text-muted">Доступно: <span id="ref-available">{{ stats.available_balance }}</span> KGS</small>
              </div>
              <div class="col-md-4">
                <label class="form-label">Способ выплаты</label>
                <select name="payment_method" class="form-select">
                  <option value="e_wallet">Электронный кошелек</option>
                  <option value="bank_card">Банковская карта</option>
                  <option value="crypto">Криптовалюта</option>
                </select>
              </div>
              <div class="col-md-8">
                <label class="form-label">Реквизиты для выплаты</label>
                <input type="text" name="wallet_details" class="form-control" placeholder="Например: MBank +996..." />
              </div>
              <div class="col-12">
                <button class="btn btn-success" type="submit">Отправить заявку</button>
              </div>
            </div>
          </form>
          <script>
          (function(){
            try {
              const max = parseFloat('{{ stats.available_balance|default:0 }}');
              const inp = document.getElementById('ref-amount');
              const form = inp && inp.form;
              if (inp) { inp.setAttribute('max', isFinite(max) ? max : 0); }
              if (form) {
                form.addEventListener('submit', function(e){
                  const v = parseFloat(inp.value||'0');
                  if (!isFinite(v) || v <= 0) {
                    e.preventDefault(); alert('Введите корректную сумму (> 0)'); return false;
                  }
                  if (isFinite(max) && v > max + 1e-6) {
                    e.preventDefault(); alert('Сумма превышает доступный баланс'); return false;
                  }
                });
              }
            } catch(e) {}
          })();
          </script>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Топ-3 за неделю</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Пользователь</th>
                  <th>Активных рефералов</th>
                  <th>Приз</th>
                </tr>
              </thead>
              <tbody>
                {% for item in leaderboard %}
                <tr>
                  <td>{{ item.position }}</td>
                  <td>{% if item.username %}@{{ item.username }}{% else %}{{ item.first_name }}{% endif %}</td>
                  <td>{{ item.active_referrals }}</td>
                  <td>{{ item.prize }} KGS</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-muted">Нет данных</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">История выводов</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Сумма</th>
                  <th>Статус</th>
                  <th>Дата</th>
                </tr>
              </thead>
              <tbody>
                {% for it in history %}
                <tr>
                  <td>{{ it.id }}</td>
                  <td>{{ it.amount }} {{ it.currency }}</td>
                  <td>
                    {% if it.status == 'completed' %}
                      <span class="badge bg-success">Выплачено</span>
                    {% elif it.status == 'pending' %}
                      <span class="badge bg-warning text-dark">Ожидает</span>
                    {% elif it.status == 'rejected' %}
                      <span class="badge bg-danger">Отклонено</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ it.status }}</span>
                    {% endif %}
                  </td>
                  <td>{{ it.created_at }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-muted">Пока нет заявок</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
