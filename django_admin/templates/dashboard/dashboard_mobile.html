{% extends 'base.html' %}
{% load static %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - Luxon{% endblock %}

{% block header_title %}–ó–∞—è–≤–∫–∏{% endblock %}
{% block header_subtitle %}–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏{% endblock %}

{% block content %}
<style>
/* Modern Dashboard Styles */
.dashboard-header {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%);
    backdrop-filter: blur(15px);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    color: #ffffff;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 4px 16px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 4px 16px rgba(0, 0, 0, 0.3);
}

.stat-card:hover {
    transform: translateY(-5px) scale(1.02);
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.5) 100%);
    border-color: rgba(34, 197, 94, 0.4);
    box-shadow: 0 16px 50px rgba(0, 0, 0, 0.6), 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 15px rgba(34, 197, 94, 0.2);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #22c55e;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 0.9rem;
    color: #cccccc;
    font-weight: 500;
}

/* Tabs */
.tabs-container { 
    display: flex; 
    gap: 8px; 
    margin-bottom: 16px; 
    background: transparent; 
    border: none; 
    box-shadow: none; 
}
.tab { 
    flex: 1; 
    padding: 8px 12px; 
    text-align: center; 
    border-radius: 12px; 
    cursor: pointer; 
    transition: all .3s ease; 
    color: #b0b0b0; 
    font-weight: 600; 
    font-size: 13px; 
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%); 
    backdrop-filter: blur(10px);
    border: 1px solid rgba(138, 43, 226, 0.2); 
}
.tab.active { 
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
    color: #ffffff; 
    border-color: rgba(34, 197, 94, 0.6); 
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); 
}
.tab:hover { 
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.5) 100%); 
    color: #e0e0e0; 
    transform: translateY(-2px);
    border-color: rgba(34, 197, 94, 0.4);
}
.tab-refresh { 
    padding: 12px; 
    border-radius: 12px; 
    cursor: pointer; 
    transition: all .3s ease; 
    color: #b0b0b0; 
    background: rgba(30, 30, 46, 0.6); 
    backdrop-filter: blur(10px);
    font-size: 16px; 
    width: 48px; 
    height: 48px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    flex-shrink: 0; 
    border: 1px solid rgba(138, 43, 226, 0.2);
}
.tab-refresh:hover { 
    background: rgba(138, 43, 226, 0.4); 
    color: #f0f0f0; 
    transform: rotate(180deg);
    border-color: rgba(138, 43, 226, 0.6);
    box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
}

/* Card list */
.list-item { 
    background: rgba(30, 30, 46, 0.6); 
    backdrop-filter: blur(10px);
    border: 1px solid rgba(138, 43, 226, 0.2); 
    border-radius: 12px; 
    padding: 12px; 
    margin-bottom: 12px; 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    transition: all 0.3s ease; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
}
.list-item:hover { 
    transform: translateY(-5px); 
    box-shadow: 0 8px 25px rgba(138, 43, 226, 0.2); 
    border-color: rgba(138, 43, 226, 0.4);
    background: rgba(74, 42, 106, 0.5);
}
.list-icon { 
    margin-right: 8px; 
    flex: 0 0 48px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    background: rgba(138, 43, 226, 0.6); 
    backdrop-filter: blur(5px);
    border-radius: 12px;
    width: 48px;
    height: 48px;
    font-size: 18px;
    color: #f0f0f0;
    border: 1px solid rgba(138, 43, 226, 0.3);
}
.list-content { 
    flex: 1; 
    min-width: 0; 
    padding-right: 12px; 
}
.list-title { 
    font-size: 14px; 
    font-weight: 600; 
    color: #f0f0f0; 
    margin-bottom: 4px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
}
.list-subtitle { 
    font-size: 12px; 
    color: #b0b0b0; 
    margin-bottom: 4px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
}

.list-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap:4px; min-width: 80px; }
.list-date { font-size: 10px; color: #b0b0b0; margin-bottom: 0; }
.list-amount { font-size: 14px; font-weight: 600; margin-bottom: 0; padding: 4px 8px; border-radius: 6px; background: #4a4a4a; color: #f0f0f0; display: inline-block; border: 1px solid #5a5a5a; }
/* Positive amounts: remove heavy green backgrounds, keep green text only */
.list-amount.positive { color: #4ade80; background: #3a3a3a; }
.list-amount.negative { color: #f87171; background: #3a3a3a; }

.list-status { display: flex; align-items: center; justify-content: flex-end; font-size: 11px; color: #b0b0b0; gap:6px; }
.status-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; }
.status-pending { background: #fbbf24; }
.status-completed { background: #4ade80; }
.status-rejected { background: #f87171; }
</style>


<!-- –§–∏–ª—å—Ç—Ä—ã: –û–∂–∏–¥–∞—é—â–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | –û—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ (—Ä—É—á–Ω—ã–µ) -->
<div class="tabs-container">
  <div id="tab-pending" class="tab active" onclick="switchStatus('pending')">–û–∂–∏–¥–∞—é—â–∏–µ</div>
  <div id="tab-left" class="tab" onclick="switchStatus('awaiting_manual')">–û—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ</div>
  <div class="tab-refresh" onclick="loadRequests()" title="–û–±–Ω–æ–≤–∏—Ç—å"><i class="fas fa-sync-alt"></i></div>
  </div>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
<div id="requests-container">
    <div style="text-align: center; color: #cccccc; padding: 20px;">
        <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStatus = 'pending'; // 'pending' | 'awaiting_manual'

document.addEventListener('DOMContentLoaded', function() {
    // –ß–∏—Ç–∞–µ–º ?status= –∏–∑ URL (awaiting_manual | pending)
    try {
      const params = new URLSearchParams(window.location.search);
      const s = (params.get('status') || '').toLowerCase();
      if (s === 'awaiting_manual' || s === 'pending') {
        currentStatus = s;
        document.getElementById('tab-pending').classList.toggle('active', currentStatus === 'pending');
        document.getElementById('tab-left').classList.toggle('active', currentStatus === 'awaiting_manual');
      }
    } catch (e) {}

    loadRequests();
    loadStats();
    setInterval(loadRequests, 30000);
    setInterval(loadStats, 60000);
});

function switchStatus(status) {
  currentStatus = status;
  document.getElementById('tab-pending').classList.toggle('active', status === 'pending');
  document.getElementById('tab-left').classList.toggle('active', status === 'awaiting_manual');
  const container = document.getElementById('requests-container');
  container.innerHTML = `<div style="text-align:center;color:#999;padding:20px;"><i class='fas fa-spinner fa-spin'></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
  loadRequests();
}

function loadStats() {
    fetch('/api/stats/')
        .then(response => response.json())
        .then(data => {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            const totalRequestsEl = document.getElementById('total-requests');
            if (totalRequestsEl) totalRequestsEl.textContent = data.total_requests || '0';
            
            const pendingRequestsEl = document.getElementById('pending-requests');
            if (pendingRequestsEl) pendingRequestsEl.textContent = data.pending_requests || '0';
            
            const completedRequestsEl = document.getElementById('completed-requests');
            if (completedRequestsEl) completedRequestsEl.textContent = data.completed_requests || '0';
            
            const totalAmountEl = document.getElementById('total-amount');
            if (totalAmountEl) totalAmountEl.textContent = (data.total_amount || '0') + ' —Å–æ–º';
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${day}.${month}.${year} ‚Ä¢ ${hours}:${minutes}`;
}

// –ï–¥–∏–Ω—ã–π –º–∞–ø–ø–µ—Ä –∏–∫–æ–Ω–æ–∫ –±–∞–Ω–∫–∞ –ø–æ–¥ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –≤ static/images
function getBankIconUrl(bankStr){
  const s = String(bankStr||'').toLowerCase();
  if (s.includes('mbank')) return '{% static "images/mbank.png" %}';
  if (s.includes('bakai')) return '{% static "images/bakai.jpg" %}'; // –¥–æ–±–∞–≤—å —Ñ–∞–π–ª –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏
  if (s.includes('optima')) return '{% static "images/optima.jpg" %}';
  if (s.includes('demir')) return '{% static "images/demirbank.jpg" %}';
  if (s.includes('megapay')) return '{% static "images/megapay.jpg" %}';
  if (s.includes('balance')) return '{% static "images/balance.jpg" %}';
  if (s.includes('o!') || s.includes('omoney') || s.includes('odengi') || s.includes('o! bank')) return '{% static "images/omoney.jpg" %}';
  return '{% static "images/companion.png" %}';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫
async function loadRequests() {
    try {
        console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏...');
        const resp = await fetch('/api/pending-requests/', { headers: { 'Cache-Control': 'no-cache' }, cache: 'no-cache' });
        const data = resp.ok ? await resp.json() : { success:false, requests: [] };

        const container = document.getElementById('requests-container');
        const items = (data.requests || []).filter(r => {
          if (currentStatus === 'awaiting_manual') return r.status === 'awaiting_manual';
          // –û–∂–∏–¥–∞—é—â–∏–µ: pending + processing
          return r.status === 'pending' || r.status === 'processing';
        });

        if (items.length > 0) {
            container.innerHTML = '';
            items.forEach(request => {
                const isDeposit = request.type === 'deposit';
                const amountColor = isDeposit ? '#00ff88' : '#ff4444';
                const amountSign = isDeposit ? '+' : '-';
                let statusClass = 'status-pending';
                if (request.status === 'rejected') statusClass = 'status-rejected';
                else if (request.status === 'completed' || request.status === 'approved' || request.status === 'auto_completed') statusClass = 'status-completed';
                else if (request.status === 'awaiting_manual') statusClass = 'status-rejected';

                const userName = request.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${request.user_id}`;
                // –ò–∫–æ–Ω–∫–∞: ELQR –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π, –±–∞–Ω–∫ –ø–æ wallet_details/bank –¥–ª—è –≤—ã–≤–æ–¥–æ–≤
                let iconSrc = '';
                if (isDeposit) {
                  iconSrc = '{% static "images/elqr.svg" %}?v=20251002';
                } else {
                  const bankText = (request.wallet_details || request.bank || '').toString();
                  iconSrc = getBankIconUrl(bankText);
                }

                const item = document.createElement('div');
                item.className = 'list-item';
                item.onclick = () => { window.location.href = `/bot/transactions/${request.id}/`; };
                const amountClass = isDeposit ? 'positive' : 'negative';
                item.innerHTML = `
                    <div class="list-icon">
                        <div style="width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                       <img src="${iconSrc}" alt="icon" style="width:56px;height:56px;object-fit:contain;background:transparent;padding:0;border:0;"
                                 onerror="this.onerror=null;this.src='{% static "images/companion.png" %}';"/>
                        </div>
                    </div>
                    <div class="list-content">
                        <div class="list-title">${userName}</div>
                        <div class="list-subtitle">${(request.bookmaker || '').toUpperCase()} ‚Ä¢ ID: ${request.user_id}</div>
                    </div>
                    <div class="list-right">
                        <div class="list-date">${formatDate(request.created_at || new Date())}</div>
                        <div class="list-amount ${amountClass}">${amountSign}${Number(request.amount || 0).toFixed(2)}</div>
                        <div class="list-status"><div class="status-dot ${statusClass}"></div><span>${request.status === 'awaiting_manual' ? '–û—Å—Ç–∞–≤–ª–µ–Ω–∞' : (request.status === 'processing' ? '–í —Ä–∞–±–æ—Ç–µ' : (request.status === 'rejected' ? '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' : (request.status === 'completed' || request.status === 'approved' || request.status === 'auto_completed' ? '–£—Å–ø–µ—à–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç')))}</span></div>
                    </div>`;
                container.appendChild(item);
            });
        } else {
            container.innerHTML = `
                <div style="text-align: center; color: #cccccc; padding: 40px; background: transparent;">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5; color: #22c55e;"></i><br>
                    <span style="color: #cccccc;">–ù–µ—Ç –∑–∞—è–≤–æ–∫</span>
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
        console.error('‚ùå –¢–∏–ø –æ—à–∏–±–∫–∏:', error.name);
        console.error('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
        
        let errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫';
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            errorMessage = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
        } else if (error.message.includes('HTTP error')) {
            errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}`;
        }
        
        document.getElementById('requests-container').innerHTML = `
            <div style="text-align: center; color: #ff4444; padding: 20px;">
                <i class="fas fa-exclamation-triangle"></i><br>
                ${errorMessage}<br>
                <small style="color: #888; margin-top: 10px; display: block;">
                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </small>
            </div>
        `;
    }
}
</script>
{% endblock %}

