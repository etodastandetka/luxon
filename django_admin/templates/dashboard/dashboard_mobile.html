{% extends 'base.html' %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - Luxon{% endblock %}

{% block header_icon %}history{% endblock %}
{% block header_title %}–ó–∞—è–≤–∫–∏{% endblock %}
{% block header_subtitle %}–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏{% endblock %}

{% block content %}
<style>
.tabs-container { display: flex; gap: 8px; margin-bottom: 16px; background: transparent; border: none; box-shadow: none; }
.tab { flex: 1; padding: 10px 14px; text-align: center; border-radius: 10px; cursor: pointer; transition: all .2s; color: #999; font-weight: 600; font-size: 13px; background: #1a1a1a; border: 1px solid #222; }
.tab.active { background: #2a2a2a; color: #fff; border-color: #444; }
.tab:hover { background: #222; color: #ccc; }
.tab-refresh { padding: 12px; border-radius: 12px; cursor: pointer; transition: all .3s; color: #999; background: transparent; font-size: 16px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.tab-refresh:hover { background: #333; color: #fff; }
.list-item { background: transparent; border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: none; border: none; transition: all .3s; }
.list-item:hover { background: #1a1a1a; }
.list-icon { margin-right: 16px; }
.list-content { flex: 1; }
.list-title { font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 4px; }
.list-subtitle { font-size: 12px; color: #999; margin-bottom: 4px; }
.list-right { text-align: right; }
.list-date { font-size: 11px; color: #999; margin-bottom: 4px; }
.list-amount { font-size: 16px; font-weight: bold; margin-bottom: 4px; }
.list-status { display: flex; align-items: center; justify-content: flex-end; font-size: 11px; color: #999; }
.status-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; }
.status-pending { background: #ffa500; }
.status-completed { background: #00ff88; }
.status-rejected { background: #ff4444; }
</style>

<!-- –§–∏–ª—å—Ç—Ä—ã: –û–∂–∏–¥–∞—é—â–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | –û—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ (—Ä—É—á–Ω—ã–µ) -->
<div class="tabs-container">
  <div id="tab-pending" class="tab active" onclick="switchStatus('pending')">–û–∂–∏–¥–∞—é—â–∏–µ</div>
  <div id="tab-left" class="tab" onclick="switchStatus('awaiting_manual')">–û—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ</div>
  <div class="tab-refresh" onclick="loadRequests()" title="–û–±–Ω–æ–≤–∏—Ç—å"><i class="fas fa-sync-alt"></i></div>
  </div>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
<div id="requests-container">
    <div style="text-align: center; color: #cccccc; padding: 20px;">
        <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStatus = 'pending'; // 'pending' | 'awaiting_manual'

document.addEventListener('DOMContentLoaded', function() {
    // –ß–∏—Ç–∞–µ–º ?status= –∏–∑ URL (awaiting_manual | pending)
    try {
      const params = new URLSearchParams(window.location.search);
      const s = (params.get('status') || '').toLowerCase();
      if (s === 'awaiting_manual' || s === 'pending') {
        currentStatus = s;
        document.getElementById('tab-pending').classList.toggle('active', currentStatus === 'pending');
        document.getElementById('tab-left').classList.toggle('active', currentStatus === 'awaiting_manual');
      }
    } catch (e) {}

    loadRequests();
    setInterval(loadRequests, 30000);
});

function switchStatus(status) {
  currentStatus = status;
  document.getElementById('tab-pending').classList.toggle('active', status === 'pending');
  document.getElementById('tab-left').classList.toggle('active', status === 'awaiting_manual');
  const container = document.getElementById('requests-container');
  container.innerHTML = `<div style="text-align:center;color:#999;padding:20px;"><i class='fas fa-spinner fa-spin'></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
  loadRequests();
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${day}.${month}.${year} ‚Ä¢ ${hours}:${minutes}`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫
async function loadRequests() {
    try {
        console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏...');
        const resp = await fetch('/api/pending-requests/', { headers: { 'Cache-Control': 'no-cache' }, cache: 'no-cache' });
        const data = resp.ok ? await resp.json() : { success:false, requests: [] };

        const container = document.getElementById('requests-container');
        const items = (data.requests || []).filter(r => {
          if (currentStatus === 'awaiting_manual') return r.status === 'awaiting_manual';
          // –û–∂–∏–¥–∞—é—â–∏–µ: pending + processing
          return r.status === 'pending' || r.status === 'processing';
        });

        if (items.length > 0) {
            container.innerHTML = '';
            items.forEach(request => {
                const isDeposit = request.type === 'deposit';
                const amountColor = isDeposit ? '#00ff88' : '#ff4444';
                const amountSign = isDeposit ? '+' : '-';
                let statusClass = 'status-pending';
                if (request.status === 'rejected') statusClass = 'status-rejected';
                else if (request.status === 'completed' || request.status === 'approved' || request.status === 'auto_completed') statusClass = 'status-completed';
                else if (request.status === 'awaiting_manual') statusClass = 'status-rejected';

                const userName = request.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${request.user_id}`;
                const userInitial = (userName || 'U').charAt(0).toUpperCase();
                const iconColor = isDeposit ? '#00ff88' : '#ff4444';

                const item = document.createElement('div');
                item.className = 'list-item';
                item.style.cursor = 'pointer';
                item.onclick = () => { window.location.href = `/request/${request.id}/`; };
                item.innerHTML = `
                    <div class="list-icon">
                        <div style="width:40px;height:40px;background:${iconColor};border-radius:8px;display:flex;align-items:center;justify-content:center;border:2px solid #333;position:relative;">
                            <span style="color:#fff;font-weight:bold;font-size:16px;">${userInitial}</span>
                            <div style="position:absolute;bottom:-2px;right:-2px;width:16px;height:16px;background:#666;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid #333;">
                                <i class="fas fa-${isDeposit ? 'arrow-down' : 'arrow-up'}" style="color:#fff;font-size:8px;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="list-content">
                        <div class="list-title">${userName}</div>
                        <div class="list-subtitle">${(request.bookmaker || '').toUpperCase()} ‚Ä¢ ID: ${request.user_id}</div>
                    </div>
                    <div class="list-right">
                        <div class="list-date">${formatDate(request.created_at || new Date())}</div>
                        <div class="list-amount" style="color:${amountColor};">${amountSign}${Number(request.amount || 0).toFixed(2)}</div>
                        <div class="list-status"><div class="status-dot ${statusClass}"></div><span>${request.status === 'awaiting_manual' ? '–û—Å—Ç–∞–≤–ª–µ–Ω–∞' : (request.status === 'processing' ? '–í —Ä–∞–±–æ—Ç–µ' : (request.status === 'rejected' ? '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' : (request.status === 'completed' || request.status === 'approved' || request.status === 'auto_completed' ? '–£—Å–ø–µ—à–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç')))}</span></div>
                    </div>`;
                container.appendChild(item);
            });
        } else {
            container.innerHTML = `
                <div style="text-align: center; color: #ccc; padding: 40px;">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i><br>
                    –ù–µ—Ç –∑–∞—è–≤–æ–∫
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
        console.error('‚ùå –¢–∏–ø –æ—à–∏–±–∫–∏:', error.name);
        console.error('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
        
        let errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫';
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            errorMessage = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
        } else if (error.message.includes('HTTP error')) {
            errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}`;
        }
        
        document.getElementById('requests-container').innerHTML = `
            <div style="text-align: center; color: #ff4444; padding: 20px;">
                <i class="fas fa-exclamation-triangle"></i><br>
                ${errorMessage}<br>
                <small style="color: #888; margin-top: 10px; display: block;">
                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </small>
            </div>
        `;
    }
}
</script>
{% endblock %}

