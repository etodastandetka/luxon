{% extends 'base.html' %}
{% load static %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - Luxon{% endblock %}

{% block header_icon %}history{% endblock %}
{% block header_title %}–ó–∞—è–≤–∫–∏{% endblock %}
{% block header_subtitle %}–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏{% endblock %}

{% block content %}
<style>
/* Tabs */
.tabs-container { display: flex; gap: 8px; margin-bottom: 16px; background: transparent; border: none; box-shadow: none; }
.tab { flex: 1; padding: 10px 14px; text-align: center; border-radius: 12px; cursor: pointer; transition: all .18s; color: #bfc8d6; font-weight: 700; font-size: 13px; background: transparent; border: 1px solid rgba(255,255,255,0.04); }
.tab.active { background: rgba(255,255,255,0.03); color: #fff; border-color: rgba(255,255,255,0.06); box-shadow: 0 1px 0 rgba(255,255,255,0.02) inset; }
.tab:hover { background: rgba(255,255,255,0.02); color: #e6eef9; }
.tab-refresh { padding: 10px; border-radius: 12px; cursor: pointer; transition: all .22s; color: #9aa8b8; background: rgba(255,255,255,0.02); font-size: 16px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.tab-refresh:hover { background: rgba(255,255,255,0.04); color: #fff; }

/* Card list */
.list-item { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border:1px solid rgba(255,255,255,0.03); border-radius: 14px; padding: 12px; margin-bottom: 12px; display: flex; align-items: center; gap:12px; transition: transform .12s ease, box-shadow .12s ease; box-shadow: 0 1px 0 rgba(0,0,0,0.6); }
.list-item:hover { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
.list-icon { margin-right: 6px; flex: 0 0 52px; }
.list-content { flex: 1; min-width: 0; padding-right: 8px; }
.list-title { font-size: 15px; font-weight: 800; color: #eaf3ff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-subtitle { font-size: 12px; color: #9fb0c4; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.list-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap:6px; min-width: 100px; }
.list-date { font-size: 11px; color: #9fb0c4; margin-bottom: 0; }
.list-amount { font-size: 16px; font-weight: 900; margin-bottom: 0; padding: 6px 10px; border-radius: 12px; background: rgba(255,255,255,0.02); color: #ffffff; display: inline-block; box-shadow: 0 1px 0 rgba(0,0,0,0.6); }
.list-amount.positive { color: #00e08a; background: linear-gradient(180deg, rgba(0,224,138,0.06), rgba(0,224,138,0.02)); }
.list-amount.negative { color: #ff6b6b; background: linear-gradient(180deg, rgba(255,107,107,0.06), rgba(255,107,107,0.02)); }

.list-status { display: flex; align-items: center; justify-content: flex-end; font-size: 12px; color: #b6c6d6; gap:8px; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
.status-pending { background: #ffb86b; box-shadow: 0 0 6px rgba(255,184,107,0.08); }
.status-completed { background: #4ef1a6; box-shadow: 0 0 8px rgba(78,241,166,0.08); }
.status-rejected { background: #ff6b6b; box-shadow: 0 0 6px rgba(255,107,107,0.06); }
</style>

<!-- –§–∏–ª—å—Ç—Ä—ã: –û–∂–∏–¥–∞—é—â–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | –û—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ (—Ä—É—á–Ω—ã–µ) -->
<div class="tabs-container">
  <div id="tab-pending" class="tab active" onclick="switchStatus('pending')">–û–∂–∏–¥–∞—é—â–∏–µ</div>
  <div id="tab-left" class="tab" onclick="switchStatus('awaiting_manual')">–û—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ</div>
  <div class="tab-refresh" onclick="loadRequests()" title="–û–±–Ω–æ–≤–∏—Ç—å"><i class="fas fa-sync-alt"></i></div>
  </div>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
<div id="requests-container">
    <div style="text-align: center; color: #cccccc; padding: 20px;">
        <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStatus = 'pending'; // 'pending' | 'awaiting_manual'

document.addEventListener('DOMContentLoaded', function() {
    // –ß–∏—Ç–∞–µ–º ?status= –∏–∑ URL (awaiting_manual | pending)
    try {
      const params = new URLSearchParams(window.location.search);
      const s = (params.get('status') || '').toLowerCase();
      if (s === 'awaiting_manual' || s === 'pending') {
        currentStatus = s;
        document.getElementById('tab-pending').classList.toggle('active', currentStatus === 'pending');
        document.getElementById('tab-left').classList.toggle('active', currentStatus === 'awaiting_manual');
      }
    } catch (e) {}

    loadRequests();
    setInterval(loadRequests, 30000);
});

function switchStatus(status) {
  currentStatus = status;
  document.getElementById('tab-pending').classList.toggle('active', status === 'pending');
  document.getElementById('tab-left').classList.toggle('active', status === 'awaiting_manual');
  const container = document.getElementById('requests-container');
  container.innerHTML = `<div style="text-align:center;color:#999;padding:20px;"><i class='fas fa-spinner fa-spin'></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
  loadRequests();
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${day}.${month}.${year} ‚Ä¢ ${hours}:${minutes}`;
}

// –ï–¥–∏–Ω—ã–π –º–∞–ø–ø–µ—Ä –∏–∫–æ–Ω–æ–∫ –±–∞–Ω–∫–∞ –ø–æ–¥ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –≤ static/images
function getBankIconUrl(bankStr){
  const s = String(bankStr||'').toLowerCase();
  if (s.includes('mbank')) return '{% static "images/mbank.png" %}';
  if (s.includes('bakai')) return '{% static "images/bakai.jpg" %}'; // –¥–æ–±–∞–≤—å —Ñ–∞–π–ª –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏
  if (s.includes('optima')) return '{% static "images/optima.jpg" %}';
  if (s.includes('demir')) return '{% static "images/demirbank.jpg" %}';
  if (s.includes('megapay')) return '{% static "images/megapay.jpg" %}';
  if (s.includes('balance')) return '{% static "images/balance.jpg" %}';
  if (s.includes('o!') || s.includes('omoney') || s.includes('odengi') || s.includes('o! bank')) return '{% static "images/omoney.jpg" %}';
  return '{% static "images/companion.png" %}';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫
async function loadRequests() {
    try {
        console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏...');
        const resp = await fetch('/api/pending-requests/', { headers: { 'Cache-Control': 'no-cache' }, cache: 'no-cache' });
        const data = resp.ok ? await resp.json() : { success:false, requests: [] };

        const container = document.getElementById('requests-container');
        const items = (data.requests || []).filter(r => {
          if (currentStatus === 'awaiting_manual') return r.status === 'awaiting_manual';
          // –û–∂–∏–¥–∞—é—â–∏–µ: pending + processing
          return r.status === 'pending' || r.status === 'processing';
        });

        if (items.length > 0) {
            container.innerHTML = '';
            items.forEach(request => {
                const isDeposit = request.type === 'deposit';
                const amountColor = isDeposit ? '#00ff88' : '#ff4444';
                const amountSign = isDeposit ? '+' : '-';
                let statusClass = 'status-pending';
                if (request.status === 'rejected') statusClass = 'status-rejected';
                else if (request.status === 'completed' || request.status === 'approved' || request.status === 'auto_completed') statusClass = 'status-completed';
                else if (request.status === 'awaiting_manual') statusClass = 'status-rejected';

                const userName = request.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${request.user_id}`;
                // –ò–∫–æ–Ω–∫–∞: ELQR –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π, –±–∞–Ω–∫ –ø–æ wallet_details/bank –¥–ª—è –≤—ã–≤–æ–¥–æ–≤
                let iconSrc = '';
                if (isDeposit) {
                  iconSrc = '{% static "images/elqr.svg" %}?v=20251002';
                } else {
                  const bankText = (request.wallet_details || request.bank || '').toString();
                  iconSrc = getBankIconUrl(bankText);
                }

                const item = document.createElement('div');
                item.className = 'list-item';
                item.onclick = () => { window.location.href = `/bot/transactions/${request.id}/`; };
                const amountClass = isDeposit ? 'positive' : 'negative';
                item.innerHTML = `
                    <div class="list-icon">
                        <div style="width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01);overflow:hidden;">
                            <img src="${iconSrc}" alt="icon" style="width:100%;height:100%;object-fit:contain;padding:6px;"
                                 onerror="this.onerror=null;this.src='{% static "images/companion.png" %}';"/>
                        </div>
                    </div>
                    <div class="list-content">
                        <div class="list-title">${userName}</div>
                        <div class="list-subtitle">${(request.bookmaker || '').toUpperCase()} ‚Ä¢ ID: ${request.user_id}</div>
                    </div>
                    <div class="list-right">
                        <div class="list-date">${formatDate(request.created_at || new Date())}</div>
                        <div class="list-amount ${amountClass}">${amountSign}${Number(request.amount || 0).toFixed(2)}</div>
                        <div class="list-status"><div class="status-dot ${statusClass}"></div><span>${request.status === 'awaiting_manual' ? '–û—Å—Ç–∞–≤–ª–µ–Ω–∞' : (request.status === 'processing' ? '–í —Ä–∞–±–æ—Ç–µ' : (request.status === 'rejected' ? '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' : (request.status === 'completed' || request.status === 'approved' || request.status === 'auto_completed' ? '–£—Å–ø–µ—à–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç')))}</span></div>
                    </div>`;
                container.appendChild(item);
            });
        } else {
            container.innerHTML = `
                <div style="text-align: center; color: #ccc; padding: 40px;">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i><br>
                    –ù–µ—Ç –∑–∞—è–≤–æ–∫
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
        console.error('‚ùå –¢–∏–ø –æ—à–∏–±–∫–∏:', error.name);
        console.error('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
        
        let errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫';
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            errorMessage = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
        } else if (error.message.includes('HTTP error')) {
            errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}`;
        }
        
        document.getElementById('requests-container').innerHTML = `
            <div style="text-align: center; color: #ff4444; padding: 20px;">
                <i class="fas fa-exclamation-triangle"></i><br>
                ${errorMessage}<br>
                <small style="color: #888; margin-top: 10px; display: block;">
                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </small>
            </div>
        `;
    }
}
</script>
{% endblock %}

