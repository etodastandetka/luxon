{% extends 'dashboard/base_mobile.html' %}

{% block title %}–õ–æ–≥–∏{% endblock %}

{% block content %}
<div class="mobile-container">
    <div class="header" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);">
        <div class="header-content">
            <div class="header-title" style="color: #ffffff;">üì© –õ–æ–≥–∏</div>
            <div class="header-subtitle" style="color: #cccccc;">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏ —Å–æ–±—ã—Ç–∏–π</div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filters-section">
        <div class="filter-group">
            <select id="levelFilter" class="filter-select">
                <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
                <option value="ERROR">–û—à–∏–±–∫–∏</option>
                <option value="WARNING">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</option>
                <option value="INFO">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</option>
                <option value="DEBUG">–û—Ç–ª–∞–¥–∫–∞</option>
            </select>
            <select id="sourceFilter" class="filter-select">
                <option value="">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                <option value="bot">Telegram Bot</option>
                <option value="api">API</option>
                <option value="payment">–ü–ª–∞—Ç–µ–∂–∏</option>
                <option value="email">Email Parser</option>
                <option value="admin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</option>
            </select>
            <input type="datetime-local" id="dateFrom" class="filter-input" placeholder="–û—Ç">
            <input type="datetime-local" id="dateTo" class="filter-input" placeholder="–î–æ">
            <button onclick="applyFilters()" class="filter-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ–≥–æ–≤ -->
    <div class="stats-grid">
        <div class="stat-card error">
            <div class="stat-value" id="errorCount">0</div>
            <div class="stat-label">–û—à–∏–±–∫–∏</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value" id="warningCount">0</div>
            <div class="stat-label">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</div>
        </div>
        <div class="stat-card info">
            <div class="stat-value" id="infoCount">0</div>
            <div class="stat-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
        </div>
        <div class="stat-card total">
            <div class="stat-value" id="totalCount">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="actions-section">
        <button class="action-btn primary" onclick="clearOldLogs()">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏
        </button>
        <button class="action-btn secondary" onclick="exportLogs()">
            üìä –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤
        </button>
        <button class="action-btn secondary" onclick="refreshLogs()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ª–æ–≥–æ–≤ -->
    <div class="logs-list" id="logsList">
        <!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="pagination" id="pagination">
        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –ª–æ–≥–∞ -->
<div id="logDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìã –î–µ—Ç–∞–ª–∏ –ª–æ–≥–∞</h3>
            <button class="close-btn" onclick="closeLogDetailsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="log-details">
                <div class="detail-row">
                    <span class="detail-label">–í—Ä–µ–º—è:</span>
                    <span class="detail-value" id="logTime">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">–£—Ä–æ–≤–µ–Ω—å:</span>
                    <span class="detail-value" id="logLevel">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">–ò—Å—Ç–æ—á–Ω–∏–∫:</span>
                    <span class="detail-value" id="logSource">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">–°–æ–æ–±—â–µ–Ω–∏–µ:</span>
                    <span class="detail-value" id="logMessage">-</span>
                </div>
                <div class="detail-row full-width">
                    <span class="detail-label">–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤:</span>
                    <pre class="detail-value" id="logStackTrace">-</pre>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeLogDetailsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<style>
.filters-section {
    margin: 20px 0;
    padding: 0 20px;
}

.filter-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-select, .filter-input {
    flex: 1;
    min-width: 150px;
    padding: 12px 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.05);
    color: white;
    font-size: 14px;
}

.filter-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.filter-btn {
    padding: 12px 20px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    backdrop-filter: blur(10px);
}

.stat-card.error {
    border-color: #ef4444;
}

.stat-card.warning {
    border-color: #f59e0b;
}

.stat-card.info {
    border-color: #3b82f6;
}

.stat-card.total {
    border-color: #22c55e;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-card.error .stat-value {
    color: #ef4444;
}

.stat-card.warning .stat-value {
    color: #f59e0b;
}

.stat-card.info .stat-value {
    color: #3b82f6;
}

.stat-card.total .stat-value {
    color: #22c55e;
}

.stat-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.actions-section {
    display: flex;
    gap: 10px;
    margin: 20px;
    flex-wrap: wrap;
}

.action-btn {
    flex: 1;
    min-width: 150px;
    padding: 12px 20px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.action-btn.primary {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.action-btn.secondary {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.logs-list {
    margin: 20px;
}

.log-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    cursor: pointer;
}

.log-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.log-item.error {
    border-left: 4px solid #ef4444;
}

.log-item.warning {
    border-left: 4px solid #f59e0b;
}

.log-item.info {
    border-left: 4px solid #3b82f6;
}

.log-item.debug {
    border-left: 4px solid #6b7280;
}

.log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.log-level {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.log-level.error {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.log-level.warning {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.log-level.info {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

.log-level.debug {
    background: rgba(107, 114, 128, 0.2);
    color: #6b7280;
}

.log-time {
    color: rgba(255, 255, 255, 0.7);
    font-size: 12px;
}

.log-source {
    color: rgba(255, 255, 255, 0.7);
    font-size: 12px;
    background: rgba(255, 255, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
}

.log-message {
    color: white;
    font-size: 14px;
    margin-bottom: 10px;
    word-break: break-word;
}

.log-preview {
    color: rgba(255, 255, 255, 0.6);
    font-size: 12px;
    font-family: monospace;
    background: rgba(0, 0, 0, 0.2);
    padding: 8px;
    border-radius: 6px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
}

.modal-content {
    background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(50, 50, 50, 0.95));
    margin: 5% auto;
    padding: 0;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h3 {
    color: white;
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
}

.modal-body {
    padding: 20px;
}

.log-details {
    color: white;
}

.detail-row {
    display: flex;
    margin-bottom: 15px;
    align-items: flex-start;
}

.detail-row.full-width {
    flex-direction: column;
}

.detail-label {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    min-width: 100px;
    margin-right: 10px;
}

.detail-value {
    flex: 1;
    color: white;
    word-break: break-word;
}

.detail-value pre {
    background: rgba(0, 0, 0, 0.3);
    padding: 10px;
    border-radius: 6px;
    overflow-x: auto;
    font-size: 12px;
    margin: 0;
}

.modal-footer {
    display: flex;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-secondary {
    flex: 1;
    padding: 12px 20px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 30px 20px;
}

.page-btn {
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.page-btn:hover, .page-btn.active {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
}

@media (max-width: 768px) {
    .filter-group {
        flex-direction: column;
    }
    
    .filter-select, .filter-input {
        min-width: 100%;
    }
    
    .actions-section {
        flex-direction: column;
    }
    
    .action-btn {
        min-width: 100%;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .log-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}
</style>

<script>
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};

async function loadLogs(page = 1) {
    try {
        const response = await fetch(`/api/logs/?page=${page}&${new URLSearchParams(currentFilters)}`);
        const data = await response.json();
        
        if (data.success) {
            displayLogs(data.logs);
            updateStats(data.stats);
            updatePagination(data.pagination);
        } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
    }
}

function displayLogs(logs) {
    const container = document.getElementById('logsList');
    
    if (logs.length === 0) {
        container.innerHTML = '<div class="loading">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }
    
    container.innerHTML = logs.map(log => `
        <div class="log-item ${log.level.toLowerCase()}" onclick="showLogDetails(${log.id})">
            <div class="log-header">
                <div class="log-level ${log.level.toLowerCase()}">${log.level}</div>
                <div class="log-time">${log.timestamp}</div>
                <div class="log-source">${log.source}</div>
            </div>
            <div class="log-message">${log.message}</div>
            <div class="log-preview">${log.stack_trace || '–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'}</div>
        </div>
    `).join('');
}

function updateStats(stats) {
    document.getElementById('errorCount').textContent = stats.error_count || 0;
    document.getElementById('warningCount').textContent = stats.warning_count || 0;
    document.getElementById('infoCount').textContent = stats.info_count || 0;
    document.getElementById('totalCount').textContent = stats.total_count || 0;
}

function updatePagination(pagination) {
    const container = document.getElementById('pagination');
    currentPage = pagination.current_page;
    totalPages = pagination.total_pages;
    
    let html = '';
    
    if (currentPage > 1) {
        html += `<button class="page-btn" onclick="loadLogs(${currentPage - 1})">‚Äπ</button>`;
    }
    
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadLogs(${i})">${i}</button>`;
    }
    
    if (currentPage < totalPages) {
        html += `<button class="page-btn" onclick="loadLogs(${currentPage + 1})">‚Ä∫</button>`;
    }
    
    container.innerHTML = html;
}

function applyFilters() {
    currentFilters = {
        level: document.getElementById('levelFilter').value,
        source: document.getElementById('sourceFilter').value,
        date_from: document.getElementById('dateFrom').value,
        date_to: document.getElementById('dateTo').value
    };
    loadLogs(1);
}

function showLogDetails(logId) {
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –ª–æ–≥–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('logDetailsModal').style.display = 'block';
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π —á–µ—Ä–µ–∑ API
}

function closeLogDetailsModal() {
    document.getElementById('logDetailsModal').style.display = 'none';
}

function clearOldLogs() {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π?')) {
        // API –≤—ã–∑–æ–≤ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
        alert('–°—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ —É–¥–∞–ª–µ–Ω—ã');
        loadLogs(1);
    }
}

function exportLogs() {
    // API –≤—ã–∑–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –ª–æ–≥–æ–≤
    alert('–≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –Ω–∞—á–∞—Ç');
}

function refreshLogs() {
    loadLogs(currentPage);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadLogs(1);
});
</script>
{% endblock %}

