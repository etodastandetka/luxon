{% extends 'base.html' %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-tachometer-alt"></i> –î–∞—à–±–æ—Ä–¥</h1>
    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</p>
</div>

<!-- –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ -->
<div class="card">
    <h3><i class="fas fa-clock"></i> –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏</h3>
    <div class="requests-container" id="requests-container">
        <div style="text-align: center; color: #cccccc;">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="card">
    <h3><i class="fas fa-chart-bar"></i> –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-number" id="pending-deposits">0</div>
            <div class="stat-label">–û–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="pending-withdrawals">0</div>
            <div class="stat-label">–û–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–≤–æ–¥–æ–≤</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="total-users">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="bot-status">–ê–∫—Ç–∏–≤–µ–Ω</div>
            <div class="stat-label">–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-item {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #444;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: #4CAF50;
    margin-bottom: 10px;
}

.stat-label {
    color: #ccc;
    font-size: 0.9em;
}

.requests-container {
    max-height: 600px;
    overflow-y: auto;
}

.request-item {
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    position: relative;
}

.request-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #444;
}

.request-type {
    font-size: 1.2em;
    font-weight: bold;
    color: #4CAF50;
}

.request-status {
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: bold;
    background: #ff9800;
    color: #000;
}

.request-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.info-item {
    background: #333;
    padding: 10px;
    border-radius: 5px;
}

.info-label {
    color: #ccc;
    font-size: 0.8em;
    margin-bottom: 5px;
}

.info-value {
    color: #fff;
    font-weight: bold;
}

.request-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-approve {
    background: #4CAF50;
    color: #000;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}

.btn-reject {
    background: #f44336;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}

.btn-approve:hover {
    background: #45a049;
}

.btn-reject:hover {
    background: #da190b;
}

.no-requests {
    text-align: center;
    color: #ccc;
    padding: 40px;
    font-size: 1.1em;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadPendingRequests();
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
        loadDashboardData();
        loadPendingRequests();
    }, 10000);
});

async function loadDashboardData() {
    try {
        const response = await fetch('{% url "dashboard:api_stats" %}');
        const data = await response.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('total-users').textContent = data.total_users || 0;
        document.getElementById('pending-deposits').textContent = data.pending_deposits || 0;
        document.getElementById('pending-withdrawals').textContent = data.pending_withdrawals || 0;
        
        // –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
        const botStatus = document.getElementById('bot-status');
        if (data.bot_active) {
            botStatus.textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
            botStatus.style.color = '#4CAF50';
        } else {
            botStatus.textContent = '–ù–∞ –ø–∞—É–∑–µ';
            botStatus.style.color = '#f44336';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    }
}

async function loadPendingRequests() {
    try {
        const response = await fetch('{% url "dashboard:api_pending_requests" %}');
        const data = await response.json();
        
        const container = document.getElementById('requests-container');
        
        if (!data.success || data.requests.length === 0) {
            container.innerHTML = '<div class="no-requests">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</div>';
            return;
        }
        
        container.innerHTML = '';
        
        data.requests.forEach(request => {
            const requestElement = createRequestElement(request);
            container.appendChild(requestElement);
        });
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
        document.getElementById('requests-container').innerHTML = 
            '<div class="no-requests">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</div>';
    }
}

function createRequestElement(request) {
    const div = document.createElement('div');
    div.className = 'request-item';
    div.id = `request-${request.id}`;
    
    const typeIcon = request.type === 'deposit' ? 'üí∞' : 'üí∏';
    const typeText = request.type === 'deposit' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–í—ã–≤–æ–¥';
    
    div.innerHTML = `
        <div class="request-header">
            <div class="request-type">${typeIcon} ${typeText}</div>
            <div class="request-status">–û–∂–∏–¥–∞–µ—Ç</div>
        </div>
        
        <div class="request-info">
            <div class="info-item">
                <div class="info-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                <div class="info-value">${request.username || 'ID: ' + request.user_id}</div>
            </div>
            <div class="info-item">
                <div class="info-label">–ë—É–∫–º–µ–∫–µ—Ä</div>
                <div class="info-value">${request.bookmaker}</div>
            </div>
            <div class="info-item">
                <div class="info-label">–°—É–º–º–∞</div>
                <div class="info-value">${request.amount} KGS</div>
            </div>
            <div class="info-item">
                <div class="info-label">–í—Ä–µ–º—è</div>
                <div class="info-value">${request.created_at}</div>
            </div>
        </div>
        
        ${request.type === 'deposit' ? `
            <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">ID —Å—á–µ—Ç–∞</div>
                <div class="info-value">${request.account_id}</div>
            </div>
        ` : `
            <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">–ö–æ–¥ –≤—ã–≤–æ–¥–∞</div>
                <div class="info-value">${request.withdraw_code}</div>
            </div>
        `}
        
        <div class="request-actions">
            <button class="btn-approve" onclick="handleRequest(${request.id}, 'approve')">
                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            </button>
            <button class="btn-reject" onclick="handleRequest(${request.id}, 'reject')">
                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
            </button>
        </div>
    `;
    
    return div;
}

async function handleRequest(requestId, action) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action === 'approve' ? '–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å' : '–æ—Ç–∫–ª–æ–Ω–∏—Ç—å'} —ç—Ç—É –∑–∞—è–≤–∫—É?`)) {
        return;
    }
    
    try {
        const response = await fetch('{% url "dashboard:api_handle_request" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                request_id: requestId,
                action: action
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –£–¥–∞–ª—è–µ–º –∑–∞—è–≤–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞
            const requestElement = document.getElementById(`request-${requestId}`);
            if (requestElement) {
                requestElement.remove();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadDashboardData();
            
            alert(data.message);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏:', error);
        alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateBookmakersGrid(bookmakers) {
    const grid = document.getElementById('bookmakers-grid');
    const bookmakerNames = {
        '1xbet': 'üé∞ 1XBET',
        '1win': 'üé∞ 1WIN',
        'melbet': 'üé∞ MELBET',
        'mostbet': 'üé∞ MOSTBET'
    };
    
    grid.innerHTML = '';
    
    Object.entries(bookmakers).forEach(([key, data]) => {
        const card = document.createElement('div');
        card.style.cssText = `
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        `;
        
        card.innerHTML = `
            <h4 style="color: #00ff88; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                ${bookmakerNames[key] || key}
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.deposits.count}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–î–µ–ø–æ–∑–∏—Ç—ã</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.deposits.amount.toFixed(2)}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.withdrawals.count}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–í—ã–≤–æ–¥—ã</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.withdrawals.amount.toFixed(2)}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–°—É–º–º–∞ –≤—ã–≤–æ–¥–æ–≤</div>
                </div>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

async function loadTransactions() {
    try {
        const response = await fetch('{% url "dashboard:api_transactions" %}');
        const transactions = await response.json();
        
        const list = document.getElementById('transactions-list');
        list.innerHTML = '';
        
        if (transactions.length === 0) {
            list.innerHTML = '<div style="text-align: center; color: #cccccc;">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>';
            return;
        }
        
        transactions.forEach(transaction => {
            const item = document.createElement('div');
            item.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                margin-bottom: 10px;
                background: #333;
                border-radius: 8px;
                border-left: 4px solid #00ff88;
            `;
            
            const statusClass = `status-${transaction.status}`;
            const typeIcon = transaction.type === 'deposit' ? 'üí∞' : 'üí∏';
            const typeText = transaction.type === 'deposit' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–í—ã–≤–æ–¥';
            
            item.innerHTML = `
                <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">${transaction.username}</div>
                    <div style="font-size: 12px; color: #cccccc;">
                        ${typeIcon} ${typeText} ‚Ä¢ ${transaction.bookmaker} ‚Ä¢ ${transaction.created_at}
                    </div>
                </div>
                <div style="font-size: 1.2rem; font-weight: bold; color: #00ff88;">
                    ${transaction.amount} KGS
                </div>
                <span class="status-badge ${statusClass}" style="
                    padding: 5px 10px;
                    border-radius: 15px;
                    font-size: 10px;
                    font-weight: bold;
                    background: ${transaction.status === 'completed' ? '#00ff88' : 
                                transaction.status === 'pending' ? '#ffaa00' : '#ff4444'};
                    color: ${transaction.status === 'completed' ? '#000' : '#fff'};
                ">${transaction.status}</span>
            `;
            
            list.appendChild(item);
        });
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:', error);
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardData();
    loadTransactions();
});

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    loadDashboardData();
    loadTransactions();
}, 30000);
</script>
{% endblock %}



    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
        loadDashboardData();
        loadPendingRequests();
    }, 10000);
});

async function loadDashboardData() {
    try {
        const response = await fetch('{% url "dashboard:api_stats" %}');
        const data = await response.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('total-users').textContent = data.total_users || 0;
        document.getElementById('pending-deposits').textContent = data.pending_deposits || 0;
        document.getElementById('pending-withdrawals').textContent = data.pending_withdrawals || 0;
        
        // –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
        const botStatus = document.getElementById('bot-status');
        if (data.bot_active) {
            botStatus.textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
            botStatus.style.color = '#4CAF50';
        } else {
            botStatus.textContent = '–ù–∞ –ø–∞—É–∑–µ';
            botStatus.style.color = '#f44336';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    }
}

async function loadPendingRequests() {
    try {
        const response = await fetch('{% url "dashboard:api_pending_requests" %}');
        const data = await response.json();
        
        const container = document.getElementById('requests-container');
        
        if (!data.success || data.requests.length === 0) {
            container.innerHTML = '<div class="no-requests">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</div>';
            return;
        }
        
        container.innerHTML = '';
        
        data.requests.forEach(request => {
            const requestElement = createRequestElement(request);
            container.appendChild(requestElement);
        });
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
        document.getElementById('requests-container').innerHTML = 
            '<div class="no-requests">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</div>';
    }
}

function createRequestElement(request) {
    const div = document.createElement('div');
    div.className = 'request-item';
    div.id = `request-${request.id}`;
    
    const typeIcon = request.type === 'deposit' ? 'üí∞' : 'üí∏';
    const typeText = request.type === 'deposit' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–í—ã–≤–æ–¥';
    
    div.innerHTML = `
        <div class="request-header">
            <div class="request-type">${typeIcon} ${typeText}</div>
            <div class="request-status">–û–∂–∏–¥–∞–µ—Ç</div>
        </div>
        
        <div class="request-info">
            <div class="info-item">
                <div class="info-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                <div class="info-value">${request.username || 'ID: ' + request.user_id}</div>
            </div>
            <div class="info-item">
                <div class="info-label">–ë—É–∫–º–µ–∫–µ—Ä</div>
                <div class="info-value">${request.bookmaker}</div>
            </div>
            <div class="info-item">
                <div class="info-label">–°—É–º–º–∞</div>
                <div class="info-value">${request.amount} KGS</div>
            </div>
            <div class="info-item">
                <div class="info-label">–í—Ä–µ–º—è</div>
                <div class="info-value">${request.created_at}</div>
            </div>
        </div>
        
        ${request.type === 'deposit' ? `
            <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">ID —Å—á–µ—Ç–∞</div>
                <div class="info-value">${request.account_id}</div>
            </div>
        ` : `
            <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">–ö–æ–¥ –≤—ã–≤–æ–¥–∞</div>
                <div class="info-value">${request.withdraw_code}</div>
            </div>
        `}
        
        <div class="request-actions">
            <button class="btn-approve" onclick="handleRequest(${request.id}, 'approve')">
                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            </button>
            <button class="btn-reject" onclick="handleRequest(${request.id}, 'reject')">
                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
            </button>
        </div>
    `;
    
    return div;
}

async function handleRequest(requestId, action) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action === 'approve' ? '–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å' : '–æ—Ç–∫–ª–æ–Ω–∏—Ç—å'} —ç—Ç—É –∑–∞—è–≤–∫—É?`)) {
        return;
    }
    
    try {
        const response = await fetch('{% url "dashboard:api_handle_request" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                request_id: requestId,
                action: action
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –£–¥–∞–ª—è–µ–º –∑–∞—è–≤–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞
            const requestElement = document.getElementById(`request-${requestId}`);
            if (requestElement) {
                requestElement.remove();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadDashboardData();
            
            alert(data.message);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏:', error);
        alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateBookmakersGrid(bookmakers) {
    const grid = document.getElementById('bookmakers-grid');
    const bookmakerNames = {
        '1xbet': 'üé∞ 1XBET',
        '1win': 'üé∞ 1WIN',
        'melbet': 'üé∞ MELBET',
        'mostbet': 'üé∞ MOSTBET'
    };
    
    grid.innerHTML = '';
    
    Object.entries(bookmakers).forEach(([key, data]) => {
        const card = document.createElement('div');
        card.style.cssText = `
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        `;
        
        card.innerHTML = `
            <h4 style="color: #00ff88; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                ${bookmakerNames[key] || key}
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.deposits.count}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–î–µ–ø–æ–∑–∏—Ç—ã</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.deposits.amount.toFixed(2)}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.withdrawals.count}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–í—ã–≤–æ–¥—ã</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.withdrawals.amount.toFixed(2)}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–°—É–º–º–∞ –≤—ã–≤–æ–¥–æ–≤</div>
                </div>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

async function loadTransactions() {
    try {
        const response = await fetch('{% url "dashboard:api_transactions" %}');
        const transactions = await response.json();
        
        const list = document.getElementById('transactions-list');
        list.innerHTML = '';
        
        if (transactions.length === 0) {
            list.innerHTML = '<div style="text-align: center; color: #cccccc;">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>';
            return;
        }
        
        transactions.forEach(transaction => {
            const item = document.createElement('div');
            item.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                margin-bottom: 10px;
                background: #333;
                border-radius: 8px;
                border-left: 4px solid #00ff88;
            `;
            
            const statusClass = `status-${transaction.status}`;
            const typeIcon = transaction.type === 'deposit' ? 'üí∞' : 'üí∏';
            const typeText = transaction.type === 'deposit' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–í—ã–≤–æ–¥';
            
            item.innerHTML = `
                <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">${transaction.username}</div>
                    <div style="font-size: 12px; color: #cccccc;">
                        ${typeIcon} ${typeText} ‚Ä¢ ${transaction.bookmaker} ‚Ä¢ ${transaction.created_at}
                    </div>
                </div>
                <div style="font-size: 1.2rem; font-weight: bold; color: #00ff88;">
                    ${transaction.amount} KGS
                </div>
                <span class="status-badge ${statusClass}" style="
                    padding: 5px 10px;
                    border-radius: 15px;
                    font-size: 10px;
                    font-weight: bold;
                    background: ${transaction.status === 'completed' ? '#00ff88' : 
                                transaction.status === 'pending' ? '#ffaa00' : '#ff4444'};
                    color: ${transaction.status === 'completed' ? '#000' : '#fff'};
                ">${transaction.status}</span>
            `;
            
            list.appendChild(item);
        });
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:', error);
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardData();
    loadTransactions();
});

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    loadDashboardData();
    loadTransactions();
}, 30000);
</script>
{% endblock %}



    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
        loadDashboardData();
        loadPendingRequests();
    }, 10000);
});

async function loadDashboardData() {
    try {
        const response = await fetch('{% url "dashboard:api_stats" %}');
        const data = await response.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('total-users').textContent = data.total_users || 0;
        document.getElementById('pending-deposits').textContent = data.pending_deposits || 0;
        document.getElementById('pending-withdrawals').textContent = data.pending_withdrawals || 0;
        
        // –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
        const botStatus = document.getElementById('bot-status');
        if (data.bot_active) {
            botStatus.textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
            botStatus.style.color = '#4CAF50';
        } else {
            botStatus.textContent = '–ù–∞ –ø–∞—É–∑–µ';
            botStatus.style.color = '#f44336';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    }
}

async function loadPendingRequests() {
    try {
        const response = await fetch('{% url "dashboard:api_pending_requests" %}');
        const data = await response.json();
        
        const container = document.getElementById('requests-container');
        
        if (!data.success || data.requests.length === 0) {
            container.innerHTML = '<div class="no-requests">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</div>';
            return;
        }
        
        container.innerHTML = '';
        
        data.requests.forEach(request => {
            const requestElement = createRequestElement(request);
            container.appendChild(requestElement);
        });
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
        document.getElementById('requests-container').innerHTML = 
            '<div class="no-requests">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</div>';
    }
}

function createRequestElement(request) {
    const div = document.createElement('div');
    div.className = 'request-item';
    div.id = `request-${request.id}`;
    
    const typeIcon = request.type === 'deposit' ? 'üí∞' : 'üí∏';
    const typeText = request.type === 'deposit' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–í—ã–≤–æ–¥';
    
    div.innerHTML = `
        <div class="request-header">
            <div class="request-type">${typeIcon} ${typeText}</div>
            <div class="request-status">–û–∂–∏–¥–∞–µ—Ç</div>
        </div>
        
        <div class="request-info">
            <div class="info-item">
                <div class="info-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                <div class="info-value">${request.username || 'ID: ' + request.user_id}</div>
            </div>
            <div class="info-item">
                <div class="info-label">–ë—É–∫–º–µ–∫–µ—Ä</div>
                <div class="info-value">${request.bookmaker}</div>
            </div>
            <div class="info-item">
                <div class="info-label">–°—É–º–º–∞</div>
                <div class="info-value">${request.amount} KGS</div>
            </div>
            <div class="info-item">
                <div class="info-label">–í—Ä–µ–º—è</div>
                <div class="info-value">${request.created_at}</div>
            </div>
        </div>
        
        ${request.type === 'deposit' ? `
            <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">ID —Å—á–µ—Ç–∞</div>
                <div class="info-value">${request.account_id}</div>
            </div>
        ` : `
            <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">–ö–æ–¥ –≤—ã–≤–æ–¥–∞</div>
                <div class="info-value">${request.withdraw_code}</div>
            </div>
        `}
        
        <div class="request-actions">
            <button class="btn-approve" onclick="handleRequest(${request.id}, 'approve')">
                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            </button>
            <button class="btn-reject" onclick="handleRequest(${request.id}, 'reject')">
                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
            </button>
        </div>
    `;
    
    return div;
}

async function handleRequest(requestId, action) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action === 'approve' ? '–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å' : '–æ—Ç–∫–ª–æ–Ω–∏—Ç—å'} —ç—Ç—É –∑–∞—è–≤–∫—É?`)) {
        return;
    }
    
    try {
        const response = await fetch('{% url "dashboard:api_handle_request" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                request_id: requestId,
                action: action
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –£–¥–∞–ª—è–µ–º –∑–∞—è–≤–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞
            const requestElement = document.getElementById(`request-${requestId}`);
            if (requestElement) {
                requestElement.remove();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadDashboardData();
            
            alert(data.message);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏:', error);
        alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateBookmakersGrid(bookmakers) {
    const grid = document.getElementById('bookmakers-grid');
    const bookmakerNames = {
        '1xbet': 'üé∞ 1XBET',
        '1win': 'üé∞ 1WIN',
        'melbet': 'üé∞ MELBET',
        'mostbet': 'üé∞ MOSTBET'
    };
    
    grid.innerHTML = '';
    
    Object.entries(bookmakers).forEach(([key, data]) => {
        const card = document.createElement('div');
        card.style.cssText = `
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        `;
        
        card.innerHTML = `
            <h4 style="color: #00ff88; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                ${bookmakerNames[key] || key}
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.deposits.count}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–î–µ–ø–æ–∑–∏—Ç—ã</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.deposits.amount.toFixed(2)}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.withdrawals.count}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–í—ã–≤–æ–¥—ã</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #00ff88; margin-bottom: 5px;">
                        ${data.withdrawals.amount.toFixed(2)}
                    </div>
                    <div style="font-size: 12px; color: #cccccc;">–°—É–º–º–∞ –≤—ã–≤–æ–¥–æ–≤</div>
                </div>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

async function loadTransactions() {
    try {
        const response = await fetch('{% url "dashboard:api_transactions" %}');
        const transactions = await response.json();
        
        const list = document.getElementById('transactions-list');
        list.innerHTML = '';
        
        if (transactions.length === 0) {
            list.innerHTML = '<div style="text-align: center; color: #cccccc;">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>';
            return;
        }
        
        transactions.forEach(transaction => {
            const item = document.createElement('div');
            item.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                margin-bottom: 10px;
                background: #333;
                border-radius: 8px;
                border-left: 4px solid #00ff88;
            `;
            
            const statusClass = `status-${transaction.status}`;
            const typeIcon = transaction.type === 'deposit' ? 'üí∞' : 'üí∏';
            const typeText = transaction.type === 'deposit' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–í—ã–≤–æ–¥';
            
            item.innerHTML = `
                <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">${transaction.username}</div>
                    <div style="font-size: 12px; color: #cccccc;">
                        ${typeIcon} ${typeText} ‚Ä¢ ${transaction.bookmaker} ‚Ä¢ ${transaction.created_at}
                    </div>
                </div>
                <div style="font-size: 1.2rem; font-weight: bold; color: #00ff88;">
                    ${transaction.amount} KGS
                </div>
                <span class="status-badge ${statusClass}" style="
                    padding: 5px 10px;
                    border-radius: 15px;
                    font-size: 10px;
                    font-weight: bold;
                    background: ${transaction.status === 'completed' ? '#00ff88' : 
                                transaction.status === 'pending' ? '#ffaa00' : '#ff4444'};
                    color: ${transaction.status === 'completed' ? '#000' : '#fff'};
                ">${transaction.status}</span>
            `;
            
            list.appendChild(item);
        });
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:', error);
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardData();
    loadTransactions();
});

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    loadDashboardData();
    loadTransactions();
}, 30000);
</script>
{% endblock %}


