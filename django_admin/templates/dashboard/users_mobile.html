{% extends 'dashboard/base_mobile.html' %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}

{% block content %}
<div class="mobile-container">
    <div class="header" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);">
        <div class="header-content">
            <div class="header-title" style="color: #ffffff;">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="header-subtitle" style="color: #cccccc;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –±–∞–ª–∞–Ω—Å–∞–º–∏</div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filters-section">
        <div class="filter-group">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID, –∏–º–µ–Ω–∏ –∏–ª–∏ username" class="filter-input">
            <select id="statusFilter" class="filter-select">
                <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
            </select>
            <button onclick="applyFilters()" class="filter-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="totalUsers">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="activeUsers">0</div>
            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="newUsers">0</div>
            <div class="stat-label">–ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è</div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="users-list" id="usersList">
        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="pagination" id="pagination">
        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
    </div>
</div>

<style>
.filters-section {
    margin: 20px 0;
    padding: 0 20px;
}

.filter-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-input, .filter-select {
    flex: 1;
    min-width: 200px;
    padding: 12px 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.05);
    color: white;
    font-size: 14px;
}

.filter-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.filter-btn {
    padding: 12px 20px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    backdrop-filter: blur(10px);
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #22c55e;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.users-list {
    margin: 20px;
}

.user-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.user-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.user-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.user-info h3 {
    color: white;
    font-size: 16px;
    margin: 0 0 5px 0;
}

.user-info p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 14px;
    margin: 0;
}

.user-balance {
    text-align: right;
}

.balance-amount {
    font-size: 18px;
    font-weight: 700;
    color: #10b981;
}

.balance-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
}

.user-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.detail-item {
    text-align: center;
}

.detail-value {
    font-size: 16px;
    font-weight: 600;
    color: white;
    margin-bottom: 5px;
}

.detail-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.user-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.action-btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 30px 20px;
}

.page-btn {
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.page-btn:hover, .page-btn.active {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
}

.loading {
    text-align: center;
    padding: 40px;
    color: rgba(255, 255, 255, 0.7);
}

@media (max-width: 768px) {
    .filter-group {
        flex-direction: column;
    }
    
    .filter-input, .filter-select {
        min-width: 100%;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .user-details {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};

async function loadUsers(page = 1) {
    try {
        const response = await fetch(`/api/users/?page=${page}&${new URLSearchParams(currentFilters)}`);
        const data = await response.json();
        
        if (data.success) {
            displayUsers(data.users);
            updateStats(data.stats);
            updatePagination(data.pagination);
        } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
    }
}

function displayUsers(users) {
    const container = document.getElementById('usersList');
    
    if (users.length === 0) {
        container.innerHTML = '<div class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }
    
    container.innerHTML = users.map(user => `
        <div class="user-item">
            <div class="user-header">
                <div class="user-info">
                    <h3>${user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</h3>
                    <p>ID: ${user.user_id} ‚Ä¢ ${user.first_name || ''} ${user.last_name || ''}</p>
                </div>
                <div class="user-balance">
                    <div class="balance-amount">${user.balance || 0} —Å–æ–º</div>
                    <div class="balance-label">–ë–∞–ª–∞–Ω—Å</div>
                </div>
            </div>
            <div class="user-details">
                <div class="detail-item">
                    <div class="detail-value">${user.deposits_count || 0}</div>
                    <div class="detail-label">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–π</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">${user.withdrawals_count || 0}</div>
                    <div class="detail-label">–í—ã–≤–æ–¥–æ–≤</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">${user.referrals_count || 0}</div>
                    <div class="detail-label">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">${user.last_activity || '–ù–∏–∫–æ–≥–¥–∞'}</div>
                    <div class="detail-label">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                </div>
            </div>
            <div class="user-actions">
                <button class="action-btn btn-primary" onclick="viewUser(${user.user_id})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                <button class="action-btn btn-secondary" onclick="editUser(${user.user_id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    `).join('');
}

function updateStats(stats) {
    document.getElementById('totalUsers').textContent = stats.total_users || 0;
    document.getElementById('activeUsers').textContent = stats.active_users || 0;
    document.getElementById('newUsers').textContent = stats.new_users_today || 0;
}

function updatePagination(pagination) {
    const container = document.getElementById('pagination');
    currentPage = pagination.current_page;
    totalPages = pagination.total_pages;
    
    let html = '';
    
    if (currentPage > 1) {
        html += `<button class="page-btn" onclick="loadUsers(${currentPage - 1})">‚Äπ</button>`;
    }
    
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`;
    }
    
    if (currentPage < totalPages) {
        html += `<button class="page-btn" onclick="loadUsers(${currentPage + 1})">‚Ä∫</button>`;
    }
    
    container.innerHTML = html;
}

function applyFilters() {
    currentFilters = {
        search: document.getElementById('searchInput').value,
        status: document.getElementById('statusFilter').value
    };
    loadUsers(1);
}

function viewUser(userId) {
    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    window.location.href = `/bot/user/${userId}/`;
}

function editUser(userId) {
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadUsers(1);
});
</script>
{% endblock %}

