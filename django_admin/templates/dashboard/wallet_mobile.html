{% extends 'base.html' %}
{% load static %}

{% block title %}Кошелек - Управление кошельками{% endblock %}
{% block header_icon %}wallet{% endblock %}
{% block header_title %}Кошелек{% endblock %}
{% block header_subtitle %}Управление кошельками{% endblock %}
<script>
// Удаление банка по API
async function deleteBank(bankId) {
    if (!confirm('Удалить этот банк?')) return;
    try {
        const res = await fetch(`/bot_control/api/banks/${bankId}/delete/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (res.ok && data.success) {
            alert('Банк удален');
            location.reload();
        } else {
            alert(data.error || 'Ошибка удаления банка');
        }
    } catch (e) {
        console.error(e);
        alert('Ошибка удаления банка');
    }
}

// удалён дублирующийся блок BankWallet UI (используем нижний, /dashboard/api/bank-wallets/)
</script>


{% block content %}
<style>
/* Modern Wallet Styles */
.form-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-field label {
    color: #fff;
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 4px;
}

/* Унифицированные стили для всех полей ввода */
.form-field input,
.form-field select,
input[type="text"],
input[type="email"],
input[type="password"],
select,
input {
    width: 100% !important;
    padding: 14px !important;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.3) 100%) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid #333 !important;
    border-radius: 10px !important;
    color: #fff !important;
    font-size: 14px !important;
    box-sizing: border-box !important;
    transition: all 0.3s ease !important;
}

.form-field input:focus,
.form-field select:focus,
input[type="text"]:focus,
input[type="email"]:focus,
input[type="password"]:focus,
select:focus,
input:focus {
    outline: none !important;
    border-color: #00ff88 !important;
    box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2) !important;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0.4) 100%) !important;
}

/* Стилизация чекбоксов */
input[type="checkbox"] {
    appearance: none;
    width: 18px;
    height: 18px;
    border: 2px solid #00ff88;
    border-radius: 4px;
    background: transparent;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

input[type="checkbox"]:checked {
    background: #00ff88;
    border-color: #00ff88;
}

input[type="checkbox"]:checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #000;
    font-weight: bold;
    font-size: 12px;
}

input[type="checkbox"]:hover {
    border-color: #00d4aa;
    box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
}

/* Стилизация лейблов чекбоксов */
label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 12px;
    color: #fff;
    transition: color 0.3s ease;
}

label:hover {
    color: #00ff88;
}

/* Принудительное переопределение всех inline стилей полей ввода */
input[style*="background"],
input[style*="color"],
input[style*="border"] {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.3) 100%) !important;
    color: #fff !important;
    border: 1px solid #333 !important;
}

/* Специально для полей с белым фоном */
input[style*="background: white"],
input[style*="background-color: white"],
input[style*="background: #fff"],
input[style*="background-color: #fff"] {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.3) 100%) !important;
    color: #fff !important;
}

.wallet-header {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.2) 100%);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 4px 16px rgba(0, 0, 0, 0.3);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    color: white;
}

.wallet-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.3s ease;
    text-align: center;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 800;
    color: #fff;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
}

.bank-item {
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.bank-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    border-color: rgba(255,255,255,0.2);
}

.bank-name {
    font-size: 16px;
    font-weight: 800;
    color: #fff;
    margin-bottom: 8px;
}

.bank-code {
    font-size: 12px;
    color: #9fb0c4;
    font-family: monospace;
    background: rgba(255,255,255,0.05);
    padding: 4px 8px;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 8px;
}

.bank-features {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.feature-badge {
    background: rgba(0, 255, 136, 0.2);
    color: #00ff88;
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 600;
    border: 1px solid rgba(0, 255, 136, 0.3);
}

/* Улучшенные стили кнопок */
.btn-primary {
    background: linear-gradient(135deg, #00ff88 0%, #00d4aa 100%);
    border: none;
    color: #000;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
    background: linear-gradient(135deg, #00d4aa 0%, #00ff88 100%);
}

.btn-secondary {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
}

.btn-warning {
    background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
    border: none;
    color: #000;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
}

.delete-btn {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.delete-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
}
</style>


<!-- Список банков -->
<div class="banks-list" style="margin-bottom: 20px;">
    
    {% for bank in banks %}
    <div class="bank-item">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
                <div class="bank-name">{{ bank.bank_name }}</div>
                <div class="bank-code">{{ bank.bank_code }}</div>
                <div class="bank-features">
                    {% if bank.is_enabled_deposit %}<span class="feature-badge">✅ Пополнение</span>{% endif %}
                    {% if bank.is_enabled_withdraw %}<span class="feature-badge">✅ Вывод</span>{% endif %}
                </div>
            </div>
            <div style="margin-left: 12px;">
                <button onclick="deleteBank({{ bank.id }})" class="delete-btn">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <!-- нет банков -->
    {% endfor %}
</div>

<!-- Удалён блок "Список QR хешей" по требованию: списки снизу — только реквизиты и кошельки -->

<!-- Статистика скрыта по просьбе: удалён блок с показателями -->

<script>
// ===== BankWallet UI (moved inside content block) =====
function shortHash(val){
  try{
    if(!val) return '';
    const s = String(val);
    if(s.length <= 30) return s;
    return s.slice(0, 18) + '…' + s.slice(-10);
  }catch(_){ return val; }
}
async function fetchBankWallets() {
  try {
    const res = await fetch('/dashboard/api/bank-wallets/');
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    renderBankWallets(data.items || []);
  } catch (e) {
    const c = document.getElementById('bw_list');
    if (c) c.innerHTML = `<div style="color:#f66;">${e.message}</div>`;
  }
}

function renderBankWallets(items) {
  const c = document.getElementById('bw_list');
  if (!c) return;
  if (!items.length) { c.innerHTML = '<div style="color:#cccccc; background: transparent;">Кошельки не добавлены</div>'; return; }
  c.innerHTML = '';
  items.forEach(w => {
    const el = document.createElement('div');
    el.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:10px; border:1px solid rgba(255, 255, 255, 0.1); border-radius:10px; background: linear-gradient(135deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.1) 100%); backdrop-filter: blur(10px);';
    el.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:4px;">
        <div style="color:#fff; font-weight:600; font-size:13px;">${w.bank_code.toUpperCase()} • ${w.account_name}</div>
        <div style="color:#9aa4b2; font-size:11px;" title="${w.hash_value}">${shortHash(w.hash_value)}</div>
        <div style="color:#888; font-size:10px;">${w.is_active ? '✅ Активен' : '❌ Неактивен'}</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button onclick="toggleBankWallet(${w.id})" style="background:${w.is_active ? '#ef4444' : '#00ff88'}; border:none; color:#000; padding:6px 10px; border-radius:6px; font-size:12px; cursor:pointer;">${w.is_active ? 'Выключить' : 'Включить'}</button>
        <button onclick="deleteBankWallet(${w.id})" style="background:#dc3545; color:#fff; border:none; padding:6px 10px; border-radius:6px; font-size:12px; cursor:pointer;">Удалить</button>
      </div>
    `;
    c.appendChild(el);
  });
}

window.createBankWallet = async function() {
  const bank_code = document.getElementById('bw_bank').value;
  const account_name = document.getElementById('bw_name').value.trim();
  const hash_value = document.getElementById('bw_hash').value.trim();
  const is_active = document.getElementById('bw_active').checked;
  if (!account_name || !hash_value) { alert('Укажите название и hash'); return; }
  try {
    const res = await fetch('/dashboard/api/bank-wallets/create/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bank_code, account_name, hash_value, is_active }) });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    await fetchBankWallets();
    document.getElementById('bw_name').value = '';
    document.getElementById('bw_hash').value = '';
  } catch(e) { alert('Ошибка: ' + e.message); }
}

async function toggleBankWallet(id) {
  try {
    const res = await fetch(`/dashboard/api/bank-wallets/${id}/toggle/`, { method:'POST' });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    await fetchBankWallets();
    try { await refreshRequisites(); } catch (_) {}
  } catch(e) { alert('Ошибка: ' + e.message); }
}

// функция выбора основного кошелька удалена по требованию

async function deleteBankWallet(id) {
  if (!confirm('Удалить кошелёк?')) return;
  try {
    const res = await fetch(`/dashboard/api/bank-wallets/${id}/delete/`, { method:'DELETE' });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    await fetchBankWallets();
    try { await refreshRequisites(); } catch (_) {}
  } catch(e) { alert('Ошибка: ' + e.message); }
}

document.addEventListener('DOMContentLoaded', function() {
    try { fetchBankWallets(); } catch(e) { console.warn('init wallets failed', e); }
    try { refreshRequisites(); } catch(e) { console.warn('init requisites failed', e); }
});

// Добавление QR хеша
async function addQRHash() {
    const accountName = document.getElementById('account_name').value;
    const qrHash = document.getElementById('qr_hash').value;
    const gmailEmail = document.getElementById('gmail_email').value;
    const gmailPassword = document.getElementById('gmail_password').value;
    const isMain = document.getElementById('is_main').checked;
    const isActive = document.getElementById('is_active').checked;
    
    if (!accountName || !qrHash || !gmailEmail || !gmailPassword) {
        alert('Заполните все обязательные поля!');
        return;
    }
    
    try {
        const response = await fetch('/bot_control/api/qr-hashes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_name: accountName,
                hash_value: qrHash,
                gmail_email: gmailEmail,
                gmail_password: gmailPassword,
                is_main: isMain,
                is_active: isActive
            })
        });
        
        if (response.ok) {
            alert('QR хеш успешно добавлен!');
            location.reload();
        } else {
            const error = await response.json();
            alert('Ошибка: ' + error.error);
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка добавления QR хеша');
    }
}

// Установка основного QR хеша
async function setMainQR(qrId) {
    if (!confirm('Сделать этот QR хеш основным и отключить банковские кошельки?')) return;
    try {
      // 1) Сделать выбранный QR основным и активным
      const response = await fetch(`/bot_control/api/qr-hashes/${qrId}/set-main/`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      if (!response.ok) throw new Error('Ошибка установки основного хеша');

      // 2) Отключить все прочие QR
      try {
        const list = await fetch('/bot_control/api/qr-hashes/list/');
        const listJson = await list.json().catch(()=>({}));
        const arr = (listJson && listJson.wallets) || [];
        for (const q of arr) {
          if (q.id !== qrId && q.is_active) {
            await fetch(`/bot_control/api/qr-hashes/${q.id}/toggle/`, { method:'POST' });
          }
        }
        // Убедимся, что выбранный активен
        const self = arr.find(x=>x.id===qrId);
        if (self && !self.is_active) {
          await fetch(`/bot_control/api/qr-hashes/${qrId}/toggle/`, { method:'POST' });
        }
      } catch(e) { console.warn('Normalize QR list failed', e); }

      // 3) Отключить все банковские кошельки
      try {
        const listRes = await fetch('/dashboard/api/bank-wallets/');
        const listData = await listRes.json();
        const items = (listData && listData.items) || [];
        for (const w of items) {
          if (w.is_active) {
            await fetch(`/dashboard/api/bank-wallets/${w.id}/toggle/`, { method:'POST' });
          }
        }
      } catch(e) { console.warn('Deactivate bank wallets on QR select failed', e); }

      location.reload();
    } catch (error) {
      console.error('Ошибка:', error);
      alert('Ошибка установки основного хеша');
    }
}

// Переключение статуса QR хеша
async function toggleQR(qrId) {
    if (confirm('Изменить статус QR хеша?')) {
        try {
            const response = await fetch(`/bot_control/api/qr-hashes/${qrId}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('Ошибка изменения статуса');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка изменения статуса');
        }
    }
}

// Удаление QR хеша
async function deleteQR(qrId) {
    if (confirm('Удалить этот QR хеш? Это действие нельзя отменить!')) {
        try {
            const response = await fetch(`/bot_control/api/qr-hashes/${qrId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                alert('QR хеш удален!');
                location.reload();
            } else {
                alert('Ошибка удаления QR хеша');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка удаления QR хеша');
        }
    }
}
</script>

<!-- Реквизиты для QR (Новый блок) -->
<div class="requisites-section" style="margin-top: 24px;">
  <div class="stat-card" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.2) 100%); backdrop-filter: blur(10px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 16px;">
    <h3 style="color:#fff; font-size:16px; font-weight:600; margin-bottom: 12px;">Demirbank — добавить реквизит</h3>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: stretch;">
      <div style="display: flex; flex-direction: column; gap: 8px; min-height: 80px;">
        <label style="color:#fff; font-size:13px; font-weight: 600; margin-bottom: 6px; line-height: 1.2;">Название аккаунта</label>
        <input id="rq_name" type="text" placeholder="Например: Демирбанк Акк 1" style="flex: 1;">
      </div>
      <div style="display: flex; flex-direction: column; gap: 8px; min-height: 80px;">
        <label style="color:#fff; font-size:13px; font-weight: 600; margin-bottom: 6px; line-height: 1.2;">Реквизит Demirbank (16 цифр)</label>
        <input id="rq_value" type="text" placeholder="1180000353932089" style="flex: 1;">
      </div>
      <div style="display: flex; flex-direction: column; gap: 8px; min-height: 80px;">
        <label style="color:#fff; font-size:13px; font-weight: 600; margin-bottom: 6px; line-height: 1.2;">Email (для Demirbank уведомлений)</label>
        <input id="rq_email" type="email" placeholder="you@example.com" style="flex: 1;">
      </div>
      <div style="display: flex; flex-direction: column; gap: 8px; min-height: 80px;">
        <label style="color:#fff; font-size:13px; font-weight: 600; margin-bottom: 6px; line-height: 1.2;">Пароль (для Demirbank уведомлений)</label>
        <input id="rq_password" type="password" placeholder="Пароль" style="flex: 1;">
      </div>
      <div style="grid-column: 1 / span 2; display:flex; align-items:center; gap: 12px;">
        <label style="color:#fff; font-size:12px; display:flex; align-items:center; gap:6px;">
          <input id="rq_active" type="checkbox"> Активный
        </label>
        <button onclick="addRequisite()" class="btn-primary" style="margin-left:auto;">Добавить реквизит</button>
      </div>
    </div>
  </div>

  <!-- Список реквизитов перенесён вниз под список кошельков -->
</div>

<!-- Кошельки банков (MBank / Optima / Bakai) -->
<div class="requisites-section" style="margin-top: 24px;">
  <div class="stat-card" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.2) 100%); backdrop-filter: blur(10px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 16px;">
    <h3 style="color:#fff; font-size:16px; font-weight:600; margin-bottom: 12px;">Добавить кошелёк (MBank / Optima / Bakai)</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: stretch;">
      <div style="display: flex; flex-direction: column; gap: 8px; min-height: 80px;">
        <label style="color:#fff; font-size:13px; font-weight: 600; margin-bottom: 6px; line-height: 1.2;">Банк</label>
        <select id="bw_bank" style="flex: 1;">
          <option value="mbank">MBank</option>
          <option value="optima">Optima</option>
          <option value="bakai">Bakai</option>
        </select>
      </div>
      <div style="display: flex; flex-direction: column; gap: 8px; min-height: 80px;">
        <label style="color:#fff; font-size:13px; font-weight: 600; margin-bottom: 6px; line-height: 1.2;">Название</label>
        <input id="bw_name" type="text" placeholder="Например: MBank Акк 1" style="flex: 1;">
      </div>
      <div style="grid-column: 1 / span 2; display: flex; flex-direction: column; gap: 8px; min-height: 80px;">
        <label style="color:#fff; font-size:13px; font-weight: 600; margin-bottom: 6px; line-height: 1.2;">Hash/Реквизит</label>
        <input id="bw_hash" type="text" placeholder="Вставьте hash" style="flex: 1;">
      </div>
      <div style="grid-column: 1 / span 2; display:flex; align-items:center; gap: 12px;">
        <label style="color:#fff; font-size:12px; display:flex; align-items:center; gap:6px;">
          <input id="bw_active" type="checkbox" checked> Активный
        </label>
        <!-- Убран чекбокс 'Основной' -->
        <button onclick="createBankWallet()" class="btn-primary" style="margin-left:auto;">Добавить</button>
      </div>
    </div>
  </div>

  <div class="stat-card" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.2) 100%); backdrop-filter: blur(15px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); border-radius:12px; padding: 16px; border:1px solid rgba(255, 255, 255, 0.1);">
    <h3 style="color:#fff; font-size:16px; font-weight:600; margin-bottom: 12px;">Кошельки банков</h3>
    <div id="bw_list" style="display:flex; flex-direction:column; gap:10px;">
      {% if bank_wallets %}
        {% for w in bank_wallets %}
        <div style="display:flex; align-items:center; justify-content:space-between; padding:10px; border:1px solid rgba(255, 255, 255, 0.1); border-radius:10px; background: linear-gradient(135deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.1) 100%); backdrop-filter: blur(10px);">
          <div style="display:flex; flex-direction:column; gap:4px;">
            <div style="color:#fff; font-weight:600; font-size:13px;">{{ w.bank_name|upper }} • {{ w.wallet_address|slice:":20" }}</div>
            <div style="color:#9aa4b2; font-size:11px;" title="{{ w.wallet_address }}">{{ w.wallet_address|slice:":18" }}…{{ w.wallet_address|slice:"-10:" }}</div>
            <div style="color:#888; font-size:10px;">{% if w.is_active %}✅ Активен{% else %}❌ Неактивен{% endif %}</div>
          </div>
          <div style="display:flex; gap:8px;">
            <button onclick="toggleBankWallet({{ w.id }})" class="{% if w.is_active %}btn-secondary{% else %}btn-primary{% endif %}" style="font-size:12px; padding:6px 10px;">{% if w.is_active %}Выключить{% else %}Включить{% endif %}</button>
            <button onclick="deleteBankWallet({{ w.id }})" class="btn-secondary" style="font-size:12px; padding:6px 10px;">Удалить</button>
          </div>
        </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</div>

<!-- Перенесённый вниз список реквизитов Demirbank -->
<div class="requisites-section" style="margin-top: 16px;">
  <div class="stat-card" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.2) 100%); backdrop-filter: blur(15px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); border-radius:12px; padding: 16px; border:1px solid rgba(255, 255, 255, 0.1);">
    <h3 style="color:#fff; font-size:16px; font-weight:600; margin-bottom: 12px;">Реквизиты ({{ requisites_count }})</h3>
    <div id="rq_list">
      {% if requisites %}
        {% for r in requisites %}
        <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255, 255, 255, 0.1);">
          <div style="flex:1;">
            <div style="color:#fff; font-weight:600; font-size:13px;">
              {{ r.value }} {% if r.is_active %}<span style="background:#00ff88; color:#000; border-radius:4px; padding:2px 6px; font-size:10px; margin-left:6px;">АКТИВНЫЙ</span>{% endif %}
            </div>
            <div style="color:#888; font-size:11px; margin-top:2px;">{{ r.created_at }}</div>
          </div>
          <div style="display:flex; gap:8px;">
            {% if not r.is_active %}
            <button onclick="setActiveRequisite({{ r.id }})" class="btn-warning" style="font-size:12px; padding:6px 10px;">Сделать активным</button>
            {% endif %}
            <button onclick="deleteRequisite({{ r.id }})" class="btn-secondary" style="font-size:12px; padding:6px 10px;">Удалить</button>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div style="text-align:center; color:#cccccc; padding:20px; background: transparent;">Реквизиты не добавлены</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
async function addRequisite() {
  const value = document.getElementById('rq_value').value.trim();
  const name = document.getElementById('rq_name').value.trim();
  const email = document.getElementById('rq_email').value.trim();
  const password = document.getElementById('rq_password').value.trim();
  const is_active = document.getElementById('rq_active').checked;
  if (!/^\d{16}$/.test(value)) {
    alert('Реквизит должен быть 16-значным числом');
    return;
  }
  try {
    const res = await fetch('{% url "dashboard:api_requisites" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ value, is_active, name, email, password })
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    location.reload();
  } catch(err) {
    alert('Ошибка: ' + err.message);
  }
}

async function setActiveRequisite(id) {
  if (!confirm('Сделать активным этот реквизит?')) return;
  try {
    const res = await fetch(`{% url "dashboard:api_requisites_set_active" rid=0 %}`.replace('/0/', `/${id}/`), {
      method: 'POST', headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    location.reload();
  } catch(err) {
    alert('Ошибка: ' + err.message);
  }
}

async function deleteRequisite(id) {
  if (!confirm('Удалить реквизит?')) return;
  try {
    const res = await fetch(`{% url "dashboard:api_requisites_delete" rid=0 %}`.replace('/0/', `/${id}/`), {
      method: 'DELETE', headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    location.reload();
  } catch(err) {
    alert('Ошибка: ' + err.message);
  }
}
</script>
{% endblock %}

<script>
// Fallback shim: ensure createBankWallet exists globally
if (typeof window.createBankWallet !== 'function') {
  window.createBankWallet = async function() {
    try {
      const bankEl = document.getElementById('bw_bank');
      const nameEl = document.getElementById('bw_name');
      const hashEl = document.getElementById('bw_hash');
      const activeEl = document.getElementById('bw_active');
      const mainEl = document.getElementById('bw_main');
      if (!bankEl || !nameEl || !hashEl || !activeEl || !mainEl) {
        alert('Не найдены поля формы для добавления кошелька');
        return;
      }
      const bank_code = bankEl.value;
      const account_name = nameEl.value.trim();
      const hash_value = hashEl.value.trim();
      const is_active = activeEl.checked;
      const is_main = mainEl.checked;
      if (!account_name || !hash_value) { alert('Укажите название и hash'); return; }
      const res = await fetch('/api/bank-wallets/create/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bank_code, account_name, hash_value, is_active, is_main })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.success) {
        throw new Error((data && data.error) || 'Ошибка добавления кошелька');
      }
      if (typeof window.fetchBankWallets === 'function') {
        await window.fetchBankWallets();
      } else {
        // мягкое обновление, если списка нет
        location.reload();
      }
      nameEl.value = '';
      hashEl.value = '';
    } catch (e) {
      alert('Ошибка: ' + (e && e.message ? e.message : e));
    }
  };
}
</script>
