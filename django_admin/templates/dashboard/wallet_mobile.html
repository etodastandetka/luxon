{% extends 'base.html' %}
{% load static %}
<script>
// Удаление банка по API
async function deleteBank(bankId) {
    if (!confirm('Удалить этот банк?')) return;
    try {
        const res = await fetch(`/bot_control/api/banks/${bankId}/delete/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (res.ok && data.success) {
            alert('Банк удален');
            location.reload();
        } else {
            alert(data.error || 'Ошибка удаления банка');
        }
    } catch (e) {
        console.error(e);
        alert('Ошибка удаления банка');
    }
}

// удалён дублирующийся блок BankWallet UI (используем нижний, /dashboard/api/bank-wallets/)
</script>

{% block title %}Кошелек{% endblock %}

{% block header_title %}Кошелек{% endblock %}
{% block header_subtitle %}Банки и QR-коды{% endblock %}

{% block content %}

<!-- Список банков -->
<div class="banks-list" style="margin-bottom: 20px;">
    
    {% for bank in banks %}
    <div class="bank-item" style="background: #1a1a1a; border-radius: 12px; padding: 16px; border: 1px solid #333; margin-bottom: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
                <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 4px;">{{ bank.bank_name }}</div>
                <div style="font-size: 11px; color: #999; font-family: monospace;">{{ bank.bank_code }}</div>
                <div style="font-size: 10px; color: #666; margin-top: 4px;">
                    {% if bank.is_enabled_deposit %}✅ Пополнение{% endif %}
                    {% if bank.is_enabled_withdraw %}✅ Вывод{% endif %}
                </div>
            </div>
            <div style="margin-left: 12px;">
                <button onclick="deleteBank({{ bank.id }})" style="background: #ef4444; border: none; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <!-- нет банков -->
    {% endfor %}
</div>

<!-- Удалён блок "Список QR хешей" по требованию: списки снизу — только реквизиты и кошельки -->

<!-- Статистика скрыта по просьбе: удалён блок с показателями -->

<script>
// ===== BankWallet UI (moved inside content block) =====
async function fetchBankWallets() {
  try {
    const res = await fetch('/dashboard/api/bank-wallets/');
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    renderBankWallets(data.items || []);
  } catch (e) {
    const c = document.getElementById('bw_list');
    if (c) c.innerHTML = `<div style="color:#f66;">${e.message}</div>`;
  }
}

function renderBankWallets(items) {
  const c = document.getElementById('bw_list');
  if (!c) return;
  if (!items.length) { c.innerHTML = '<div style="color:#888;">Кошельки не добавлены</div>'; return; }
  c.innerHTML = '';
  items.forEach(w => {
    const el = document.createElement('div');
    el.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:10px; border:1px solid #222; border-radius:10px; background:#141414;';
    el.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:4px;">
        <div style="color:#fff; font-weight:600; font-size:13px;">${w.bank_code.toUpperCase()} • ${w.account_name}</div>
        <div style="color:#9aa4b2; font-size:11px;">${w.hash_value}</div>
        <div style="color:#888; font-size:10px;">${w.is_active ? '✅ Активен' : '❌ Неактивен'} ${w.is_main ? ' • ⭐ Основной' : ''}</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button onclick="toggleBankWallet(${w.id})" style="background:${w.is_active ? '#ef4444' : '#00ff88'}; border:none; color:#000; padding:6px 10px; border-radius:6px; font-size:12px; cursor:pointer;">${w.is_active ? 'Выключить' : 'Включить'}</button>
        <button onclick="setMainBankWallet(${w.id})" style="background:#ffc107; color:#000; border:none; padding:6px 10px; border-radius:6px; font-size:12px; cursor:pointer;">Сделать основным</button>
        <button onclick="deleteBankWallet(${w.id})" style="background:#dc3545; color:#fff; border:none; padding:6px 10px; border-radius:6px; font-size:12px; cursor:pointer;">Удалить</button>
      </div>
    `;
    c.appendChild(el);
  });
}

window.createBankWallet = async function() {
  const bank_code = document.getElementById('bw_bank').value;
  const account_name = document.getElementById('bw_name').value.trim();
  const hash_value = document.getElementById('bw_hash').value.trim();
  const is_active = document.getElementById('bw_active').checked;
  const is_main = document.getElementById('bw_main').checked;
  if (!account_name || !hash_value) { alert('Укажите название и hash'); return; }
  try {
    const res = await fetch('/dashboard/api/bank-wallets/create/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bank_code, account_name, hash_value, is_active, is_main }) });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    await fetchBankWallets();
    document.getElementById('bw_name').value = '';
    document.getElementById('bw_hash').value = '';
  } catch(e) { alert('Ошибка: ' + e.message); }
}

async function toggleBankWallet(id) {
  try {
    const res = await fetch(`/dashboard/api/bank-wallets/${id}/toggle/`, { method:'POST' });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    await fetchBankWallets();
  } catch(e) { alert('Ошибка: ' + e.message); }
}

async function setMainBankWallet(id) {
  try {
    const res = await fetch(`/dashboard/api/bank-wallets/${id}/set-main/`, { method:'POST' });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    await fetchBankWallets();
  } catch(e) { alert('Ошибка: ' + e.message); }
}

async function deleteBankWallet(id) {
  if (!confirm('Удалить кошелёк?')) return;
  try {
    const res = await fetch(`/dashboard/api/bank-wallets/${id}/delete/`, { method:'DELETE' });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    await fetchBankWallets();
  } catch(e) { alert('Ошибка: ' + e.message); }
}

document.addEventListener('DOMContentLoaded', function() {
    // init
});

// Добавление QR хеша
async function addQRHash() {
    const accountName = document.getElementById('account_name').value;
    const qrHash = document.getElementById('qr_hash').value;
    const gmailEmail = document.getElementById('gmail_email').value;
    const gmailPassword = document.getElementById('gmail_password').value;
    const isMain = document.getElementById('is_main').checked;
    const isActive = document.getElementById('is_active').checked;
    
    if (!accountName || !qrHash || !gmailEmail || !gmailPassword) {
        alert('Заполните все обязательные поля!');
        return;
    }
    
    try {
        const response = await fetch('/bot_control/api/qr-hashes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_name: accountName,
                hash_value: qrHash,
                gmail_email: gmailEmail,
                gmail_password: gmailPassword,
                is_main: isMain,
                is_active: isActive
            })
        });
        
        if (response.ok) {
            alert('QR хеш успешно добавлен!');
            location.reload();
        } else {
            const error = await response.json();
            alert('Ошибка: ' + error.error);
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка добавления QR хеша');
    }
}

// Установка основного QR хеша
async function setMainQR(qrId) {
    if (!confirm('Сделать этот QR хеш основным и отключить банковские кошельки?')) return;
    try {
      // 1) Сделать выбранный QR основным и активным
      const response = await fetch(`/bot_control/api/qr-hashes/${qrId}/set-main/`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      if (!response.ok) throw new Error('Ошибка установки основного хеша');

      // 2) Отключить все прочие QR
      try {
        const list = await fetch('/bot_control/api/qr-hashes/list/');
        const listJson = await list.json().catch(()=>({}));
        const arr = (listJson && listJson.wallets) || [];
        for (const q of arr) {
          if (q.id !== qrId && q.is_active) {
            await fetch(`/bot_control/api/qr-hashes/${q.id}/toggle/`, { method:'POST' });
          }
        }
        // Убедимся, что выбранный активен
        const self = arr.find(x=>x.id===qrId);
        if (self && !self.is_active) {
          await fetch(`/bot_control/api/qr-hashes/${qrId}/toggle/`, { method:'POST' });
        }
      } catch(e) { console.warn('Normalize QR list failed', e); }

      // 3) Отключить все банковские кошельки
      try {
        const listRes = await fetch('/api/bank-wallets/');
        const listData = await listRes.json();
        const items = (listData && listData.items) || [];
        for (const w of items) {
          if (w.is_active) {
            await fetch(`/api/bank-wallets/${w.id}/toggle/`, { method:'POST' });
          }
        }
      } catch(e) { console.warn('Deactivate bank wallets on QR select failed', e); }

      location.reload();
    } catch (error) {
      console.error('Ошибка:', error);
      alert('Ошибка установки основного хеша');
    }
}

// Переключение статуса QR хеша
async function toggleQR(qrId) {
    if (confirm('Изменить статус QR хеша?')) {
        try {
            const response = await fetch(`/bot_control/api/qr-hashes/${qrId}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('Ошибка изменения статуса');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка изменения статуса');
        }
    }
}

// Удаление QR хеша
async function deleteQR(qrId) {
    if (confirm('Удалить этот QR хеш? Это действие нельзя отменить!')) {
        try {
            const response = await fetch(`/bot_control/api/qr-hashes/${qrId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                alert('QR хеш удален!');
                location.reload();
            } else {
                alert('Ошибка удаления QR хеша');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка удаления QR хеша');
        }
    }
}
</script>

<!-- Реквизиты для QR (Новый блок) -->
<div class="requisites-section" style="margin-top: 24px;">
  <div class="stat-card" style="background: #1a1a1a; border-radius: 12px; padding: 20px; border: 1px solid #333; margin-bottom: 16px;">
    <h3 style="color:#fff; font-size:16px; font-weight:600; margin-bottom: 12px;">Demirbank — добавить реквизит</h3>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
      <div>
        <label style="color:#fff; font-size:12px;">Название аккаунта</label>
        <input id="rq_name" type="text" placeholder="Например: Демирбанк Акк 1" style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; border-radius:8px; color:#fff;">
      </div>
      <div>
        <label style="color:#fff; font-size:12px;">Реквизит Demirbank (16 цифр)</label>
        <input id="rq_value" type="text" placeholder="1180000353932089" style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; border-radius:8px; color:#fff;">
      </div>
      <div>
        <label style="color:#fff; font-size:12px;">Email (для Demirbank уведомлений)</label>
        <input id="rq_email" type="email" placeholder="you@example.com" style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; border-radius:8px; color:#fff;">
      </div>
      <div>
        <label style="color:#fff; font-size:12px;">Пароль (для Demirbank уведомлений)</label>
        <input id="rq_password" type="password" placeholder="Пароль" style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; border-radius:8px; color:#fff;">
      </div>
      <div style="grid-column: 1 / span 2; display:flex; align-items:center; gap: 12px;">
        <label style="color:#fff; font-size:12px; display:flex; align-items:center; gap:6px;">
          <input id="rq_active" type="checkbox"> Активный
        </label>
        <button onclick="addRequisite()" style="margin-left:auto; padding:10px 14px; background:#4CAF50; color:#fff; border:none; border-radius:8px; cursor:pointer;">Добавить реквизит</button>
      </div>
    </div>
  </div>

  <!-- Список реквизитов перенесён вниз под список кошельков -->
</div>

<!-- Кошельки банков (MBank / Optima / Bakai) -->
<div class="requisites-section" style="margin-top: 24px;">
  <div class="stat-card" style="background: #1a1a1a; border-radius: 12px; padding: 20px; border: 1px solid #333; margin-bottom: 16px;">
    <h3 style="color:#fff; font-size:16px; font-weight:600; margin-bottom: 12px;">Добавить кошелёк (MBank / Optima / Bakai)</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
      <div>
        <label style="color:#fff; font-size:12px;">Банк</label>
        <select id="bw_bank" style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; border-radius:8px; color:#fff;">
          <option value="mbank">MBank</option>
          <option value="optima">Optima</option>
          <option value="bakai">Bakai</option>
        </select>
      </div>
      <div>
        <label style="color:#fff; font-size:12px;">Название</label>
        <input id="bw_name" type="text" placeholder="Например: MBank Акк 1" style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; border-radius:8px; color:#fff;">
      </div>
      <div style="grid-column: 1 / span 2;">
        <label style="color:#fff; font-size:12px;">Hash/Реквизит</label>
        <input id="bw_hash" type="text" placeholder="Вставьте hash" style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; border-radius:8px; color:#fff;">
      </div>
      <div style="grid-column: 1 / span 2; display:flex; align-items:center; gap: 12px;">
        <label style="color:#fff; font-size:12px; display:flex; align-items:center; gap:6px;">
          <input id="bw_active" type="checkbox" checked> Активный
        </label>
        <label style="color:#fff; font-size:12px; display:flex; align-items:center; gap:6px;">
          <input id="bw_main" type="checkbox"> Основной
        </label>
        <button onclick="createBankWallet()" style="margin-left:auto; padding:10px 14px; background:#4CAF50; color:#fff; border:none; border-radius:8px; cursor:pointer;">Добавить</button>
      </div>
    </div>
  </div>

  <div class="stat-card" style="background:#1a1a1a; border-radius:12px; padding: 16px; border:1px solid #333;">
    <h3 style="color:#fff; font-size:16px; font-weight:600; margin-bottom: 12px;">Кошельки банков</h3>
    <div id="bw_list" style="display:flex; flex-direction:column; gap:10px;"></div>
  </div>
</div>

<!-- Перенесённый вниз список реквизитов Demirbank -->
<div class="requisites-section" style="margin-top: 16px;">
  <div class="stat-card" style="background:#1a1a1a; border-radius:12px; padding: 16px; border:1px solid #333;">
    <h3 style="color:#fff; font-size:16px; font-weight:600; margin-bottom: 12px;">Реквизиты ({{ requisites_count }})</h3>
    {% if requisites %}
      {% for r in requisites %}
      <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #222;">
        <div style="flex:1;">
          <div style="color:#fff; font-weight:600; font-size:13px;">
            {{ r.value }} {% if r.is_active %}<span style="background:#00ff88; color:#000; border-radius:4px; padding:2px 6px; font-size:10px; margin-left:6px;">АКТИВНЫЙ</span>{% endif %}
          </div>
          <div style="color:#888; font-size:11px; margin-top:2px;">{{ r.created_at }}</div>
        </div>
        <div style="display:flex; gap:8px;">
          {% if not r.is_active %}
          <button onclick="setActiveRequisite({{ r.id }})" style="background:#ffc107; color:#000; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px;">Сделать активным</button>
          {% endif %}
          <button onclick="deleteRequisite({{ r.id }})" style="background:#ef4444; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px;">Удалить</button>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div style="text-align:center; color:#888; padding:20px;">Реквизиты не добавлены</div>
    {% endif %}
  </div>
</div>

<script>
async function addRequisite() {
  const value = document.getElementById('rq_value').value.trim();
  const name = document.getElementById('rq_name').value.trim();
  const email = document.getElementById('rq_email').value.trim();
  const password = document.getElementById('rq_password').value.trim();
  const is_active = document.getElementById('rq_active').checked;
  if (!/^\d{16}$/.test(value)) {
    alert('Реквизит должен быть 16-значным числом');
    return;
  }
  try {
    const res = await fetch('{% url "dashboard:api_requisites" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ value, is_active, name, email, password })
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    location.reload();
  } catch(err) {
    alert('Ошибка: ' + err.message);
  }
}

async function setActiveRequisite(id) {
  if (!confirm('Сделать активным этот реквизит?')) return;
  try {
    const res = await fetch(`{% url "dashboard:api_requisites_set_active" rid=0 %}`.replace('/0/', `/${id}/`), {
      method: 'POST', headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    location.reload();
  } catch(err) {
    alert('Ошибка: ' + err.message);
  }
}

async function deleteRequisite(id) {
  if (!confirm('Удалить реквизит?')) return;
  try {
    const res = await fetch(`{% url "dashboard:api_requisites_delete" rid=0 %}`.replace('/0/', `/${id}/`), {
      method: 'DELETE', headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data.success) throw new Error(data.error || 'Ошибка');
    location.reload();
  } catch(err) {
    alert('Ошибка: ' + err.message);
  }
}
</script>
{% endblock %}

<script>
// Fallback shim: ensure createBankWallet exists globally
if (typeof window.createBankWallet !== 'function') {
  window.createBankWallet = async function() {
    try {
      const bankEl = document.getElementById('bw_bank');
      const nameEl = document.getElementById('bw_name');
      const hashEl = document.getElementById('bw_hash');
      const activeEl = document.getElementById('bw_active');
      const mainEl = document.getElementById('bw_main');
      if (!bankEl || !nameEl || !hashEl || !activeEl || !mainEl) {
        alert('Не найдены поля формы для добавления кошелька');
        return;
      }
      const bank_code = bankEl.value;
      const account_name = nameEl.value.trim();
      const hash_value = hashEl.value.trim();
      const is_active = activeEl.checked;
      const is_main = mainEl.checked;
      if (!account_name || !hash_value) { alert('Укажите название и hash'); return; }
      const res = await fetch('/api/bank-wallets/create/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bank_code, account_name, hash_value, is_active, is_main })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.success) {
        throw new Error((data && data.error) || 'Ошибка добавления кошелька');
      }
      if (typeof window.fetchBankWallets === 'function') {
        await window.fetchBankWallets();
      } else {
        // мягкое обновление, если списка нет
        location.reload();
      }
      nameEl.value = '';
      hashEl.value = '';
    } catch (e) {
      alert('Ошибка: ' + (e && e.message ? e.message : e));
    }
  };
}
</script>
