#!/usr/bin/env python
import os
import sys
import django

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'admin_panel.settings')
django.setup()

from django.contrib.auth.models import User
from bot_control.models import UserProfile

def list_users():
    """–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    print("=== –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===")
    users = User.objects.all()
    
    for user in users:
        try:
            profile = UserProfile.objects.get(user=user)
            print(f"üë§ {user.username} (ID: {user.id})")
            print(f"   Email: {user.email}")
            print(f"   Superuser: {'–î–∞' if user.is_superuser else '–ù–µ—Ç'}")
            print(f"   Staff: {'–î–∞' if user.is_staff else '–ù–µ—Ç'}")
            print(f"   2FA: {'–í–∫–ª—é—á–µ–Ω–∞' if profile.is_2fa_enabled else '–û—Ç–∫–ª—é—á–µ–Ω–∞'}")
            print(f"   Active: {'–î–∞' if user.is_active else '–ù–µ—Ç'}")
            print()
        except UserProfile.DoesNotExist:
            print(f"üë§ {user.username} (ID: {user.id}) - –ù–ï–¢ –ü–†–û–§–ò–õ–Ø")
            print(f"   Email: {user.email}")
            print(f"   Superuser: {'–î–∞' if user.is_superuser else '–ù–µ—Ç'}")
            print()

def reset_admin_password():
    """–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞"""
    username = 'admin'
    new_password = 'admin123'
    
    try:
        user = User.objects.get(username=username)
        user.set_password(new_password)
        user.save()
        print(f"‚úÖ –ü–∞—Ä–æ–ª—å –¥–ª—è {username} —Å–±—Ä–æ—à–µ–Ω –Ω–∞: {new_password}")
    except User.DoesNotExist:
        print(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} –Ω–µ –Ω–∞–π–¥–µ–Ω")

def create_test_user():
    """–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    username = 'test'
    email = 'test@luxon.com'
    password = 'test123'
    
    try:
        if User.objects.filter(username=username).exists():
            print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return
            
        user = User.objects.create_user(
            username=username,
            email=email,
            password=password
        )
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        UserProfile.objects.create(
            user=user,
            is_2fa_enabled=False,
            secret_key=''
        )
        
        print(f"‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω:")
        print(f"   Username: {username}")
        print(f"   Password: {password}")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

if __name__ == "__main__":
    import sys
    
    if len(sys.argv) > 1:
        command = sys.argv[1]
        
        if command == 'list':
            list_users()
        elif command == 'reset':
            reset_admin_password()
        elif command == 'test':
            create_test_user()
        else:
            print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: list, reset, test")
    else:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python manage_users.py [list|reset|test]")
