#!/usr/bin/env python
import os
import sys
import django

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'admin_panel.settings')
django.setup()

from django.contrib.auth.models import User
from bot_control.models import UserProfile

def fix_admin_user():
    """–ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    print("=== –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===")
    
    username = 'dastan'
    password = 'dastan10dz'
    email = 'admin@luxon.com'
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if User.objects.filter(username=username).exists():
            print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            user = User.objects.get(username=username)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å
            user.set_password(password)
            user.email = email
            user.is_superuser = True
            user.is_staff = True
            user.is_active = True
            user.save()
            
            print(f"‚úÖ –ü–∞—Ä–æ–ª—å –∏ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è {username}")
            
        else:
            print(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º...")
            
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = User.objects.create_superuser(
                username=username,
                email=email,
                password=password
            )
            print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} —Å–æ–∑–¥–∞–Ω")
        
        # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        profile, created = UserProfile.objects.get_or_create(
            user=user,
            defaults={
                'is_2fa_enabled': False,
                'secret_key': ''
            }
        )
        
        if created:
            print(f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è {username} —Å–æ–∑–¥–∞–Ω")
        else:
            print(f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è {username} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            profile.is_2fa_enabled = False
            profile.secret_key = ''
            profile.save()
            print(f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è {username} –æ–±–Ω–æ–≤–ª–µ–Ω")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
        from django.contrib.auth import authenticate
        auth_user = authenticate(username=username, password=password)
        
        if auth_user:
            print(f"‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è {username}")
        else:
            print(f"‚ùå –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è {username}")
        
        print(f"\nüìã –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:")
        print(f"Username: {username}")
        print(f"Password: {password}")
        print(f"Email: {email}")
        print(f"Superuser: {'–î–∞' if user.is_superuser else '–ù–µ—Ç'}")
        print(f"Staff: {'–î–∞' if user.is_staff else '–ù–µ—Ç'}")
        print(f"Active: {'–î–∞' if user.is_active else '–ù–µ—Ç'}")
        print(f"2FA: {'–í–∫–ª—é—á–µ–Ω–∞' if profile.is_2fa_enabled else '–û—Ç–∫–ª—é—á–µ–Ω–∞'}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return False

def check_all_users():
    """–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ"""
    print("\n=== –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ ===")
    
    users = User.objects.all()
    if not users:
        print("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç!")
        return
    
    for user in users:
        print(f"\nüë§ {user.username} (ID: {user.id})")
        print(f"   Email: {user.email}")
        print(f"   Superuser: {'–î–∞' if user.is_superuser else '–ù–µ—Ç'}")
        print(f"   Staff: {'–î–∞' if user.is_staff else '–ù–µ—Ç'}")
        print(f"   Active: {'–î–∞' if user.is_active else '–ù–µ—Ç'}")
        
        try:
            profile = UserProfile.objects.get(user=user)
            print(f"   2FA: {'–í–∫–ª—é—á–µ–Ω–∞' if profile.is_2fa_enabled else '–û—Ç–∫–ª—é—á–µ–Ω–∞'}")
        except UserProfile.DoesNotExist:
            print(f"   –ü—Ä–æ—Ñ–∏–ª—å: –ù–ï–¢")

if __name__ == "__main__":
    print("üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    check_all_users()
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∞
    if fix_admin_user():
        print("\nüéâ –ê–¥–º–∏–Ω—Å–∫–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω!")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑
        print("\n=== –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ===")
        check_all_users()
    else:
        print("\nüí• –û—à–∏–±–∫–∞! –ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
