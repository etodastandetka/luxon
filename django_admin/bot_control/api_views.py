from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_http_methods
from django.utils import timezone
import json
import logging

logger = logging.getLogger(__name__)

@csrf_exempt
@require_http_methods(["POST", "PUT"])
def payment_api(request):
    """
    API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ/–≤—ã–≤–æ–¥
    """
    try:
        print(f"üîÑ Django API: –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å {request.method} –Ω–∞ /api/payment/")
        print(f"üîÑ Django API: Headers: {dict(request.headers)}")
        print(f"üîÑ Django API: Body: {request.body}")
        
        data = json.loads(request.body)
        print(f"üîÑ Django API: Parsed data: {data}")
        
        if request.method == 'POST':
            # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏
            print("üîÑ Django API: –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É...")
            return create_payment_request(data)
        elif request.method == 'PUT':
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏
            print("üîÑ Django API: –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—è–≤–∫—É...")
            return update_payment_status(data)
            
    except Exception as e:
        print(f"‚ùå Django API error: {str(e)}")
        logger.error(f"Error in payment_api: {str(e)}")
        return JsonResponse({'error': str(e)}, status=500)

def create_payment_request(data):
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–≤–æ–¥"""
    try:
        print(f"üîÑ Django API: –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏: {data}")
        
        from bot_control.models import Request
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        required_fields = ['type', 'amount', 'bookmaker']
        for field in required_fields:
            if field not in data:
                print(f"‚ùå Django API: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: {field}")
                return JsonResponse({'error': f'Missing required field: {field}'}, status=400)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if not data.get('userId') and not data.get('user_id') and not data.get('telegram_user_id'):
            print(f"‚ùå Django API: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (userId, user_id –∏–ª–∏ telegram_user_id)")
            return JsonResponse({'error': 'Missing user identification'}, status=400)
        
        print(f"üîÑ Django API: –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç")
        
        # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        telegram_user_id = data.get('telegram_user_id')
        casino_player_id = data.get('userId') or data.get('user_id')  # ID –∏–≥—Ä–æ–∫–∞ –≤ –±—É–∫–º–µ–∫–µ—Ä—Å–∫–æ–π –∫–æ–Ω—Ç–æ—Ä–µ
        
        print(f"üîÑ Django API: Telegram ID: {telegram_user_id}, Casino ID: {casino_player_id}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ID
        if not telegram_user_id and not casino_player_id:
            return JsonResponse({'error': 'Missing user identification'}, status=400)
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ Django ORM
        request_obj = Request.objects.create(
            user_id=telegram_user_id or casino_player_id,  # Telegram ID –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ–Ω, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Casino ID –∫–∞–∫ fallback
            request_type=data['type'],  # 'deposit' –∏–ª–∏ 'withdraw'
            amount=data['amount'],
            bookmaker=data['bookmaker'],
            bank=data.get('bank', ''),
            account_id=casino_player_id or '',  # Casino ID –∏–≥—Ä–æ–∫–∞ –≤ –±—É–∫–º–µ–∫–µ—Ä—Å–∫–æ–π –∫–æ–Ω—Ç–æ—Ä–µ
            phone=data.get('phone', ''),
            status='pending',
            created_at=timezone.now(),
            # –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
            username=data.get('telegram_username', ''),
            first_name=data.get('telegram_first_name', ''),
            last_name=data.get('telegram_last_name', '')
        )
        
        print(f"‚úÖ Django API: –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å ID {request_obj.id}")
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∑–∞—è–≤–∫—É –≤ SQLite –±–∞–∑—É –±–æ—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
        if data['type'] == 'deposit':
            try:
                # –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É –≤ SQLite –±–∞–∑–µ –±–æ—Ç–∞
                from django.conf import settings
                import sqlite3
                import os
                from pathlib import Path
                
                # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
                db_path = getattr(settings, 'BOT_DATABASE_PATH', None)
                if not db_path:
                    # Fallback –ø—É—Ç—å
                    project_root = Path(__file__).resolve().parent.parent.parent
                    db_path = str(project_root / 'bot' / 'universal_bot.db')
                
                # –ó–∞—è–≤–∫–∞ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ PostgreSQL —á–µ—Ä–µ–∑ Request.objects.create()
                # –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ SQLite –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
                logger.info(f"Request {request_obj.id} saved to PostgreSQL")
                
                # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—á—Ç—ã –¥–ª—è –∞–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
                try:
                    from autodeposit.watcher import trigger_immediate_check
                    trigger_immediate_check()
                    logger.info(f"‚úÖ –ó–∞–ø—É—â–µ–Ω–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—á—Ç—ã –¥–ª—è –∑–∞—è–≤–∫–∏ {request_obj.id}")
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—á—Ç—ã –¥–ª—è –∑–∞—è–≤–∫–∏ {request_obj.id}: {e}")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞—è–≤–∫–∏ {request_obj.id} –≤ SQLite –±–∞–∑—É –±–æ—Ç–∞: {e}")
        
        return JsonResponse({
            'success': True,
            'id': request_obj.id,
            'transactionId': request_obj.id,
            'message': '–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞'
        })
        
    except Exception as e:
        print(f"‚ùå Django API: –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏: {str(e)}")
        logger.error(f"Error creating payment request: {str(e)}")
        return JsonResponse({'error': str(e)}, status=500)

def update_payment_status(data):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏"""
    try:
        from bot_control.models import Request
        
        print(f"üîÑ Django API: –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—è–≤–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏: {data}")
        
        # –ï—Å–ª–∏ ID –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ null, –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞—è–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if 'id' not in data or data['id'] is None:
            print("üîÑ Django API: ID –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞—è–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞—è–≤–∫—É –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
            request_obj = Request.objects.filter(
                request_type=data.get('type', 'deposit')
            ).order_by('-created_at').first()
            
            if not request_obj:
                print("üîÑ Django API: –ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é")
                # –ï—Å–ª–∏ –∑–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                request_obj = Request.objects.create(
                    user_id=1,  # –í—Ä–µ–º–µ–Ω–Ω—ã–π ID
                    request_type=data.get('type', 'deposit'),
                    amount=0,
            status=data.get('status', 'pending'),
                    created_at=timezone.now()
                )
                print(f"üîÑ Django API: –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ID {request_obj.id}")
            else:
                print(f"üîÑ Django API: –ù–∞–π–¥–µ–Ω–∞ –∑–∞—è–≤–∫–∞ ID {request_obj.id}")
        else:
            try:
                request_obj = Request.objects.get(id=data['id'])
                print(f"üîÑ Django API: –ù–∞–π–¥–µ–Ω–∞ –∑–∞—è–≤–∫–∞ –ø–æ ID {request_obj.id}")
            except Request.DoesNotExist:
                return JsonResponse({'error': 'Request not found'}, status=404)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        if 'status' in data:
            request_obj.status = data['status']
            request_obj.updated_at = timezone.now()
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º status_detail –µ—Å–ª–∏ –µ—Å—Ç—å
            if 'status_detail' in data:
                try:
                    if hasattr(request_obj, 'status_detail'):
                        request_obj.status_detail = data['status_detail']
                except Exception:
                    pass
            
            # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º processed_at
            if data['status'] in ['completed', 'rejected', 'approved', 'auto_completed', 'autodeposit_success', 'profile-5']:
                request_obj.processed_at = timezone.now()
            
            request_obj.save()

        return JsonResponse({
            'success': True,
            'message': '–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω'
        })
        
    except Exception as e:
        logger.error(f"Error updating payment status: {str(e)}")
        return JsonResponse({'error': str(e)}, status=500)

@csrf_exempt
@require_http_methods(["POST"])
def generate_qr_api(request):
    """
    API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö –±–∞–Ω–∫–æ–≤
    """
    try:
        data = json.loads(request.body)
        
        amount = data.get('amount', 0)
        player_id = data.get('playerId', '')
        
        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∫–≤–∏–∑–∏—Ç –∏–∑ PostgreSQL —á–µ—Ä–µ–∑ Django ORM
        requisite = None
        try:
            from bot_control.models import BotRequisite
            active_requisite = BotRequisite.objects.filter(is_active=True).first()
            if active_requisite:
                requisite = active_requisite.value
                logger.info(f"Using active requisite from PostgreSQL: {requisite}")
        except Exception as e:
            logger.error(f"Error fetching requisite from PostgreSQL: {str(e)}", exc_info=True)
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ PostgreSQL, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ BotConfiguration (fallback)
        if not requisite:
            try:
                from bot_control.models import BotConfiguration
                active_config = BotConfiguration.objects.filter(key='active_requisite').first()
                if active_config and active_config.value:
                    # –ò—â–µ–º —Ä–µ–∫–≤–∏–∑–∏—Ç –ø–æ ID
                    req_id = active_config.value
                    req_config = BotConfiguration.objects.filter(id=int(req_id), key__startswith='requisite_').first()
                    if req_config:
                        requisite = req_config.value
                        logger.info(f"Using requisite from BotConfiguration: {requisite}")
            except Exception as e:
                logger.error(f"Error fetching requisite from BotConfiguration: {str(e)}", exc_info=True)
        
        # –ï—Å–ª–∏ –≤—Å—ë –µ—â–µ –Ω–µ—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
        if not requisite:
            requisite = '1234567890123456'
            logger.warning("No active requisite found, using fallback")
        
        logger.info(f"Generating QR for amount={amount}, requisite={requisite}")
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        if not amount or amount <= 0:
            logger.error(f"Invalid amount: {amount}")
            return JsonResponse({'error': 'Invalid amount'}, status=400)
        
        if not requisite or len(requisite) < 10:
            logger.error(f"Invalid requisite: {requisite}")
            return JsonResponse({'error': 'Invalid requisite'}, status=400)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥
        try:
            amount_cents = int(float(amount) * 100)
            # –ü–∞–¥–¥–∏–º —Å—É–º–º—É –¥–æ 5 —Å–∏–º–≤–æ–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 200.74 -> 20074)
            amount_str = str(amount_cents).zfill(5)
            amount_length = "05"  # –í—Å–µ–≥–¥–∞ 5 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            
            requisite_length = str(len(requisite)).zfill(2)  # –î–ª–∏–Ω–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞
            
            # –°–æ–∑–¥–∞–µ–º TLV —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã (–±–µ–∑ 6304)
            # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ –≤—Å–µ–º–∏ –±–∞–Ω–∫–∞–º–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ MBank)
            merchant_account_value = (
                f"0015qr.demirbank.kg"  # –ü–æ–¥-—Ç–µ–≥ 00: –¥–æ–º–µ–Ω
                f"01047001"              # –ü–æ–¥-—Ç–µ–≥ 01: –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–∏–ø (7001)
                f"10{requisite_length}{requisite}"  # –ü–æ–¥-—Ç–µ–≥ 10: —Ä–µ–∫–≤–∏–∑–∏—Ç
                f"120211130212"          # –ü–æ–¥-—Ç–µ–≥–∏ 12, 13: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ)
            )
            merchant_account_length = str(len(merchant_account_value)).zfill(2)
            
            payload = (
                f"000201"  # 00 - Payload Format Indicator
                f"010211"  # 01 - Point of Initiation Method (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π QR)
                f"32{merchant_account_length}{merchant_account_value}"  # 32 - Merchant Account
                f"52044829"  # 52 - Merchant Category Code
                f"5303417"   # 53 - Transaction Currency
                f"54{amount_length}{amount_str}"  # 54 - Amount (5 —Ü–∏—Ñ—Ä —Å –ø–∞–¥–¥–∏–Ω–≥–æ–º)
                f"5909DEMIRBANK"  # 59 - Merchant Name
            )
            
            logger.info(f"Payload before checksum: {payload}")
            
            # –í—ã—á–∏—Å–ª—è–µ–º SHA256 –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É (–ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ - –æ—Ç payload –ë–ï–ó '6304')
            import hashlib
            checksum_full = hashlib.sha256(payload.encode('utf-8')).hexdigest()
            # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ: 283f)
            checksum = checksum_full[-4:].lower()
            
            # –ü–æ–ª–Ω—ã–π QR —Ö–µ—à: payload + '6304' + checksum
            qr_hash = payload + "6304" + checksum
        except Exception as e:
            logger.error(f"Error generating QR hash: {str(e)}", exc_info=True)
            return JsonResponse({'error': f'Error generating QR: {str(e)}'}, status=500)
        
        logger.info(f"Generated QR hash: {qr_hash}")
        logger.info(f"Checksum: {checksum}")
        
        # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –≤—Å–µ—Ö –±–∞–Ω–∫–æ–≤
        bank_links = {
            'DemirBank': f"https://retail.demirbank.kg/#{qr_hash}",
            'O!Money': f"https://api.dengi.o.kg/ru/qr/#{qr_hash}",
            'Balance.kg': f"https://balance.kg/#{qr_hash}",
            'Bakai': f"https://bakai24.app/#{qr_hash}",
            'MegaPay': f"https://megapay.kg/get#{qr_hash}",
            'MBank': f"https://app.mbank.kg/qr/#{qr_hash}",
            'Optima': f"https://optima.kg/qr/#{qr_hash}",
            '–ö–æ–º–ø–∞–Ω—å–æ–Ω': f"https://kompanion.kg/qr/#{qr_hash}"
        }

        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –∏–∑ –∞–¥–º–∏–Ω–∫–∏
        try:
            import json
            deposits_str = BotConfiguration.get_setting('deposits', '{"enabled": true, "banks": ["mbank", "bakai", "balance", "demir", "omoney", "megapay"]}')
            deposits = json.loads(deposits_str) if isinstance(deposits_str, str) else deposits_str
            
            # –ú–∞–ø–ø–∏–Ω–≥ –±–∞–Ω–∫–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
            bank_mapping = {
                'mbank': 'MBank',
                'demir': 'DemirBank', 
                'balance': 'Balance.kg',
                'omoney': 'O!Money',
                'megapay': 'MegaPay',
                'bakai': 'Bakai',
                'optima': 'Optima',
                'kompanion': '–ö–æ–º–ø–∞–Ω—å–æ–Ω'
            }
            
            # –§–∏–ª—å—Ç—Ä—É–µ–º –±–∞–Ω–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
            enabled_banks = []
            for bank_code in deposits.get('banks', []):
                if bank_code in bank_mapping:
                    enabled_banks.append(bank_code)
            
            logger.info(f"Enabled banks from admin: {enabled_banks}")
            
        except Exception as e:
            logger.error(f"Error getting deposit settings: {str(e)}")
            # Fallback - –≤—Å–µ –±–∞–Ω–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã
            enabled_banks = ['demir', 'omoney', 'balance', 'bakai', 'megapay', 'mbank', 'optima', 'kompanion']

        return JsonResponse({
            'success': True,
            'qr_hash': qr_hash,
            'primary_url': bank_links['DemirBank'],
            'all_bank_urls': bank_links,
            'settings': {
                'enabled_banks': enabled_banks,
                'deposits_enabled': deposits.get('enabled', True)
            }
        })
        
    except Exception as e:
        logger.error(f"Error generating QR code: {str(e)}", exc_info=True)
        return JsonResponse({'error': str(e)}, status=500)

@csrf_exempt
@require_http_methods(["GET"])
def api_bot_settings(request):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞"""
    try:
        from bot_control.models import BotConfiguration
        
        settings = {}
        configs = BotConfiguration.objects.all()
        
        for config in configs:
            settings[config.key] = config.value
        
        return JsonResponse({
            'success': True,
            'settings': settings
        })
        
    except Exception as e:
        logger.error(f"Error getting bot settings: {str(e)}")
        return JsonResponse({'error': str(e)}, status=500)

@csrf_exempt
@require_http_methods(["GET"])
def api_requisites_list(request):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∏–∑ PostgreSQL —á–µ—Ä–µ–∑ Django ORM"""
    try:
        from bot_control.models import BotRequisite
        requisites_list = BotRequisite.objects.all().order_by('-is_active', '-id')
        
        requisites = []
        active_id = None
        
        for req in requisites_list:
            if req.is_active and active_id is None:
                active_id = req.id
            
            requisites.append({
                'id': req.id,
                'name': req.name or f'–†–µ–∫–≤–∏–∑–∏—Ç {req.id}',
                'value': req.value,
                'is_active': req.is_active,
                'created_at': req.created_at.isoformat() if req.created_at else ''
            })
        
        logger.info(f"Found {len(requisites)} requisites, active_id: {active_id}")
        
        return JsonResponse({
            'success': True,
            'requisites': requisites,
            'active_id': active_id
        })
        
    except Exception as e:
        logger.error(f"Error getting requisites: {str(e)}", exc_info=True)
        return JsonResponse({'error': str(e)}, status=500)

@csrf_exempt
@require_http_methods(["GET"])
def api_search_payments(request):
    """API –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π –ø–æ —Å—É–º–º–µ (–∏–≥–Ω–æ—Ä–∏—Ä—É—è –∫–æ–ø–µ–π–∫–∏)"""
    try:
        from bot_control.models import IncomingPayment
        from decimal import Decimal
        
        search_amount = request.GET.get('amount', '').strip()
        exact_match = request.GET.get('exact', 'false').lower() == 'true'
        processed_only = request.GET.get('processed', 'false').lower() == 'true'
        request_id = request.GET.get('request_id')
        
        payments_queryset = IncomingPayment.objects.all()
        
        # –§–∏–ª—å—Ç—Ä –ø–æ –∑–∞—è–≤–∫–µ, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
        if request_id:
            try:
                from bot_control.models import Request
                req = Request.objects.get(id=int(request_id))
                payments_queryset = payments_queryset.filter(request=req)
            except (Request.DoesNotExist, ValueError):
                payments_queryset = payments_queryset.none()
        
        # –§–∏–ª—å—Ç—Ä –ø–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º
        if processed_only:
            payments_queryset = payments_queryset.filter(is_processed=True)
        
        # –ü–æ–∏—Å–∫ –ø–æ —Å—É–º–º–µ
        if search_amount:
            try:
                search_amount_float = float(search_amount)
                # –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ - –∏—â–µ–º —Ç–æ—á–Ω—É—é —Å—É–º–º—É
                if exact_match:
                    payments_queryset = payments_queryset.filter(amount=Decimal(str(search_amount_float)))
                else:
                    # –ò—â–µ–º –ø–æ —Å—É–º–º–µ –±–µ–∑ –∫–æ–ø–µ–µ–∫ (–æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª–æ–≥–æ)
                    search_int = int(search_amount_float)
                    # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å—É–º–º—ã, –≥–¥–µ —Ü–µ–ª–∞—è —á–∞—Å—Ç—å —Ä–∞–≤–Ω–∞ search_int
                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º FLOOR –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                    from django.db.models import F, Value, IntegerField
                    from django.db.models.functions import Floor
                    payments_queryset = payments_queryset.annotate(
                        amount_int=Floor(F('amount'))
                    ).filter(amount_int=search_int)
            except ValueError:
                return JsonResponse({
                    'success': False,
                    'error': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞'
                }, status=400)
        
        payments_queryset = payments_queryset.order_by('-payment_date')[:50]  # –ú–∞–∫—Å–∏–º—É–º 50
        
        payments = []
        for payment in payments_queryset:
            payments.append({
                'id': payment.id,
                'amount': float(payment.amount),
                'bank': payment.bank or '',
                'payment_date': payment.payment_date.strftime('%d.%m.%Y ‚Ä¢ %H:%M'),
                'is_processed': payment.is_processed,
                'request_id': payment.request.id if payment.request else None,
                'notification_text': payment.notification_text[:100] if payment.notification_text else ''
            })
        
        return JsonResponse({
            'success': True,
            'payments': payments,
            'count': len(payments)
        })
        
    except Exception as e:
        # –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ (–º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫,
        # —á—Ç–æ–±—ã UI –ø—Ä–æ–¥–æ–ª–∂–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π.
        if 'no such table' in str(e).lower() and 'incoming_payments' in str(e).lower():
            return JsonResponse({'success': True, 'payments': [], 'count': 0})
        logger.error(f"Error searching payments: {str(e)}", exc_info=True)
        return JsonResponse({'error': str(e)}, status=500)

@csrf_exempt
@require_http_methods(["GET"])
def api_referral_data(request):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤"""
    try:
        user_id = request.GET.get('user_id')
        
        if not user_id:
            return JsonResponse({'error': 'user_id is required'}, status=400)
        
        # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        return JsonResponse({
            'success': True,
            'referral_data': {
                'user_id': user_id,
                'referral_code': f'REF{user_id}',
                'total_referrals': 0,
                'total_earnings': 0
            }
        })
        
    except Exception as e:
        logger.error(f"Error getting referral data: {str(e)}")
        return JsonResponse({'error': str(e)}, status=500)

@csrf_exempt
@require_http_methods(["GET"])
def api_transaction_history(request):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"""
    try:
        from bot_control.models import Request
        
        user_id = request.GET.get('user_id')
        request_type = request.GET.get('type', '')  # deposit, withdraw, –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –≤—Å–µ—Ö
        
        print(f"üîÑ Django API: –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, user_id={user_id}, type={request_type}")
        
        # –ë–ï–ó–û–ü–ê–°–ù–û: –≤—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π
        base_qs = Request.objects.all().only(
            'id', 'user_id', 'account_id', 'username', 'first_name', 'last_name',
            'request_type', 'amount', 'status', 'bookmaker', 'bank', 'phone',
            'created_at', 'processed_at'
        )
        if user_id:
            print(f"üîÑ Django API: –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ user_id={user_id}")
            base_qs = base_qs.filter(user_id=user_id)
        else:
            print("üîÑ Django API: user_id –Ω–µ —É–∫–∞–∑–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏")

        if request_type:
            base_qs = base_qs.filter(request_type=request_type)

        transactions = list(base_qs.order_by('-created_at')[: (50 if user_id else 100)])

        transaction_list = []
        for tx in transactions:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_display_name = 'Unknown'
            if tx.username:
                user_display_name = f"@{tx.username}"
            elif tx.first_name and tx.last_name:
                user_display_name = f"{tx.first_name} {tx.last_name}"
            elif tx.first_name:
                user_display_name = tx.first_name
            
            # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ—Å—Ç–∞–µ–º status_detail –∏–∑ metadata, –µ—Å–ª–∏ –ø–æ–ª–µ –µ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–Ω–æ
            status_detail_value = None
            try:
                if getattr(tx, 'status_detail', None):
                    status_detail_value = tx.status_detail
                elif hasattr(tx, 'metadata') and getattr(tx, 'metadata', None):
                    meta = getattr(tx, 'metadata', '{}') or '{}'
                    if isinstance(meta, str):
                        meta_json = json.loads(meta)
                    else:
                        meta_json = meta
                    status_detail_value = meta_json.get('status_detail')
            except Exception:
                status_detail_value = None

            transaction_list.append({
                'id': tx.id,
                'user_id': tx.user_id,  # Telegram ID
                'account_id': tx.account_id or '',  # Casino ID
                'user_display_name': user_display_name,
                'username': tx.username or '',
                'first_name': tx.first_name or '',
                'last_name': tx.last_name or '',
                'type': tx.request_type,
                'amount': float(tx.amount) if tx.amount else 0,
                'status': tx.status,
                'status_detail': status_detail_value,
                'bookmaker': tx.bookmaker or '',
                'bank': tx.bank or '',
                'phone': tx.phone or '',
                'created_at': tx.created_at.isoformat() if tx.created_at else '',
                'processed_at': tx.processed_at.isoformat() if tx.processed_at else None,
            })
        
        print(f"‚úÖ Django API: –í–æ–∑–≤—Ä–∞—â–∞–µ–º {len(transaction_list)} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")
        
        return JsonResponse({
            'success': True,
            'transactions': transaction_list
        })
        
    except Exception as e:
        print(f"‚ùå Django API: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {str(e)}")
        logger.error(f"Error getting transaction history: {str(e)}")
        # –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ –∏–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è ‚Äî –Ω–µ –ª–æ–º–∞–µ–º UI
        if 'no such table' in str(e).lower() and 'request' in str(e).lower():
            return JsonResponse({'success': True, 'transactions': []})
        return JsonResponse({'success': False, 'transactions': [], 'error': str(e)}, status=500)

@csrf_exempt
@require_http_methods(["POST"])
def sync_bot_api(request):
    """
    API –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Telegram –±–æ—Ç–æ–º
    """
    try:
        print(f"üîÑ Django API: –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å –±–æ—Ç–æ–º")
        
        data = json.loads(request.body)
        print(f"üîÑ Django API: –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {data}")
        
        user_data = data.get('user', {})
        action = data.get('action', '')
        additional_data = data.get('data', {})
        init_data = data.get('initData', '')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        if user_data:
            from bot_control.models import UserProfile
            
            user_id = user_data.get('id')
            if user_id:
                # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                profile, created = UserProfile.objects.get_or_create(
                    telegram_id=user_id,
                    defaults={
                        'username': user_data.get('username', ''),
                        'first_name': user_data.get('first_name', ''),
                        'last_name': user_data.get('last_name', ''),
                        'language_code': user_data.get('language_code', 'ru'),
                        'is_premium': user_data.get('is_premium', False),
                        'init_data': init_data,
                        'last_activity': timezone.now()
                    }
                )
                
                if not created:
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å
                    profile.username = user_data.get('username', profile.username)
                    profile.first_name = user_data.get('first_name', profile.first_name)
                    profile.last_name = user_data.get('last_name', profile.last_name)
                    profile.language_code = user_data.get('language_code', profile.language_code)
                    profile.is_premium = user_data.get('is_premium', profile.is_premium)
                    profile.init_data = init_data
                    profile.last_activity = timezone.now()
                    profile.save()
                
                print(f"‚úÖ Django API: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} {'—Å–æ–∑–¥–∞–Ω' if created else '–æ–±–Ω–æ–≤–ª–µ–Ω'}")
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        if action == 'deposit_request_created':
            print(f"üîÑ Django API: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ")
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É
            
        elif action == 'withdraw_request_created':
            print(f"üîÑ Django API: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥")
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É
            
        return JsonResponse({
            'success': True,
            'message': '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–æ—Ç–æ–º —É—Å–ø–µ—à–Ω–∞'
        })
        
    except Exception as e:
        print(f"‚ùå Django API: –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –±–æ—Ç–æ–º: {str(e)}")
        logger.error(f"Error in sync_bot_api: {str(e)}")
        return JsonResponse({'error': str(e)}, status=500)