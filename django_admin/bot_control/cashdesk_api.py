"""
Cashdesk API –∫–ª–∏–µ–Ω—Ç –¥–ª—è Melbet –∏ 1xbet
"""
import hashlib
import json
import requests
from datetime import datetime
from typing import Dict, Any, Optional
import logging

logger = logging.getLogger(__name__)


class CashdeskAPI:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Cashdesk API (Melbet/1xbet)"""
    
    def __init__(self, casino: str, hash_key: str, cashierpass: str, login: str, cashdeskid: int):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è API –∫–ª–∏–µ–Ω—Ç–∞
        
        Args:
            casino: 'melbet' –∏–ª–∏ '1xbet'
            hash_key: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
            cashierpass: –ü–∞—Ä–æ–ª—å –∫–∞—Å—Å–∏—Ä–∞
            login: –õ–æ–≥–∏–Ω –∫–∞—Å—Å–∏—Ä–∞
            cashdeskid: –ù–æ–º–µ—Ä –∫–∞—Å—Å—ã (–ö–†–ú)
        """
        self.casino = casino
        self.hash_key = hash_key
        self.cashierpass = cashierpass
        self.login = login
        self.cashdeskid = cashdeskid
        self.base_url = "https://partners.servcul.com/CashdeskBotAPI"
    
    def _calculate_confirm(self, user_id: str) -> str:
        """–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–µ–π —Å—Ç—Ä–æ–∫–∏ confirm = MD5(userId:hash)"""
        confirm_str = f"{user_id}:{self.hash_key}"
        return hashlib.md5(confirm_str.encode()).hexdigest()
    
    def _generate_sign_balance(self, dt: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞"""
        # a. SHA256(hash={0}&cashierpass={1}&dt={2})
        step1 = f"hash={self.hash_key}&cashierpass={self.cashierpass}&dt={dt}"
        sha1 = hashlib.sha256(step1.encode()).hexdigest()
        
        # b. MD5(dt={0}&cashierpass={1}&cashdeskid={2})
        step2 = f"dt={dt}&cashierpass={self.cashierpass}&cashdeskid={self.cashdeskid}"
        md5_hash = hashlib.md5(step2.encode()).hexdigest()
        
        # c. SHA256(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã a –∏ b –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã)
        combined = sha1 + md5_hash
        sign = hashlib.sha256(combined.encode()).hexdigest()
        
        return sign
    
    def _generate_sign_player_search(self, user_id: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–∞"""
        # a. SHA256(hash={0}&userid={1}&cashdeskid={2})
        step1 = f"hash={self.hash_key}&userid={user_id}&cashdeskid={self.cashdeskid}"
        sha1 = hashlib.sha256(step1.encode()).hexdigest()
        
        # b. MD5(userid={0}&cashierpass={1}&hash={2})
        step2 = f"userid={user_id}&cashierpass={self.cashierpass}&hash={self.hash_key}"
        md5_hash = hashlib.md5(step2.encode()).hexdigest()
        
        # c. SHA256(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã a –∏ b –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã)
        combined = sha1 + md5_hash
        sign = hashlib.sha256(combined.encode()).hexdigest()
        
        return sign
    
    def _generate_sign_deposit(self, lng: str, user_id: str, summa: float) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è"""
        # a. SHA256(hash={0}&lng={1}&UserId={2})
        step1 = f"hash={self.hash_key}&lng={lng}&UserId={user_id}"
        sha1 = hashlib.sha256(step1.encode()).hexdigest()
        
        # b. MD5(summa={0}&cashierpass={1}&cashdeskid={2})
        step2 = f"summa={summa}&cashierpass={self.cashierpass}&cashdeskid={self.cashdeskid}"
        md5_hash = hashlib.md5(step2.encode()).hexdigest()
        
        # c. SHA256(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã a –∏ b –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã)
        combined = sha1 + md5_hash
        sign = hashlib.sha256(combined.encode()).hexdigest()
        
        return sign
    
    def _generate_sign_payout(self, lng: str, user_id: str, code: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã"""
        # a. SHA256(hash={0}&lng={1}&UserId={2})
        step1 = f"hash={self.hash_key}&lng={lng}&UserId={user_id}"
        sha1 = hashlib.sha256(step1.encode()).hexdigest()
        
        # b. MD5(code={0}&cashierpass={1}&cashdeskid={2})
        step2 = f"code={code}&cashierpass={self.cashierpass}&cashdeskid={self.cashdeskid}"
        md5_hash = hashlib.md5(step2.encode()).hexdigest()
        
        # c. SHA256(—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã a –∏ b –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã)
        combined = sha1 + md5_hash
        sign = hashlib.sha256(combined.encode()).hexdigest()
        
        return sign
    
    def get_balance(self) -> Dict[str, Any]:
        """
        1. –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–∞—Å—Å—ã
        
        Returns:
            {'Balance': float, 'Limit': float}
        """
        try:
            dt = datetime.now().strftime('%Y.%m.%d %H:%M:%S')
            confirm = self._calculate_confirm(self.cashdeskid)
            sign = self._generate_sign_balance(dt)
            
            url = f"{self.base_url}/Cashdesk/{self.cashdeskid}/Balance?confirm={confirm}&dt={dt}"
            headers = {'sign': sign}
            
            logger.info(f"üí∞ –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è {self.casino}")
            response = requests.get(url, headers=headers, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                logger.info(f"‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—É—á–µ–Ω: {data}")
                return data
            else:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: {response.status_code} - {response.text}")
                return {'Balance': 0, 'Limit': 0}
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ get_balance: {e}")
            return {'Balance': 0, 'Limit': 0}
    
    def search_player(self, user_id: str) -> Dict[str, Any]:
        """
        2. –ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞
        
        Args:
            user_id: ID –∏–≥—Ä–æ–∫–∞
            
        Returns:
            {'currencyId': int, 'userId': int, 'name': str}
        """
        try:
            confirm = self._calculate_confirm(user_id)
            sign = self._generate_sign_player_search(user_id)
            
            url = f"{self.base_url}/Users/{user_id}?confirm={confirm}&cashdeskId={self.cashdeskid}"
            headers = {'sign': sign}
            
            logger.info(f"üîç –ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞ {user_id} –¥–ª—è {self.casino}")
            response = requests.get(url, headers=headers, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                logger.info(f"‚úÖ –ò–≥—Ä–æ–∫ –Ω–∞–π–¥–µ–Ω: {data}")
                return data
            else:
                logger.error(f"‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω: {response.status_code} - {response.text}")
                return {}
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ search_player: {e}")
            return {}
    
    def deposit(self, user_id: str, summa: float, lng: str = 'ru') -> Dict[str, Any]:
        """
        3. –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞ –∏–≥—Ä–æ–∫–∞
        
        Args:
            user_id: ID –∏–≥—Ä–æ–∫–∞
            summa: –°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
            lng: –Ø–∑—ã–∫
            
        Returns:
            {'summa': float, 'success': bool, 'messageId': int, 'message': str}
        """
        try:
            confirm = self._calculate_confirm(user_id)
            sign = self._generate_sign_deposit(lng, user_id, summa)
            
            url = f"{self.base_url}/Deposit/{user_id}/Add"
            headers = {'sign': sign, 'Content-Type': 'application/json'}
            
            payload = {
                'cashdeskId': self.cashdeskid,
                'lng': lng,
                'summa': summa,
                'confirm': confirm
            }
            
            logger.info(f"üí∏ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ {summa} –¥–ª—è –∏–≥—Ä–æ–∫–∞ {user_id} –≤ {self.casino}")
            response = requests.post(url, headers=headers, json=payload, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                logger.info(f"‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {data}")
                return data
            else:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: {response.status_code} - {response.text}")
                return {'success': False, 'message': '–û—à–∏–±–∫–∞ API', 'messageId': -1}
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ deposit: {e}")
            return {'success': False, 'message': str(e), 'messageId': -1}
    
    def payout(self, user_id: str, code: str, lng: str = 'ru') -> Dict[str, Any]:
        """
        4. –í—ã–ø–ª–∞—Ç–∞ —Å–æ —Å—á–µ—Ç–∞ –∏–≥—Ä–æ–∫–∞
        
        Args:
            user_id: ID –∏–≥—Ä–æ–∫–∞
            code: –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            lng: –Ø–∑—ã–∫
            
        Returns:
            {'summa': float, 'success': bool, 'messageId': int, 'message': str}
        """
        try:
            confirm = self._calculate_confirm(user_id)
            sign = self._generate_sign_payout(lng, user_id, code)
            
            url = f"{self.base_url}/Deposit/{user_id}/Payout"
            headers = {'sign': sign, 'Content-Type': 'application/json'}
            
            payload = {
                'cashdeskId': self.cashdeskid,
                'lng': lng,
                'code': code,
                'confirm': confirm
            }
            
            logger.info(f"üí∞ –í—ã–ø–ª–∞—Ç–∞ {code} –¥–ª—è –∏–≥—Ä–æ–∫–∞ {user_id} –≤ {self.casino}")
            response = requests.post(url, headers=headers, json=payload, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                logger.info(f"‚úÖ –í—ã–ø–ª–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: {data}")
                return data
            else:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–ª–∞—Ç—ã: {response.status_code} - {response.text}")
                return {'success': False, 'message': '–û—à–∏–±–∫–∞ API', 'messageId': -1}
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ payout: {e}")
            return {'success': False, 'message': str(e), 'messageId': -1}
