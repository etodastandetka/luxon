#!/usr/bin/env python
import os
import sys
import django

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'admin_panel.settings')
django.setup()

from django.contrib.auth.models import User
from bot_control.models import UserProfile

def cleanup_users():
    """–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–∑–¥–∞—Ç—å –æ–¥–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞"""
    print("=== –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===")
    
    # –£–¥–∞–ª—è–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫—Ä–æ–º–µ dastan
    users_to_delete = User.objects.exclude(username='dastan')
    deleted_count = users_to_delete.count()
    
    for user in users_to_delete:
        print(f"üóëÔ∏è –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user.username}")
        user.delete()
    
    print(f"‚úÖ –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {deleted_count}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è dastan
    try:
        dastan = User.objects.get(username='dastan')
        print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å dastan –Ω–∞–π–¥–µ–Ω (ID: {dastan.id})")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ dastan
        dastan.email = 'admin@luxon.com'
        dastan.is_superuser = True
        dastan.is_staff = True
        dastan.is_active = True
        dastan.set_password('dastan10dz')
        dastan.save()
        
        print(f"‚úÖ –î–∞–Ω–Ω—ã–µ dastan –æ–±–Ω–æ–≤–ª–µ–Ω—ã")
        print(f"   Email: {dastan.email}")
        print(f"   Superuser: {'–î–∞' if dastan.is_superuser else '–ù–µ—Ç'}")
        print(f"   Staff: {'–î–∞' if dastan.is_staff else '–ù–µ—Ç'}")
        print(f"   Active: {'–î–∞' if dastan.is_active else '–ù–µ—Ç'}")
        
        # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        profile, created = UserProfile.objects.get_or_create(
            user=dastan,
            defaults={
                'is_2fa_enabled': False,
                'secret_key': ''
            }
        )
        
        if created:
            print(f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è dastan —Å–æ–∑–¥–∞–Ω")
        else:
            print(f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è dastan —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        
        print(f"\nüìã –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:")
        print(f"Username: dastan")
        print(f"Password: dastan10dz")
        print(f"Email: {dastan.email}")
        
    except User.DoesNotExist:
        print(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å dastan –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º...")
        
        # –°–æ–∑–¥–∞–µ–º dastan
        dastan = User.objects.create_superuser(
            username='dastan',
            email='admin@luxon.com',
            password='dastan10dz'
        )
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        UserProfile.objects.create(
            user=dastan,
            is_2fa_enabled=False,
            secret_key=''
        )
        
        print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å dastan —Å–æ–∑–¥–∞–Ω")
    
    print(f"\n=== –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===")
    users = User.objects.all()
    for user in users:
        try:
            profile = UserProfile.objects.get(user=user)
            print(f"üë§ {user.username} (ID: {user.id})")
            print(f"   Email: {user.email}")
            print(f"   Superuser: {'–î–∞' if user.is_superuser else '–ù–µ—Ç'}")
            print(f"   Staff: {'–î–∞' if user.is_staff else '–ù–µ—Ç'}")
            print(f"   2FA: {'–í–∫–ª—é—á–µ–Ω–∞' if profile.is_2fa_enabled else '–û—Ç–∫–ª—é—á–µ–Ω–∞'}")
            print(f"   Active: {'–î–∞' if user.is_active else '–ù–µ—Ç'}")
            print()
        except UserProfile.DoesNotExist:
            print(f"üë§ {user.username} (ID: {user.id}) - –ù–ï–¢ –ü–†–û–§–ò–õ–Ø")
            print(f"   Email: {user.email}")
            print(f"   Superuser: {'–î–∞' if user.is_superuser else '–ù–µ—Ç'}")
            print()

if __name__ == "__main__":
    cleanup_users()
