#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /var/www/luxon/admin_nextjs

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –∞–¥–º–∏–Ω–∫–∏ –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# 1. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
cd /var/www/luxon
git pull origin main

# 2. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∞–¥–º–∏–Ω–∫–∏
cd admin_nextjs

# 3. –ö–†–ò–¢–ò–ß–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É source –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo "üóÑÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ source –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
if [ -n "$DATABASE_URL" ]; then
    echo "–í—ã–ø–æ–ª–Ω—è—é SQL –º–∏–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ psql..."
    psql "$DATABASE_URL" -c "ALTER TABLE requests ADD COLUMN IF NOT EXISTS source VARCHAR(20);" 2>/dev/null || {
        echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ psql, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:"
        echo "   psql \$DATABASE_URL -c \"ALTER TABLE requests ADD COLUMN IF NOT EXISTS source VARCHAR(20);\""
    }
else
    echo "‚ö†Ô∏è DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:"
    echo "   ALTER TABLE requests ADD COLUMN IF NOT EXISTS source VARCHAR(20);"
fi

# 4. –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç
echo "üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞..."
npx prisma generate

# 5. –û—á–∏—â–∞–µ–º –∫–µ—à —Å–±–æ—Ä–∫–∏
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞..."
rm -rf .next
rm -rf node_modules/.cache

# 6. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

# 7. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞..."
pm2 restart luxon-admin

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: pm2 status"

