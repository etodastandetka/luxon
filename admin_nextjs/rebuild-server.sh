#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –ø–æ—Ç–µ—Ä–µ–π —Å–∏–º–≤–æ–ª–∞ @ –≤ –∏–º–ø–æ—Ä—Ç–∞—Ö
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./rebuild-server.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üîÑ –ù–∞—á–∏–Ω–∞—é –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
echo ""

# –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_DIR="/var/www/luxon/admin_nextjs"
cd "$PROJECT_DIR" || exit 1

echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ tsconfig.json
if [ ! -f "tsconfig.json" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: tsconfig.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ jsconfig.json
if [ ! -f "jsconfig.json" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: jsconfig.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ next.config.js
if [ ! -f "next.config.js" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: next.config.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

echo "‚úÖ –í—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã"
echo ""

echo "üì• –ü–æ–ª—É—á–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ git..."
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
# –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã
echo "   –ü–æ–ª—É—á–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git fetch origin main

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if ! git diff --quiet HEAD origin/main 2>/dev/null; then
    echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ä–∞–∑–ª–∏—á–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π, –æ–±–Ω–æ–≤–ª—è—é —Ñ–∞–π–ª—ã..."
    git reset --hard origin/main
    echo "‚úÖ –§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏"
else
    echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞"
fi
echo ""

echo "üßπ –û—á–∏—â–∞—é –í–°–ï –∫–µ—à–∏ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–±–æ—Ä–∫–∏..."
echo "   –£–¥–∞–ª—è—é .next..."
rm -rf .next

echo "   –£–¥–∞–ª—è—é node_modules/.cache..."
rm -rf node_modules/.cache

echo "   –£–¥–∞–ª—è—é tsconfig.tsbuildinfo..."
rm -rf tsconfig.tsbuildinfo

echo "   –£–¥–∞–ª—è—é .swc..."
rm -rf .swc

echo "   –£–¥–∞–ª—è—é .turbo..."
rm -rf .turbo

echo "‚úÖ –ö–µ—à–∏ –æ—á–∏—â–µ–Ω—ã"
echo ""

echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –≤–µ—Ä—Å–∏–∏ Node.js –∏ npm..."
node -v
npm -v
echo ""

echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
if [ ! -d "node_modules" ] || [ ! -f "node_modules/.package-lock.json" ]; then
    echo "‚ö†Ô∏è  node_modules –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω, –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    rm -rf node_modules
    npm install
else
    echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
fi
echo ""

echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–ª–∏–∞—Å–æ–≤..."
echo "   –ü—Ä–æ–≤–µ—Ä—è—é tsconfig.json..."
if grep -q '"@/\*":\s*\["./\*"\]' tsconfig.json; then
    echo "   ‚úÖ tsconfig.json: –∞–ª–∏–∞—Å @ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
else
    echo "   ‚ö†Ô∏è  tsconfig.json: –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞–ª–∏–∞—Å–æ–º @"
fi

echo "   –ü—Ä–æ–≤–µ—Ä—è—é jsconfig.json..."
if grep -q '"@/\*":\s*\["./\*"\]' jsconfig.json; then
    echo "   ‚úÖ jsconfig.json: –∞–ª–∏–∞—Å @ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
else
    echo "   ‚ö†Ô∏è  jsconfig.json: –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞–ª–∏–∞—Å–æ–º @"
fi

echo "   –ü—Ä–æ–≤–µ—Ä—è—é next.config.js..."
if grep -q "alias\['@'\]" next.config.js || grep -q 'alias\["@"\]' next.config.js || grep -q "'@':" next.config.js || grep -q '"@":' next.config.js || grep -q "webpack" next.config.js; then
    echo "   ‚úÖ next.config.js: webpack –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞"
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å webpack –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    echo "   üìù –°–æ–¥–µ—Ä–∂–∏–º–æ–µ webpack –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
    grep -A 15 "webpack:" next.config.js | head -10
else
    echo "   ‚ùå next.config.js: webpack –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ù–ï –Ω–∞–π–¥–µ–Ω–∞!"
fi
echo ""

echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é –ø—Ä–æ–µ–∫—Ç..."
npm run build

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!"
    echo ""
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é PM2 –ø—Ä–æ—Ü–µ—Å—Å..."
    pm2 restart luxon-admin
    
    echo ""
    echo "üìä –°—Ç–∞—Ç—É—Å PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
    pm2 list
    
    echo ""
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω."
else
    echo ""
    echo "‚ùå –û–®–ò–ë–ö–ê: –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π."
    exit 1
fi

