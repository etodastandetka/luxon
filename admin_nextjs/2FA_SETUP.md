# üîê –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA)

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç TOTP (Time-based One-Time Password) —Å—Ç–∞–Ω–¥–∞—Ä—Ç. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:
- Google Authenticator
- Microsoft Authenticator
- Authy
- 1Password
- LastPass Authenticator
- –ò –¥—Ä—É–≥–∏–µ TOTP-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd admin_nextjs
npm install otplib qrcode @types/qrcode
```

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π –≤ —Å—Ö–µ–º—É Prisma:

```bash
npm run db:push
# –∏–ª–∏
npm run db:migrate
```

## API Endpoints

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 2FA

**GET** `/api/auth/2fa/setup`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–µ–∫—Ä–µ—Ç –∏ QR –∫–æ–¥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 2FA.

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "secret": "JBSWY3DPEHPK3PXP",
    "qrCode": "data:image/png;base64,...",
    "backupCodes": ["ABC12345", "DEF67890", ...],
    "message": "Scan QR code with authenticator app and save backup codes"
  }
}
```

### 2. –í–∫–ª—é—á–µ–Ω–∏–µ 2FA

**POST** `/api/auth/2fa/enable`

–í–∫–ª—é—á–∞–µ—Ç 2FA –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "secret": "JBSWY3DPEHPK3PXP",
  "token": "123456",
  "backupCodes": ["ABC12345", "DEF67890", ...]
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "message": "2FA enabled successfully"
  }
}
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ 2FA –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

**POST** `/api/auth/2fa/verify`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç 2FA —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "userId": 1,
  "token": "123456",
  "useBackupCode": false
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "username": "admin",
      "email": "admin@luxon.com",
      "isSuperAdmin": true
    },
    "message": "2FA verified successfully"
  }
}
```

### 4. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ 2FA

**POST** `/api/auth/2fa/disable`

–û—Ç–∫–ª—é—á–∞–µ—Ç 2FA (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–º).

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "token": "123456"
}
```

## –ü—Ä–æ—Ü–µ—Å—Å –ª–æ–≥–∏–Ω–∞ —Å 2FA

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å**
   - POST `/api/auth/login`
   - –ï—Å–ª–∏ 2FA –≤–∫–ª—é—á–µ–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `requires2FA: true` –∏ `userId`

2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç 2FA —Ç–æ–∫–µ–Ω**
   - POST `/api/auth/2fa/verify`
   - –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –≤—ã–¥–∞–µ—Ç—Å—è JWT —Ç–æ–∫–µ–Ω

3. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–¥–∞**
   - POST `/api/auth/2fa/verify` —Å `useBackupCode: true`
   - –†–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω —Ä–∞–∑

## –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã

–ü—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ 2FA –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è 10 —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–¥–æ–≤. –ö–∞–∂–¥—ã–π –∫–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. –ü–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–¥ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

**–í–∞–∂–Ω–æ:** –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ! –û–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞, –µ—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –°–µ–∫—Ä–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ
- ‚úÖ TOTP —Ç–æ–∫–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 30 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ (window: 1)
- ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ 2FA –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π 2FA

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 2FA –≤ UI

1. –ó–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
2. –ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å 2FA"
3. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º
4. –í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ

## –û—Ç–∫–ª—é—á–µ–Ω–∏–µ 2FA

1. –ó–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
2. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫–ª—é—á–∏—Ç—å 2FA"
3. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π 2FA —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
4. 2FA –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–∞

## –ó–∞—â–∏—Ç–∞ API endpoints

–í—Å–µ API endpoints –∑–∞—â–∏—â–µ–Ω—ã:
- ‚úÖ Rate limiting
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç XSS

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç–µ 2FA** –¥–ª—è –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
2. **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã** –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ (–º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π, —Å–µ–π—Ñ)
3. **–ù–µ –¥–µ–ª–∏—Ç–µ—Å—å** —Å–µ–∫—Ä–µ—Ç–æ–º –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–¥–µ–∂–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä**
5. **–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ** –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–¥–æ–≤

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ù–µ –º–æ–≥—É –≤–æ–π—Ç–∏, –ø–æ—Ç–µ—Ä—è–ª –¥–æ—Å—Ç—É–ø –∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞
- –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ –∏ –∑–∞–Ω–æ–≤–æ –≤–∫–ª—é—á–∏—Ç–µ 2FA

### –¢–æ–∫–µ–Ω –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Ä–µ–º—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–æ–∂–¥–∞—Ç—å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (30 —Å–µ–∫—É–Ω–¥)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–µ

### –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (`npm run db:push`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

