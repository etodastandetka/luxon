// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin Users
model AdminUser {
  id                   Int      @id @default(autoincrement())
  username             String   @unique
  password             String
  email                String?  @unique
  isActive             Boolean  @default(true)
  isSuperAdmin         Boolean  @default(false)
  twoFactorEnabled     Boolean  @default(false) @map("two_factor_enabled")
  twoFactorSecret      String?  @map("two_factor_secret") @db.VarChar(255)
  twoFactorBackupCodes String?  @map("two_factor_backup_codes") @db.Text // JSON array of backup codes
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("admin_users")
}

// Bot Users (from universal_bot.db)
model BotUser {
  userId            BigInt   @id @map("user_id") @db.BigInt
  username          String?  @db.VarChar(255)
  firstName         String?  @map("first_name") @db.VarChar(255)
  lastName          String?  @map("last_name") @db.VarChar(255)
  language          String   @default("ru") @db.VarChar(10)
  selectedBookmaker String?  @map("selected_bookmaker") @db.VarChar(50)
  note              String?  @db.Text
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")

  transactions      BotTransaction[]
  referralMade      BotReferral[]        @relation("Referrer")
  referralFrom      BotReferral?         @relation("Referred")
  referralEarnings  BotReferralEarning[] @relation("ReferrerEarnings")
  earningsGenerated BotReferralEarning[] @relation("ReferredEarnings")
  userData          BotUserData[]
  referralTopEntry  BotReferralTop?
  topPayments       BotTopPayment[]
  monthlyPayments   BotMonthlyPayment[]

  @@map("users")
}

model BotUserData {
  id        Int      @id @default(autoincrement())
  userId    BigInt   @map("user_id") @db.BigInt
  dataType  String   @map("data_type") @db.VarChar(255)
  dataValue String?  @map("data_value") @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user BotUser @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, dataType])
  @@index([userId])
  @@map("user_data")
}

// Requests (Заявки на пополнение/вывод)
model Request {
  id              Int       @id @default(autoincrement())
  userId          BigInt    @map("user_id") @db.BigInt
  username        String?   @db.VarChar(255)
  firstName       String?   @map("first_name") @db.VarChar(255)
  lastName        String?   @map("last_name") @db.VarChar(255)
  bookmaker       String?   @db.VarChar(100)
  accountId       String?   @map("account_id") @db.VarChar(255)
  amount          Decimal?  @db.Decimal(10, 2)
  requestType     String    @map("request_type") @db.VarChar(20) // deposit/withdraw
  status          String    @default("pending") @db.VarChar(20)
  statusDetail    String?   @map("status_detail") @db.VarChar(50)
  processedBy     String?   @map("processed_by") @db.VarChar(100) // логин админа или "автопополнение"
  withdrawalCode  String?   @map("withdrawal_code") @db.VarChar(255)
  photoFileId     String?   @map("photo_file_id") @db.VarChar(255)
  photoFileUrl    String?   @map("photo_file_url") @db.Text
  bank            String?   @db.VarChar(100)
  phone           String?   @db.VarChar(20)
  paymentMethod   String?   @map("payment_method") @db.VarChar(20) // 'bank', 'crypto'
  cryptoPaymentId Int?      @unique @map("crypto_payment_id")
  source          String?   @db.VarChar(20) // 'bot' или 'mini_app'
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  processedAt     DateTime? @map("processed_at")

  incomingPayments IncomingPayment[]
  cryptoPayment    CryptoPayment?    @relation(fields: [cryptoPaymentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([requestType])
  @@index([createdAt])
  @@index([accountId, bookmaker]) // Для поиска транзакций казино по accountId + bookmaker
  @@index([accountId]) // Для поиска по accountId
  @@index([processedBy]) // Для фильтрации ручных заявок
  @@index([amount]) // Для поиска matching payments
  @@index([status, requestType]) // Составной индекс для частых фильтров
  @@index([userId, status]) // Для поиска заявок пользователя по статусу
  @@index([processedBy, status]) // Для фильтрации ручных заявок (manual) - processedBy + status
  @@index([requestType, createdAt]) // Для истории с фильтром по типу и сортировке по дате
  @@index([status, createdAt]) // Для истории с фильтром по статусу и сортировке по дате
  // Индексы для оптимизации запросов лимитов
  @@index([requestType, status]) // Для агрегации по типу заявки и статусу (limits stats)
  @@index([requestType, status, createdAt]) // Для запросов графика с фильтрацией (limits stats)
  @@index([bookmaker]) // Для поиска по платформе (limits stats)
  @@index([bookmaker, requestType, status]) // Для статистики по платформам (limits stats)
  @@map("requests")
}

// Bot Transactions
model BotTransaction {
  id        Int      @id @default(autoincrement())
  userId    BigInt   @map("user_id") @db.BigInt
  bookmaker String?  @db.VarChar(50)
  transType String   @map("trans_type") @db.VarChar(50)
  amount    Decimal  @db.Decimal(10, 2)
  status    String   @default("pending") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  user BotUser @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([status])
  @@map("transactions")
}

// Referrals
model BotReferral {
  id         Int      @id @default(autoincrement())
  referrerId BigInt   @map("referrer_id") @db.BigInt
  referredId BigInt   @unique @map("referred_id") @db.BigInt
  createdAt  DateTime @default(now()) @map("created_at")

  referrer BotUser @relation("Referrer", fields: [referrerId], references: [userId], onDelete: Cascade)
  referred BotUser @relation("Referred", fields: [referredId], references: [userId], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredId])
  @@map("referrals")
}

model BotReferralEarning {
  id               Int      @id @default(autoincrement())
  referrerId       BigInt   @map("referrer_id") @db.BigInt
  referredId       BigInt   @map("referred_id") @db.BigInt
  amount           Decimal  @db.Decimal(10, 2)
  commissionAmount Decimal  @map("commission_amount") @db.Decimal(10, 2)
  bookmaker        String?  @db.VarChar(50)
  status           String   @default("pending") @db.VarChar(20)
  createdAt        DateTime @default(now()) @map("created_at")

  referrer BotUser @relation("ReferrerEarnings", fields: [referrerId], references: [userId], onDelete: Cascade)
  referred BotUser @relation("ReferredEarnings", fields: [referredId], references: [userId], onDelete: Cascade)

  @@index([referrerId, status])
  @@index([referredId])
  @@map("referral_earnings")
}

model BotReferralTop {
  id             Int      @id @default(autoincrement())
  userId         BigInt   @unique @map("user_id") @db.BigInt
  totalEarnings  Decimal  @default(0) @map("total_earnings") @db.Decimal(10, 2)
  totalReferrals Int      @default(0) @map("total_referrals")
  lastUpdated    DateTime @updatedAt @map("last_updated")

  user BotUser @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("referral_top")
}

model BotTopPayment {
  id        Int      @id @default(autoincrement())
  userId    BigInt   @map("user_id") @db.BigInt
  position  Int
  amount    Decimal  @db.Decimal(10, 2)
  status    String   @default("pending") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  user BotUser @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("top_payments")
}

model BotMonthlyPayment {
  id        Int      @id @default(autoincrement())
  userId    BigInt   @map("user_id") @db.BigInt
  position  Int
  amount    Decimal  @db.Decimal(10, 2)
  status    String   @default("pending") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  user BotUser @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("monthly_payments")
}

// Requisites
model BotRequisite {
  id        Int      @id @default(autoincrement())
  value     String   @db.Text
  isActive  Boolean  @default(false) @map("is_active")
  name      String?  @db.VarChar(255)
  email     String?  @db.VarChar(255)
  password  String?  @db.VarChar(255)
  bank      String?  @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([isActive])
  @@map("requisites")
}

// Bot Settings
model BotSetting {
  key       String   @id @db.VarChar(100)
  value     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("bot_settings")
}

// Bot Configuration
model BotConfiguration {
  id          Int      @id @default(autoincrement())
  key         String   @unique @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("bot_configuration")
}

// Bank Settings
model BankSettings {
  id                Int      @id @default(autoincrement())
  bankName          String   @map("bank_name") @db.VarChar(100)
  bankCode          String?  @map("bank_code") @db.VarChar(50)
  isActive          Boolean  @default(true) @map("is_active")
  isEnabledDeposit  Boolean  @default(true) @map("is_enabled_deposit")
  isEnabledWithdraw Boolean  @default(true) @map("is_enabled_withdraw")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("bank_settings")
}

// Bank Wallets
model BankWallet {
  id            Int      @id @default(autoincrement())
  bankName      String   @default("Unknown") @map("bank_name") @db.VarChar(100)
  bankCode      String   @default("unknown") @map("bank_code") @db.VarChar(50)
  walletAddress String   @default("") @map("wallet_address") @db.VarChar(255)
  isActive      Boolean  @default(true) @map("is_active")
  isMain        Boolean  @default(false) @map("is_main")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("bank_wallets")
}

// Incoming Payments
model IncomingPayment {
  id               Int      @id @default(autoincrement())
  amount           Decimal  @db.Decimal(10, 2)
  bank             String?  @db.VarChar(50)
  paymentDate      DateTime @map("payment_date")
  notificationText String?  @map("notification_text") @db.Text
  requestId        Int?     @map("request_id")
  isProcessed      Boolean  @default(false) @map("is_processed")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  request Request? @relation(fields: [requestId], references: [id], onDelete: SetNull)

  @@index([amount, isProcessed])
  @@index([paymentDate])
  @@index([bank, isProcessed])
  @@index([amount]) // Для поиска по сумме
  @@index([requestId]) // Для поиска платежей по заявке
  @@index([isProcessed]) // Для фильтрации обработанных/необработанных
  @@map("incoming_payments")
}

// Chat Messages
model ChatMessage {
  id                Int      @id @default(autoincrement())
  userId            BigInt   @map("user_id") @db.BigInt
  messageText       String?  @map("message_text") @db.Text
  messageType       String   @default("text") @map("message_type") @db.VarChar(20)
  mediaUrl          String?  @map("media_url") @db.Text
  direction         String   @default("in") @db.VarChar(10) // 'in' - от пользователя, 'out' - от админа
  telegramMessageId BigInt?  @map("telegram_message_id") @db.BigInt
  channel           String   @default("bot") @db.VarChar(20) // bot
  replyToId         Int?     @map("reply_to_id") // ID сообщения, на которое отвечаем
  editedAt          DateTime? @map("edited_at") // Время последнего редактирования
  isDeleted         Boolean  @default(false) @map("is_deleted") // Флаг удаления
  createdAt         DateTime @default(now()) @map("created_at")

  replyTo           ChatMessage? @relation("MessageReplies", fields: [replyToId], references: [id])
  replies           ChatMessage[] @relation("MessageReplies")

  @@index([userId, createdAt])
  @@index([channel, userId, createdAt])
  @@index([replyToId])
  @@map("chat_messages")
}

// Broadcast Messages
model BroadcastMessage {
  id        Int       @id @default(autoincrement())
  title     String    @db.VarChar(200)
  message   String    @db.Text
  isSent    Boolean   @default(false) @map("is_sent")
  sentAt    DateTime? @map("sent_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("broadcast_messages")
}

// Referral Withdrawal Requests
model ReferralWithdrawalRequest {
  id                 Int       @id @default(autoincrement())
  userId             BigInt    @map("user_id") @db.BigInt
  username           String?   @db.VarChar(100)
  firstName          String?   @map("first_name") @db.VarChar(100)
  lastName           String?   @map("last_name") @db.VarChar(100)
  phoneNumber        String?   @map("phone_number") @db.VarChar(20)
  amount             Decimal   @db.Decimal(12, 2)
  currency           String    @default("KGS") @db.VarChar(10)
  bookmaker          String    @db.VarChar(20)
  bookmakerAccountId String    @map("bookmaker_account_id") @db.VarChar(64)
  paymentMethod      String    @map("payment_method") @db.VarChar(20)
  walletDetails      String    @map("wallet_details") @db.Text
  status             String    @default("pending") @db.VarChar(20)
  adminComment       String?   @map("admin_comment") @db.Text
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  processedAt        DateTime? @map("processed_at")

  @@index([status])
  @@index([userId])
  @@map("referral_withdrawal_requests")
}

// Crypto Payments
model CryptoPayment {
  id               Int       @id @default(autoincrement())
  invoice_id       String    @unique @map("invoice_id") @db.VarChar(255)
  hash             String    @db.VarChar(255)
  amount           Decimal   @db.Decimal(12, 2)
  asset            String    @db.VarChar(20) // USDT, TON, BTC, etc.
  currency_type    String    @map("currency_type") @db.VarChar(10) // 'crypto' or 'fiat'
  status           String    @default("pending") @db.VarChar(20) // 'pending', 'paid', 'expired'
  paid_at          DateTime? @map("paid_at")
  request_id       String?   @map("request_id") @db.VarChar(255)
  telegram_user_id String?   @map("telegram_user_id") @db.VarChar(255)
  payload          String?   @db.Text
  fee_amount       Decimal?  @map("fee_amount") @db.Decimal(12, 2)
  fee_asset        String?   @map("fee_asset") @db.VarChar(20)
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  request Request?

  @@index([invoice_id])
  @@index([status])
  @@index([request_id])
  @@index([telegram_user_id])
  @@map("crypto_payments")
}

// Banners for main page carousel
model Banner {
  id         Int       @id @default(autoincrement())
  image_url  String?   @db.Text
  video_url  String?   @db.Text
  link       String?   @db.Text
  is_active  Boolean   @default(true) @map("is_active")
  order      Int       @default(0)
  created_at DateTime  @default(now()) @map("created_at")
  updated_at DateTime  @updatedAt @map("updated_at")

  @@index([is_active])
  @@index([order])
  @@map("banners")
}

// Daily Shifts (Дневные смены)
model DailyShift {
  id                Int      @id @default(autoincrement())
  shiftDate         DateTime @unique @map("shift_date") // Дата смены (только дата, без времени)
  depositsSum       Decimal  @default(0) @map("deposits_sum") @db.Decimal(12, 2)
  withdrawalsSum    Decimal  @default(0) @map("withdrawals_sum") @db.Decimal(12, 2)
  netProfit         Decimal  @default(0) @map("net_profit") @db.Decimal(12, 2) // Чистая прибыль: 8% от пополнений + 2% от выводов
  depositsCount     Int      @default(0) @map("deposits_count")
  withdrawalsCount  Int      @default(0) @map("withdrawals_count")
  isClosed          Boolean  @default(false) @map("is_closed") // Закрыта ли смена
  closedAt          DateTime? @map("closed_at") // Когда была закрыта смена
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([shiftDate])
  @@index([isClosed])
  @@map("daily_shifts")
}

// Message Templates
model MessageTemplate {
  id        Int      @id @default(autoincrement())
  title     String   @db.VarChar(200)
  text      String   @db.Text
  category  String?  @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("message_templates")
}
