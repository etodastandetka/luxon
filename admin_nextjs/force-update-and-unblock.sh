#!/bin/bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö IP

set -e

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞"
echo ""

cd /var/www/luxon/admin_nextjs || exit 1

# 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–∑ git
echo "üì• –°–æ—Ö—Ä–∞–Ω—è—é –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è—é –∏–∑ git..."
git fetch origin main

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if ! git diff-index --quiet HEAD --; then
    echo "  üíæ –°–æ—Ö—Ä–∞–Ω—è—é –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash..."
    git stash push -m "Local changes before update $(date +%Y-%m-%d_%H:%M:%S)"
    echo "  ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
fi

# –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑ git
echo "  üì• –û–±–Ω–æ–≤–ª—è—é –∏–∑ git..."
git pull origin main || {
    echo "  ‚ö†Ô∏è  –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ merge, –ø—ã—Ç–∞—é—Å—å —Ä–∞–∑—Ä–µ—à–∏—Ç—å..."
    git merge --no-edit origin/main || {
        echo "  ‚ö†Ô∏è  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π merge –Ω–µ —É–¥–∞–ª—Å—è, –æ—Å—Ç–∞–≤–ª—è—é –∫–∞–∫ –µ—Å—Ç—å"
    }
}

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if git stash list | grep -q "Local changes before update"; then
    echo "  üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    git stash pop || {
        echo "  ‚ö†Ô∏è  –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏, –æ—Å—Ç–∞–≤–ª—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ git"
    }
    echo "  ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
fi

echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
echo ""

# 2. –û—á–∏—â–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–∑ –ë–î
echo "1Ô∏è‚É£ –û—á–∏—â–∞—é –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–∑ –ë–î..."
if [ -f "scripts/unblock-all-ips.ts" ]; then
    npx tsx scripts/unblock-all-ips.ts 2>/dev/null || echo "  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ë–î (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π)"
    echo "  ‚úÖ –ë–î –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
else
    echo "  ‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é"
fi

echo ""
echo "2Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤ –ø–∞–º—è—Ç–∏..."
pm2 restart luxon-admin

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –í—Å–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—á–∏—â–µ–Ω—ã:"
    echo "   ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã"
    echo "   ‚Ä¢ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –ø–∞–º—è—Ç–∏ (–æ—á–∏—â–µ–Ω—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º)"
    echo "   ‚Ä¢ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –ë–î (–æ—á–∏—â–µ–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º)"
    echo ""
    echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs luxon-admin --lines 20"
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi
echo ""

