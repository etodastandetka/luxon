#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ git pull
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./resolve-conflicts.sh

cd /var/www/ls/admin_nextjs || exit 1

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å git..."
git status

echo ""
echo "üìã –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏:"
git diff --name-only --diff-filter=U

echo ""
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å—Ç—å –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã!"
echo ""
echo "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
echo "1) –û—Ç–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
echo "2) –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash –∏ –æ—Ç–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã"
echo "3) –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è"
echo ""
read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-3): " choice

case $choice in
    1)
        echo "üîÑ –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
        git reset --hard HEAD
        echo "‚¨áÔ∏è  –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
        git pull
        if [ $? -eq 0 ]; then
            echo "‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"
            echo "üî® –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            npm install --production=false
            echo "üî® –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client..."
            npm run db:generate
            echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
            npm run build
            if [ $? -eq 0 ]; then
                echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞"
                echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2..."
                pm2 restart luxon-admin
                echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
            else
                echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ"
                exit 1
            fi
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–¥–∞"
            exit 1
        fi
        ;;
    2)
        echo "üì¶ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash..."
        git stash push -m "Backup before conflict resolution $(date +%Y-%m-%d_%H-%M-%S)"
        echo "üîÑ –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã..."
        git reset --hard HEAD
        echo "‚¨áÔ∏è  –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
        git pull
        if [ $? -eq 0 ]; then
            echo "‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"
            echo "üí° –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ stash. –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞: git stash list"
            echo "üî® –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            npm install --production=false
            echo "üî® –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client..."
            npm run db:generate
            echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
            npm run build
            if [ $? -eq 0 ]; then
                echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞"
                echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2..."
                pm2 restart luxon-admin
                echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
            else
                echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ"
                exit 1
            fi
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–¥–∞"
            exit 1
        fi
        ;;
    3)
        echo "üìã –§–∞–π–ª—ã —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏:"
        git diff --name-only --diff-filter=U
        echo ""
        echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ —Ñ–∞–π–ª–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
        echo "  git diff <filename>"
        echo ""
        echo "–ü–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:"
        echo "  git add <resolved-files>"
        echo "  git commit"
        echo "  git pull"
        ;;
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        exit 1
        ;;
esac

