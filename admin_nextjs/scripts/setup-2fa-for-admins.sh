#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 2FA –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ Bishkek –∏ dastan

set -e

echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 2FA –¥–ª—è –∞–¥–º–∏–Ω–æ–≤"
echo ""

cd /var/www/luxon/admin_nextjs || exit 1

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -d "venv-2fa" ]; then
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    echo "   –ó–∞–ø—É—Å–∫–∞—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É..."
    chmod +x scripts/setup-2fa-env.sh
    ./scripts/setup-2fa-env.sh
    echo ""
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ö–µ–º—É –ë–î –¥–ª—è 2FA
echo "üóÑÔ∏è  –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if [ -f "scripts/update-db-2fa.sh" ]; then
    chmod +x scripts/update-db-2fa.sh
    ./scripts/update-db-2fa.sh
    echo ""
else
    echo "‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é..."
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ö–µ–º–∞ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞: npm run db:push"
    echo ""
fi

                                                                                                                                                                                                                                                                                                        # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source venv-2fa/bin/activate

# –ú–∞—Å—Å–∏–≤ –∞–¥–º–∏–Ω–æ–≤
admins=("Bishkek" "dastan")

echo "üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 2FA –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∞–¥–º–∏–Ω–æ–≤:"
for admin in "${admins[@]}"; do
    echo "   - $admin"
done
echo ""

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 2FA –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–¥–º–∏–Ω–∞
for admin in "${admins[@]}"; do
    echo "============================================================"
    echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 2FA –¥–ª—è: $admin"
    echo "============================================================"
    echo ""
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î
    python3 scripts/generate-2fa-qr.py "$admin" --save
    
    if [ $? -eq 0 ]; then
        echo ""
        echo "‚úÖ 2FA —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –¥–ª—è $admin"
    else
        echo ""
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ 2FA –¥–ª—è $admin"
    fi
    
    echo ""
    echo "============================================================"
    echo ""
done

echo "üéâ –ì–æ—Ç–æ–≤–æ! 2FA –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤"
echo ""
echo "üìÑ –§–∞–π–ª—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:"
for admin in "${admins[@]}"; do
    if [ -f "2fa-${admin}.txt" ]; then
        echo "   - 2fa-${admin}.txt"
    fi
done
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª—ã 2fa-*.txt –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ!"
echo "   –û–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞."
echo ""

