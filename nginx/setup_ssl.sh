#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ Let's Encrypt (certbot)

set -e

echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è nginx"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞ –∏ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "$SCRIPT_DIR/.." && pwd )"
NGINX_CONFIG_DIR="$PROJECT_ROOT/nginx"

echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_ROOT"
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π nginx: $NGINX_CONFIG_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç –æ—Ç root
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç root (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ sudo)"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º certbot, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v certbot &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ certbot..."
    apt-get update
    apt-get install -y certbot python3-certbot-nginx
else
    echo "‚úÖ Certbot —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ nginx —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v nginx &> /dev/null; then
    echo "‚ùå nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞."
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è ACME challenge
mkdir -p /var/www/html/.well-known/acme-challenge

# –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–µ–∑ SSL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π nginx..."

# –î–ª—è lux-on.org
cat > /etc/nginx/sites-available/lux-on.org.temp << 'EOF'
server {
    listen 80;
    server_name lux-on.org www.lux-on.org;
    
    location / {
        return 200 "OK";
        add_header Content-Type text/plain;
    }
    
    location ~ /.well-known/acme-challenge {
        allow all;
        root /var/www/html;
    }
}
EOF

# –î–ª—è pipiska.net
cat > /etc/nginx/sites-available/pipiska.net.temp << 'EOF'
server {
    listen 80;
    server_name pipiska.net www.pipiska.net;
    
    location / {
        return 200 "OK";
        add_header Content-Type text/plain;
    }
    
    location ~ /.well-known/acme-challenge {
        allow all;
        root /var/www/html;
    }
}
EOF

# –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–µ—Å–ª–∏ –µ—ë –Ω–µ—Ç)
if [ ! -f /etc/nginx/sites-available/lux-on.org ]; then
    echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ lux-on.org..."
    cp "$NGINX_CONFIG_DIR/lux-on.org.conf" /etc/nginx/sites-available/lux-on.org
fi

if [ ! -f /etc/nginx/sites-available/pipiska.net ]; then
    echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ pipiska.net..."
    cp "$NGINX_CONFIG_DIR/pipiska.net.conf" /etc/nginx/sites-available/pipiska.net
fi

# –í–∫–ª—é—á–∞–µ–º —Å–∞–π—Ç—ã (–µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã)
if [ ! -L /etc/nginx/sites-enabled/lux-on.org ]; then
    ln -s /etc/nginx/sites-available/lux-on.org /etc/nginx/sites-enabled/
fi

if [ ! -L /etc/nginx/sites-enabled/pipiska.net ]; then
    ln -s /etc/nginx/sites-available/pipiska.net /etc/nginx/sites-enabled/
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
nginx -t

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx! –ò—Å–ø—Ä–∞–≤—å—Ç–µ –µ—ë –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º."
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx..."
systemctl restart nginx

# –ü–æ–ª—É—á–∞–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
echo "üîê –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ certbot..."

# –î–ª—è lux-on.org
echo "üìú –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è lux-on.org..."
certbot certonly --nginx \
    -d lux-on.org \
    -d www.lux-on.org \
    --non-interactive \
    --agree-tos \
    --email admin@lux-on.org \
    --redirect || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è lux-on.org (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –ø–æ–ª—É—á–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞)"

# –î–ª—è pipiska.net
echo "üìú –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è pipiska.net..."
certbot certonly --nginx \
    -d pipiska.net \
    -d www.pipiska.net \
    --non-interactive \
    --agree-tos \
    --email admin@pipiska.net \
    --redirect || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è pipiska.net (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –ø–æ–ª—É—á–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞)"

# –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å SSL
echo "üìù –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π —Å SSL..."

# –ö–æ–ø–∏—Ä—É–µ–º SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤)
if [ -f "$NGINX_CONFIG_DIR/lux-on.org.ssl.conf" ]; then
    cp "$NGINX_CONFIG_DIR/lux-on.org.ssl.conf" /etc/nginx/sites-available/lux-on.org
    echo "‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è lux-on.org"
else
    echo "‚ö†Ô∏è –§–∞–π–ª $NGINX_CONFIG_DIR/lux-on.org.ssl.conf –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º..."
fi

if [ -f "$NGINX_CONFIG_DIR/pipiska.net.ssl.conf" ]; then
    cp "$NGINX_CONFIG_DIR/pipiska.net.ssl.conf" /etc/nginx/sites-available/pipiska.net
    echo "‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è pipiska.net"
else
    echo "‚ö†Ô∏è –§–∞–π–ª $NGINX_CONFIG_DIR/pipiska.net.ssl.conf –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º..."
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
nginx -t

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º."
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx —Å SSL..."
systemctl reload nginx

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
echo "‚è∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
if ! grep -q "certbot renew" /etc/crontab; then
    echo "0 3 * * * certbot renew --quiet --deploy-hook 'systemctl reload nginx'" >> /etc/crontab
fi

echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–æ–º–µ–Ω—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞"
echo "2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç—ã 80 –∏ 443 –æ—Ç–∫—Ä—ã—Ç—ã –≤ firewall"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–æ–≤:"
echo "   - https://lux-on.org"
echo "   - https://pipiska.net"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:"
echo "   certbot certificates"

