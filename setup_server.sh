#!/bin/bash

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è luxservice.online –∏ xendro.pro
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ: chmod +x setup_server.sh && ./setup_server.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–µ—Ä–≤–µ—Ä–∞..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã root
if [ "$EUID" -ne 0 ]; then
    error "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç –∏–º–µ–Ω–∏ root: sudo ./setup_server.sh"
    exit 1
fi

log "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
cd /var/www/luxservice
git pull origin main

log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Django..."
cd django_admin
source .venv/bin/activate
python manage.py migrate
python manage.py collectstatic --noinput
deactivate
cd ..

log "–°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx (–±–µ–∑ SSL –¥–ª—è xendro.pro)..."
cat > /etc/nginx/sites-available/combined << 'EOF'
# –†–µ–¥–∏—Ä–µ–∫—Ç —Å HTTP –Ω–∞ HTTPS –¥–ª—è luxservice.online
server {
    listen 80;
    server_name luxservice.online www.luxservice.online;
    return 301 https://$server_name$request_uri;
}

# –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç luxservice.online (Next.js)
server {
    listen 443 ssl http2;
    server_name luxservice.online www.luxservice.online;
    
    ssl_certificate /etc/letsencrypt/live/luxservice.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/luxservice.online/privkey.pem;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# –í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è xendro.pro (HTTP —Ç–æ–ª—å–∫–æ)
server {
    listen 80;
    server_name xendro.pro www.xendro.pro;
    
    location /static/ {
        alias /var/www/luxservice/django_admin/staticfiles/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF

log "–ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
ln -sf /etc/nginx/sites-available/combined /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t
systemctl reload nginx

log "–ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è xendro.pro..."
certbot --nginx -d xendro.pro -d www.xendro.pro --non-interactive --agree-tos --email etodastandetka@gmail.com

log "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx —Å SSL –¥–ª—è xendro.pro..."
cat > /etc/nginx/sites-available/combined << 'EOF'
# –†–µ–¥–∏—Ä–µ–∫—Ç —Å HTTP –Ω–∞ HTTPS –¥–ª—è luxservice.online
server {
    listen 80;
    server_name luxservice.online www.luxservice.online;
    return 301 https://$server_name$request_uri;
}

# –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç luxservice.online (Next.js)
server {
    listen 443 ssl http2;
    server_name luxservice.online www.luxservice.online;
    
    ssl_certificate /etc/letsencrypt/live/luxservice.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/luxservice.online/privkey.pem;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# –†–µ–¥–∏—Ä–µ–∫—Ç —Å HTTP –Ω–∞ HTTPS –¥–ª—è xendro.pro
server {
    listen 80;
    server_name xendro.pro www.xendro.pro;
    return 301 https://$server_name$request_uri;
}

# –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å xendro.pro (Django) —Å SSL
server {
    listen 443 ssl http2;
    server_name xendro.pro www.xendro.pro;
    
    ssl_certificate /etc/letsencrypt/live/xendro.pro/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xendro.pro/privkey.pem;
    
    location /static/ {
        alias /var/www/luxservice/django_admin/staticfiles/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF

log "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."
nginx -t
systemctl reload nginx

log "–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —á–µ—Ä–µ–∑ PM2..."
pm2 start ecosystem.config.js
pm2 save

log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
pm2 status

log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–æ–≤..."
echo "–ü—Ä–æ–≤–µ—Ä—è—é luxservice.online..."
curl -I https://luxservice.online 2>/dev/null | head -1 || warn "luxservice.online –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo "–ü—Ä–æ–≤–µ—Ä—è—é xendro.pro..."
curl -I https://xendro.pro 2>/dev/null | head -1 || warn "xendro.pro –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo ""
echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üìã –°—Ç–∞—Ç—É—Å:"
echo "  ‚Ä¢ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç: https://luxservice.online"
echo "  ‚Ä¢ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: https://xendro.pro"
echo "  ‚Ä¢ Telegram –±–æ—Ç: —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ"
echo ""
echo "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  ‚Ä¢ pm2 status - —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤"
echo "  ‚Ä¢ pm2 logs - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
echo "  ‚Ä¢ pm2 restart all - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
echo ""
