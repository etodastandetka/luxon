#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ LUXON

set -e

BASE_DIR="/var/www/luxon"

echo "üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ LUXON..."
echo ""

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
echo "1Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pm2 stop all 2>/dev/null || true
pm2 delete all 2>/dev/null || true

# –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞
echo ""
echo "2Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞..."
cd $BASE_DIR/app

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
if [ ! -d "node_modules" ]; then
    echo "‚ö†Ô∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    npm install
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω
if [ ! -d ".next" ]; then
    echo "‚ö†Ô∏è –ü—Ä–æ–µ–∫—Ç –Ω–µ —Å–æ–±—Ä–∞–Ω, –∑–∞–ø—É—Å–∫–∞—é —Å–±–æ—Ä–∫—É..."
    npm run build
fi

pm2 start ecosystem.config.js
echo "‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3030"

# –ó–∞–ø—É—Å–∫ –∞–¥–º–∏–Ω–∫–∏
echo ""
echo "3Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –∞–¥–º–∏–Ω–∫–∏..."
cd $BASE_DIR/admin_nextjs

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
if [ ! -d "node_modules" ]; then
    echo "‚ö†Ô∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    npm install
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω
if [ ! -d ".next" ]; then
    echo "‚ö†Ô∏è –ü—Ä–æ–µ–∫—Ç –Ω–µ —Å–æ–±—Ä–∞–Ω, –∑–∞–ø—É—Å–∫–∞—é —Å–±–æ—Ä–∫—É..."
    npm run build
fi

pm2 start ecosystem.config.js
echo "‚úÖ –ê–¥–º–∏–Ω–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 3001"

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
echo ""
echo "4Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
cd $BASE_DIR/bot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -d "venv" ]; then
    echo "‚ö†Ô∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞—é..."
    python3 -m venv venv
    source venv/bin/activate
    pip install --upgrade pip
    pip install -r requirements.txt
fi

pm2 start ecosystem.config.js
echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω"

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2
echo ""
echo "5Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2..."
pm2 save

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
echo ""
echo "6Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞..."
pm2 startup || echo "‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ startup —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ root, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ"

echo ""
echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!"
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
pm2 status

echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  pm2 status          - —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
echo "  pm2 logs            - –ª–æ–≥–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
echo "  pm2 logs luxon-mini-app - –ª–æ–≥–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞"
echo "  pm2 logs luxon-admin - –ª–æ–≥–∏ –∞–¥–º–∏–Ω–∫–∏"
echo "  pm2 logs luxon-bot   - –ª–æ–≥–∏ –±–æ—Ç–∞"
echo "  pm2 restart all     - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ"
echo "  pm2 stop all        - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ"

