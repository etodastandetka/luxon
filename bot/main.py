#!/usr/bin/env python3
"""
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –±–æ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±—É–∫–º–µ–∫–µ—Ä–∞–º–∏
"""
import logging
import asyncio
from aiogram import Bot, Dispatcher, types, F
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
import os

# –ò–º–ø–æ—Ä—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
from handlers import (
    start_handlers, 
    bookmaker_handlers,
    deposit_handlers, 
    withdraw_handlers,
    referral_handlers,
    support_handlers,
    language_handlers,
    faq_handlers,
    history_handlers,
)

from database import Database
from config import BOOKMAKERS, BOT_TOKEN as CONFIG_BOT_TOKEN
from autodeposit.watcher import AutoDepositWatcher
from translations import get_translation
from qr_utils import enforce_amount_with_kopecks
import random
from middleware.bot_status_middleware import BotStatusMiddleware

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class UniversalBot:
    def __init__(self, token: str):
        self.bot = Bot(token=token)
        self.dp = Dispatcher(storage=MemoryStorage())
        self.db = Database()
        self.api_manager = None
        
        # –°–Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware (–ø–∞—É–∑–∞/—Ç–µ—Ö—Ä–∞–±–æ—Ç—ã), –∑–∞—Ç–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        self._register_middleware()
        self._register_handlers()
    
    def _register_handlers(self):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""
        # Register handlers
        start_handlers.register_handlers(self.dp, self.db, BOOKMAKERS, bot=self.bot)
        bookmaker_handlers.register_handlers(self.dp, self.db, BOOKMAKERS)
        deposit_handlers.register_handlers(self.dp, self.db, BOOKMAKERS, self.api_manager)
        withdraw_handlers.register_handlers(self.dp, self.db, BOOKMAKERS, self.api_manager)
        referral_handlers.register_handlers(self.dp, self.db, BOOKMAKERS)
        support_handlers.register_handlers(self.dp, self.db, BOOKMAKERS)
        language_handlers.register_handlers(self.dp, self.db, BOOKMAKERS)
        faq_handlers.register_handlers(self.dp, self.db, BOOKMAKERS)
        # –•–µ–Ω–¥–ª–µ—Ä—ã –∏—Å—Ç–æ—Ä–∏–∏: –∫–æ–ª–±—ç–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é
        try:
            history_handlers.register_handlers(self.dp, self.db, BOOKMAKERS, self.api_manager)
        except Exception as e:
            logger.warning(f"Failed to register history callbacks: {e}")

        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        import handlers.api_handlers as api_handlers
        api_handlers.register_handlers(self.dp, self.db, BOOKMAKERS, self.api_manager)
        
    def _get_enabled_sites(self):
        """Reads enabled bookmaker site keys from SQLite bot_settings (key='sites').
        Returns a set like {'melbet','1xbet','1win','mostbet'} or default with all.
        """
        try:
            import sqlite3, json
            conn = sqlite3.connect(self.db.db_path)
            cur = conn.cursor()
            cur.execute("SELECT value FROM bot_settings WHERE key='sites'")
            row = cur.fetchone()
            conn.close()
            if not row or not row[0]:
                return { 'melbet','1xbet','1win','mostbet' }
            lst = json.loads(row[0]) if isinstance(row[0], str) else []
            return set([str(x).lower() for x in (lst or [])]) or { 'melbet','1xbet','1win','mostbet' }
        except Exception:
            return { 'melbet','1xbet','1win','mostbet' }

    def _withdrawals_enabled(self) -> bool:
        """Reads withdrawals_enabled flag from SQLite bot_settings."""
        try:
            import sqlite3
            conn = sqlite3.connect(self.db.db_path)
            cur = conn.cursor()
            cur.execute("SELECT value FROM bot_settings WHERE key='withdrawals_enabled'")
            row = cur.fetchone()
            conn.close()
            if not row:
                return True
            return str(row[0]).strip() in ('1','true','True')
        except Exception:
            return True

    def _register_middleware(self):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è middleware"""
        # –í–∫–ª—é—á–∞–µ–º middleware —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞ (–ø–∞—É–∑–∞/—Ç–µ—Ö—Ä–∞–±–æ—Ç—ã)
        try:
            # –ü–µ—Ä–µ–¥–∞–µ–º –ø—É—Ç—å –∫ –ë–î, —á—Ç–æ–±—ã middleware —á–∏—Ç–∞–ª–æ bot_settings
            self.dp.message.middleware(BotStatusMiddleware(db_path=self.db.db_path))
            self.dp.callback_query.middleware(BotStatusMiddleware(db_path=self.db.db_path))
            logger.info("BotStatusMiddleware registered")
        except Exception as e:
            logger.error(f"Failed to register BotStatusMiddleware: {e}")

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        # –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ö–µ–Ω–¥–ª–µ—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-–∫–æ–º–∞–Ω–¥–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        @self.dp.message(~F.text.startswith("/"))
        async def handle_all_messages(message: types.Message):
            """Handle all messages - text and photo"""
            user_id = message.from_user.id
            text = message.text
            language = self.db.get_user_language(user_id)
            translations = get_translation(language)

            # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ /start: –æ—á–∏—Å—Ç–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é
            try:
                if text in ("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", translations.get('back_to_menu', '')):
                    try:
                        # –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
                        self.db.save_user_data(user_id, 'current_state', '')
                        self.db.save_user_data(user_id, 'current_action', '')
                        self.db.save_user_data(user_id, 'current_bookmaker', '')
                        self.db.save_user_data(user_id, 'current_amount', '')
                        self.db.save_user_data(user_id, 'current_qr_hash', '')
                        self.db.save_user_data(user_id, 'qr_photo_id', '')
                        self.db.save_user_data(user_id, 'withdraw_id', '')
                        self.db.save_user_data(user_id, 'withdraw_code', '')
                        self.db.save_user_data(user_id, 'selected_bank', '')
                    except Exception:
                        pass
                    await self._show_main_menu(message, language)
                    return
            except Exception:
                pass
            # –ó–¥–µ—Å—å –∫–æ–º–∞–Ω–¥ —É–∂–µ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ –∏–∑-–∑–∞ —Ñ–∏–ª—å—Ç—Ä–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
            if text and text.startswith('/'):
                return
            # language —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤—ã—à–µ

            # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—É–∑—ã –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ middleware)
            try:
                import sqlite3
                conn = sqlite3.connect(self.db.db_path)
                cur = conn.cursor()
                cur.execute("SELECT value FROM bot_settings WHERE key='is_active'")
                row = cur.fetchone()
                is_active = True if not row else bool(int(row[0]))
                if not is_active:
                    cur.execute("SELECT value FROM bot_settings WHERE key='maintenance_message'")
                    mm = cur.fetchone()
                    maintenance_message = mm[0] if (mm and mm[0]) else "üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã\n–ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
                    conn.close()
                    await message.answer(maintenance_message)
                    return
                conn.close()
            except Exception:
                # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—ã—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
                pass
            
            # Save user
            self.db.save_user(
                user_id=user_id,
                username=message.from_user.username,
                first_name=message.from_user.first_name,
                last_name=message.from_user.last_name
            )
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
            if message.photo:
                current_state = self.db.get_user_data(user_id, 'current_state')
                if current_state == 'waiting_for_receipt':
                    await self._process_receipt_photo(message)
                    return
                elif current_state == 'waiting_for_qr_photo':
                    await self._process_qr_photo(message)
                    return
                else:
                    translations = get_translation(language)
                    await message.answer(
                        f"üì∏ {translations['photo_not_expected']}\n\n"
                        f"‚ÑπÔ∏è {translations['follow_instructions']}"
                    )
                    await self._show_main_menu(message, language)
                    return
            
            # Get translations (—É–∂–µ –ø–æ–ª—É—á–µ–Ω—ã –≤—ã—à–µ)
            
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            current_state = self.db.get_user_data(user_id, 'current_state')
            logger.info(f"User {user_id} current state: {current_state}")
            
            if current_state == 'waiting_for_id':
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥ ID —á–µ—Ä–µ–∑ deposit_handlers
                from handlers.deposit_handlers import handle_id_input
                await handle_id_input(message, None, self.db, BOOKMAKERS)
                return
            elif current_state == 'waiting_for_amount':
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥ —Å—É–º–º—ã
                logger.info(f"Processing amount input: {text}")
                try:
                    amount = float(text)
                    if amount <= 0:
                        await message.answer("‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
                        return
                    
                    logger.info(f"Amount validated: {amount}")
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–≤–µ–¥—ë–Ω–Ω—É—é —Å—É–º–º—É (—Ä–∞–Ω–¥–æ–º–Ω—ã–µ –∫–æ–ø–µ–π–∫–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –≤ _show_bank_selection)
                    self.db.save_user_data(user_id, 'current_amount', str(amount))
                    
                    logger.info(f"Calling deposit_handlers.show_bank_selection for amount: {amount}")
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–∫–∏ –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –æ–±—â–∏–π —Ö–µ–Ω–¥–ª–µ—Ä
                    from handlers.deposit_handlers import show_bank_selection
                    await show_bank_selection(message, amount, self.db, BOOKMAKERS)
                    logger.info(f"Bank selection completed for user {user_id}")
                    return
                except ValueError:
                    await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É")
                    return
                except Exception as e:
                    logger.error(f"Error processing amount: {e}")
                    await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å—É–º–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
                    return
            elif current_state == 'waiting_for_receipt':
                await message.answer("üì∏ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —á–µ–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã")
                return
            elif current_state == 'waiting_for_bank_selection':
                await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫")
                return
            elif current_state == 'waiting_for_qr_photo':
                await message.answer("üì± –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ QR-–∫–æ–¥–∞ –≤–∞—à–µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞")
                return
            elif current_state == 'waiting_for_withdraw_id':
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥ ID –¥–ª—è –≤—ã–≤–æ–¥–∞ —á–µ—Ä–µ–∑ withdraw_handlers
                from handlers.withdraw_handlers import handle_withdraw_id_input
                await handle_withdraw_id_input(message, self.db, BOOKMAKERS)
                return
            elif current_state == 'waiting_for_withdraw_code':
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞–∂–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–Ω–æ–ø–∫—É –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
                if text in [translations['deposit'], translations['withdraw'], translations['referral'], translations['support'], translations['history'], translations['faq'], translations['language']]:
                    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—É—é –∫–Ω–æ–ø–∫—É
                    self.db.save_user_data(user_id, 'current_state', '')
                    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                else:
                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥ –∫–æ–¥–∞ –≤—ã–≤–æ–¥–∞ —á–µ—Ä–µ–∑ withdraw_handlers
                    from handlers.withdraw_handlers import handle_withdraw_code_input
                    await handle_withdraw_code_input(message, self.db, BOOKMAKERS)
                    return
            
            # Handle main menu buttons
            if text == translations['deposit'] or text == "üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å":
                await self._handle_deposit(message)
            elif text == translations['withdraw'] or text == "üí∞ –í—ã–≤–µ—Å—Ç–∏":
                await self._handle_withdraw(message)
            elif text == translations['referral']:
                await self._handle_referral(message)
            elif text == translations['support']:
                await self._handle_support(message)
            elif text == translations['history']:
                await self._handle_history(message)
            elif text == translations['faq']:
                await self._handle_faq(message)
            elif text == translations['language']:
                await self._handle_language(message)
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –±—É–∫–º–µ–∫–µ—Ä–∞
            elif text in ['1XBET', '1WIN', 'MELBET', 'MOSTBET', 'üéØ 1XBET', 'üé≤ MELBET', 'üèÜ 1WIN', 'üéØ MOSTBET']:
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—É–∫–º–µ–∫–µ—Ä–∞ –ø–æ —Ç–µ–∫—Å—Ç—É
                bookmaker_map = {
                    '1XBET': '1xbet',
                    'MELBET': 'melbet',
                    '1WIN': '1win',
                    'MOSTBET': 'mostbet',
                    'üéØ 1XBET': '1xbet',
                    'üé≤ MELBET': 'melbet',
                    'üèÜ 1WIN': '1win',
                    'üéØ MOSTBET': 'mostbet'
                }
                bookmaker = bookmaker_map.get(text, text.lower())
                await self._handle_bookmaker_selection(message, bookmaker, self.db.get_user_data(user_id, 'current_action'))
            else:
                # –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ FAQ (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –ø–æ—Ä—è–¥–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤)
                try:
                    supported_langs = ['ru', 'ky', 'uz']
                    DEPOSIT_BUTTONS = set()
                    WITHDRAW_BUTTONS = set()
                    TIME_BUTTONS = set()
                    IMPORTANT_BUTTONS = set()
                    for lang in supported_langs:
                        tr = get_translation(lang)
                        DEPOSIT_BUTTONS.add(tr.get('faq_deposit_button'))
                        WITHDRAW_BUTTONS.add(tr.get('faq_withdraw_button'))
                        TIME_BUTTONS.add(tr.get('faq_time_button'))
                        IMPORTANT_BUTTONS.add(tr.get('faq_important_button'))

                    # –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ –ª—é–±–∞—è –∏–∑ FAQ-–∫–Ω–æ–ø–æ–∫ ‚Äî –æ—Ç–≤–µ—Ç–∏–º —Å—Ä–∞–∑—É —Ç—É—Ç, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    if text in DEPOSIT_BUTTONS or text in WITHDRAW_BUTTONS or text in TIME_BUTTONS or text in IMPORTANT_BUTTONS:
                        # –°—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É FAQ
                        kb = ReplyKeyboardMarkup(
                            keyboard=[
                                [KeyboardButton(text=translations['faq_deposit_button'])],
                                [KeyboardButton(text=translations['faq_withdraw_button'])],
                                [KeyboardButton(text=translations['faq_time_button'])],
                                [KeyboardButton(text=translations['faq_important_button'])],
                                [KeyboardButton(text=translations['back_to_menu'])]
                            ],
                            resize_keyboard=True
                        )
                        if text in DEPOSIT_BUTTONS:
                            await message.answer(translations['faq_deposit_steps'], reply_markup=kb, parse_mode="HTML")
                            return
                        if text in WITHDRAW_BUTTONS:
                            await message.answer(translations['faq_withdraw_steps'], reply_markup=kb, parse_mode="HTML")
                            return
                        if text in TIME_BUTTONS:
                            await message.answer(translations['faq_time_content'], reply_markup=kb, parse_mode="HTML")
                            return
                        if text in IMPORTANT_BUTTONS:
                            await message.answer(translations['faq_important_content'], reply_markup=kb, parse_mode="HTML")
                            return
                except Exception:
                    # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫ —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—ë–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                    await self._show_main_menu(message, language)
                    return

                # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ‚Äî –≤–µ—Ä–Ω—ë–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                await self._show_main_menu(message, language)
        
    
    async def _handle_deposit(self, message):
        """Handle deposit button"""
        logger.info(f"Deposit button pressed by user {message.from_user.id}")
        user_id = message.from_user.id
        self.db.save_user_data(user_id, 'current_action', 'deposit')
        await self._show_bookmaker_selection(message, 'deposit')
    
    async def _handle_withdraw(self, message):
        """Handle withdraw button"""
        logger.info(f"Withdraw button pressed by user {message.from_user.id}")
        user_id = message.from_user.id
        self.db.save_user_data(user_id, 'current_action', 'withdraw')
        # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—ã–≤–æ–¥–æ–≤
        try:
            if not self._withdrawals_enabled():
                await message.answer("‚õî –í—ã–≤–æ–¥—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
                return
        except Exception:
            pass
        await self._show_bookmaker_selection(message, 'withdraw')
    
    async def _handle_referral(self, message):
        """Handle referral button"""
        user_id = message.from_user.id
        language = self.db.get_user_language(user_id)
        await referral_handlers.handle_referral(message, self.db)
    
    async def _handle_support(self, message):
        """Handle support button"""
        user_id = message.from_user.id
        language = self.db.get_user_language(user_id)
        await support_handlers.handle_support(message, language, self.db)
    
    async def _handle_history(self, message):
        """Handle history button"""
        user_id = message.from_user.id
        # history_handlers –æ–∂–∏–¥–∞–µ—Ç user_languages —Å–ª–æ–≤–∞—Ä—å –∏ bot_name
        user_languages = {user_id: self.db.get_user_language(user_id)}
        try:
            await history_handlers.handle_history_command(
                message=message,
                bot_name='universal',
                user_languages=user_languages,
                db_manager=self.db
            )
        except Exception as e:
            # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø–æ–∫–∞–∂–µ–º –∑–∞–≥–ª—É—à–∫—É –∏–∑ support_handlers
            language = user_languages[user_id]
            await support_handlers.handle_history(message, language, self.db)
    
    async def _handle_faq(self, message):
        """Handle FAQ button"""
        user_id = message.from_user.id
        language = self.db.get_user_language(user_id)
        await faq_handlers.handle_faq_start(message, language, self.db)
    
    async def _handle_language(self, message):
        """Handle language button"""
        user_id = message.from_user.id
        language = self.db.get_user_language(user_id)
        await language_handlers.handle_language_selection(message, language, self.db)
    
    async def _show_bookmaker_selection(self, message, action):
        """Show bookmaker selection"""
        logger.info(f"Showing bookmaker selection for action {action}")
        user_id = message.from_user.id
        language = self.db.get_user_language(user_id)
        translations = get_translation(language)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
        self.db.save_user_data(user_id, 'current_action', action)
        
        # –°–æ–∑–¥–∞–µ–º –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –±—É–∫–º–µ–∫–µ—Ä–æ–≤
        keyboard = ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="1XBET"), KeyboardButton(text="1WIN")],
                [KeyboardButton(text="MELBET"), KeyboardButton(text="MOSTBET")],
                [KeyboardButton(text="üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é")]
            ],
            resize_keyboard=True
        )
        
        text = translations['select_bookmaker']
        await message.answer(text, reply_markup=keyboard, parse_mode="HTML")
    
    async def _handle_bookmaker_selection(self, message, bookmaker, action):
        """Handle bookmaker selection"""
        from handlers.bookmaker_handlers import handle_bookmaker_selection

        # –ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.
        bookmaker_names = {
            '1xbet': '1XBET',
            '1win': '1WIN', 
            'melbet': 'MELBET',
            'mostbet': 'MOSTBET'
        }
        bookmaker_name = bookmaker_names.get(bookmaker.lower(), bookmaker.upper())
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∫–ª—é—á–µ–Ω–Ω–æ—Å—Ç—å –ø–ª–æ—â–∞–¥–∫–∏
        try:
            enabled = self._get_enabled_sites()
            key = bookmaker.lower()
            if key not in enabled:
                await message.answer(
                    f"‚õî –†–∞–∑–¥–µ–ª {bookmaker_name} –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–≥–æ –±—É–∫–º–µ–∫–µ—Ä–∞.")
                # –í–µ—Ä–Ω—ë–º –≤—ã–±–æ—Ä –±—É–∫–º–µ–∫–µ—Ä–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
                await self._show_bookmaker_selection(message, action or self.db.get_user_data(message.from_user.id, 'current_action') or 'deposit')
                return
        except Exception:
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
            pass
        try:
            await message.answer(f"‚úÖ <b>–í—ã–±—Ä–∞–Ω –±—É–∫–º–µ–∫–µ—Ä:</b> {bookmaker_name}", parse_mode="HTML")
        except Exception as e:
            logger.warning(f"Could not send bookmaker confirmation message: {e}")

        await handle_bookmaker_selection(message, bookmaker, action, self.db, BOOKMAKERS)
    
    async def _process_receipt_photo(self, message):
        """Process receipt photo"""
        from handlers.deposit_handlers import process_receipt_photo
        await process_receipt_photo(message, self.db, BOOKMAKERS)
    
    async def _process_qr_photo(self, message):
        """Process QR photo for withdrawal"""
        logger.info(f"Processing QR photo for user {message.from_user.id}")
        from handlers.withdraw_handlers import process_qr_photo
        await process_qr_photo(message, self.db, BOOKMAKERS)
    
    # –£–¥–∞–ª–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ _show_bank_selection –∏ —Ç–∞–π–º–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—ã–π –∫–æ–¥ –∏–∑ deposit_handlers
    
    async def _show_main_menu(self, message, language):
        """Show main menu"""
        # –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_id = message.from_user.id
        self.db.save_user_data(user_id, 'current_state', '')
        self.db.save_user_data(user_id, 'current_action', '')
        self.db.save_user_data(user_id, 'current_bookmaker', '')
        
        translations = get_translation(language)
        keyboard = ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text=translations['deposit']), KeyboardButton(text=translations['withdraw'])],
                [KeyboardButton(text=translations['referral'])],
                [KeyboardButton(text=translations['support']), KeyboardButton(text=translations['history'])],
                [KeyboardButton(text=translations['faq']), KeyboardButton(text=translations['language'])]
            ],
            resize_keyboard=True
        )
        
        # –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        welcome_text = translations['welcome'].format(
            user_name=message.from_user.first_name or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 
            admin_username='@luxon_support'
        )
        
        await message.answer(welcome_text, reply_markup=keyboard, parse_mode="HTML")
    
    async def start(self):
        """Start the bot"""
        logger.info("Starting universal bot...")
        # Start AutoDeposit watcher in background
        try:
            loop = asyncio.get_running_loop()
            self.auto_watcher = AutoDepositWatcher(self.db.db_path, self.bot, loop=loop)
            await self.auto_watcher.start()
        except Exception as e:
            logger.error(f"Failed to start AutoDepositWatcher: {e}")
        # Start polling
        await self.dp.start_polling(self.bot)

async def main():
    """Main function"""
    try:
        # Allow overriding token via environment variable for secure rotation
        token = os.getenv('BOT_TOKEN') or CONFIG_BOT_TOKEN
        bot = UniversalBot(token)
        logger.info("Starting universal bot...")
        await bot.start()
    except KeyboardInterrupt:
        logger.info("Bot stopped by user")
    except Exception as e:
        logger.error(f"Error starting bot: {e}")

if __name__ == "__main__":
    asyncio.run(main())