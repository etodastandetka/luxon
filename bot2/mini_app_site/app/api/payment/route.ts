import { NextRequest, NextResponse } from 'next/server'

const DJANGO_API_URL = process.env.DJANGO_API_URL || 'http://localhost:8081'
const DJANGO_API_TOKEN = process.env.DJANGO_API_TOKEN || '222ef40eaf1486b2588e1214c1ddc112d7296b90'

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    console.log('Payment API received data:', body)
    const { type, amount, user_id, bookmaker, bank, phone, site_code, qr_photo, request_id } = body
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    if (!type || !amount || !user_id || !bookmaker) {
      console.log('Missing required fields:', { type, amount, user_id, bookmaker })
      return NextResponse.json({ 
        error: 'Missing required fields', 
        details: { type, amount, user_id, bookmaker } 
      }, { status: 400 })
    }
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
    const parsedUserId = typeof user_id === 'string' ? parseInt(user_id) : user_id
    const parsedAmount = typeof amount === 'string' ? parseFloat(amount) : amount
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
    if (isNaN(parsedUserId) || isNaN(parsedAmount)) {
      console.log('Invalid number format:', { user_id, amount })
      return NextResponse.json({ 
        error: 'Invalid number format', 
        details: { user_id, amount } 
      }, { status: 400 })
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Django API —á–µ—Ä–µ–∑ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API
    const djangoResponse = await fetch(`${DJANGO_API_URL}/bot/api/requests/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_id: parsedUserId,
        request_type: type,
        amount: parsedAmount,
        bookmaker: bookmaker,
        bank: bank || null,
        phone: phone || null,
        site_code: site_code || null,
        qr_photo: qr_photo || null,
        request_id: request_id || null,
        status: 'pending'
      })
    })
    
    if (!djangoResponse.ok) {
      const errorData = await djangoResponse.json()
      return NextResponse.json({ 
        error: 'Django API error', 
        details: errorData 
      }, { status: djangoResponse.status })
    }
    
    const transactionData = await djangoResponse.json()
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram —á–µ—Ä–µ–∑ Django
    await sendTelegramNotification(`
üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ ${type === 'deposit' ? '–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–≤—ã–≤–æ–¥'}
üÜî ID: ${transactionData.id}
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user_id}
üéØ –ë—É–∫–º–µ–∫–µ—Ä: ${bookmaker}
üí∞ –°—É–º–º–∞: ${amount} —Å–æ–º
üè¶ –ë–∞–Ω–∫: ${bank || '–ù–µ —É–∫–∞–∑–∞–Ω'}
${phone ? `üì± –¢–µ–ª–µ—Ñ–æ–Ω: +${phone}` : ''}
${site_code ? `üîë –ö–æ–¥: ${site_code}` : ''}
${request_id ? `üÜî ID –∑–∞—è–≤–∫–∏: ${request_id}` : ''}
    `)
    
    return NextResponse.json({
      success: true,
      transactionId: transactionData.id,
      message: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ'
    })
    
  } catch (error) {
    console.error('Payment API error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}

export async function PUT(request: NextRequest) {
  try {
    const body = await request.json()
    const { id, status, reason } = body
    
    if (!id || !status) {
      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Django API —á–µ—Ä–µ–∑ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API
    const djangoResponse = await fetch(`${DJANGO_API_URL}/bot/api/requests/${id}/status/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        status: status,
        source: 'mini_app',
        user_id: id,
        amount: 0
      })
    })
    
    if (!djangoResponse.ok) {
      const errorData = await djangoResponse.json()
      return NextResponse.json({ 
        error: 'Django API error', 
        details: errorData 
      }, { status: djangoResponse.status })
    }
    
    const transactionData = await djangoResponse.json()
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞
    await sendTelegramNotification(`
üîÑ –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω
üÜî ID: ${id}
üìä –°—Ç–∞—Ç—É—Å: ${status === 'completed' ? '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ' : status}
    `)
    
    return NextResponse.json({
      success: true,
      transactionId: transactionData.id,
      status: transactionData.status,
      message: '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ'
    })
    
  } catch (error) {
    console.error('Update transaction error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const transactionId = searchParams.get('id')
    
    if (!transactionId) {
      return NextResponse.json({ error: 'Transaction ID required' }, { status: 400 })
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Django API —á–µ—Ä–µ–∑ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API
    const djangoResponse = await fetch(`${DJANGO_API_URL}/bot/api/requests/${transactionId}/`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    
    if (!djangoResponse.ok) {
      return NextResponse.json({ error: 'Transaction not found' }, { status: 404 })
    }
    
    const transaction = await djangoResponse.json()
    return NextResponse.json(transaction)
    
  } catch (error) {
    console.error('Get transaction error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}

async function sendTelegramNotification(message: string) {
  try {
    const botToken = process.env.BOT_TOKEN
    const adminChatId = process.env.ADMIN_CHAT_ID
    
    if (!botToken || !adminChatId) {
      console.log('Telegram notification skipped: missing credentials')
      return
    }
    
    const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        chat_id: adminChatId,
        text: message,
        parse_mode: 'HTML'
      })
    })
    
    if (!response.ok) {
      console.error('Failed to send Telegram notification:', await response.text())
    }
  } catch (error) {
    console.error('Telegram notification error:', error)
  }
}