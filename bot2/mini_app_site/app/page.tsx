"use client"
import { useEffect, useState } from 'react'
import LanguageSelector from '../components/LanguageSelector'
import AnimatedHeader from '../components/AnimatedHeader'
import LoadingScreen from '../components/LoadingScreen'
import ServiceStatus from '../components/ServiceStatus'
import { useLanguage } from '../components/LanguageContext'
import { useBotSettings } from '../components/SettingsLoader'
import { initTelegramWebApp, getTelegramUser, syncWithBot, TelegramUser } from '../utils/telegram'

export default function HomePage() {
  const [user, setUser] = useState<TelegramUser | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [loadingProgress, setLoadingProgress] = useState(0)
  const { language } = useLanguage()
  const { settings, loading: settingsLoading, error: settingsError } = useBotSettings()

  useEffect(() => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram WebApp
    const telegramUser = initTelegramWebApp()
    if (telegramUser) {
      setUser(telegramUser)
      
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –±–æ—Ç–æ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
      syncWithBot(telegramUser, 'app_opened', {
        page: 'home',
        language
      })
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç 0 –¥–æ 100
    const progressInterval = setInterval(() => {
      setLoadingProgress(prev => {
        if (prev >= 100) {
          clearInterval(progressInterval)
          setIsLoading(false)
          return 100
        }
        return prev + 2 // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞ 2% –∫–∞–∂–¥—ã–µ 50–º—Å
      })
    }, 50)

    return () => clearInterval(progressInterval)
  }, [language])

  const handleLoaderComplete = () => {
    setIsLoading(false)
  }

  const translations = {
    ru: {
      welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
      subtitle: '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ –≤ –∫–∞–∑–∏–Ω–æ',
      deposit: '–ü–æ–ø–æ–ª–Ω–∏—Ç—å',
      withdraw: '–í—ã–≤–µ—Å—Ç–∏',
      referral: '–†–µ—Ñ–µ—Ä–∞–ª—ã',
      support: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞',
      history: '–ò—Å—Ç–æ—Ä–∏—è',
      instruction: '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è',
      quickDeposit: '–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
      quickWithdraw: '–ë—ã—Å—Ç—Ä—ã–π –≤—ã–≤–æ–¥',
      referralProgram: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞',
      supportHelp: '–ü–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
      transactionHistory: '–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π',
      stepByStepGuide: '–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è'
    },
    en: {
      welcome: 'Welcome!',
      subtitle: 'Platform for deposits and withdrawals in casinos',
      deposit: 'üí≥ Deposit',
      withdraw: 'üí∞ Withdraw',
      referral: 'üë• Referrals',
      support: 'üéß Support',
      history: 'üìú History',
      instruction: 'üßæ Instruction',
      quickDeposit: 'Quick deposit',
      quickWithdraw: 'Quick withdraw',
      referralProgram: 'Referral program',
      supportHelp: 'Help and support',
      transactionHistory: 'Transaction history',
      stepByStepGuide: 'Step-by-step guide'
    }
  }

  const t = translations[language as keyof typeof translations] || translations.ru

  if (isLoading) {
    return (
      <LoadingScreen 
        message="–ó–∞–≥—Ä—É–∑–∫–∞ LUX ON"
        variant="object"
        showProgress={true}
        progress={loadingProgress}
      />
    )
  }

  return (
    <main className="space-y-6">
      {/* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */}
      <AnimatedHeader />
      
      {/* –ö—Ä–∞—Å–∏–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */}
      <div className="text-center space-y-4 fade-in">
        <div className="relative">
          <h1 className="text-3xl font-bold text-white gentle-float">{t.welcome}</h1>
          <div className="absolute -top-2 -right-2 w-3 h-3 bg-green-400 rounded-full pulse"></div>
        </div>
        <p className="text-sm text-white/70 slide-in-left delay-200">{t.subtitle}</p>
        {user && (
          <p className="text-sm text-white/60 slide-in-right delay-300">
            üëã {user.first_name} {user.last_name}
          </p>
        )}
        <div className="flex justify-center scale-in delay-400">
          <LanguageSelector />
        </div>
      </div>
      
      {/* –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è */}
      <div className="grid grid-cols-2 gap-3">
        <ServiceStatus service="deposits">
          <a href="/deposit" className="card btn btn-primary text-center p-4 fade-in delay-500">
            <div className="font-semibold text-lg">{t.deposit}</div>
          </a>
        </ServiceStatus>
        <ServiceStatus service="withdrawals">
          <a href="/withdraw" className="card btn btn-primary text-center p-4 fade-in delay-600">
            <div className="font-semibold text-lg">{t.withdraw}</div>
          </a>
        </ServiceStatus>
      </div>
      
      {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã */}
      <div className="grid grid-cols-2 gap-3">
        <a href="/referral" className="card btn btn-ghost text-center p-4 fade-in delay-700">
          <div className="font-semibold text-lg">{t.referral}</div>
        </a>
        <a href="/history" className="card btn btn-ghost text-center p-4 fade-in delay-800">
          <div className="font-semibold text-lg">{t.history}</div>
        </a>
      </div>
      
      {/* –ü–æ–º–æ—â—å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */}
      <div className="grid grid-cols-2 gap-3">
        <a href="/instruction" className="card btn btn-ghost text-center p-4 fade-in delay-800">
          <div className="font-semibold text-lg">{t.instruction}</div>
        </a>
        <a href="/support" className="card btn btn-ghost text-center p-4 fade-in delay-800">
          <div className="font-semibold text-lg">{t.support}</div>
        </a>
      </div>
    </main>
  )
}