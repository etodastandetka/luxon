#!/usr/bin/env python3
"""
–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
- Django –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–ø–æ—Ä—Ç 8081)
- Next.js –≤–µ–±-—Å–∞–π—Ç (–ø–æ—Ä—Ç 3030)
- Telegram-–±–æ—Ç
"""
import subprocess
import sys
import os
import time
import threading
import signal

def start_django_admin():
    """–ó–∞–ø—É—Å–∫ Django –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    print("üîê –ó–∞–ø—É—Å–∫ Django –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...")
    try:
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é Django
        django_dir = os.path.join(os.path.dirname(__file__), '..', 'django_admin')
        if os.path.exists(django_dir):
            subprocess.run([sys.executable, 'start_admin.py'], cwd=django_dir, check=True)
        else:
            print("‚ùå Django –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Django: {e}")

def start_website():
    """–ó–∞–ø—É—Å–∫ Next.js –≤–µ–±-—Å–∞–π—Ç–∞"""
    print("üåê –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–∞–π—Ç–∞...")
    try:
        website_dir = os.path.join(os.path.dirname(__file__), 'mini_app_site')
        if os.path.exists(website_dir):
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if not os.path.exists(os.path.join(website_dir, 'node_modules')):
                print("üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Next.js...")
                subprocess.run(['npm', 'install'], cwd=website_dir, check=True)
            
            subprocess.run(['npm', 'run', 'dev'], cwd=website_dir, check=True)
        else:
            print("‚ùå –í–µ–±-—Å–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-—Å–∞–π—Ç–∞: {e}")

def start_telegram_bot():
    """–ó–∞–ø—É—Å–∫ Telegram-–±–æ—Ç–∞"""
    print("ü§ñ –ó–∞–ø—É—Å–∫ Telegram-–±–æ—Ç–∞...")
    try:
        subprocess.run([sys.executable, 'start_telegram_bot.py'], check=True)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {e}")

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"""
    print("üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ RouteMaster KG")
    print("=" * 60)
    print("üì± –°–µ—Ä–≤–∏—Å—ã:")
    print("üîê Django –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - http://localhost:8081")
    print("üåê –í–µ–±-—Å–∞–π—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - http://localhost:3030")
    print("ü§ñ Telegram-–±–æ—Ç - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ")
    print("=" * 60)
    print("–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...")
    
    # –°–æ–∑–¥–∞–µ–º –ø–æ—Ç–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
    django_thread = threading.Thread(target=start_django_admin, daemon=True)
    website_thread = threading.Thread(target=start_website, daemon=True)
    bot_thread = threading.Thread(target=start_telegram_bot, daemon=True)
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
        django_thread.start()
        time.sleep(2)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏
        
        website_thread.start()
        time.sleep(2)
        
        bot_thread.start()
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤
        django_thread.join()
        website_thread.join()
        bot_thread.join()
        
    except KeyboardInterrupt:
        print("\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...")
        sys.exit(0)
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()

