#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –ø—Ä–∏ git pull

set -e

BASE_DIR="/var/www/luxon"
APP_DIR="$BASE_DIR/app"

echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

cd $APP_DIR

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ git..."
git status

echo ""
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ app/app/ (–µ—Å–ª–∏ –µ—Å—Ç—å)..."
if [ -d "app" ]; then
    # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã –≤ app/app/
    git clean -fd app/ 2>/dev/null || true
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - —É–¥–∞–ª–∏—Ç—å –≤—Å—é –ø–∞–ø–∫—É app/app –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –≤ git
    if [ -d "app/app" ] && ! git ls-files --error-unmatch app/app/ >/dev/null 2>&1; then
        echo "   –£–¥–∞–ª—è—é –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—É—é –ø–∞–ø–∫—É app/app/..."
        rm -rf app/app
    fi
fi

echo ""
echo "üì• –í—ã–ø–æ–ª–Ω—è—é git pull..."
git fetch origin
git reset --hard origin/main || git pull origin main

echo ""
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —Å–±–æ—Ä–∫–∏..."
rm -rf .next
rm -f tsconfig.tsbuildinfo

echo ""
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install

echo ""
echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

echo ""
echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: pm2 restart ecosystem.config.js"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs"

