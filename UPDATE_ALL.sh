#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./UPDATE_ALL.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤..."
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
update_project() {
    local dir=$1
    local name=$2
    
    echo -e "${YELLOW}üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ $name...${NC}"
    echo "   –ü—É—Ç—å: $dir"
    
    if [ ! -d "$dir" ]; then
        echo -e "${RED}   ‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $dir${NC}"
        return 1
    fi
    
    cd "$dir" || return 1
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π?
    if [ ! -d ".git" ]; then
        echo -e "${YELLOW}   ‚ö†Ô∏è  –≠—Ç–æ –Ω–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º${NC}"
        return 0
    fi
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if [ -n "$(git status --porcelain)" ]; then
        echo "   üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash..."
        git stash push -m "Auto-stash before update $(date +%Y-%m-%d_%H-%M-%S)" || true
    fi
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
    echo "   ‚¨áÔ∏è  –í—ã–ø–æ–ª–Ω—è–µ–º git pull..."
    if git pull; then
        echo -e "${GREEN}   ‚úÖ $name –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ${NC}"
        
        # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å stash –æ–±—Ä–∞—Ç–Ω–æ
        if git stash list | grep -q "Auto-stash"; then
            echo "   üì¶ –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
            git stash pop || echo "   ‚ö†Ô∏è  –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ stash (–º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å)"
        fi
        
        # –ï—Å–ª–∏ —ç—Ç–æ Next.js –ø—Ä–æ–µ–∫—Ç, —Å–æ–±–∏—Ä–∞–µ–º –µ–≥–æ
        if [ -f "package.json" ] && grep -q "next" package.json; then
            echo "   üî® –°–æ–±–∏—Ä–∞–µ–º Next.js –ø—Ä–æ–µ–∫—Ç..."
            if npm run build; then
                echo -e "${GREEN}   ‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞${NC}"
            else
                echo -e "${RED}   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ${NC}"
            fi
        fi
        
        return 0
    else
        echo -e "${RED}   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ git pull${NC}"
        return 1
    fi
}

# –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã
echo "1Ô∏è‚É£  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∫–∏..."
update_project "/var/www/ls/admin_nextjs" "–ê–¥–º–∏–Ω–∫–∞" || true

echo ""
echo "2Ô∏è‚É£  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
update_project "/var/www/luxon/app/app" "–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" || true

echo ""
echo "3Ô∏è‚É£  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)..."
update_project "/var/www/luxon" "–ö–æ—Ä–Ω–µ–≤–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π" || true

echo ""
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pm2 restart all || true

echo ""
echo -e "${GREEN}‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
pm2 status

