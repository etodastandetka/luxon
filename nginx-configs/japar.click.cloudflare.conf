# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –¥–ª—è japar.click —Å –∑–∞—â–∏—Ç–æ–π Cloudflare
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ /etc/nginx/sites-available/japar.click

# Cloudflare IP ranges (–æ–±–Ω–æ–≤–ª—è–π—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏)
# –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫: https://www.cloudflare.com/ips/

# IPv4
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;
set_real_ip_from 162.158.0.0/15;
set_real_ip_from 104.16.0.0/13;
set_real_ip_from 104.24.0.0/14;
set_real_ip_from 172.64.0.0/13;
set_real_ip_from 131.0.72.0/22;

# IPv6
set_real_ip_from 2400:cb00::/32;
set_real_ip_from 2606:4700::/32;
set_real_ip_from 2803:f800::/32;
set_real_ip_from 2405:b500::/32;
set_real_ip_from 2405:8100::/32;
set_real_ip_from 2a06:98c0::/29;
set_real_ip_from 2c0f:f248::/32;

real_ip_header CF-Connecting-IP;

# üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ DDoS - Rate Limiting Zones
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/m;  # 30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è API
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=120r/m;  # 120 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è –æ–±—â–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=10r/m;  # 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è –ª–æ–≥–∏–Ω–∞
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

server {
    listen 80;
    server_name japar.click www.japar.click;

    # –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ Cloudflare IP (IPv4)
    allow 173.245.48.0/20;
    allow 103.21.244.0/22;
    allow 103.22.200.0/22;
    allow 103.31.4.0/22;
    allow 141.101.64.0/18;
    allow 108.162.192.0/18;
    allow 190.93.240.0/20;
    allow 188.114.96.0/20;
    allow 197.234.240.0/22;
    allow 198.41.128.0/17;
    allow 162.158.0.0/15;
    allow 104.16.0.0/13;
    allow 104.24.0.0/14;
    allow 172.64.0.0/13;
    allow 131.0.72.0/22;
    deny all;  # –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ IP

    # üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ DDoS - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
    limit_conn conn_limit 20;  # –ú–∞–∫—Å–∏–º—É–º 20 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –æ–¥–Ω–æ–≥–æ IP
    client_max_body_size 10M;  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
    client_body_buffer_size 1M;  # –ë—É—Ñ–µ—Ä –¥–ª—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
    client_header_buffer_size 4k;  # –ë—É—Ñ–µ—Ä –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    large_client_header_buffers 4 16k;  # –ë—É—Ñ–µ—Ä—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (Slowloris –∞—Ç–∞–∫–∞)
    client_body_timeout 10s;
    client_header_timeout 10s;
    keepalive_timeout 65s;
    send_timeout 10s;

    # –õ–æ–≥–∏
    access_log /var/log/nginx/japar.click.access.log;
    error_log /var/log/nginx/japar.click.error.log;

    # üõ°Ô∏è –ó–ê–©–ò–¢–ê API ENDPOINTS
    location ~ ^/api/ {
        # Rate limiting –¥–ª—è API
        limit_req zone=api_limit burst=10 nodelay;
        limit_req_status 429;
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ User-Agent
        if ($http_user_agent ~* (bot|crawler|spider|scanner|curl|wget|python|java|go-http|sqlmap|nikto|nmap|masscan)) {
            return 403;
        }
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ User-Agent
        if ($http_user_agent = "") {
            return 403;
        }
        
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_cache_bypass $http_upgrade;
        
        # –¢–∞–π–º–∞—É—Ç—ã
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
        
        # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # üõ°Ô∏è –ó–ê–©–ò–¢–ê LOGIN
    location ~ ^/(login|api/auth/login) {
        # –°—Ç—Ä–æ–≥–∏–π rate limiting –¥–ª—è –ª–æ–≥–∏–Ω–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞)
        limit_req zone=login_limit burst=3 nodelay;
        limit_req_status 429;
        
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # üõ°Ô∏è –û–ë–©–ò–ï –°–¢–†–ê–ù–ò–¶–´
    location / {
        # Rate limiting –¥–ª—è –æ–±—â–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
        limit_req zone=general_limit burst=20 nodelay;
        limit_req_status 429;
        
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_cache_bypass $http_upgrade;
        
        # –¢–∞–π–º–∞—É—Ç—ã
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# HTTPS –±–ª–æ–∫ (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞)
# Certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç —ç—Ç–æ—Ç –±–ª–æ–∫ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

